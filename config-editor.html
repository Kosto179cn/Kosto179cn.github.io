<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>页面配置编辑器 | Kosto Hub</title>
    <!-- 引入Bootstrap和FontAwesome，保持与主站一致 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #f0f2f5;
            --card-bg: rgba(255, 255, 255, 0.85);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --primary-color: #007bff;
            --success-color: #20c997;
            --danger-color: #dc3545;
            --github-green: #2ea44f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft Yahei", Arial, sans-serif; }
        body { 
            padding: 20px; 
            max-width: 1400px; 
            margin: 0 auto; 
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            background-attachment: fixed;
            color: #333;
        }

        /* 顶部导航栏 */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
        }
        .header-title {
            font-weight: 700;
            font-size: 1.5rem;
            background: linear-gradient(45deg, #007bff, #6610f2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 返回主站按钮 */
        .back-home-btn {
            background: rgba(0,123,255,0.1);
            color: var(--primary-color);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.9rem;
            border: none;
            transition: var(--transition-base);
            margin-right: 15px;
        }
        .back-home-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        /* GitHub Token 样式 */
        .token-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .token-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 280px;
            font-size: 0.9rem;
        }
        .token-btn {
            background: var(--github-green);
            color: white;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            border: none;
            transition: var(--transition-base);
        }
        .token-btn:hover {
            background: #2c974b;
            transform: translateY(-1px);
        }
        .token-btn.logout {
            background: var(--danger-color);
        }
        .token-btn.logout:hover {
            background: #bb2d3b;
        }
        .token-status {
            font-size: 0.85rem;
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .token-status.error {
            color: var(--danger-color);
        }
        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .container { 
            display: flex; 
            gap: 20px; 
            flex-wrap: wrap; 
        }
        .panel { 
            flex: 1; 
            min-width: 400px; 
            background: var(--card-bg);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.6);
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: var(--shadow-sm);
            transition: var(--transition-base);
        }
        .panel:hover {
            box-shadow: var(--shadow-md);
        }

        h2 { 
            margin-bottom: 20px; 
            color: #333; 
            border-bottom: 2px solid var(--primary-color); 
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* 图标选择器样式 */
        .icon-select-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .icon-select-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .icon-search {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }
        .icon-item {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition-base);
            font-size: 1.5rem;
            color: #495057;
            background: #f8f9fa;
        }
        .icon-item:hover {
            background: #e9ecef;
            transform: scale(1.1);
            color: var(--primary-color);
        }
        .icon-item.selected {
            background: var(--primary-color);
            color: white;
        }

        /* 表单样式 */
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #555; 
        }
        input, textarea, select { 
            width: 100%; 
            padding: 10px 15px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 14px;
            transition: var(--transition-base);
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        textarea { 
            height: 120px; 
            resize: vertical; 
            font-family: Consolas, monospace; 
        }

        /* 按钮样式 */
        button { 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            margin: 5px 0;
            transition: var(--transition-base);
        }
        button:hover { 
            background: #0056b3;
            transform: translateY(-2px);
        }
        .btn-danger { background: var(--danger-color); }
        .btn-danger:hover { background: #bb2d3b; }
        .btn-success { background: var(--success-color); }
        .btn-success:hover { background: #19a279; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }

        /* 列表项样式 */
        .blacklist-item { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            margin-bottom: 10px; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 8px;
            transition: var(--transition-base);
        }
        .blacklist-item:hover {
            background: #e9ecef;
        }
        .config-item { 
            background: #f8f9fa; 
            padding: 20px; 
            margin-bottom: 15px; 
            border-radius: 10px;
            transition: var(--transition-base);
        }
        .config-item:hover {
            background: #e9ecef;
        }

        /* JSON预览 */
        #json-preview { 
            margin-top: 20px; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 10px; 
            overflow-x: auto; 
            font-family: Consolas, monospace;
            font-size: 13px; 
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .tips { color: #666; font-size: 12px; margin-top: 5px; }

        /* 响应式适配 */
        @media (max-width: 768px) {
            .header-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .header-title {
                justify-content: center;
            }
            .token-container {
                width: 100%;
                flex-direction: column;
            }
            .token-input {
                width: 100%;
            }
            .panel {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="header-bar">
        <div class="header-title">
            <!-- 返回主站按钮 -->
            <button class="back-home-btn" onclick="window.location.href='index.html'">
                <i class="fas fa-home me-1"></i> 主站
            </button>
            <i class="fas fa-cog me-2"></i> Kosto 配置编辑器
        </div>
        <!-- GitHub Token 登录区域 -->
        <div class="token-container">
            <input type="password" id="githubTokenInput" class="token-input" placeholder="请输入GitHub Personal Access Token" />
            <button id="saveTokenBtn" class="token-btn">
                <i class="fab fa-github me-1"></i> 登录
            </button>
            <button id="logoutTokenBtn" class="token-btn logout" style="display: none;">
                <i class="fas fa-sign-out-alt me-1"></i> 登出
            </button>
            <span id="tokenStatus" class="token-status"></span>
        </div>
    </div>

    <!-- 主操作按钮 -->
    <div class="btn-group">
        <button id="load-config" class="btn-success">
            <i class="fas fa-download me-1"></i> 加载当前配置
        </button>
        <button id="save-config" class="btn-success">
            <i class="fas fa-save me-1"></i> 保存配置到本地
        </button>
        <button id="preview-json">
            <i class="fas fa-code me-1"></i> 预览JSON
        </button>
        <button id="submit-config" class="btn-success">
            <i class="fab fa-github me-1"></i> 提交到GitHub
        </button>
    </div>

    <div class="container">
        <!-- 黑名单配置面板 -->
        <div class="panel">
            <h2>
                <i class="fas fa-ban me-2 text-danger"></i> 黑名单配置（不显示的页面）
            </h2>
            <div class="form-group">
                <label>添加页面到黑名单</label>
                <input type="text" id="blacklist-input" placeholder="例如：test.html">
                <button id="add-blacklist" class="mt-2">
                    <i class="fas fa-plus me-1"></i> 添加
                </button>
                <p class="tips">添加后该页面不会出现在pages.json中</p>
            </div>
            <div id="blacklist-container"></div>
        </div>

        <!-- 页面配置面板 -->
        <div class="panel">
            <h2>
                <i class="fas fa-file-code me-2 text-primary"></i> 页面信息配置
            </h2>
            <div class="form-group">
                <label>页面文件名</label>
                <input type="text" id="page-filename" placeholder="例如：whitelist.html">
            </div>
            <div class="form-group">
                <label>图标 (fa-xxx)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="page-icon" placeholder="例如：fa-shield-alt" readonly>
                    <button id="selectIconBtn">
                        <i class="fas fa-icons me-1"></i> 选择图标
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>分类</label>
                <input type="text" id="page-category" placeholder="例如：admin">
            </div>
            <div class="form-group">
                <label>主题</label>
                <input type="text" id="page-theme" placeholder="例如：theme-admin">
            </div>
            <div class="form-group">
                <label>描述</label>
                <textarea id="page-desc" placeholder="页面描述信息"></textarea>
            </div>
            <button id="add-config">
                <i class="fas fa-plus-circle me-1"></i> 添加/更新页面配置
            </button>
            <div id="config-list" class="config-list mt-4"></div>
        </div>
    </div>

    <!-- JSON预览区域 -->
    <div class="panel" style="margin-top: 20px;">
        <h2>
            <i class="fas fa-file-json me-2 text-success"></i> 配置JSON预览
        </h2>
        <div id="json-preview"></div>
    </div>

    <!-- 图标选择模态框 -->
    <div id="iconSelectModal" class="icon-select-modal">
        <div class="icon-select-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="m-0">选择图标</h4>
                <button id="closeIconModal" class="btn-danger">
                    <i class="fas fa-times"></i> 关闭
                </button>
            </div>
            <input type="text" id="iconSearchInput" class="icon-search" placeholder="搜索图标（例如：gamepad、cog）">
            <div id="iconGrid" class="icon-grid"></div>
        </div>
    </div>

    <!-- 引入Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // ================= 全局变量 =================
        let configData = {
            CONFIG_MAP: {},
            EXCLUDE_FILES: []
        };
        
        // GitHub Token 本地存储键名（固定）
        const GITHUB_TOKEN_KEY = 'githubToken';
        // GitHub仓库信息（需替换为你的实际信息）
        const GITHUB_REPO_INFO = {
            owner: 'Kosto179cn',
            repo: 'Kosto179cn.github.io',
            path: 'page-config.json'
        };
        // 常用FontAwesome图标列表（免费版）
        const FA_ICONS = [
            // 工具/管理类
            'fa-tools', 'fa-cog', 'fa-gears', 'fa-database', 'fa-file-code', 
            'fa-download', 'fa-upload', 'fa-save', 'fa-search', 'fa-shield-halved',
            'fa-refresh', 'fa-sync', 'fa-user-cog', 'fa-lock', 'fa-unlock',
            // 游戏类
            'fa-gamepad', 'fa-dice', 'fa-chess', 'fa-puzzle-piece', 'fa-volume-high',
            'fa-user-astronaut', 'fa-rocket', 'fa-star', 'fa-trophy', 'fa-bomb',
            // 编辑/内容类
            'fa-pen-to-square', 'fa-image', 'fa-photo-film', 'fa-font', 'fa-table',
            'fa-file-excel', 'fa-file-pdf', 'fa-file-text', 'fa-edit', 'fa-copy',
            // 通用类
            'fa-file', 'fa-link', 'fa-question-circle', 'fa-clock', 'fa-globe',
            'fa-home', 'fa-info-circle', 'fa-warning', 'fa-check-circle', 'fa-times-circle'
        ];

        // ================= 工具函数 =================
        // 安全编码请求头值
        function encodeHeaderValue(value) {
            // 移除所有非ASCII字符，确保符合ISO-8859-1编码
            return value.replace(/[^\x00-\xFF]/g, '').trim();
        }

        // 加密 Token
        function encryptToken(token) {
            try {
                const salt = Math.random().toString(36).substring(2, 8);
                const data = JSON.stringify({ token, timestamp: Date.now(), salt });
                return btoa(data);
            } catch (e) { return null; }
        }

        // 解密 Token（兼容加密和非加密）
        function decryptToken(encrypted) {
            try {
                if (!encrypted) return null;
                const data = JSON.parse(atob(encrypted));
                return data.token;
            } catch (e) {
                // 解密失败，说明可能是明文 Token
                return encrypted;
            }
        }

        // ================= GitHub Token 管理 =================
        // 验证Token是否有效
        async function validateToken(token) {
            if (!token || token.trim() === '') return false;
            
            try {
                // 创建Headers对象，避免直接拼接导致的编码问题
                const headers = new Headers();
                // 安全设置Authorization头
                const authHeader = encodeHeaderValue(`token ${token.trim()}`);
                headers.append('Authorization', authHeader);
                headers.append('Accept', 'application/vnd.github.v3+json');
                
                // 调用GitHub API验证Token有效性
                const response = await fetch('https://api.github.com/user', {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                return response.ok;
            } catch (error) {
                console.error('Token验证失败:', error);
                return false;
            }
        }

        // 初始化Token状态
        async function initTokenStatus() {
            const encryptedToken = localStorage.getItem(GITHUB_TOKEN_KEY);
            const tokenInput = document.getElementById('githubTokenInput');
            const saveBtn = document.getElementById('saveTokenBtn');
            const logoutBtn = document.getElementById('logoutTokenBtn');
            const statusEl = document.getElementById('tokenStatus');

            // 清空状态
            statusEl.innerHTML = '';

            if (encryptedToken) {
                // 尝试解密 Token（兼容加密和非加密）
                const token = decryptToken(encryptedToken);

                // 仅保留Token的有效字符
                const cleanToken = token.trim().replace(/[^\x00-\xFF]/g, '');
                tokenInput.value = cleanToken;
                saveBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';

                // 显示验证中状态
                statusEl.innerHTML = '<div class="loading-spinner"></div> 验证中...';

                // 验证Token有效性
                const isValid = await validateToken(cleanToken);
                if (isValid) {
                    statusEl.innerHTML = '✅ Token有效';
                    // Token有效则自动加载配置
                    await loadConfigData();
                } else {
                    statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Token无效或无权限';
                    statusEl.classList.add('error');
                    // 清除无效Token
                    localStorage.removeItem(GITHUB_TOKEN_KEY);
                    tokenInput.value = '';
                    saveBtn.style.display = 'inline-block';
                    logoutBtn.style.display = 'none';
                }
            } else {
                saveBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                statusEl.textContent = '';
            }
        }

        // 保存并验证Token
        document.getElementById('saveTokenBtn').addEventListener('click', async () => {
            const tokenInput = document.getElementById('githubTokenInput');
            const rawToken = tokenInput.value;
            const statusEl = document.getElementById('tokenStatus');
            
            // 清理Token，移除非法字符
            const cleanToken = rawToken.trim().replace(/[^\x00-\xFF]/g, '');
            
            if (!cleanToken) {
                alert('请输入有效的GitHub Personal Access Token！');
                return;
            }
            
            // 显示验证中状态
            statusEl.innerHTML = '<div class="loading-spinner"></div> 验证中...';
            
            // 验证Token
            const isValid = await validateToken(cleanToken);
            if (isValid) {
                // 加密后存储Token
                const encryptedToken = encryptToken(cleanToken);
                localStorage.setItem(GITHUB_TOKEN_KEY, encryptedToken);
                await initTokenStatus();
                alert('Token验证通过并保存！');
            } else {
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Token无效或无权限';
                statusEl.classList.add('error');
                alert('Token无效，请检查后重新输入！\n提示：确保Token有repo权限，且没有特殊字符');
            }
        });

        // 登出（清除Token）
        document.getElementById('logoutTokenBtn').addEventListener('click', () => {
            if (confirm('确定要登出吗？')) {
                localStorage.removeItem(GITHUB_TOKEN_KEY);
                document.getElementById('githubTokenInput').value = '';
                initTokenStatus();
                alert('已登出！');
            }
        });

        // 检查Token是否存在且有效
        async function checkToken() {
            const encryptedToken = localStorage.getItem(GITHUB_TOKEN_KEY);
            if (!encryptedToken) {
                alert('请先登录GitHub Token！');
                document.getElementById('githubTokenInput').focus();
                return false;
            }

            // 尝试解密 Token（兼容加密和非加密）
            const token = decryptToken(encryptedToken);

            // 清理并验证Token
            const cleanToken = token.trim().replace(/[^\x00-\xFF]/g, '');
            // 二次验证Token有效性
            const isValid = await validateToken(cleanToken);
            if (!isValid) {
                alert('Token已失效，请重新登录！');
                localStorage.removeItem(GITHUB_TOKEN_KEY);
                initTokenStatus();
                return false;
            }

            return cleanToken;
        }

        // ================= 配置管理 =================
        // 加载配置数据
        async function loadConfigData() {
            try {
                // 读取仓库中的配置文件，添加时间戳避免缓存
                const response = await fetch(`${GITHUB_REPO_INFO.path}?t=${Date.now()}`, {
                    cache: 'no-cache'
                });
                if (response.ok) {
                    configData = await response.json();
                    renderBlacklist();
                    renderConfigList();
                    // 自动预览JSON
                    document.getElementById('json-preview').textContent = JSON.stringify(configData, null, 2);
                    console.log('配置加载成功');
                } else {
                    console.log('配置文件不存在，使用空配置');
                    configData = { CONFIG_MAP: {}, EXCLUDE_FILES: [] };
                }
            } catch (e) {
                console.error('加载配置失败：', e);
                alert('加载配置失败：' + e.message);
            }
        }

        // 手动加载配置按钮
        document.getElementById('load-config').addEventListener('click', async () => {
            const token = await checkToken();
            if (!token) return;
            await loadConfigData();
            alert('配置加载成功！');
        });

        // 渲染黑名单列表
        function renderBlacklist() {
            const container = document.getElementById('blacklist-container');
            container.innerHTML = '';
            
            configData.EXCLUDE_FILES.forEach(file => {
                const item = document.createElement('div');
                item.className = 'blacklist-item';
                item.innerHTML = `
                    <span>${file}</span>
                    <button class="btn-danger" onclick="removeBlacklist('${file}')">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                `;
                container.appendChild(item);
            });
        }

        // 删除黑名单项
        function removeBlacklist(file) {
            configData.EXCLUDE_FILES = configData.EXCLUDE_FILES.filter(item => item !== file);
            renderBlacklist();
        }

        // 添加黑名单项
        document.getElementById('add-blacklist').addEventListener('click', () => {
            const input = document.getElementById('blacklist-input');
            const file = input.value.trim();
            
            if (!file) {
                alert('请输入页面文件名');
                return;
            }
            
            if (!configData.EXCLUDE_FILES.includes(file)) {
                configData.EXCLUDE_FILES.push(file);
                renderBlacklist();
                input.value = '';
            } else {
                alert('该文件已在黑名单中');
            }
        });

        // 渲染配置列表
        function renderConfigList() {
            const container = document.getElementById('config-list');
            container.innerHTML = '';
            
            Object.keys(configData.CONFIG_MAP).forEach(filename => {
                const config = configData.CONFIG_MAP[filename];
                const item = document.createElement('div');
                item.className = 'config-item';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong>${filename}</strong>
                        <button class="btn-danger" onclick="removeConfig('${filename}')">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                    <p><i class="fas ${config.icon} me-2"></i> 图标：${config.icon}</p>
                    <p><i class="fas fa-folder me-2"></i> 分类：${config.category}</p>
                    <p><i class="fas fa-palette me-2"></i> 主题：${config.theme}</p>
                    <p><i class="fas fa-comment me-2"></i> 描述：${config.desc}</p>
                `;
                container.appendChild(item);
            });
        }

        // 删除配置项
        function removeConfig(filename) {
            delete configData.CONFIG_MAP[filename];
            renderConfigList();
        }

        // 添加/更新配置项
        document.getElementById('add-config').addEventListener('click', () => {
            const filename = document.getElementById('page-filename').value.trim();
            const icon = document.getElementById('page-icon').value.trim();
            const category = document.getElementById('page-category').value.trim();
            const theme = document.getElementById('page-theme').value.trim();
            const desc = document.getElementById('page-desc').value.trim();
            
            if (!filename) {
                alert('请输入页面文件名');
                return;
            }
            
            configData.CONFIG_MAP[filename] = {
                icon: icon || 'fa-file',
                category: category || 'other',
                theme: theme || 'theme-other',
                desc: desc || '未设置描述'
            };
            
            // 清空表单
            document.getElementById('page-filename').value = '';
            document.getElementById('page-icon').value = '';
            document.getElementById('page-category').value = '';
            document.getElementById('page-theme').value = '';
            document.getElementById('page-desc').value = '';
            
            renderConfigList();
            alert('配置已更新！');
        });

        // 预览JSON
        document.getElementById('preview-json').addEventListener('click', () => {
            const preview = document.getElementById('json-preview');
            preview.textContent = JSON.stringify(configData, null, 2);
        });

        // 保存配置到本地文件
        document.getElementById('save-config').addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(configData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'page-config.json';
            a.click();
            URL.revokeObjectURL(url);
            alert('配置文件已下载！');
        });

        // 提交配置到GitHub
        document.getElementById('submit-config').addEventListener('click', async () => {
            const token = await checkToken();
            if (!token) return;
            
            try {
                // 创建Headers对象
                const headers = new Headers();
                const authHeader = encodeHeaderValue(`token ${token}`);
                headers.append('Authorization', authHeader);
                headers.append('Accept', 'application/vnd.github.v3+json');
                
                // 1. 获取文件的SHA（用于更新）
                const shaResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO_INFO.owner}/${GITHUB_REPO_INFO.repo}/contents/${GITHUB_REPO_INFO.path}`, {
                    method: 'GET',
                    headers: headers,
                    cache: 'no-cache'
                });
                
                let sha = '';
                if (shaResponse.ok) {
                    const shaData = await shaResponse.json();
                    sha = shaData.sha;
                }

                // 2. 准备提交数据
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(configData, null, 2))));
                
                // 3. 提交配置文件
                const submitHeaders = new Headers();
                submitHeaders.append('Authorization', authHeader);
                submitHeaders.append('Accept', 'application/vnd.github.v3+json');
                submitHeaders.append('Content-Type', 'application/json');
                
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO_INFO.owner}/${GITHUB_REPO_INFO.repo}/contents/${GITHUB_REPO_INFO.path}`, {
                    method: 'PUT',
                    headers: submitHeaders,
                    body: JSON.stringify({
                        message: 'Update page-config.json via config-editor',
                        content: content,
                        sha: sha
                    }),
                    cache: 'no-cache'
                });

                if (response.ok) {
                    alert('配置已成功提交到GitHub！');
                } else {
                    const errorData = await response.json();
                    alert(`提交失败：${errorData.message}`);
                }
            } catch (e) {
                alert('提交失败：' + e.message);
                console.error(e);
            }
        });

        // ================= 图标选择器 =================
        // 初始化图标网格
        function initIconGrid() {
            const iconGrid = document.getElementById('iconGrid');
            const searchInput = document.getElementById('iconSearchInput');
            let filteredIcons = FA_ICONS;

            // 渲染图标
            function renderIcons(icons) {
                iconGrid.innerHTML = '';
                icons.forEach(icon => {
                    const iconEl = document.createElement('div');
                    iconEl.className = 'icon-item';
                    iconEl.dataset.icon = icon;
                    iconEl.innerHTML = `<i class="fas ${icon}"></i>`;
                    
                    // 点击选择图标
                    iconEl.addEventListener('click', () => {
                        document.querySelectorAll('.icon-item').forEach(el => {
                            el.classList.remove('selected');
                        });
                        iconEl.classList.add('selected');
                        document.getElementById('page-icon').value = icon;
                    });
                    
                    iconGrid.appendChild(iconEl);
                });
            }

            // 初始渲染
            renderIcons(filteredIcons);

            // 搜索过滤
            searchInput.addEventListener('input', () => {
                const keyword = searchInput.value.toLowerCase().trim();
                filteredIcons = FA_ICONS.filter(icon => 
                    icon.includes(keyword) || icon.replace('fa-', '').includes(keyword)
                );
                renderIcons(filteredIcons);
            });
        }

        // 打开图标选择模态框
        document.getElementById('selectIconBtn').addEventListener('click', () => {
            document.getElementById('iconSelectModal').style.display = 'flex';
            initIconGrid();
        });

        // 关闭图标选择模态框
        document.getElementById('closeIconModal').addEventListener('click', () => {
            document.getElementById('iconSelectModal').style.display = 'none';
        });

        // 点击模态框外部关闭
        document.getElementById('iconSelectModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('iconSelectModal')) {
                document.getElementById('iconSelectModal').style.display = 'none';
            }
        });

        // ================= 初始化 =================
        document.addEventListener('DOMContentLoaded', async () => {
            // 初始化Token状态并自动加载配置
            await initTokenStatus();
            
            // 初始化图标选择器
            initIconGrid();
        });
    </script>
</body>
</html>
