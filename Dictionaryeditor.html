<!-- START OF FILE Dictionaryeditor.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>国服屏蔽词管理 Pro</title>
    <!-- Bootstrap 5.3 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome 6 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
            --bg-color: #f8f9fa;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            color: #2d3748;
            padding-bottom: 60px;
        }

        /* 顶部导航 */
        .navbar-custom {
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .brand-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            font-size: 1.4rem;
        }

        /* 卡片样式 */
        .content-card {
            background: #fff;
            border-radius: 16px;
            border: none;
            box-shadow: var(--card-shadow);
            margin-bottom: 24px;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .card-header-custom {
            padding: 20px;
            border-bottom: 1px solid #edf2f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 表格样式 */
        .table-custom thead th {
            background: #f7fafc;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            padding: 16px;
            border-bottom: 2px solid #edf2f7;
        }

        .table-custom td {
            padding: 16px;
            vertical-align: middle;
            border-bottom: 1px solid #edf2f7;
        }
        
        .table-custom tr:last-child td {
            border-bottom: none;
        }

        /* 输入框美化 */
        .form-control-custom {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px 15px;
            transition: all 0.3s;
        }

        .form-control-custom:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* 按钮美化 */
        .btn-gradient {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 10px 24px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3);
            color: white;
        }

        /* 状态指示器 */
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
            background: #edf2f7;
            color: #718096;
        }

        /* 自动保存状态浮窗 */
        .save-status-float {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1050;
            font-size: 0.9rem;
            border: 1px solid #edf2f7;
        }

        /* 批量导入预览区 */
        .batch-preview-box {
            max-height: 400px;
            overflow-y: auto;
            background: #f8fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 10px;
        }

        .batch-item {
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            display: flex;
            align-items: center;
        }

        .batch-item.magic { border-left-color: #ecc94b; }
        .batch-item.replace { border-left-color: #f56565; }
        .batch-item.new { border-left-color: #48bb78; }

        /* 加载动画 */
        .spinner-line {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast-container { z-index: 2000; }

        /* --- 新增样式：屏蔽符可视化 --- */
        .magic-tag {
            display: inline-block;
            font-size: 0.75rem;
            padding: 0 4px;
            margin: 0 1px;
            border-radius: 4px;
            background-color: #f6e05e; /* 黄色背景 */
            color: #744210;
            font-family: monospace;
            vertical-align: middle;
            user-select: none;
            cursor: help;
        }
        .magic-preview {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 4px;
            padding-left: 2px;
            min-height: 1.2em; /* 防止高度跳动 */
        }

        /* --- 表格容器自适应 --- */
        .table-container-wrapper {
            height: calc(100vh - 280px);
            min-height: 400px;
            max-height: 800px;
            overflow-y: auto;
        }
        .table-container-wrapper::-webkit-scrollbar {
            width: 8px;
        }
        .table-container-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .table-container-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .table-container-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body>

    <!-- 顶部导航 -->
    <nav class="navbar navbar-custom">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center w-100">
                <div class="d-flex align-items-center gap-2">
                    <a href="index.html" class="btn btn-sm btn-outline-secondary me-2">
                        <i class="fas fa-home"></i> 主页
                    </a>
                    <i class="fas fa-shield-alt text-primary fs-4"></i>
                    <span class="brand-text">国服屏蔽词管理</span>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-light text-primary fw-bold border" data-bs-toggle="modal" data-bs-target="#configModal">
                        <i class="fas fa-cog"></i> 设置
                    </button>
                    <button id="loadBtn" class="btn btn-gradient">
                        <i class="fas fa-cloud-download-alt"></i> 加载文件
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 头部统计与操作 -->
        <div class="row g-4 mb-4">
            <div class="col-md-8">
                <div class="content-card h-100 p-4 d-flex align-items-center">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control form-control-custom border-start-0" placeholder="搜索关键词或替换词...">
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="content-card h-100 p-4 d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-muted small text-uppercase fw-bold">当前词条数</div>
                        <div class="fs-2 fw-bold text-dark" id="totalCount">0</div>
                    </div>
                    <div class="d-flex flex-column gap-2">
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSingleModal">
                            <i class="fas fa-plus"></i> 单条添加
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="openBatchModalBtn">
                            <i class="fas fa-file-import"></i> 批量导入
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 列表区域 -->
        <div class="content-card">
            <div class="card-header-custom">
                <h5 class="m-0 fw-bold text-secondary d-flex align-items-center">
                    <i class="fas fa-list-alt me-2"></i>词库列表
                    <span class="badge bg-secondary ms-2" style="font-size: 0.7em;" id="dictCount">0</span>
                </h5>
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex align-items-center gap-2">
                        <label class="small text-muted mb-0">显示：</label>
                        <select id="displayLimitSelect" class="form-select form-select-sm" style="width: auto;">
                            <option value="50">50 条</option>
                            <option value="100" selected>100 条</option>
                            <option value="200">200 条</option>
                            <option value="500">500 条</option>
                            <option value="1000">1000 条</option>
                            <option value="0">全部</option>
                        </select>
                    </div>
                    <span class="status-badge" id="dataStatus">未加载</span>
                </div>
            </div>
            <div class="table-container-wrapper" id="tableContainer">
                <div class="table-responsive">
                    <table class="table table-custom table-hover mb-0" id="dictTable">
                        <thead>
                        <tr>
                            <th width="30%">原词</th>
                            <th width="50%">替换词</th>
                            <th width="20%" class="text-end">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dictTableBody">
                        <tr>
                            <td colspan="3" class="text-center py-5">
                                <div class="text-muted mb-3">
                                    <i class="fas fa-inbox fa-3x opacity-25"></i>
                                </div>
                                <p class="text-muted">请点击右上角"加载文件"获取数据</p>
                            </td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 自动保存状态悬浮窗 -->
    <div class="save-status-float" id="saveStatus" style="display: none;">
        <div id="saveIcon"><i class="fas fa-check-circle text-success"></i></div>
        <div id="saveText" class="fw-bold text-secondary">已同步</div>
    </div>

    <!-- 通知 Toast 容器 -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- ================= 模态框区域 ================= -->

    <!-- 1. 设置模态框 -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">系统设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <label class="form-label fw-bold text-secondary">GitHub Access Token</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="fas fa-key"></i></span>
                            <input type="password" id="tokenInput" class="form-control" placeholder="ghp_..." autocomplete="off">
                        </div>
                        <div class="form-text text-muted small mt-2">
                            <i class="fas fa-shield-alt"></i> Token 将会被加密存储在本地 (Key: githubToken)。
                        </div>
                    </div>
                    
                    <div class="bg-light p-3 rounded-3 mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoSaveSwitch" checked>
                            <label class="form-check-label fw-bold" for="autoSaveSwitch">启用自动保存</label>
                        </div>
                        <div class="text-muted small mt-1">修改后3秒自动同步到 GitHub</div>
                    </div>

                    <button class="btn btn-outline-primary w-100" id="testTokenBtn">
                        验证 Token 有效性
                    </button>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">完成</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. 单条添加模态框 -->
    <div class="modal fade" id="addSingleModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">添加屏蔽词</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">原词</label>
                        <input type="text" id="singleKey" class="form-control form-control-custom" placeholder="例如：敏感词">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">替换词</label>
                        <div class="input-group">
                            <input type="text"
                                   id="singleVal"
                                   class="form-control form-control-custom"
                                   placeholder="例如：敏*词"
                                   oninput="App.renderSinglePreview()"> <!-- 添加 oninput 事件 -->
                            <button class="btn btn-warning text-white" type="button" onclick="App.insertMagicChar('singleVal')">
                                <i class="fas fa-magic"></i> 加符
                            </button>
                        </div>
                        <!-- 新增：可视化预览区域 -->
                        <div id="singleValPreview" class="magic-preview"></div>
                        <div class="form-text">点击"加符"可插入隐形防屏蔽字符 (U+200E)</div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-gradient" id="confirmAddSingleBtn">确认添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. 批量导入模态框 -->
    <div class="modal fade" id="batchModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-file-import text-primary me-2"></i>批量导入工作台</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row h-100">
                        <!-- 左侧输入 -->
                        <div class="col-lg-5 d-flex flex-column border-end">
                            <!-- 新增：网络导入区域 -->
                            <div class="bg-light p-3 rounded mb-3 border">
                                <label class="fw-bold mb-2"><i class="fas fa-globe me-1"></i>网络文件导入</label>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" id="batchUrlInput" class="form-control" placeholder="https://example.com/dict.txt">
                                    <button class="btn btn-outline-primary" id="fetchUrlBtn">
                                        <i class="fas fa-download"></i> 获取
                                    </button>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="corsProxySwitch" checked>
                                    <label class="form-check-label small text-muted" for="corsProxySwitch">
                                        使用 CORS 代理 (推荐，解决跨域失败问题)
                                    </label>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="fw-bold">直接粘贴数据</label>
                                <select id="batchFormat" class="form-select form-select-sm w-auto border-0 bg-light">
                                    <option value="auto">自动识别格式</option>
                                    <option value="keyvalue">键值对 (Key=Value 或 空格)</option>
                                    <option value="json">JSON</option>
                                </select>
                            </div>
                            <textarea id="batchInput" class="form-control flex-grow-1 mb-3" style="min-height: 200px; font-family: monospace; font-size: 0.9rem;" placeholder="支持格式：&#10;1. 原词 替换词 (空格/Tab分隔)&#10;2. 原词=替换词&#10;3. JSON 对象 {&quot;Key&quot;:&quot;Val&quot;}"></textarea>
                            <div class="d-grid">
                                <button class="btn btn-primary" id="parseBatchBtn">
                                    <i class="fas fa-arrow-right me-2"></i>解析到预览区
                                </button>
                            </div>
                        </div>
                        
                        <!-- 右侧预览 -->
                        <div class="col-lg-7 d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="fw-bold">2. 预览与操作 (<span id="batchCount">0</span>)</label>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-warning" id="batchMagicBtn">
                                        <i class="fas fa-magic"></i> 全体加符 (间隔)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 选项 -->
                            <div class="bg-light p-2 rounded mb-2 d-flex align-items-center justify-content-between">
                                <div class="form-check ms-2">
                                    <input class="form-check-input" type="checkbox" id="batchOverwrite">
                                    <label class="form-check-label small" for="batchOverwrite">覆盖已存在的词条</label>
                                </div>
                                <div class="small text-muted">
                                    <span class="badge bg-success rounded-circle p-1 me-1"> </span>新增
                                    <span class="badge bg-danger rounded-circle p-1 me-1 ms-2"> </span>替换
                                    <span class="badge bg-warning text-dark rounded-circle p-1 me-1 ms-2"> </span>含符
                                </div>
                            </div>

                            <div id="batchPreviewList" class="batch-preview-box flex-grow-1">
                                <div class="text-center text-muted py-5 mt-4">
                                    <i class="fas fa-paste fa-2x mb-3 opacity-25"></i>
                                    <p>请先在左侧粘贴数据或输入网址并解析</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-gradient px-4" id="confirmBatchImportBtn">
                        <i class="fas fa-check me-2"></i>确认导入
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 脚本逻辑 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        /**
         * 核心逻辑模块
         */
        
        // 常量配置
        const CONFIG = {
            owner: "Kosto179cn",
            repo: "Kosto179cn.github.io",
            path: "chinese_words_replacer/dictionary.json",
            tokenKey: "githubToken", // 标准化键名
            displayLimitKey: "displayLimit", // 显示条数设置的键名
            magicChar: '\u200E'
        };

        // 工具类
        const Utils = {
            // 加密 Token
            encryptToken: (token) => {
                try {
                    const salt = Math.random().toString(36).substring(2, 8);
                    const data = JSON.stringify({ token, timestamp: Date.now(), salt });
                    return btoa(data);
                } catch (e) { return null; }
            },
            
            // 解密 Token
            decryptToken: (encrypted) => {
                try {
                    if (!encrypted) return null;
                    const data = JSON.parse(atob(encrypted));
                    return data.token;
                } catch (e) { return null; }
            },

            // 转义 HTML
            escapeHtml: (str) => {
                if (!str) return '';
                return str.replace(/&/g, "&amp;")
                          .replace(/</g, "&lt;")
                          .replace(/>/g, "&gt;")
                          .replace(/"/g, "&quot;")
                          .replace(/'/g, "&#039;");
            },

            // 显示 Toast
            showToast: (message, type = 'info') => {
                const container = document.querySelector('.toast-container');
                const id = 'toast-' + Date.now();
                const colors = {
                    info: 'text-bg-primary',
                    success: 'text-bg-success',
                    error: 'text-bg-danger',
                    warning: 'text-bg-warning'
                };
                
                const html = `
                    <div id="${id}" class="toast align-items-center ${colors[type]} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'} me-2"></i>
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', html);
                const toastEl = document.getElementById(id);
                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
                
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            },

            // 更新自动保存状态UI
            updateSaveStatus: (status, text) => {
                const el = document.getElementById('saveStatus');
                const icon = document.getElementById('saveIcon');
                const txt = document.getElementById('saveText');
                
                el.style.display = 'flex';
                txt.textContent = text;
                
                if (status === 'saving') {
                    icon.innerHTML = '<div class="spinner-border spinner-loading text-primary" style="width:1rem;height:1rem;"></div>';
                } else if (status === 'success') {
                    icon.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                    setTimeout(() => { if(el.style.display!=='none') el.style.display='none'; }, 3000);
                } else if (status === 'error') {
                    icon.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i>';
                } else {
                    el.style.display = 'none';
                }
            }
        };

        // Token 管理
        const TokenManager = {
            init: () => {
                // 迁移旧键名逻辑：github-Token -> githubToken
                const oldToken = localStorage.getItem('github-Token');
                if (oldToken) {
                    // 如果 githubToken 不存在，则迁移过去
                    if (!localStorage.getItem(CONFIG.tokenKey)) {
                        localStorage.setItem(CONFIG.tokenKey, oldToken);
                        console.log('Migrated github-Token to githubToken');
                    }
                    // 无论是否迁移成功，删除旧 key 防止混淆
                    localStorage.removeItem('github-Token');
                }

                // 加载 Token
                const encrypted = localStorage.getItem(CONFIG.tokenKey);
                const token = Utils.decryptToken(encrypted);
                if (token) {
                    document.getElementById('tokenInput').value = token;
                    // 自动加载
                    setTimeout(() => App.loadData(), 500);
                }
            },

            save: () => {
                const token = document.getElementById('tokenInput').value.trim();
                if (token) {
                    const encrypted = Utils.encryptToken(token);
                    localStorage.setItem(CONFIG.tokenKey, encrypted);
                    // 确保旧键被清除
                    localStorage.removeItem('github-Token');
                    Utils.showToast('Token 已保存', 'success');
                } else {
                    localStorage.removeItem(CONFIG.tokenKey);
                }
            },

            get: () => {
                const encrypted = localStorage.getItem(CONFIG.tokenKey);
                return Utils.decryptToken(encrypted);
            }
        };

        // GitHub API
        const GitHubAPI = {
            // 获取文件
            fetchFile: async () => {
                const token = TokenManager.get();
                if (!token) throw new Error("Token 未设置");

                const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`;
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });

                if (!res.ok) {
                    if (res.status === 401) throw new Error("Token 无效或过期");
                    if (res.status === 404) throw new Error("文件或仓库不存在");
                    throw new Error(`HTTP Error: ${res.status}`);
                }

                return await res.json();
            },

            // 更新文件
            updateFile: async (contentObj, sha) => {
                const token = TokenManager.get();
                if (!token) throw new Error("Token 未设置");

                // Base64 编码 (处理 UTF-8)
                const contentStr = JSON.stringify(contentObj, null, 2);
                const encoder = new TextEncoder();
                const data = encoder.encode(contentStr);
                let binary = '';
                for (let i = 0; i < data.byteLength; i++) binary += String.fromCharCode(data[i]);
                const contentBase64 = btoa(binary);

                const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`;
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: "Update via Shield Words Manager Pro",
                        content: contentBase64,
                        sha: sha
                    })
                });

                if (!res.ok) throw new Error(`保存失败: ${res.status}`);
                return await res.json();
            }
        };

        // 主应用逻辑
        const App = {
            data: {},
            sha: null,
            autoSaveTimer: null,
            batchDraft: [],

            init: () => {
                TokenManager.init();

                // 加载用户设置的显示条数
                const savedLimit = localStorage.getItem(CONFIG.displayLimitKey);
                if (savedLimit) {
                    const selectEl = document.getElementById('displayLimitSelect');
                    if (selectEl) selectEl.value = savedLimit;
                }

                App.bindEvents();
                App.adjustTableHeight();
            },

            bindEvents: () => {
                // Token 保存
                document.getElementById('tokenInput').addEventListener('input', TokenManager.save);
                
                // 加载按钮
                document.getElementById('loadBtn').onclick = App.loadData;
                
                // 搜索
                document.getElementById('searchInput').addEventListener('input', (e) => App.renderTable(e.target.value));

                // 显示条数选择
                document.getElementById('displayLimitSelect').addEventListener('change', (e) => {
                    localStorage.setItem(CONFIG.displayLimitKey, e.target.value);
                    App.renderTable(document.getElementById('searchInput').value);
                });

                // 单条添加
                document.getElementById('confirmAddSingleBtn').onclick = App.addSingle;
                
                // 批量相关
                document.getElementById('openBatchModalBtn').onclick = () => {
                    const saved = localStorage.getItem('batchSourceDraft');
                    if (saved) document.getElementById('batchInput').value = saved;
                    new bootstrap.Modal(document.getElementById('batchModal')).show();
                };
                document.getElementById('batchInput').addEventListener('input', (e) => {
                    localStorage.setItem('batchSourceDraft', e.target.value);
                });
                document.getElementById('parseBatchBtn').onclick = App.parseBatch;
                document.getElementById('confirmBatchImportBtn').onclick = App.importBatch;
                document.getElementById('batchMagicBtn').onclick = App.batchAddMagic;
                // 新增：网络获取按钮绑定
                document.getElementById('fetchUrlBtn').onclick = App.fetchFromUrl;
                
                // 测试 Token
                document.getElementById('testTokenBtn').onclick = async () => {
                    try {
                        await GitHubAPI.fetchFile();
                        Utils.showToast('Token 验证成功', 'success');
                    } catch (e) {
                        Utils.showToast(`验证失败: ${e.message}`, 'error');
                    }
                };

                // 窗口大小变化时调整表格容器高度
                window.addEventListener('resize', () => {
                    App.adjustTableHeight();
                });
            },

            // 新增：调整表格容器高度
            adjustTableHeight: () => {
                const container = document.getElementById('tableContainer');
                if (!container) return;

                const viewportHeight = window.innerHeight;
                const headerHeight = 100; // 导航栏高度
                const searchHeight = 150; // 搜索和统计区域高度
                const cardHeaderHeight = 70; // 卡片头部高度
                const cardPadding = 32; // 卡片内边距
                const footerHeight = 60; // 底部预留空间

                // 计算容器高度
                const containerHeight = viewportHeight - headerHeight - searchHeight - cardHeaderHeight - cardPadding - footerHeight;

                // 设置最小和最大高度
                const finalHeight = Math.max(400, Math.min(containerHeight, 900));

                container.style.height = `${finalHeight}px`;
            },

            // 新增：从网络获取文件
            fetchFromUrl: async () => {
                let url = document.getElementById('batchUrlInput').value.trim();
                const useProxy = document.getElementById('corsProxySwitch').checked;
                const btn = document.getElementById('fetchUrlBtn');
                
                if (!url) return Utils.showToast('请输入有效的 URL', 'warning');

                const originalHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                try {
                    // 如果勾选代理，使用 allorigins.win 绕过 CORS
                    if (useProxy) {
                        url = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    }

                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    
                    const text = await res.text();
                    
                    if (!text.trim()) throw new Error('文件内容为空');

                    // 填充到输入框
                    const textarea = document.getElementById('batchInput');
                    textarea.value = text;
                    // 触发 input 事件以保存草稿
                    textarea.dispatchEvent(new Event('input'));
                    
                    Utils.showToast('获取成功，请点击"解析到预览区"', 'success');
                } catch (e) {
                    console.error(e);
                    Utils.showToast(`获取失败: ${e.message} (请检查链接或尝试切换代理开关)`, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            },

            loadData: async () => {
                const btn = document.getElementById('loadBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 加载中...';

                try {
                    const res = await GitHubAPI.fetchFile();
                    App.sha = res.sha;
                    // 解码 UTF-8
                    const decoded = decodeURIComponent(escape(atob(res.content)));
                    App.data = JSON.parse(decoded);
                    
                    App.renderTable();
                    document.getElementById('dataStatus').textContent = '已加载';
                    document.getElementById('dataStatus').className = 'status-badge bg-success text-white';
                    Utils.showToast('加载成功', 'success');
                } catch (e) {
                    Utils.showToast(e.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> 加载文件';
                }
            },

            renderTable: (filter = '') => {
                const tbody = document.getElementById('dictTableBody');
                tbody.innerHTML = '';
                const entries = Object.entries(App.data).filter(([k, v]) =>
                    k.includes(filter) || v.includes(filter)
                );

                // 更新计数器
                const totalCountEl = document.getElementById('totalCount');
                if (totalCountEl) totalCountEl.textContent = entries.length;

                const dictCountEl = document.getElementById('dictCount');
                if (dictCountEl) dictCountEl.textContent = entries.length;

                if (entries.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-muted">无匹配数据</td></tr>`;
                    return;
                }

                // 获取用户选择的显示条数限制
                const limit = parseInt(document.getElementById('displayLimitSelect').value);
                // 如果 limit 为 0，表示显示全部
                const displayEntries = limit === 0 ? entries : entries.slice(0, limit);

                displayEntries.forEach(([key, val]) => {
                    const row = document.createElement('tr');
                    const safeKey = Utils.escapeHtml(key);

                    // 生成唯一ID
                    const uniqueId = Math.random().toString(36).substr(2, 9);
                    const inputId = `val-${uniqueId}`;
                    const previewId = `prev-${uniqueId}`;

                    row.innerHTML = `
                        <td class="fw-bold text-dark align-top pt-3">${safeKey}</td>
                        <td>
                            <div class="d-flex flex-column">
                                <div class="input-group input-group-sm">
                                    <!-- 增加 oninput 事件，实时更新下方预览 -->
                                    <input type="text"
                                           class="form-control border-0 bg-transparent"
                                           id="${inputId}"
                                           value="${Utils.escapeHtml(val)}"
                                           onchange="App.updateItem('${safeKey}', this.value)"
                                           oninput="App.renderVisualPreview(this, '${previewId}')"
                                    >
                                    <button class="btn btn-link text-warning p-0 ms-2" title="插入防屏蔽符" onclick="App.insertMagicChar('${inputId}')">
                                        <i class="fas fa-magic"></i>
                                    </button>
                                </div>
                                <!-- 新增：可视化预览区域 -->
                                <div id="${previewId}" class="magic-preview"></div>
                            </div>
                        </td>
                        <td class="text-end align-top pt-3">
                            <button class="btn btn-sm btn-link text-danger p-0" onclick="App.deleteItem('${safeKey}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);

                    // 渲染完行后，立即触发一次预览计算，如果有屏蔽符直接显示出来
                    const inputEl = document.getElementById(inputId);
                    App.renderVisualPreview(inputEl, previewId);
                });
            },

            // 更新单条
            updateItem: (key, newVal) => {
                App.data[key] = newVal;
                App.triggerAutoSave();
            },

            // 删除单条
            deleteItem: (key) => {
                if (confirm(`确定要删除 "${key}" 吗？`)) {
                    delete App.data[key];
                    App.renderTable(document.getElementById('searchInput').value);
                    App.triggerAutoSave();
                }
            },

            // 添加单条
            addSingle: () => {
                const key = document.getElementById('singleKey').value.trim();
                const val = document.getElementById('singleVal').value.trim();

                if (!key || !val) return Utils.showToast('内容不能为空', 'warning');
                if (App.data[key]) return Utils.showToast('该词条已存在', 'error');

                App.data[key] = val;
                App.renderTable();

                // 清空输入框
                document.getElementById('singleKey').value = '';
                document.getElementById('singleVal').value = '';
                // 清空预览 (新增)
                document.getElementById('singleValPreview').innerHTML = '';
                document.getElementById('singleValPreview').style.display = 'none';

                bootstrap.Modal.getInstance(document.getElementById('addSingleModal')).hide();
                Utils.showToast('添加成功', 'success');
                App.triggerAutoSave();
            },

            // 插入 Magic Char
            insertMagicChar: (inputId) => {
                const input = document.getElementById(inputId);
                if (!input) return;

                const start = input.selectionStart;
                const end = input.selectionEnd;
                const text = input.value;

                input.value = text.substring(0, start) + CONFIG.magicChar + text.substring(end);
                input.selectionStart = input.selectionEnd = start + 1;
                input.focus();

                // 触发 change 以保存数据
                input.dispatchEvent(new Event('change'));
                // 触发 input 以更新可视化视图 (新增这一行)
                input.dispatchEvent(new Event('input'));
            },

            // 新增：渲染可视化预览（辅助函数）
            renderVisualPreview: (inputEl, previewId) => {
                const val = inputEl.value;
                const previewEl = document.getElementById(previewId);
                if (!previewEl) return;

                // 检查是否包含屏蔽符
                if (val.includes(CONFIG.magicChar)) {
                    // 将字符串按屏蔽符分割，然后用可视化标签连接
                    // 使用 font-awesome 的幽灵图标或者文字"符"来表示
                    const visualHtml = val.split(CONFIG.magicChar)
                        .map(part => Utils.escapeHtml(part))
                        .join('<span class="magic-tag" title="此处有不可见防屏蔽符 (U+200E)"><i class="fas fa-ghost"></i></span>');

                    previewEl.innerHTML = visualHtml;
                    previewEl.style.display = 'block';
                } else {
                    // 如果没有屏蔽符，隐藏预览或者是清空
                    previewEl.innerHTML = '';
                    previewEl.style.display = 'none';
                }
            },

            // 新增：为单条添加模态框实现可视化预览
            renderSinglePreview: () => {
                const inputEl = document.getElementById('singleVal');
                const previewEl = document.getElementById('singleValPreview'); // 新增的预览元素 ID
                if (!inputEl || !previewEl) return;

                // 调用通用的预览渲染逻辑
                App.renderVisualPreview(inputEl, 'singleValPreview');
            },

            // 批量解析
            parseBatch: () => {
                const text = document.getElementById('batchInput').value;
                const format = document.getElementById('batchFormat').value;
                App.batchDraft = [];
                
                if (!text.trim()) return;

                try {
                    // JSON 检测
                    if (format === 'json' || (format === 'auto' && text.trim().startsWith('{'))) {
                        const json = JSON.parse(text);
                        Object.entries(json).forEach(([k, v]) => App.batchDraft.push({ key: k, val: v }));
                    } else {
                        // Key-Value 解析优化：支持 空格、=、:、Tab
                        const lines = text.split('\n');
                        lines.forEach(line => {
                            line = line.trim();
                            if (!line) return;
                            
                            // 尝试匹配 "Key=Val", "Key:Val", "Key\tVal", "Key Val"
                            // 匹配逻辑：第一个非空字符序列作为Key，剩余部分（去除分隔符后）作为Val
                            // 修正：支持各种分隔符，优先匹配 =:
                            let match = line.match(/^([^=:\t]+)[=:\t]+(.*)$/); // 匹配 =, :, Tab
                            
                            if (!match) {
                                // 如果没有标点分隔符，尝试匹配第一个空格
                                match = line.match(/^(\S+)\s+(.*)$/);
                            }

                            if (match) {
                                App.batchDraft.push({ key: match[1].trim(), val: match[2].trim() });
                            }
                        });
                    }
                    App.renderBatchPreview();
                } catch (e) {
                    Utils.showToast('解析失败，请检查格式', 'error');
                }
            },

            // 渲染批量预览
            renderBatchPreview: () => {
                const container = document.getElementById('batchPreviewList');
                container.innerHTML = '';
                document.getElementById('batchCount').textContent = App.batchDraft.length;
                
                if (App.batchDraft.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-5">无有效数据</div>';
                    return;
                }

                App.batchDraft.forEach(item => {
                    const isExist = !!App.data[item.key];
                    const hasMagic = item.val.includes(CONFIG.magicChar);
                    
                    let className = 'new';
                    if (isExist) className = 'replace';
                    if (hasMagic) className += ' magic';

                    const div = document.createElement('div');
                    div.className = `batch-item ${className}`;
                    div.innerHTML = `
                        <div class="fw-bold me-2">${Utils.escapeHtml(item.key)}</div>
                        <div class="text-muted flex-grow-1 text-truncate">→ ${Utils.escapeHtml(item.val)}</div>
                        ${isExist ? '<span class="badge bg-danger">覆</span>' : '<span class="badge bg-success">新</span>'}
                        ${hasMagic ? '<span class="badge bg-warning text-dark ms-1">符</span>' : ''}
                    `;
                    container.appendChild(div);
                });
            },

            // 批量加符
            batchAddMagic: () => {
                App.batchDraft.forEach(item => {
                    if (!item.val.includes(CONFIG.magicChar)) {
                        // 全体加符逻辑：在每个字符之间插入屏蔽符
                        // 例: "AB" -> "A-B", "ABC" -> "A-B-C"
                        item.val = item.val.split('').join(CONFIG.magicChar);
                    }
                });
                App.renderBatchPreview();
                Utils.showToast('已为所有预览项添加间隔防屏蔽符', 'success');
            },

            // 确认批量导入
            importBatch: () => {
                const overwrite = document.getElementById('batchOverwrite').checked;
                let count = 0;
                
                App.batchDraft.forEach(item => {
                    if (!App.data[item.key] || overwrite) {
                        App.data[item.key] = item.val;
                        count++;
                    }
                });

                App.renderTable();
                bootstrap.Modal.getInstance(document.getElementById('batchModal')).hide();
                Utils.showToast(`成功导入 ${count} 条数据`, 'success');
                
                // 清理
                document.getElementById('batchInput').value = '';
                localStorage.removeItem('batchSourceDraft');
                App.batchDraft = [];
                App.triggerAutoSave();
            },

            // 自动保存
            triggerAutoSave: () => {
                if (!document.getElementById('autoSaveSwitch').checked || !App.sha) return;

                Utils.updateSaveStatus('saving', '正在同步...');
                clearTimeout(App.autoSaveTimer);

                App.autoSaveTimer = setTimeout(async () => {
                    try {
                        const res = await GitHubAPI.updateFile(App.data, App.sha);
                        App.sha = res.content.sha;
                        Utils.updateSaveStatus('success', '已同步到 GitHub');
                    } catch (e) {
                        Utils.updateSaveStatus('error', '同步失败');
                        Utils.showToast('自动保存失败: ' + e.message, 'error');
                    }
                }, 3000); // 3秒防抖
            }
        };

        // 初始化
        window.addEventListener('DOMContentLoaded', App.init);

    </script>
</body>
</html>
