<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†å›½æœå±è”½è¯ 25.12.6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0,0,0,0.3);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    :root {
      --primary-color: #3498db;
      --primary-hover: #2980b9;
      --success-color: #2ecc71;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --light-bg: #f8f9fa;
      --border-color: #dee2e6;
      --text-color: #333;
      --text-muted: #6c757d;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--text-color);
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20æé€Ÿèµ›è½¦å¼€å¥–ç»“æœæŸ¥è¯¢ rgba(0,0,0,0.1);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 25px 0;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      animation: fadeIn 0.5s ease;
    }

    th {
      background: var(--primary-color);
      color: white;
      padding: 16px;
      font-weight: 500;
      text-align: left;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s ease;
    }

    tr:hover td {
      background: var(--light-bg);
    }

    tr:last-child td {
      border-bottom: none;
    }

    input[type="text"], input[type="search"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s ease;
      height: 48px;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .delbtn { 
      background: var(--danger-color); 
      border: none;
      margin: 0; 
      padding: 8px 16px; 
      border-radius: 6px;
      color: white;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .delbtn:hover {
      background: #c0392b;
      transform: translateY(-1px);
    }
    .editbtn { 
      background: var(--warning-color); 
      border: none;
      margin: 0; 
      padding: 8px 16px; 
      border-radius: 6px;
      color: white;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .editbtn:hover {
      background: #e67e22;
      transform: translateY(-1px);
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #addForm { background: #f9f9f9; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 12px; display:none;}
    #addForm input { width: 90%; margin-bottom: 8px;}
    #addForm button { margin-bottom: 0;}
    @media (max-width: 600px) {
      th, td { font-size: 0.95em; padding: 4px 2px;}
      button, #token, #search { font-size: 1em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>å›½æœå±è”½è¯ç®¡ç†</h1>
      <p>å®‰å…¨åœ°ç®¡ç†å’Œç¼–è¾‘æ¸¸æˆå±è”½è¯åº“</p>
    </div>
    <div class="content">
      <div class="form-group">
        <label for="token">GitHub è®¿é—®å¯†é’¥</label>
        <input type="password" id="token" class="form-control" placeholder="è¾“å…¥ GitHub Personal Access Token" autocomplete="off">
        <div class="form-help">éœ€è¦ repo æƒé™æ¥è¯»å†™å­—å…¸æ–‡ä»¶</div>
      </div>
      <div class="btn-group">
        <button id="loadBtn" class="btn btn-primary modern-btn">
          <span class="btn-icon">ğŸ“¥</span>
          åŠ è½½çº¿ä¸Šæ–‡ä»¶
        </button>
        <button id="addRow" class="btn btn-success modern-btn">
          <span class="btn-icon">â•</span>
          å•æ¡æ·»åŠ 
        </button>
        <!-- æ–°å¢ï¼šæ‰¹é‡æ·»åŠ æŒ‰é’® -->
        <button id="batchAddBtn" class="btn modern-btn" style="background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white;">
          <span class="btn-icon">ğŸ“œ</span>
          æ‰¹é‡æ·»åŠ 
        </button>
      </div>
      <div class="form-group">
        <div class="search-box">
          <input type="search" id="search" class="form-control search-input" placeholder="ğŸ” æœç´¢å…³é”®è¯æˆ–æ›¿æ¢è¯...">
        </div>
      </div>
  <div id="addForm" class="add-form">
    <div class="form-group">
      <label for="newKey" class="modern-label">åŸè¯</label>
      <input id="newKey" type="text" class="form-control modern-input" placeholder="è¾“å…¥è¦å±è”½çš„è¯è¯­" autocomplete="off">
    </div>
    <div class="form-group">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <label for="newVal" class="modern-label">æ›¿æ¢è¯</label>
        <!-- æ–°å¢çš„æ’å…¥æŒ‰é’® -->
        <button type="button" id="insertCharBtn" class="editbtn" style="font-size: 12px; padding: 4px 10px; margin-bottom: 6px;">
           ğŸª„ æ’å…¥é˜²å±è”½ç¬¦ (U+200E)
        </button>
      </div>
      <input id="newVal" type="text" class="form-control modern-input" placeholder="è¾“å…¥æ›¿æ¢åçš„è¯è¯­" autocomplete="off">
    </div>
    <div class="form-actions">
      <button id="confirmAddBtn" class="btn btn-primary modern-btn">ç¡®è®¤æ·»åŠ </button>
      <button onclick="document.getElementById('addForm').style.display='none'" class="btn btn-secondary modern-btn">å–æ¶ˆ</button>
    </div>
    <div id="addMsg" class="status-message"></div>
  </div>
  
  <!-- æ‰¹é‡æ·»åŠ é¢æ¿ (æ–°ç‰ˆï¼šåˆ†æ å¼) -->
  <div id="batchForm" class="add-form" style="display:none; border-color: #9b59b6; background: #fbfaff;">
    <h3 style="margin-bottom: 10px; color: #8e44ad;">æ‰¹é‡å¯¼å…¥å·¥ä½œå°</h3>
    
    <!-- åŒºåŸŸ1ï¼šåŸå§‹è¾“å…¥ -->
    <div class="form-group">
      <label class="modern-label" style="color:#666">1. ç²˜è´´åŸå§‹æ–‡æœ¬ (æ ¼å¼ï¼šåŸè¯=æ›¿æ¢è¯)</label>
      <textarea id="batchSource" class="form-control modern-input" rows="4" 
        placeholder="åœ¨è¿™é‡Œç²˜è´´...&#10;æ¯”å¦‚ï¼š&#10;æµ‹è¯•=Test&#10;æ•æ„Ÿ=å±è”½" 
        style="height: 100px; font-family: monospace; border-style: dashed;"></textarea>
    </div>

    <!-- ä¸­é—´æ“ä½œæ  -->
    <div style="display:flex; justify-content:center; gap:10px; margin: 10px 0;">
      <button id="parseBtn" type="button" class="modern-btn" style="background:#8e44ad; color:white; padding: 8px 15px; font-size: 13px;">
        â¬‡ï¸ è§£æåˆ°ç­‰å¾…åŒº
      </button>
    </div>

    <!-- åŒºåŸŸ2ï¼šç­‰å¾…åŒº -->
    <div class="form-group">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <label class="modern-label" style="color:#666">2. ç­‰å¾…å¯¼å…¥åˆ—è¡¨ (<span id="previewCount">0</span>)</label>
        
        <!-- ä½ çš„æ ¸å¿ƒéœ€æ±‚ï¼šä¸€é”®åŠ ç¬¦æŒ‰é’® -->
        <button id="batchMagicBtn" type="button" class="editbtn" style="font-size: 12px; padding: 4px 10px; margin-bottom: 6px; background: #f39c12;">
           ğŸª„ ç»™æ›¿æ¢è¯æ’å…¥é˜²å±è”½ç¬¦
        </button>
      </div>
      
      <!-- é¢„è§ˆåˆ—è¡¨å®¹å™¨ -->
      <div id="batchPreview" style="
          height: 200px; 
          overflow-y: auto; 
          background: #fff; 
          border: 2px solid #e1e5e9; 
          border-radius: 8px;
          padding: 8px;
      ">
        <div style="text-align:center; color:#ccc; padding-top:80px;">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹ç²˜è´´å¹¶è§£æ</div>
      </div>
      
      <!-- è‰ç¨¿çŠ¶æ€æç¤º -->
      <div id="draftIndicator" style="display:none; margin-top:5px; padding:5px 8px; background:#f0f7ff; border-radius:4px; font-size:12px; color:#3498db; align-items:center; justify-content:space-between;">
        <span>ğŸ“ è‰ç¨¿å·²ä¿å­˜</span>
        <button id="clearDraftBtn" style="background:transparent; border:none; color:#e74c3c; cursor:pointer; font-size:12px;">æ¸…ç©º</button>
      </div>
    </div>
    
    <div class="form-actions" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
      <button id="confirmBatchBtn" class="btn modern-btn" style="background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; width: 100%;">
        ğŸš€ ç¡®è®¤å…¨éƒ¨å¯¼å…¥
      </button>
      <button onclick="document.getElementById('batchForm').style.display='none'" class="btn btn-secondary modern-btn" style="margin-top:8px; width: 100%;">
        å–æ¶ˆ
      </button>
    </div>
  </div>
  <table id="dictTable"></table>
  <button id="saveBtn" class="save-button">
    ğŸ’¾ ä¿å­˜æ›´æ”¹
  </button>
  <!-- å³ä¸Šè§’è‡ªåŠ¨æ¶ˆå¤±é€šçŸ¥ -->
  <div id="notificationToast" style="display:none; position:fixed; top:20px; right:20px; max-width:300px; background:#fff; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:1000; overflow:hidden;">
    <div style="padding:12px 16px;">
      <div style="display:flex; align-items:center; margin-bottom:6px;">
        <div id="toastIcon" style="width:20px; height:20px; margin-right:8px; border-radius:50%;"></div>
        <h3 id="toastTitle" style="margin:0; font-size:14px; font-weight:600;"></h3>
      </div>
      <p id="toastContent" style="margin:0; font-size:13px; color:#666;"></p>
    </div>
    <div id="toastProgress" style="height:3px; background:#3498db; width:100%;"></div>
  </style>

  <style>
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes progress {
      from { width: 100%; }
      to { width: 0%; }
    }
    
    /* ç°ä»£åŒ–æ ·å¼ */
    .modern-input {
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        background: #fff;
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .modern-input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        transform: translateY(-1px);
    }
    
    .modern-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #2c3e50;
        font-size: 14px;
    }
    
    .modern-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        position: relative;
        overflow: hidden;
    }
    
    .modern-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .modern-btn:hover::before {
        left: 100%;
    }
    
    .modern-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .modern-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    
    .btn-primary.modern-btn {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
    }
    
    .btn-success.modern-btn {
        background: linear-gradient(135deg, #27ae60, #229954);
        color: white;
    }
    
    .btn-secondary.modern-btn {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        color: white;
    }
    
    .btn-danger.modern-btn {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
    }
    
    /* å›ºå®šä¿å­˜æŒ‰é’®æ ·å¼ */
    .save-button {
        position: fixed;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        padding: 16px 24px;
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0.3;
        transition: all 0.3s ease;
        z-index: 1000;
    }
    
    .save-button:hover {
        opacity: 1;
        transform: translateY(-50%) scale(1.05);
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }
    
    /* æ‰¹é‡æ·»åŠ ç­‰å¾…åŒºæ ·å¼ */
    .batch-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 5px;
        background: #f8f9fa;
        border-radius: 6px;
        transition: background 0.2s ease;
        border-left: 3px solid #3498db;
    }
    
    .batch-item:hover {
        background: #e9ecef;
    }
    
    .batch-item.has-magic {
        border-left-color: #f39c12;
        background: #fef8e7;
    }
    
    .batch-item.has-magic:hover {
        background: #fdeaa7;
    }
    
    .batch-item-index {
        flex: 0 0 25px;
        color: #666;
        font-size: 12px;
        text-align: center;
        font-weight: 600;
    }
    
    .batch-item-key {
        flex: 0 0 35%;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 8px;
    }
    
    .batch-item-value {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #555;
    }
    
    .batch-item-magic-indicator {
        flex: 0 0 15px;
        height: 15px;
        border-radius: 50%;
        background: #f39c12;
        display: none;
        margin-left: 8px;
        font-size: 8px;
        color: white;
        text-align: center;
        line-height: 15px;
    }
    
    .batch-item.has-magic .batch-item-magic-indicator {
        display: block;
    }
  </style>
  <script>

// è‡ªåŠ¨è®°ä½å’Œå¡«å…… Token
window.addEventListener('DOMContentLoaded', () => {
  const tokenInput = document.getElementById('token');
  if (tokenInput) {
    // åŠ å¯†å­˜å‚¨Token
    const encryptToken = (token) => {
      try {
        return btoa(encodeURIComponent(token + '|' + Date.now()));
      } catch {
        return null;
      }
    };
    
    const decryptToken = (encrypted) => {
      try {
        const decoded = atob(encrypted);
        const [token, timestamp] = decodeURIComponent(decoded).split('|');
        if(Date.now() - Number(timestamp) > 86400000) return null; // 24å°æ—¶æœ‰æ•ˆæœŸ
        return token;
      } catch { 
        return null; 
      }
    };

    const savedToken = decryptToken(localStorage.getItem('github-Token'));
    if (savedToken) {
      tokenInput.value = savedToken;
      // éªŒè¯tokenæœ‰æ•ˆæ€§
      validateToken(savedToken).then(isValid => {
        if (isValid) {
          // Tokenæœ‰æ•ˆåˆ™è‡ªåŠ¨åŠ è½½
          setTimeout(() => document.getElementById('loadBtn').click(), 500);
        } else {
          // Tokenæ— æ•ˆåˆ™æ¸…é™¤
          localStorage.removeItem('github-Token');
          tokenInput.value = '';
          showToast('TokenéªŒè¯', 'ä¿å­˜çš„Tokenå·²å¤±æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥', 'red');
        }
      });
    }
    tokenInput.addEventListener('input', () => {
      const token = tokenInput.value.trim();
      if (token) {
        validateToken(token).then(isValid => {
          if (isValid) {
            const encrypted = encryptToken(token);
            if (encrypted) {
              localStorage.setItem('github-Token', encrypted);
              showToast('TokenéªŒè¯', 'Tokenå·²ä¿å­˜', 'green');
            }
          } else {
            showToast('TokenéªŒè¯', 'Tokenæ ¼å¼å¯èƒ½ä¸æ­£ç¡®', 'orange');
          }
        });
      } else {
        // æ¸…ç©ºè¾“å…¥æ—¶ç§»é™¤ä¿å­˜çš„token
        localStorage.removeItem('github-Token');
      }
    });

    // TokenéªŒè¯å‡½æ•° - åŸºæœ¬æ ¼å¼æ£€æŸ¥
    async function validateToken(token) {
      // GitHub tokené€šå¸¸æ˜¯40å­—ç¬¦ä»¥ä¸Šï¼Œæ”¾å®½éªŒè¯æ¡ä»¶
      return token && token.length >= 40;
    }

    // æ·»åŠ è‡ªåŠ¨ä¿å­˜å¼€å…³
    const autoSaveToggle = document.createElement('label');
    autoSaveToggle.innerHTML = `
      <input type="checkbox" id="autoSaveToggle" checked> å¯ç”¨è‡ªåŠ¨ä¿å­˜
      <span id="lastSaveTime" style="margin-left:10px;color:#666;font-size:0.9em;"></span>
    `;
    autoSaveToggle.style.display = 'block';
    autoSaveToggle.style.margin = '10px 0';
    tokenInput.parentNode.insertBefore(autoSaveToggle, tokenInput.nextSibling);

    document.getElementById('autoSaveToggle').addEventListener('change', (e) => {
      isAutoSaveEnabled = e.target.checked;
      showToast('è®¾ç½®', `è‡ªåŠ¨ä¿å­˜å·²${isAutoSaveEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, isAutoSaveEnabled ? 'green' : 'orange');
    });

    const owner = "Kosto179cn";
    const repo = "Kosto179cn.github.io";
    const path = "chinese_words_replacer/dictionary.json";
    let dict = {};
    let sha = null;
    let filter = "";
    let autoSaveTimer = null;
    let isAutoSaveEnabled = true;
    let lastSaveTime = null;

    function showToast(title, content, color="#3498db") {
      const toast = document.getElementById('notificationToast');
      const icon = document.getElementById('toastIcon');
      const progress = document.getElementById('toastProgress');
      
      // è®¾ç½®å†…å®¹å’Œæ ·å¼
      document.getElementById('toastTitle').textContent = title;
      document.getElementById('toastContent').textContent = content;
      icon.style.background = color;
      
      // æ˜¾ç¤ºé€šçŸ¥
      toast.style.display = 'block';
      toast.style.animation = 'slideInRight 0.3s forwards';
      
      // è¿›åº¦æ¡åŠ¨ç”»
      progress.style.animation = 'progress 2s linear forwards';
      
      // 2ç§’åè‡ªåŠ¨å…³é—­
      setTimeout(() => {
        toast.style.animation = 'slideInRight 0.3s reverse forwards';
        setTimeout(() => toast.style.display = 'none', 300);
      }, 2000);
    }

    function showMsg(text, color="blue") {
      showToast('æç¤º', text, color);
    }

    function showAddMsg(text, color="red") {
      showToast('æç¤º', text, color);
    }

    function renderTable() {
      const table = document.getElementById('dictTable');
      table.innerHTML = "<tr><th>åŸè¯</th><th>æ›¿æ¢è¯</th><th>æ“ä½œ</th></tr>";
      const entries = Object.entries(dict)
        .filter(([key, val]) => key.includes(filter) || val.includes(filter));
      if(entries.length===0){
        table.innerHTML += "<tr><td colspan=3 style='text-align:center;color:#aaa'>æ— ç»“æœ</td></tr>";
        return;
      }
      entries.forEach(([key, value], i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${key}</td>
                         <td><input type="text" value="${value}" onchange="updateValue('${key}', this.value)"></td>
                         <td class="action-buttons">
                            <button class="editbtn" onclick="editKey('${key}')">âœï¸ ç¼–è¾‘</button>
                            <button class="delbtn" onclick="deleteRow('${key}')">ğŸ—‘ï¸ åˆ é™¤</button>
                         </td>`;
        table.appendChild(row);
      });
    }

    // æœç´¢åŠŸèƒ½
    document.getElementById('search').oninput = function(){
      filter = this.value.trim();
      renderTable();
    };

    // åŠ è½½æ–‡ä»¶
    document.getElementById('loadBtn').onclick = async () => {
      showMsg("æ­£åœ¨åŠ è½½...", "grey", 0);
      document.getElementById('loadBtn').disabled = true;
      document.getElementById('loadBtn').innerHTML = 
        '<span class="loading-spinner"></span>åŠ è½½ä¸­...';
      const token = document.getElementById('token').value;
      if (!token) { showMsg("è¯·å…ˆè¾“å…¥ Token", "red"); return; }
      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          headers: { Authorization: 'token ' + token }
        });
        if (!res.ok) throw new Error("åŠ è½½å¤±è´¥");
        const data = await res.json();
        sha = data.sha;
        dict = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        renderTable();
        showMsg("æ–‡ä»¶å·²åŠ è½½ï¼Œå¯ç¼–è¾‘", "green");
        document.getElementById('loadBtn').disabled = false;
        document.getElementById('loadBtn').textContent = 'åŠ è½½çº¿ä¸Šæ–‡ä»¶';
      } catch(e) {
        showMsg(`åŠ è½½å¤±è´¥: ${e.message}`, "red");
        document.getElementById('loadBtn').disabled = false;
        document.getElementById('loadBtn').textContent = 'åŠ è½½çº¿ä¸Šæ–‡ä»¶';
      }
    };

    // æ·»åŠ è¯æ¡å¼¹çª—
    document.getElementById('addRow').onclick = () => {
      document.getElementById('addForm').style.display = 'block';
      document.getElementById('batchForm').style.display = 'none'; // å…³é—­æ‰¹é‡é¢æ¿
      document.getElementById('addMsg').textContent = '';
      document.getElementById('newKey').value = '';
      document.getElementById('newVal').value = '';
      document.getElementById('newKey').focus();
    };

    // æ‰“å¼€æ‰¹é‡æ·»åŠ é¢æ¿
    document.getElementById('batchAddBtn').onclick = () => {
      document.getElementById('addForm').style.display = 'none'; // å…³é—­å•æ¡
      document.getElementById('batchForm').style.display = 'block';
      
      // ä»æœ¬åœ°å­˜å‚¨æ¢å¤è‰ç¨¿å†…å®¹
      const savedDraft = localStorage.getItem('batchSourceDraft');
      if (savedDraft && !document.getElementById('batchSource').value) {
        document.getElementById('batchSource').value = savedDraft;
        showToast('è‰ç¨¿æ¢å¤', 'å·²æ¢å¤ä¸Šæ¬¡æœªå®Œæˆçš„è¾“å…¥å†…å®¹', 'blue');
      }
      
      document.getElementById('batchSource').focus();
    };

    // ä¸´æ—¶å­˜å‚¨å¾…å¤„ç†è¯æ¡çš„æ•°ç»„
    let batchItems = [];
    
    // ç›‘å¬æ‰¹é‡è¾“å…¥æ¡†å†…å®¹å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜è‰ç¨¿
    document.getElementById('batchSource').addEventListener('input', () => {
      const content = document.getElementById('batchSource').value;
      const draftIndicator = document.getElementById('draftIndicator');
      
      if (content.trim()) {
        localStorage.setItem('batchSourceDraft', content);
        // æ˜¾ç¤ºè‰ç¨¿ä¿å­˜æç¤º
        draftIndicator.style.display = 'flex';
      } else {
        localStorage.removeItem('batchSourceDraft');
        // éšè—è‰ç¨¿ä¿å­˜æç¤º
        draftIndicator.style.display = 'none';
      }
    });
    
    // æ¸…ç©ºè‰ç¨¿æŒ‰é’®
    document.getElementById('clearDraftBtn').onclick = () => {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºè‰ç¨¿å†…å®¹å—ï¼Ÿ')) {
        document.getElementById('batchSource').value = '';
        localStorage.removeItem('batchSourceDraft');
        document.getElementById('draftIndicator').style.display = 'none';
        showToast('è‰ç¨¿å·²æ¸…ç©º', 'è‰ç¨¿å†…å®¹å·²è¢«åˆ é™¤', 'blue');
      }
    };
    
    // è§£ææŒ‰é’®ï¼šå°†åŸå§‹æ–‡æœ¬è§£æåˆ°å¾…å¤„ç†åˆ—è¡¨
    document.getElementById('parseBtn').onclick = () => {
      const rawText = document.getElementById('batchSource').value;
      if (!rawText.trim()) {
        showMsg("è¯·å…ˆè¾“å…¥å†…å®¹", "orange");
        return;
      }

      const lines = rawText.split(/\n/);
      batchItems = [];

      lines.forEach((line, index) => {
        line = line.trim();
        if (!line) return; // è·³è¿‡ç©ºè¡Œ

        // æ”¯æŒç”¨ ç­‰å·(=)ã€ä¸­æ–‡å†’å·(ï¼š)ã€è‹±æ–‡å†’å·(:) æˆ– åˆ¶è¡¨ç¬¦ åˆ†éš”
        let separatorIndex = -1;
        // ä¼˜å…ˆæ‰¾ç­‰å·
        if (line.includes('=')) separatorIndex = line.indexOf('=');
        // å…¶æ¬¡æ‰¾åˆ¶è¡¨ç¬¦
        else if (line.includes('\t')) separatorIndex = line.indexOf('\t');
        // å†æ¬¡æ‰¾å†’å·
        else if (line.includes(':')) separatorIndex = line.indexOf(':');
        
        if (separatorIndex === -1) {
          // å°è¯•ç”¨ç©ºæ ¼åˆ†éš”ï¼ˆåªå–ç¬¬ä¸€ä¸ªç©ºæ ¼ä½œä¸ºåˆ†éš”ç¬¦ï¼‰
          separatorIndex = line.indexOf(' ');
        }

        if (separatorIndex > -1) {
          const key = line.substring(0, separatorIndex).trim();
          const val = line.substring(separatorIndex + 1).trim();

          if (key && val) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æˆ–å·²åœ¨å¾…å¤„ç†åˆ—è¡¨ä¸­
            if (dict[key]) {
              // å·²å­˜åœ¨äºå­—å…¸ä¸­ï¼Œè·³è¿‡
              return;
            }
            
            // æ·»åŠ åˆ°å¾…å¤„ç†åˆ—è¡¨
            batchItems.push({
              key: key,
              value: val,
              hasMagic: false // æ ‡è®°æ˜¯å¦å·²æ·»åŠ é˜²å±è”½ç¬¦
            });
          }
        }
      });

      // æ¸²æŸ“é¢„è§ˆåˆ—è¡¨
      renderBatchPreview();
      showMsg(`å·²è§£æå‡º ${batchItems.length} æ¡å¾…å¤„ç†è¯æ¡`, "green");
    };

    // æ¸²æŸ“æ‰¹é‡é¢„è§ˆåˆ—è¡¨
    function renderBatchPreview() {
      const preview = document.getElementById('batchPreview');
      const count = document.getElementById('previewCount');
      count.textContent = batchItems.length;

      if (batchItems.length === 0) {
        preview.innerHTML = '<div style="text-align:center; color:#ccc; padding-top:80px;">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹ç²˜è´´å¹¶è§£æ</div>';
        return;
      }

      let html = '';
      batchItems.forEach((item, index) => {
        html += `
          <div class="batch-item ${item.hasMagic ? 'has-magic' : ''}" data-index="${index}">
            <div class="batch-item-index">${index + 1}</div>
            <div class="batch-item-key">${item.key}</div>
            <div class="batch-item-value">${item.value}</div>
            <div class="batch-item-magic-indicator">âœ“</div>
          </div>
        `;
      });

      preview.innerHTML = html;
    }

    // ä¸€é”®åŠ ç¬¦æŒ‰é’®ï¼šç»™æ‰€æœ‰æ›¿æ¢è¯æ’å…¥é˜²å±è”½ç¬¦
    document.getElementById('batchMagicBtn').onclick = () => {
      if (batchItems.length === 0) {
        showMsg("è¯·å…ˆè§£æå†…å®¹", "orange");
        return;
      }

      let changedCount = 0;
      batchItems.forEach(item => {
        if (!item.hasMagic && item.value.length > 1) {
          // å¦‚æœè¯æ¡é•¿åº¦å¤§äº3ä¸ªå­—ç¬¦ï¼Œåœ¨æ¯ä¸ªå­—ç¬¦åæ’å…¥é˜²å±è”½ç¬¦
          if (item.value.length > 3) {
            // å°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºå­—ç¬¦æ•°ç»„ï¼Œæ¯ä¸ªå­—ç¬¦åæ·»åŠ é˜²å±è”½ç¬¦
            let newValue = '';
            for (let i = 0; i < item.value.length; i++) {
              newValue += item.value[i] + '\u200E';
            }
            item.value = newValue;
          } else {
            // å¯¹äº3ä¸ªå­—ç¬¦åŠä»¥ä¸‹çš„è¯æ¡ï¼Œåœ¨å­—ç¬¦ä¸²ä¸­é—´æ’å…¥é˜²å±è”½ç¬¦
            const mid = Math.floor(item.value.length / 2);
            item.value = item.value.slice(0, mid) + '\u200E' + item.value.slice(mid);
          }
          item.hasMagic = true;
          changedCount++;
        }
      });

      // é‡æ–°æ¸²æŸ“é¢„è§ˆ
      renderBatchPreview();
      showToast('é˜²å±è”½ç¬¦æ·»åŠ ', `å·²ä¸º ${changedCount} ä¸ªè¯æ¡æ·»åŠ é˜²å±è”½ç¬¦`, '#f39c12');
    };

    // ç¡®è®¤æ‰¹é‡å¯¼å…¥æŒ‰é’®ï¼šå°†å¾…å¤„ç†åˆ—è¡¨ä¸­çš„è¯æ¡æ·»åŠ åˆ°å­—å…¸
    document.getElementById('confirmBatchBtn').onclick = () => {
      if (batchItems.length === 0) {
        showMsg("æ²¡æœ‰å¯å¯¼å…¥çš„è¯æ¡", "orange");
        return;
      }

      let successCount = 0;
      let skipCount = 0;

      batchItems.forEach(item => {
        // å†æ¬¡æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆåŒé‡ä¿é™©ï¼‰
        if (dict[item.key]) {
          skipCount++;
          return;
        }
        
        // æ·»åŠ åˆ°å­—å…¸
        dict[item.key] = item.value;
        successCount++;
      });

      // æ›´æ–°ç•Œé¢
      document.getElementById('batchForm').style.display = 'none';
      document.getElementById('batchSource').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
      localStorage.removeItem('batchSourceDraft'); // æ¸…é™¤è‰ç¨¿
      batchItems = []; // æ¸…ç©ºå¾…å¤„ç†åˆ—è¡¨
      renderBatchPreview(); // æ¸…ç©ºç­‰å¾…åŒºæ˜¾ç¤º
      renderTable();
      
      // æ˜¾ç¤ºç»“æœé€šçŸ¥
      let msg = `æˆåŠŸå¯¼å…¥ ${successCount} æ¡`;
      if (skipCount > 0) msg += `ï¼Œè·³è¿‡é‡å¤ ${skipCount} æ¡`;
      
      showToast('æ‰¹é‡å¯¼å…¥å®Œæˆ', msg, successCount > 0 ? 'green' : 'orange');

      // åªæœ‰çœŸæ­£æ·»åŠ äº†è¯æ‰è§¦å‘ä¿å­˜
      if (successCount > 0) {
        triggerAutoSave();
      }
    };

    // æ–°å¢ï¼šæ’å…¥éšå½¢å­—ç¬¦ U+200E çš„åŠŸèƒ½
    document.getElementById('insertCharBtn').onclick = (e) => {
      e.preventDefault(); // é˜²æ­¢è§¦å‘è¡¨å•é»˜è®¤è¡Œä¸º
      const input = document.getElementById('newVal');
      const currentText = input.value;
      
      // æ£€æŸ¥å½“å‰æ–‡æœ¬é•¿åº¦
      if (currentText.length > 3) {
        // å¯¹äºé•¿åº¦å¤§äº3çš„æ–‡æœ¬ï¼Œåœ¨æ¯ä¸ªå­—ç¬¦åæ’å…¥é˜²å±è”½ç¬¦
        let newText = '';
        for (let i = 0; i < currentText.length; i++) {
          newText += currentText[i] + '\u200E';
        }
        input.value = newText;
        showToast('å°å·¥å…·', 'å·²ä¸ºæ‰€æœ‰å­—ç¬¦åæ’å…¥é˜²å±è”½ç¬¦ U+200E', '#f39c12');
      } else {
        // å¯¹äºé•¿åº¦3åŠä»¥ä¸‹çš„æ–‡æœ¬ï¼Œåœ¨ä¸­é—´æ’å…¥ä¸€ä¸ªé˜²å±è”½ç¬¦
        const invisibleChar = '\u200E'; // U+200E å­—ç¬¦
        
        // è·å–å½“å‰å…‰æ ‡ä½ç½®ï¼Œä»¥ä¾¿åœ¨å…‰æ ‡å¤„æ’å…¥è€Œä¸æ˜¯æœ«å°¾
        const startPos = input.selectionStart;
        const endPos = input.selectionEnd;
        
        // æ’å…¥å­—ç¬¦
        input.value = input.value.substring(0, startPos)
          + invisibleChar
          + input.value.substring(endPos, input.value.length);
        
        // é‡æ–°å®šä½å…‰æ ‡åˆ°æ’å…¥å­—ç¬¦ä¹‹å
        input.selectionStart = startPos + invisibleChar.length;
        input.selectionEnd = startPos + invisibleChar.length;
        
        // è®©è¾“å…¥æ¡†é‡æ–°è·å¾—ç„¦ç‚¹
        input.focus();
        
        // æç¤ºç”¨æˆ·
        showToast('å°å·¥å…·', 'å·²åœ¨å…‰æ ‡å¤„æ’å…¥éšå½¢å­—ç¬¦ U+200E', '#f39c12');
      }
    };

    // ç¡®è®¤æ·»åŠ è¯æ¡
    document.getElementById('confirmAddBtn').onclick = () => {
      let key = document.getElementById('newKey').value.trim();
      let val = document.getElementById('newVal').value.trim();
      
      // æ•°æ®éªŒè¯
      if(!key) { 
        showAddMsg("è¯ä¸èƒ½ä¸ºç©º"); 
        document.getElementById('newKey').focus();
        return;
      }
      if(key.length > 50) {
        showAddMsg("è¯é•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦");
        document.getElementById('newKey').focus();
        return;
      }
      if(!val) {
        showAddMsg("æ›¿æ¢è¯ä¸èƒ½ä¸ºç©º");
        document.getElementById('newVal').focus();
        return;
      }
      if(val.length > 200) {
        showAddMsg("æ›¿æ¢è¯é•¿åº¦ä¸èƒ½è¶…è¿‡200ä¸ªå­—ç¬¦");
        document.getElementById('newVal').focus();
        return;
      }
      if(dict[key]) { 
        showAddMsg("è¯¥è¯å·²å­˜åœ¨"); 
        document.getElementById('newKey').focus();
        return;
      }
      
      dict[key] = val;
      document.getElementById('addForm').style.display = 'none';
      renderTable();
      showMsg(`å·²æ·»åŠ è¯æ¡: ${key}`, "green");
      triggerAutoSave();
    };

    // è‡ªå®šä¹‰å¼¹çª—å‡½æ•°
    function showCustomPrompt(message, defaultValue, callback) {
      const modal = document.createElement('div');
      modal.style = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
        align-items: center; z-index: 10000;
      `;
      
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; width: 300px;">
          <div style="margin-bottom: 10px;">${message}</div>
          <input type="text" id="promptInput" value="${defaultValue || ''}" 
                 style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;">
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="promptCancelBtn" class="modern-btn btn-secondary">å–æ¶ˆ</button>
            <button id="promptConfirmBtn" class="modern-btn btn-primary">ç¡®å®š</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      document.getElementById('promptInput').focus();
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      document.getElementById('promptCancelBtn').onclick = function() {
        modal.remove();
      };
      
      document.getElementById('promptConfirmBtn').onclick = function() {
        const value = document.getElementById('promptInput').value;
        modal.remove();
        callback(value);
      };
    }

    function showCustomConfirm(message, callback) {
      const modal = document.createElement('div');
      modal.style = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
        align-items: center; z-index: 10000;
      `;
      
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; width: 300px;">
          <div style="margin-bottom: 15px;">${message}</div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="cancelBtn" class="modern-btn btn-secondary">å–æ¶ˆ</button>
            <button id="confirmBtn" class="modern-btn btn-danger">ç¡®å®š</button>
          </div>
        </div>
      `;
      modal.id = 'confirmModal';
      
      document.body.appendChild(modal);
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      document.getElementById('cancelBtn').onclick = function() {
        modal.remove();
        callback(false);
      };
      
      document.getElementById('confirmBtn').onclick = function() {
        modal.remove();
        callback(true);
      };
    }

    // ç¼–è¾‘è¯
    window.editKey = (oldKey) => {
      showCustomPrompt("è¯·è¾“å…¥æ–°è¯å", oldKey, (newKey) => {
        if(newKey === null || newKey.trim() === oldKey) return;
        newKey = newKey.trim();
        if(!newKey) { 
          showMsg("è¯ä¸èƒ½ä¸ºç©º", "red");
          return;
        }
        if(dict[newKey]) { 
          showMsg("è¯¥è¯å·²å­˜åœ¨", "red");
          return;
        }
        dict[newKey] = dict[oldKey];
        delete dict[oldKey];
        renderTable();
        triggerAutoSave();
      });
    };

    // ç¼–è¾‘æ›¿æ¢è¯
    window.updateValue = (key, newValue) => {
      dict[key] = newValue;
      triggerAutoSave();
    };

    function triggerAutoSave() {
      console.log('triggerAutoSave called', { isAutoSaveEnabled, sha });
      if (!isAutoSaveEnabled || !sha) {
        console.log('Auto save skipped - isAutoSaveEnabled:', isAutoSaveEnabled, 'sha:', sha);
        return;
      }
      
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        console.log('Auto saving to GitHub...');
        saveToGithub();
      }, 3000); // å»¶é•¿åˆ°3ç§’ï¼Œé¿å…é¢‘ç¹ä¿å­˜
      
      updateLastSaveTime('ç­‰å¾…ä¿å­˜...');
    }

    function updateLastSaveTime(text) {
      const el = document.getElementById('lastSaveTime');
      if (el) el.textContent = text;
    }

    async function saveToGithub() {
      const token = document.getElementById('token').value;
      if (!token || !sha) {
        console.log('saveToGithub skipped - token:', !!token, 'sha:', sha);
        return;
      }
      
      try {
        console.log('Starting auto save to GitHub...');
        updateLastSaveTime('ä¿å­˜ä¸­...');
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            Authorization: 'token ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: "Auto update dictionary.json",
            content: btoa(unescape(encodeURIComponent(JSON.stringify(dict, null, 2)))),
            sha: sha,
            branch: "main"
          })
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('GitHub API error:', res.status, errorText);
          throw new Error(`è‡ªåŠ¨ä¿å­˜å¤±è´¥: ${res.status}`);
        }
        
        const data = await res.json();
        sha = data.content.sha;
        lastSaveTime = new Date();
        updateLastSaveTime(`æœ€åä¿å­˜: ${lastSaveTime.toLocaleTimeString()}`);
        console.log('Auto save successful, new sha:', sha);
        showToast('è‡ªåŠ¨ä¿å­˜', 'å­—å…¸å·²è‡ªåŠ¨ä¿å­˜', 'green');
      } catch(e) {
        console.error('Auto save error:', e);
        showToast('è‡ªåŠ¨ä¿å­˜å¤±è´¥', e.message, 'red');
        updateLastSaveTime('ä¿å­˜å¤±è´¥');
      }
    }

    // åˆ é™¤è¯æ¡
    window.deleteRow = (key) => {
      showCustomConfirm(`ç¡®å®šè¦åˆ é™¤ "${key}" è¿™ä¸ªè¯æ¡å—ï¼Ÿ`, (confirmed) => {
        if(confirmed){
          delete dict[key];
          renderTable();
          triggerAutoSave();
        }
      });
    };

    // ä¿å­˜ä¸Šä¼ 
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.addEventListener('mouseenter', () => saveBtn.style.opacity = '1');
    saveBtn.addEventListener('mouseleave', () => saveBtn.style.opacity = '0.5');
    
    saveBtn.onclick = async () => {
      const token = document.getElementById('token').value;
      if (!token) { showMsg("è¯·å…ˆè¾“å…¥ Token", "red"); return; }
      if (!sha) { showMsg("è¯·å…ˆåŠ è½½æ–‡ä»¶", "red"); return; }
      showMsg("æ­£åœ¨ä¸Šä¼ ...", "grey");
      await saveToGithub();
      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            Authorization: 'token ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: "Update dictionary.json by web UI",
            content: btoa(unescape(encodeURIComponent(JSON.stringify(dict, null, 2)))),
            sha: sha,
            branch: "main"
          })
        });
        if (!res.ok) throw new Error("ä¸Šä¼ å¤±è´¥");
        const data = await res.json();
        sha = data.content.sha; // æ›´æ–°æ–°sha
        showToast('ä¸Šä¼ æˆåŠŸ', 'å­—å…¸æ–‡ä»¶å·²æˆåŠŸæ›´æ–°åˆ°GitHubä»“åº“', 'green');
      } catch(e) {
        showMsg("ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥Tokenå’Œç½‘ç»œ", "red");
      }
    };
  }
});
</script>
  </script>
</body>
</html>