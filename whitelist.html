<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kosto 管理系统 Pro</title>
<link rel="icon" href="icon/KostoIcon.jpg" type="image/x-icon">
<!-- 引入 Bootstrap 5.3 和 FontAwesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


<style>
    :root {
        --primary-color: #4361ee;
        --secondary-color: #3f37c9;
        --success-color: #4cc9f0;
        --danger-color: #f72585;
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --text-main: #2b2d42;
        --text-muted: #8d99ae;
        --border-radius: 12px;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-main);
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        padding-bottom: 60px;
    }

    /* 顶部导航栏 */
    .navbar-custom {
        background-color: var(--card-bg);
        box-shadow: var(--shadow-sm);
        padding: 15px 0;
        position: sticky;
        top: 0;
        z-index: 1000;
        transition: all 0.3s;
    }

    .brand-title {
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* 统计卡片 */
    .stat-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s;
        height: 100%;
        border-left: 4px solid var(--primary-color);
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }

    .stat-label {
        color: var(--text-muted);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-main);
        margin: 5px 0;
    }

    /* 导航标签 */
    .nav-pills-custom {
        gap: 8px;
        padding: 10px 0;
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
    }
    
    .nav-pills-custom::-webkit-scrollbar {
        display: none; /* Chrome/Safari */
    }

    .nav-pills-custom .nav-link {
        color: var(--text-muted);
        background: transparent;
        border-radius: 30px;
        padding: 8px 20px;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .nav-pills-custom .nav-link:hover {
        color: var(--primary-color);
        background: rgba(67, 97, 238, 0.05);
    }

    .nav-pills-custom .nav-link.active {
        background-color: var(--primary-color);
        color: white;
        box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
    }

    /* 内容卡片 */
    .content-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        border: none;
        overflow: hidden;
        margin-top: 20px;
    }

    .card-header-custom {
        background: transparent;
        padding: 20px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    /* 头部工具栏容器：包含搜索框和按钮 */
    .header-tools {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        white-space: nowrap;
    }

    /* 表格样式 */
    .table-custom th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: var(--text-muted);
        border-bottom: 2px solid #edf2f7;
        white-space: nowrap;
    }
    
    .table-custom td {
        vertical-align: middle;
        border-bottom: 1px solid #edf2f7;
    }

    .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-online { background: rgba(76, 201, 240, 0.1); color: #00b4d8; }
    .status-offline { background: rgba(141, 153, 174, 0.1); color: var(--text-muted); }
    .status-blocked { background: rgba(247, 37, 133, 0.1); color: var(--danger-color); }

    /* 悬浮操作按钮 */
    .fab-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: flex-end;
    }

    .fab-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--card-bg);
        box-shadow: var(--shadow-md);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-main);
        transition: all 0.3s;
        cursor: pointer;
        position: relative;
    }

    .fab-btn:hover {
        transform: scale(1.1);
        color: var(--primary-color);
    }

    .fab-label {
        position: absolute;
        right: 60px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        white-space: nowrap;
    }

    .fab-btn:hover .fab-label {
        opacity: 1;
    }

    /* 开关样式优化 */
    .form-switch .form-check-input {
        width: 2.5em;
        height: 1.25em;
        cursor: pointer;
    }
    
    .form-switch .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    /* 移动端优化 */
    @media (max-width: 768px) {
        .stat-card {
            margin-bottom: 15px;
            padding: 15px;
        }
        
        .stat-value {
            font-size: 1.5rem;
        }
        
        .card-header-custom {
            flex-direction: column;
            align-items: flex-start;
        }

        .header-tools {
            width: 100%;
            justify-content: space-between;
        }
        
        .header-tools .input-group {
            width: 100% !important;
            max-width: none !important;
            margin-bottom: 10px;
        }
        
        .header-tools .action-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: flex-end;
        }
        
        .hidden-mobile {
            display: none;
        }
        
        .table-responsive {
            border: 0;
        }
        
        /* 在移动端，按钮不需要文字，只显示图标 */
        .btn-responsive-text span {
            display: none;
        }
    }
    
    /* 进度条 */
    .custom-loader {
        height: 3px;
        width: 100%;
        background: #e9ecef;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1001;
        display: none;
    }
    
    .custom-loader .bar {
        height: 100%;
        background: var(--primary-color);
        width: 0;
        transition: width 0.3s;
    }

    /* 通知容器 */
    #notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1060;
        max-width: 320px;
        width: 100%;
    }
</style>
</head>
<body>


<!-- 加载条 -->
<div class="custom-loader" id="loadingBar"><div class="bar"></div></div>

<!-- 通知容器 -->
<div id="notification-container"></div>

<!-- 顶部导航 -->
<nav class="navbar navbar-custom">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center w-100">
            <div class="brand-title">
                <i class="fas fa-shield-alt"></i> Kosto <span class="badge bg-primary fs-6" style="border-radius: 6px;">Pro</span>
            </div>
            
            <div class="d-flex gap-3 align-items-center">
                <a href="index.html" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-home"></i> <span class="d-none d-md-inline">主页</span>
                </a>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog"></i> 设置
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end p-3" style="min-width: 250px;">
                        <li>
                            <label class="form-label fw-bold small">GitHub/Gitee Token</label>
                            <div class="input-group mb-3">
                                <input type="password" id="giteeToken" class="form-control form-control-sm" placeholder="输入 Token">
                                <button class="btn btn-primary btn-sm" id="saveTokenBtn">保存</button>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">用户端自毁</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="selfDestructSwitch">
                            </div>
                        </li>
                        <li class="d-flex justify-content-between align-items-center">
                            <span class="small">日志记录</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="logSwitch">
                            </div>
                        </li>
                    </ul>
                </div>
                
                <button id="refreshBtn" class="btn btn-primary btn-sm shadow-sm">
                    <i class="fas fa-sync-alt"></i> <span class="d-none d-md-inline">刷新</span>
                </button>
            </div>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- 导航标签 -->
    <ul class="nav nav-pills nav-pills-custom mb-4" id="mainTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#online-view"><i class="fas fa-users me-2"></i>在线监控</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#whitelist-id-view"><i class="fas fa-id-card me-2"></i>白名单ID</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#whitelist-group-view"><i class="fas fa-users-cog me-2"></i>白名单军团</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#developer-view"><i class="fas fa-code me-2"></i>开发者</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#blacklist-view"><i class="fas fa-ban me-2"></i>黑名单</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#user-fingerprint-view"><i class="fas fa-fingerprint me-2"></i>指纹库</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#foreign-view"><i class="fas fa-globe me-2"></i>外服管理</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#config-view"><i class="fas fa-sliders-h me-2"></i>杂项配置</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#github-view"><i class="fab fa-github me-2"></i>字典管理</button></li>
    </ul>

    <div class="tab-content">
        <!-- 1. 在线监控面板 -->
        <div class="tab-pane fade show active" id="online-view">
            <!-- 统计卡片区 -->
            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <div class="stat-label">当前在线</div>
                        <div class="stat-value text-primary" id="statOnline">0</div>
                        <small class="text-success"><i class="fas fa-clock"></i> 实时更新</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card" style="border-left-color: var(--success-color);">
                        <div class="stat-label">今日总数</div>
                        <div class="stat-value text-success" id="statToday">0</div>
                        <small class="text-muted">独立访客</small>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="stat-card" style="border-left-color: var(--secondary-color);">
                        <div class="stat-label">最新活动</div>
                        <div class="d-flex align-items-center mt-2">
                            <div class="flex-grow-1">
                                <div class="fw-bold fs-5" id="lastActiveUser">-</div>
                                <div class="text-muted small" id="lastActiveDetail" style="font-size: 0.75rem;">等待数据...</div>
                            </div>
                            <div class="text-end text-muted small ms-2" id="lastActiveTime">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 在线列表 -->
            <div class="content-card">
                <div class="card-header-custom">
                    <div class="card-title text-primary"><i class="fas fa-list-alt"></i> 在线用户列表</div>
                    <div class="input-group" style="max-width: 300px;">
                        <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                        <input type="text" data-target="onlineTableBody" class="form-control bg-light border-0 table-search-input" placeholder="搜索 ID/指纹...">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-custom table-hover mb-0" id="onlineTable">
                        <thead>
                            <tr>
                                <th>状态</th>
                                <th>用户名/指纹</th>
                                <th>ID</th>
                                <th class="d-none d-md-table-cell">脚本</th>
                                <th class="d-none d-md-table-cell">阶段</th>
                                <th>最后活动</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="onlineTableBody">
                            <!-- JS 填充 -->
                        </tbody>
                    </table>
                </div>
                <div class="p-3 text-center text-muted small bg-light">
                    数据来源: log.json | 上次更新: <span id="lastUpdateTime">-</span>
                </div>
            </div>
        </div>

        <!-- 2. 白名单ID -->
        <div class="tab-pane fade" id="whitelist-id-view">
            <div class="content-card">
                <div class="card-header-custom">
                    <div class="card-title"><i class="fas fa-id-card"></i> 白名单用户 ID</div>
                    <div class="header-tools">
                        <div class="input-group input-group-sm" style="width: 200px;">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                            <input type="text" data-target="tanknamesTableBody" class="form-control bg-light border-0 table-search-input" placeholder="搜索 ID...">
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-outline-danger btn-sm" onclick="batchManager.toggle('tanknames')"><i class="fas fa-tasks"></i> 批量</button>
                            <button class="btn btn-primary btn-sm" onclick="itemManager.showAddModal(CONSTANTS.INDEX.TANKNAMES, '添加白名单ID')"><i class="fas fa-plus"></i> 添加</button>
                        </div>
                    </div>
                </div>
                
                <!-- 批量操作栏 -->
                <div id="batch-tanknames" class="bg-light p-2 border-bottom d-none">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check ms-2">
                            <input class="form-check-input" type="checkbox" id="selectAll-tanknames">
                            <label class="form-check-label" for="selectAll-tanknames">全选</label>
                        </div>
                        <button class="btn btn-danger btn-sm me-2" onclick="batchManager.deleteSelected('tanknames')">删除选中</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-custom table-hover">
                        <thead><tr><th style="width:50px">#</th><th>ID</th><th class="text-end">操作</th></tr></thead>
                        <tbody id="tanknamesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. 白名单军团 -->
        <div class="tab-pane fade" id="whitelist-group-view">
            <div class="content-card">
                <div class="card-header-custom">
                    <div class="card-title"><i class="fas fa-users-cog"></i> 白名单军团</div>
                    <div class="header-tools">
                        <div class="input-group input-group-sm" style="width: 200px;">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                            <input type="text" data-target="groupsTableBody" class="form-control bg-light border-0 table-search-input" placeholder="搜索 军团...">
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-outline-danger btn-sm" onclick="batchManager.toggle('groups')"><i class="fas fa-tasks"></i> 批量</button>
                            <button class="btn btn-primary btn-sm" onclick="itemManager.showAddModal(CONSTANTS.INDEX.GROUPS, '添加军团')"><i class="fas fa-plus"></i> 添加</button>
                        </div>
                    </div>
                </div>
                 <!-- 批量操作栏 -->
                 <div id="batch-groups" class="bg-light p-2 border-bottom d-none">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check ms-2">
                            <input class="form-check-input" type="checkbox" id="selectAll-groups">
                            <label class="form-check-label" for="selectAll-groups">全选</label>
                        </div>
                        <button class="btn btn-danger btn-sm me-2" onclick="batchManager.deleteSelected('groups')">删除选中</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-custom table-hover">
                        <thead><tr><th style="width:50px">#</th><th>军团名称</th><th class="text-end">操作</th></tr></thead>
                        <tbody id="groupsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 4. 开发者 -->
        <div class="tab-pane fade" id="developer-view">
            <div class="content-card">
                <div class="card-header-custom">
                    <div class="card-title"><i class="fas fa-code"></i> 开发者 ID</div>
                    <button class="btn btn-primary btn-sm" onclick="itemManager.showAddModal(CONSTANTS.INDEX.OURS, '添加开发者')"><i class="fas fa-plus"></i> 添加</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-custom table-hover">
                        <thead><tr><th>ID</th><th class="text-end">操作</th></tr></thead>
                        <tbody id="oursTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 5. 黑名单 -->
        <div class="tab-pane fade" id="blacklist-view">
            <div class="content-card border-danger" style="border-top: 4px solid var(--danger-color);">
                <div class="card-header-custom">
                    <div class="card-title text-danger"><i class="fas fa-ban"></i> 黑名单用户</div>
                    <div class="header-tools">
                        <div class="input-group input-group-sm" style="width: 200px;">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                            <input type="text" data-target="blacklistTableBody" class="form-control bg-light border-0 table-search-input" placeholder="搜索 黑名单...">
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-outline-danger btn-sm" onclick="batchManager.toggle('blacklist')"><i class="fas fa-tasks"></i> 批量</button>
                            <button class="btn btn-danger btn-sm" onclick="itemManager.showAddBlacklistModal()"><i class="fas fa-plus"></i> 添加黑名单</button>
                        </div>
                    </div>
                </div>
                 <!-- 批量操作栏 -->
                 <div id="batch-blacklist" class="bg-light p-2 border-bottom d-none">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check ms-2">
                            <input class="form-check-input" type="checkbox" id="selectAll-blacklist">
                            <label class="form-check-label" for="selectAll-blacklist">全选</label>
                        </div>
                        <button class="btn btn-danger btn-sm me-2" onclick="batchManager.deleteSelected('blacklist')">删除选中</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-custom table-hover">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>ID</th>
                                <th>名称</th>
                                <th>军团</th>
                                <th>指纹</th>
                                <th class="text-end">操作</th>
                            </tr>
                        </thead>
                        <tbody id="blacklistTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 6. 用户指纹库 -->
        <div class="tab-pane fade" id="user-fingerprint-view">
             <div class="content-card">
                <div class="card-header-custom">
                    <div class="card-title"><i class="fas fa-fingerprint"></i> 用户指纹数据</div>
                     <div class="header-tools">
                        <div class="input-group input-group-sm" style="width: 200px;">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                            <input type="text" data-target="usersTableBody" class="form-control bg-light border-0 table-search-input" placeholder="搜索 指纹/用户...">
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-outline-danger btn-sm" onclick="batchManager.toggle('users')"><i class="fas fa-tasks"></i> 批量</button>
                            <button class="btn btn-primary btn-sm" onclick="itemManager.showAddUserModal()"><i class="fas fa-plus"></i> 添加用户</button>
                        </div>
                    </div>
                </div>
                 <!-- 批量操作栏 -->
                 <div id="batch-users" class="bg-light p-2 border-bottom d-none">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check ms-2">
                            <input class="form-check-input" type="checkbox" id="selectAll-users">
                            <label class="form-check-label" for="selectAll-users">全选</label>
                        </div>
                        <button class="btn btn-danger btn-sm me-2" onclick="batchManager.deleteSelected('users')">删除选中</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-custom table-hover">
                        <thead><tr><th style="width: 40px;"></th><th>指纹 ID</th><th>绑定名称</th><th class="text-end">操作</th></tr></thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 7. 外服管理 -->
        <div class="tab-pane fade" id="foreign-view">
            <div class="row">
                <div class="col-md-12 mb-4">
                    <div class="content-card">
                        <div class="card-header-custom">
                            <div class="card-title"><i class="fas fa-globe-americas"></i> 外服白名单军团</div>
                            <div class="header-tools">
                                <div class="input-group input-group-sm" style="width: 200px;">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                                    <input type="text" data-target="foreignGroupsTableBody" class="form-control bg-light border-0 table-search-input" placeholder="搜索...">
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="itemManager.showAddModal(CONSTANTS.INDEX.FOREIGN_GROUPS, '添加外服军团')"><i class="fas fa-plus"></i> 添加</button>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-custom table-hover">
                                <tbody id="foreignGroupsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 mb-4">
                     <div class="content-card">
                        <div class="card-header-custom">
                            <div class="card-title"><i class="fas fa-passport"></i> 外服白名单ID</div>
                            <div class="header-tools">
                                <div class="input-group input-group-sm" style="width: 200px;">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                                    <input type="text" data-target="foreignTanknamesTableBody" class="form-control bg-light border-0 table-search-input" placeholder="搜索...">
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="itemManager.showAddModal(CONSTANTS.INDEX.FOREIGN_TANKNAMES, '添加外服ID')"><i class="fas fa-plus"></i> 添加</button>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-custom table-hover">
                                <tbody id="foreignTanknamesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                     <div class="content-card border-danger" style="border-top: 4px solid #f72585;">
                        <div class="card-header-custom">
                            <div class="card-title text-danger"><i class="fas fa-ban"></i> 外服黑名单</div>
                            <div class="header-tools">
                                <div class="input-group input-group-sm" style="width: 200px;">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                                    <input type="text" data-target="foreignBlacklistTableBody" class="form-control bg-light border-0 table-search-input" placeholder="搜索...">
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="itemManager.showAddBlacklistModal(true)"><i class="fas fa-plus"></i> 添加</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-custom table-hover">
                                <thead><tr><th>ID</th><th>名称</th><th>军团</th><th>指纹</th><th class="text-end">操作</th></tr></thead>
                                <tbody id="foreignBlacklistTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 8. 杂项配置 -->
         <div class="tab-pane fade" id="config-view">
            <div class="content-card">
                <div class="card-header-custom">
                    <div class="card-title"><i class="fas fa-bomb"></i> 自爆程序标志 (SS)</div>
                    <button class="btn btn-warning btn-sm" onclick="itemManager.showAddModal(CONSTANTS.INDEX.SS, '添加标志')"><i class="fas fa-plus"></i> 添加</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-custom">
                        <tbody id="ssTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 9. GitHub 字典 -->
        <div class="tab-pane fade" id="github-view">
            <div class="content-card" style="height: 600px;">
                <iframe src="https://kosto179cn.github.io/Dictionaryeditor.html" style="width:100%; height:100%; border:none;"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- 浮动操作按钮 -->
<div class="fab-container">
    <button class="fab-btn bg-success text-white" onclick="dataManager.saveAll()" title="保存所有更改">
        <i class="fas fa-save"></i>
        <span class="fab-label">保存所有更改</span>
    </button>
    <button class="fab-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <i class="fas fa-arrow-up"></i>
    </button>
</div>

<!-- ================= 模态框区域 ================= -->

<!-- 通用单值添加/编辑模态框 -->
<div class="modal fade" id="simpleItemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="simpleItemModalTitle">编辑</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control" id="simpleItemValue" placeholder="请输入值">
                <input type="hidden" id="simpleItemIndex">
                <input type="hidden" id="simpleItemArrayIndex">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btnSaveSimpleItem">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 用户数据模态框 -->
<div class="modal fade" id="userItemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">用户指纹数据</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">指纹 ID</label>
                    <input type="text" class="form-control" id="userInputId">
                </div>
                <div class="mb-3">
                    <label class="form-label">用户名称</label>
                    <input type="text" class="form-control" id="userInputName">
                </div>
                <input type="hidden" id="userInputIndex">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btnSaveUserItem">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 黑名单模态框 -->
<div class="modal fade" id="blacklistModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="blacklistModalTitle">黑名单条目</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2">
                    <div class="col-md-6 mb-2">
                        <label class="form-label small">ID</label>
                        <input type="text" class="form-control" id="blId">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label small">名称</label>
                        <input type="text" class="form-control" id="blName">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label small">军团</label>
                        <input type="text" class="form-control" id="blCorp">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label small">指纹</label>
                        <input type="text" class="form-control" id="blFingerprint">
                    </div>
                </div>
                <input type="hidden" id="blIndex">
                <input type="hidden" id="blIsForeign" value="false">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="btnSaveBlacklist">保存至黑名单</button>
            </div>
        </div>
    </div>
</div>

<!-- 用户详情模态框 -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">用户详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <ul class="list-group list-group-flush" id="detailList">
                    <!-- JS 填充 -->
                </ul>
                <div class="p-3 bg-light" id="detailRawJson" style="font-family: monospace; font-size: 0.8rem; overflow: auto; max-height: 200px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger btn-sm" id="btnQuickBlock">快速拉黑</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 脚本逻辑 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    /**
     * Kosto Manager Pro - Logic Script
     * 结构化重构，保留所有核心功能键值
     */

    // ================= 常量定义 =================
    const API_CONFIG = {
        whitelist: 'https://gitee.com/api/v5/repos/Kosto179/kosto/contents/json/1.json',
        updateLog: 'https://gitee.com/api/v5/repos/Kosto179/kosto-battle-clicker-new/contents/log.json'
    };

    const CONSTANTS = {
        INDEX: {
            TANKNAMES: 0,
            GROUPS: 1,
            OURS: 2,
            SS: 3,
            FOREIGN_GROUPS: 4,
            USERS: 5,
            BLACKLIST: 6,
            LOG_SWITCH: 7,
            FOREIGN_BLACKLIST: 8,
            FOREIGN_TANKNAMES: 9,
            SELF_DESTRUCT: 10
        },
        REFRESH_INTERVAL: 10000,
        ONLINE_THRESHOLD: 2.5 // 分钟
    };

    // ================= 状态管理 =================
    let appState = {
        whitelistData: Array(11).fill([]), // 初始化空数组
        onlineData: [],
        blockedFingerprints: new Set(),
        isBatchMode: {}
    };

    // ================= 工具函数 =================
    const Utils = {
        // 转义 HTML 防止 XSS
        escapeHtml: (text) => {
            if (!text) return text;
            return text.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        },
        
        // 格式化时间
        formatTime: (ts) => {
            if (!ts) return '-';
            return new Date(ts).toLocaleString('zh-CN', {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        },

        // 格式化时长
        formatDuration: (seconds) => {
            return Math.round(seconds / 60) + ' 分钟';
        },

        // Base64 解码 (支持 UTF-8)
        decodeBase64: (str) => {
            try {
                const binaryString = atob(str.replace(/\s/g, ''));
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return new TextDecoder('utf-8').decode(bytes);
            } catch (e) {
                console.error("Decode error", e);
                return "[]";
            }
        },

        // Base64 编码 (支持 UTF-8)
        encodeBase64: (str) => {
            const bytes = new TextEncoder().encode(str);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }
    };

    // ================= 通知系统 =================
    const Notify = {
        show: (message, type = 'info') => {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            
            let icon = 'info-circle';
            let bgClass = 'bg-primary';
            if (type === 'success') { icon = 'check-circle'; bgClass = 'bg-success'; }
            if (type === 'error') { icon = 'exclamation-circle'; bgClass = 'bg-danger'; }
            if (type === 'warning') { icon = 'exclamation-triangle'; bgClass = 'bg-warning text-dark'; }

            toast.className = `toast align-items-center text-white ${bgClass} border-0 show mb-2`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${icon} me-2"></i> ${Utils.escapeHtml(message)}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>`;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
    };

    // ================= 数据管理 =================
    const DataManager = {
        getToken: () => localStorage.getItem('giteeToken'),
        
        saveToken: () => {
            const token = document.getElementById('giteeToken').value.trim();
            if (token) {
                localStorage.setItem('giteeToken', token);
                Notify.show('Token 已保存', 'success');
                App.initData();
            }
        },

        // 获取数据
        fetch: async (url, isJsonContent = false) => {
            const token = DataManager.getToken();
            if (!token && url.includes('gitee')) {
                Notify.show('请先设置 Token', 'warning');
                return null;
            }
            
            document.getElementById('loadingBar').style.display = 'block';
            document.querySelector('.custom-loader .bar').style.width = '70%';

            try {
                const finalUrl = url.includes('?') ? `${url}&access_token=${token}` : `${url}?access_token=${token}`;
                const res = await fetch(finalUrl);
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const data = await res.json();
                document.querySelector('.custom-loader .bar').style.width = '100%';
                
                if (data.content) {
                    return JSON.parse(Utils.decodeBase64(data.content));
                }
                return data;
            } catch (error) {
                console.error('Fetch error:', error);
                Notify.show(`请求失败: ${error.message}`, 'error');
                return null;
            } finally {
                setTimeout(() => document.getElementById('loadingBar').style.display = 'none', 500);
            }
        },

        // 上传数据
        saveAll: async () => {
            const token = DataManager.getToken();
            if (!token) return Notify.show('未设置 Token', 'error');

            try {
                // 1. Get SHA
                const resInfo = await fetch(`${API_CONFIG.whitelist}?access_token=${token}`);
                if (!resInfo.ok) throw new Error('获取文件信息失败');
                const infoData = await resInfo.json();

                // 2. Prepare content
                const contentStr = JSON.stringify(appState.whitelistData, null, 2);
                const base64Content = Utils.encodeBase64(contentStr);

                // 3. PUT
                const resPut = await fetch(`${API_CONFIG.whitelist}?access_token=${token}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Update via Kosto Pro',
                        content: base64Content,
                        sha: infoData.sha
                    })
                });

                if (resPut.ok) {
                    Notify.show('所有更改已保存至 Gitee', 'success');
                } else {
                    throw new Error('上传失败');
                }
            } catch (error) {
                Notify.show(`保存失败: ${error.message}`, 'error');
            }
        },

        // 加载本地黑名单缓存
        loadBlockedFingerprints: () => {
            const saved = localStorage.getItem('blockedFingerprints');
            if (saved) appState.blockedFingerprints = new Set(JSON.parse(saved));
        },
        
        saveBlockedFingerprints: () => {
            localStorage.setItem('blockedFingerprints', JSON.stringify([...appState.blockedFingerprints]));
        }
    };

    // ================= 界面渲染管理 =================
    const Render = {
        // 渲染在线用户
        onlineList: () => {
            const tbody = document.getElementById('onlineTableBody');
            tbody.innerHTML = '';
            const data = appState.onlineData || [];
            
            // 过滤最近几分钟的数据
            const now = new Date();
            const threshold = new Date(now.getTime() - CONSTANTS.ONLINE_THRESHOLD * 60000);
            
            const onlineUsers = data.filter(item => new Date(item.time || item.timestamp) > threshold);
            
            // 更新统计
            document.getElementById('statOnline').textContent = onlineUsers.length;
            document.getElementById('statToday').textContent = new Set(data.map(i => i.fingerprint || i.username)).size;
            document.getElementById('lastUpdateTime').textContent = Utils.formatTime(new Date());

            if(onlineUsers.length > 0) {
               const latest = onlineUsers[0];
               document.getElementById('lastActiveUser').textContent = latest.username || latest.fingerprint;
               document.getElementById('lastActiveDetail').textContent = `ID: ${latest.getid} | Ver: ${latest.Code || 'Unknown'}`;
               document.getElementById('lastActiveTime').textContent = Utils.formatTime(latest.time || latest.timestamp).split(' ')[1];
            }

            if (onlineUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">当前无在线用户</td></tr>';
                return;
            }

            onlineUsers.forEach(user => {
                const isBlocked = appState.blockedFingerprints.has(user.fingerprint);
                const badgeClass = isBlocked ? 'status-blocked' : 'status-online';
                const badgeText = isBlocked ? '已拉黑' : '在线';
                const rowClass = isBlocked ? 'table-danger' : '';

                const row = `
                    <tr class="${rowClass}">
                        <td><span class="status-badge ${badgeClass}">${badgeText}</span></td>
                        <td class="fw-bold">${Utils.escapeHtml(user.username || user.fingerprint)}</td>
                        <td>${Utils.escapeHtml(user.getid)}</td>
                        <td class="d-none d-md-table-cell small text-muted">${Utils.escapeHtml(user.scriptName || '-')}</td>
                        <td class="d-none d-md-table-cell small text-muted">${Utils.escapeHtml(user.phase || '-')}</td>
                        <td class="small">${Utils.formatTime(user.time || user.timestamp)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-responsive-text" onclick='itemManager.showDetails(${JSON.stringify(user).replace(/'/g, "&#39;")})'>
                                <i class="fas fa-info-circle"></i> <span>详情</span>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        },

        // 通用列表渲染
        simpleList: (index, tableId, type) => {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            const list = appState.whitelistData[index] || [];
            
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">无数据</td></tr>';
                return;
            }

            list.forEach((item, i) => {
                const display = Utils.escapeHtml(item);
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div class="form-check">
                                <input class="form-check-input batch-check-${type}" type="checkbox" data-index="${i}">
                                <span class="text-muted small ms-1">${i+1}</span>
                            </div>
                        </td>
                        <td>${display}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-link text-primary p-0 me-2" onclick="itemManager.showEditSimple(${index}, ${i}, '${display.replace(/'/g, "\\'")}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-link text-danger p-0" onclick="itemManager.deleteItem(${index}, ${i})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        },

        // 渲染对象列表 (黑名单、用户库)
        objectList: (index, tableId, type) => {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            const list = appState.whitelistData[index] || [];

            if (list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">无数据</td></tr>`;
                return;
            }

            list.forEach((item, i) => {
                let cols = '';
                if (type === 'users') {
                    cols = `
                        <td>${Utils.escapeHtml(item.id)}</td>
                        <td>${Utils.escapeHtml(item.name)}</td>
                    `;
                } else { // Blacklist
                    cols = `
                        <td>${Utils.escapeHtml(item.id || '-')}</td>
                        <td>${Utils.escapeHtml(item.name || '-')}</td>
                        <td>${Utils.escapeHtml(item.corp || '-')}</td>
                        <td class="small text-muted text-truncate" style="max-width: 100px;">${Utils.escapeHtml(item.fingerprint || '-')}</td>
                    `;
                }

                tbody.innerHTML += `
                    <tr>
                        <td><input class="form-check-input batch-check-${type}" type="checkbox" data-index="${i}"></td>
                        ${cols}
                        <td class="text-end">
                            <button class="btn btn-sm btn-link text-primary p-0 me-2" onclick='itemManager.showEditObject(${index}, ${i}, ${JSON.stringify(item)})'><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-link text-danger p-0" onclick="itemManager.deleteItem(${index}, ${i})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        },

        // 刷新所有视图
        all: () => {
            Render.simpleList(CONSTANTS.INDEX.TANKNAMES, 'tanknamesTableBody', 'tanknames');
            Render.simpleList(CONSTANTS.INDEX.GROUPS, 'groupsTableBody', 'groups');
            Render.simpleList(CONSTANTS.INDEX.OURS, 'oursTableBody', 'ours');
            Render.simpleList(CONSTANTS.INDEX.SS, 'ssTableBody', 'ss');
            Render.simpleList(CONSTANTS.INDEX.FOREIGN_GROUPS, 'foreignGroupsTableBody', 'foreignGroups');
            Render.simpleList(CONSTANTS.INDEX.FOREIGN_TANKNAMES, 'foreignTanknamesTableBody', 'foreignTanknames');
            
            Render.objectList(CONSTANTS.INDEX.USERS, 'usersTableBody', 'users');
            Render.objectList(CONSTANTS.INDEX.BLACKLIST, 'blacklistTableBody', 'blacklist');
            Render.objectList(CONSTANTS.INDEX.FOREIGN_BLACKLIST, 'foreignBlacklistTableBody', 'foreignBlacklist');
            
            // 开关状态同步
            const destruct = appState.whitelistData[CONSTANTS.INDEX.SELF_DESTRUCT];
            const log = appState.whitelistData[CONSTANTS.INDEX.LOG_SWITCH];
            document.getElementById('selfDestructSwitch').checked = (destruct && destruct[0] === 'YES');
            document.getElementById('logSwitch').checked = (log && log[0] === 'OK');
        }
    };

    // ================= 交互逻辑 =================
    const itemManager = {
        // 删除
        deleteItem: (arrayIndex, itemIndex) => {
            if(!confirm('确定删除?')) return;
            appState.whitelistData[arrayIndex].splice(itemIndex, 1);
            Render.all();
            DataManager.saveAll(); // 自动保存
        },

        // 简单添加/编辑
        showAddModal: (arrayIndex, title) => {
            document.getElementById('simpleItemModalTitle').innerText = title;
            document.getElementById('simpleItemValue').value = '';
            document.getElementById('simpleItemArrayIndex').value = arrayIndex;
            document.getElementById('simpleItemIndex').value = -1; // -1 for add
            new bootstrap.Modal(document.getElementById('simpleItemModal')).show();
        },
        
        showEditSimple: (arrayIndex, itemIndex, value) => {
            document.getElementById('simpleItemModalTitle').innerText = '编辑条目';
            let val = value;
            if((arrayIndex === CONSTANTS.INDEX.GROUPS || arrayIndex === CONSTANTS.INDEX.FOREIGN_GROUPS) && val.startsWith('[') && val.endsWith(']')) {
                val = val.slice(1, -1);
            }
            document.getElementById('simpleItemValue').value = val;
            document.getElementById('simpleItemArrayIndex').value = arrayIndex;
            document.getElementById('simpleItemIndex').value = itemIndex;
            new bootstrap.Modal(document.getElementById('simpleItemModal')).show();
        },

        saveSimple: () => {
            const arrayIndex = parseInt(document.getElementById('simpleItemArrayIndex').value);
            const itemIndex = parseInt(document.getElementById('simpleItemIndex').value);
            let value = document.getElementById('simpleItemValue').value.trim();
            
            if (!value) return Notify.show('内容不能为空', 'warning');

            // 自动加方括号逻辑
            if ((arrayIndex === CONSTANTS.INDEX.GROUPS || arrayIndex === CONSTANTS.INDEX.FOREIGN_GROUPS) && (!value.startsWith('[') || !value.endsWith(']'))) {
                value = `[${value}]`;
            }

            if (itemIndex === -1) {
                if (!appState.whitelistData[arrayIndex]) appState.whitelistData[arrayIndex] = [];
                appState.whitelistData[arrayIndex].push(value);
            } else {
                appState.whitelistData[arrayIndex][itemIndex] = value;
            }
            
            bootstrap.Modal.getInstance(document.getElementById('simpleItemModal')).hide();
            Render.all();
            DataManager.saveAll();
        },

        // 用户对象操作
        showAddUserModal: () => {
            document.getElementById('userInputId').value = '';
            document.getElementById('userInputName').value = '';
            document.getElementById('userInputIndex').value = -1;
            new bootstrap.Modal(document.getElementById('userItemModal')).show();
        },

        showEditObject: (arrayIndex, itemIndex, item) => {
            if (arrayIndex === CONSTANTS.INDEX.USERS) {
                document.getElementById('userInputId').value = item.id;
                document.getElementById('userInputName').value = item.name;
                document.getElementById('userInputIndex').value = itemIndex;
                new bootstrap.Modal(document.getElementById('userItemModal')).show();
            } else {
                // 编辑黑名单
                document.getElementById('blacklistModalTitle').innerText = '编辑黑名单';
                document.getElementById('blId').value = item.id || '';
                document.getElementById('blName').value = item.name || '';
                document.getElementById('blCorp').value = item.corp || '';
                document.getElementById('blFingerprint').value = item.fingerprint || '';
                document.getElementById('blIndex').value = itemIndex;
                document.getElementById('blIsForeign').value = (arrayIndex === CONSTANTS.INDEX.FOREIGN_BLACKLIST);
                new bootstrap.Modal(document.getElementById('blacklistModal')).show();
            }
        },
        
        saveUser: () => {
             const id = document.getElementById('userInputId').value.trim();
             const name = document.getElementById('userInputName').value.trim();
             const index = parseInt(document.getElementById('userInputIndex').value);
             
             if (!id || !name) return Notify.show('请填写完整', 'warning');
             
             const newItem = { id, name };
             const arrayIndex = CONSTANTS.INDEX.USERS;
             
             if (index === -1) {
                 appState.whitelistData[arrayIndex].push(newItem);
             } else {
                 appState.whitelistData[arrayIndex][index] = newItem;
             }
             bootstrap.Modal.getInstance(document.getElementById('userItemModal')).hide();
             Render.all();
             DataManager.saveAll();
        },

        // 黑名单操作
        showAddBlacklistModal: (isForeign = false) => {
            document.getElementById('blacklistModalTitle').innerText = isForeign ? '添加外服黑名单' : '添加黑名单';
            ['blId', 'blName', 'blCorp', 'blFingerprint'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('blIndex').value = -1;
            document.getElementById('blIsForeign').value = isForeign;
            new bootstrap.Modal(document.getElementById('blacklistModal')).show();
        },

        saveBlacklist: () => {
            const isForeign = document.getElementById('blIsForeign').value === 'true';
            const arrayIndex = isForeign ? CONSTANTS.INDEX.FOREIGN_BLACKLIST : CONSTANTS.INDEX.BLACKLIST;
            const index = parseInt(document.getElementById('blIndex').value);
            
            const item = {
                id: document.getElementById('blId').value.trim(),
                name: document.getElementById('blName').value.trim(),
                corp: document.getElementById('blCorp').value.trim(),
                fingerprint: document.getElementById('blFingerprint').value.trim(),
                blockedAt: new Date().toISOString()
            };
            
            // 处理军团格式
            if (item.corp && (!item.corp.startsWith('[') || !item.corp.endsWith(']'))) {
                item.corp = `[${item.corp}]`;
            }

            if (!item.id && !item.name && !item.corp && !item.fingerprint) return Notify.show('至少填写一项', 'warning');

            if (index === -1) {
                if (!appState.whitelistData[arrayIndex]) appState.whitelistData[arrayIndex] = [];
                appState.whitelistData[arrayIndex].push(item);
            } else {
                appState.whitelistData[arrayIndex][index] = item;
            }
            
            bootstrap.Modal.getInstance(document.getElementById('blacklistModal')).hide();
            Render.all();
            DataManager.saveAll();
        },

        // 详情
        showDetails: (user) => {
            const list = document.getElementById('detailList');
            list.innerHTML = `
                <li class="list-group-item d-flex justify-content-between"><span>用户名</span> <strong>${Utils.escapeHtml(user.username)}</strong></li>
                <li class="list-group-item d-flex justify-content-between"><span>ID</span> <strong>${Utils.escapeHtml(user.getid)}</strong></li>
                <li class="list-group-item d-flex justify-content-between"><span>脚本</span> <span>${Utils.escapeHtml(user.scriptName)} (${Utils.escapeHtml(user.Code)})</span></li>
                <li class="list-group-item d-flex justify-content-between"><span>IP</span> <span>${Utils.escapeHtml(user.details?.ip || '-')}</span></li>
                <li class="list-group-item d-flex justify-content-between"><span>在线时长</span> <span>${Utils.formatDuration(user.details?.onlineTime || 0)}</span></li>
            `;
            document.getElementById('detailRawJson').textContent = JSON.stringify(user, null, 2);
            
            const btnBlock = document.getElementById('btnQuickBlock');
            btnBlock.onclick = () => {
                const fingerprint = user.fingerprint || user.username;
                appState.blockedFingerprints.add(fingerprint);
                DataManager.saveBlockedFingerprints();
                // 同时也添加到黑名单列表
                appState.whitelistData[CONSTANTS.INDEX.BLACKLIST].push({
                    id: user.getid,
                    name: user.username,
                    fingerprint: fingerprint,
                    blockedAt: new Date().toISOString()
                });
                
                Notify.show('已快速拉黑', 'success');
                bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
                Render.onlineList();
                DataManager.saveAll();
            };
            
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }
    };

    // ================= 批量管理 =================
    const batchManager = {
        toggle: (type) => {
            const el = document.getElementById(`batch-${type}`);
            el.classList.toggle('d-none');
        },
        
        deleteSelected: (type) => {
            const checks = document.querySelectorAll(`.batch-check-${type}:checked`);
            if (checks.length === 0) return Notify.show('未选择任何项目', 'warning');
            
            if (!confirm(`确认删除选中的 ${checks.length} 项?`)) return;

            const indices = Array.from(checks).map(c => parseInt(c.dataset.index)).sort((a,b) => b-a);
            let arrayIndex;
            
            switch(type) {
                case 'tanknames': arrayIndex = CONSTANTS.INDEX.TANKNAMES; break;
                case 'groups': arrayIndex = CONSTANTS.INDEX.GROUPS; break;
                case 'users': arrayIndex = CONSTANTS.INDEX.USERS; break;
                case 'blacklist': arrayIndex = CONSTANTS.INDEX.BLACKLIST; break;
                default: return;
            }

            indices.forEach(idx => {
                appState.whitelistData[arrayIndex].splice(idx, 1);
            });

            document.getElementById(`selectAll-${type}`).checked = false;
            Render.all();
            DataManager.saveAll();
            Notify.show('批量删除成功', 'success');
        }
    };

    // ================= 初始化 =================
    const App = {
        init: () => {
            // 读取 Token
            const savedToken = DataManager.getToken();
            if (savedToken) document.getElementById('giteeToken').value = savedToken;
            
            DataManager.loadBlockedFingerprints();

            // 事件绑定
            document.getElementById('saveTokenBtn').onclick = DataManager.saveToken;
            document.getElementById('refreshBtn').onclick = App.refresh;
            document.getElementById('btnSaveSimpleItem').onclick = itemManager.saveSimple;
            document.getElementById('btnSaveUserItem').onclick = itemManager.saveUser;
            document.getElementById('btnSaveBlacklist').onclick = itemManager.saveBlacklist;
            
            // 通用搜索功能绑定 (使用事件委托或初始化时绑定)
            // 这里我们使用一种简单的方法，因为搜索框是静态HTML存在的
            const bindSearch = () => {
                document.querySelectorAll('.table-search-input').forEach(input => {
                    input.addEventListener('input', function(e) {
                        const term = e.target.value.toLowerCase();
                        const targetId = this.dataset.target;
                        const tbody = document.getElementById(targetId);
                        if(!tbody) return;
                        
                        const rows = tbody.querySelectorAll('tr');
                        rows.forEach(row => {
                            const text = row.innerText.toLowerCase();
                            row.style.display = text.includes(term) ? '' : 'none';
                        });
                    });
                });
            };
            bindSearch();

            // 全选功能绑定
            ['tanknames', 'groups', 'users', 'blacklist'].forEach(type => {
                const master = document.getElementById(`selectAll-${type}`);
                if(master) {
                    master.onclick = (e) => {
                        document.querySelectorAll(`.batch-check-${type}`).forEach(c => c.checked = e.target.checked);
                    };
                }
            });

            // 开关监听
            document.getElementById('selfDestructSwitch').onchange = (e) => {
                appState.whitelistData[CONSTANTS.INDEX.SELF_DESTRUCT] = e.target.checked ? ["YES"] : ["NO"];
                DataManager.saveAll();
            };
            document.getElementById('logSwitch').onchange = (e) => {
                appState.whitelistData[CONSTANTS.INDEX.LOG_SWITCH] = e.target.checked ? ["OK"] : ["NO"];
                DataManager.saveAll();
            };

            // 启动
            App.initData();
            setInterval(App.fetchOnline, CONSTANTS.REFRESH_INTERVAL);
        },

        initData: async () => {
            await App.fetchWhitelist();
            await App.fetchOnline();
        },

        refresh: () => {
            App.initData();
            Notify.show('数据已刷新', 'success');
        },

        fetchWhitelist: async () => {
            const data = await DataManager.fetch(API_CONFIG.whitelist);
            if (data) {
                appState.whitelistData = data;
                // 确保所有数组初始化
                for(let i=0; i<=10; i++) {
                    if(!appState.whitelistData[i]) appState.whitelistData[i] = [];
                }
                Render.all();
            }
        },

        fetchOnline: async () => {
            const data = await DataManager.fetch(API_CONFIG.updateLog);
            if (data && Array.isArray(data)) {
                appState.onlineData = data;
                Render.onlineList();
            }
        }
    };

    // 启动应用
    window.addEventListener('DOMContentLoaded', App.init);

</script>
</body>
</html>
