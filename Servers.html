<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>3Då¦å…‹-æœåŠ¡å™¨å…­åˆä¸€</title>
    <link rel="shortcut icon" href="https://tankionline.com/favicon.ico" />
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&family=M+PLUS+1p&display=swap" rel="stylesheet" />
    
    <style>
        :root {
            --primary-color: #76ff33;
            --primary-dim: rgba(118, 255, 51, 0.2);
            --bg-dark: #001926;
            --text-light: #BFD5FF;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-hover: rgba(118, 255, 51, 0.1);
            --transition-speed: 0.3s;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Rubik', 'M PLUS 1p', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
            background: radial-gradient(circle at center, rgb(32, 48, 64) 0%, rgb(3, 8, 13) 100%);
            color: white;
            overflow-x: hidden;
            padding-top: 60px; /* Header space */
        }

        /* --- Header --- */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(0, 25, 38, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 1px;
        }

        .header-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition-speed);
            font-size: 14px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .header-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: var(--primary-dim);
        }

        /* --- Layout Containers --- */
        .view-section {
            display: none; /* Hidden by default */
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
            animation: fadeIn 0.4s ease-out;
            padding-bottom: 80px;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Grid & Cards --- */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            width: 100%;
        }
        
        /* Compact grid for downloads */
        .grid-compact {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-decoration: none;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 140px;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            background: var(--card-hover);
            border-color: var(--primary-color);
            box-shadow: 0 10px 20px rgba(118, 255, 51, 0.1);
            color: white;
        }

        .card-icon {
            font-size: 32px;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .card-icon img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            margin: 0;
            line-height: 1.3;
        }

        .card-sub {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* --- Section Divider --- */
        .section-header {
            width: 100%;
            margin: 25px 0 15px 0;
            font-size: 14px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 5px;
        }

        /* --- Status Page Specifics --- */
        .status-display {
            text-align: center;
            background: var(--glass-bg);
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .stat-row {
            margin: 20px 0;
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        .stat-row:last-child { border-bottom: none; }

        .stat-val {
            font-size: 32px;
            color: var(--primary-color);
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- Test Server List --- */
        .server-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px;
            text-align: left;
            min-height: auto;
        }
        
        .server-item .stats-badges {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
        }

        /* --- Settings & Options --- */
        .options-panel {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--glass-border);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .checkbox-wrapper input { display: none; }
        .checkbox-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            margin-right: 10px;
            position: relative;
            transition: 0.2s;
        }
        .checkbox-wrapper input:checked + .checkbox-custom {
            background: var(--primary-color);
        }
        .checkbox-wrapper input:checked + .checkbox-custom::after {
            content: 'âœ”';
            position: absolute;
            color: #001926;
            font-size: 14px;
            left: 3px;
            top: -1px;
        }

        /* --- Modals --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #112233;
            border: 1px solid var(--primary-color);
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 0 20px rgba(118, 255, 51, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .input-group {
            margin-bottom: 15px;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            color: white;
            border-radius: 6px;
        }
        .action-btn {
            width: 100%;
            padding: 10px;
            background: var(--primary-color);
            color: #001926;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            display: block;
        }

        /* --- Loading Spinner --- */
        .loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(118, 255, 51, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <button class="header-btn" id="navBackBtn">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/></svg>
            è¿”å›
        </button>
        <div class="header-title" id="pageTitle">æœåŠ¡å™¨ä¸­å¿ƒ</div>
        <button class="header-btn" id="openSettingsBtn">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/><path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zM8 0c1.146 0 2.228.608 2.768 1.557l.11.193C11.378.804 12.804 2.23 11.75 3.12l.193.11C12.948 3.772 13.556 4.854 13.556 6c0 1.146-.608 2.228-1.557 2.768l-.193.11c.947 1.054-.479 2.48-1.369 1.426l-.11.193C9.772 11.392 8.69 12 7.544 12c-1.146 0-2.228-.608-2.768-1.557l-.11-.193c-1.054.947-2.48-.479-1.426-1.369l-.193-.11C2.052 8.228 1.444 7.146 1.444 6c0-1.146.608-2.228 1.557-2.768l.193-.11C2.247 2.068 3.673.642 4.563 1.696l.11-.193C5.228.608 6.31 0 7.456 0z"/></svg>
            è®¾ç½®
        </button>
    </div>

    <!-- 1. HOME VIEW -->
    <div id="view-home" class="view-section active">
        <div class="grid-container">
            <a href="https://3dtank.com/play" class="card" id="linkGuofu">
                <div class="card-icon">ğŸ‡¨ğŸ‡³</div>
                <div class="card-title">å›½æœ (Main)</div>
                <div class="card-sub">å®˜æ–¹æœåŠ¡å™¨</div>
            </a>
            
            <div class="card" onclick="app.navigate('global')">
                <div class="card-icon">ğŸ‡ªğŸ‡º</div>
                <div class="card-title">å¤–æœä¸­å¿ƒ</div>
                <div class="card-sub">Global / å®¢æˆ·ç«¯ / å¹³å°</div>
            </div>

            <div class="card" onclick="app.navigate('classic')">
                <div class="card-icon">ğŸ®</div>
                <div class="card-title">ç»å…¸ç‰ˆ</div>
                <div class="card-sub">Classic Tanki</div>
            </div>

            <div class="card" onclick="app.navigate('test')">
                <div class="card-icon">ğŸ§ª</div>
                <div class="card-title">æµ‹è¯•æœ</div>
                <div class="card-sub">è‡ªåŠ¨æ‰«æå¯ç”¨æœåŠ¡å™¨</div>
            </div>

            <div class="card" onclick="app.navigate('partners')">
                <div class="card-icon">ğŸ¤</div>
                <div class="card-title">è”è¿æœ</div>
                <div class="card-sub">4399, 7k7k, YYç­‰</div>
            </div>

            <div class="card" onclick="app.navigate('status')">
                <div class="card-icon">ğŸ“Š</div>
                <div class="card-title">å›½æœçŠ¶æ€</div>
                <div class="card-sub">å®æ—¶åœ¨çº¿äººæ•°ç›‘æ§</div>
            </div>

            <a href="index.html" class="card">
                <div class="card-icon">ğŸ </div>
                <div class="card-title">è¿”å›ä¸»é¡µ</div>
            </a>
        </div>
    </div>

    <!-- 2. GLOBAL VIEW (NEW) -->
    <div id="view-global" class="view-section">
        <div class="section-header">ç½‘é¡µå®¢æˆ·ç«¯</div>
        <div class="grid-container">
            <a href="https://tankionline.com/play/" class="card" id="linkWaifu">
                <div class="card-icon">ğŸŒ</div>
                <div class="card-title">ç½‘é¡µç‰ˆ</div>
                <div class="card-sub">å®˜æ–¹ç½‘ç«™</div>
            </a>
        </div>

        <div class="section-header">PC å®¢æˆ·ç«¯ä¸‹è½½</div>
        <div class="grid-container grid-compact">
            <a href="https://tankionline.com/desktop/TankiOnlineSetup.exe" class="card">
                <div class="card-icon">ğŸªŸ</div>
                <div class="card-title">Windows</div>
                <div class="card-sub">Win 10/11</div>
            </a>
            <a href="https://tankionline.com/desktop/TankiOnlineSetup-win7-x64.exe" class="card">
                <div class="card-icon">ğŸ¢</div>
                <div class="card-title">Windows 7/8</div>
                <div class="card-sub">æ—§ç‰ˆ</div>
            </a>
            <a href="https://tankionline.com/desktop/TankiOnlineSetup.dmg" class="card">
                <div class="card-icon">ğŸ</div>
                <div class="card-title">macOS</div>
            </a>
            <a href="https://tankionline.com/desktop/TankiOnlineSetup-linux-x86_64.AppImage" class="card">
                <div class="card-icon">ğŸ§</div>
                <div class="card-title">Linux</div>
            </a>
        </div>

        <div class="section-header">æ¸¸æˆå¹³å°</div>
        <div class="grid-container grid-compact">
            <a href="https://store.steampowered.com/app/562010/Tanki_Online/" class="card">
                <div class="card-icon">ğŸš‚</div>
                <div class="card-title">Steam</div>
            </a>
            <a href="https://vkplay.ru/app/21879" class="card">
                <div class="card-icon">ğŸ”µ</div>
                <div class="card-title">VK Play</div>
            </a>
            <a href="https://ok.ru/game/tankionline_official" class="card">
                <div class="card-icon">ğŸ†—</div>
                <div class="card-title">OK.ru</div>
            </a>
            <a href="https://www.nintendo.com/us/store/products/tanki-online-switch/" class="card">
                <div class="card-icon">ğŸ”´</div>
                <div class="card-title">Switch</div>
            </a>
        </div>

        <div class="section-header">ç§»åŠ¨ç«¯</div>
        <div class="grid-container grid-compact">
            <a href="https://play.google.com/store/apps/details?id=com.tankionline.mobile.production" class="card">
                <div class="card-icon">ğŸ¤–</div>
                <div class="card-title">Google Play</div>
            </a>
            <a href="https://apps.apple.com/us/app/tanki-online-pvp-tank-battle/id6737538964" class="card">
                <div class="card-icon">ğŸ</div>
                <div class="card-title">App Store</div>
            </a>
        </div>
    </div>

    <!-- 3. CLASSIC VIEW (NEW) -->
    <div id="view-classic" class="view-section">
        <div class="grid-container">
            <a href="https://tankiclassic.com/play/" class="card">
                <div class="card-icon">ğŸ›ï¸</div>
                <div class="card-title">ç½‘é¡µç‰ˆ</div>
                <div class="card-sub">Official Website</div>
            </a>
            <a href="https://store.steampowered.com/app/3872910/Tanki_Classic/" class="card">
                <div class="card-icon">ğŸš‚</div>
                <div class="card-title">Steam</div>
                <div class="card-sub">Classic on Steam</div>
            </a>
        </div>
    </div>

    <!-- 4. PARTNERS VIEW -->
    <div id="view-partners" class="view-section">
        <div class="options-panel">
            <button class="action-btn" style="background: transparent; border: 1px solid var(--primary-color); color: white;" onclick="document.getElementById('mobileModal').style.display='flex'">
                ğŸ“± ä¸‹è½½æ‰‹æœºç«¯æ¸ é“
            </button>
        </div>
        <div class="grid-container">
            <a href="https://my.4399.com/yxtk/play?sid=1" class="card">
                <div class="card-title">4399</div>
                <div class="card-sub">è‡ªåŠ¨ç™»å½•</div>
            </a>
            <a href="http://web.7k7k.com/stat/game.php?target=3dtk" class="card">
                <div class="card-title">7k7k</div>
                <div class="card-sub">éœ€Flash/å¾®ç«¯</div>
            </a>
            <a href="https://udblogin.yy.com/login.do?game=TKRJ&webyygame&hideNav=1&server=s1" class="card">
                <div class="card-title">YYæ¸¸æˆ</div>
            </a>
            <a href="http://wan.baidu.com/game?gameId=23699359" class="card">
                <div class="card-title">ç™¾åº¦æ¸¸æˆ</div>
            </a>
            <a href="http://web.gamersky.com/Games/236.html" class="card">
                <div class="card-title">æ¸¸æ°‘æ˜Ÿç©º</div>
            </a>
            <a href="https://wans.ixinyou.com/games/tank/" class="card">
                <div class="card-title">å¿ƒæ¸¸</div>
            </a>
            <a href="https://game.qzone.qq.com/1102530450" class="card">
                <div class="card-title">QQç©ºé—´</div>
                <div class="card-sub">éœ€æ¡Œé¢ç‰ˆ</div>
            </a>
            <a href="https://wan.ludashi.com/yeyou/tk3d?s=1" class="card">
                <div class="card-title">é²å¤§å¸ˆ</div>
            </a>
            <a href="https://appgallery.huawei.com/app/C101972055" class="card">
                <div class="card-title">åä¸ºåº”ç”¨å¸‚åœº</div>
            </a>
        </div>
    </div>

    <!-- 5. TEST SERVER VIEW -->
    <div id="view-test" class="view-section">
        <div class="options-panel">
            <div class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px;">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="optLockLocale">
                    <span class="checkbox-custom"></span> é”å®šä¸­æ–‡
                </label>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="optSkipKey">
                    <span class="checkbox-custom"></span> è·³è¿‡ä»»æ„é”®
                </label>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="optChinaBuild">
                    <span class="checkbox-custom"></span> å›½æœç•Œé¢
                </label>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="optNewWindow">
                    <span class="checkbox-custom"></span> æ–°çª—å£æ‰“å¼€
                </label>
            </div>
            <button class="action-btn" onclick="testScanner.start()">ğŸ”„ é‡æ–°æ‰«æ</button>
        </div>

        <div id="testLoader" class="loader-container" style="display:none;">
            <div class="spinner"></div>
            <div>æ­£åœ¨æ‰«ææœåŠ¡å™¨... (<span id="scanProgress">0</span>/20)</div>
        </div>

        <div id="testNoServers" class="status-display" style="display:none; padding: 20px;">
            âš ï¸ å½“å‰æš‚æ— å¯ç”¨æµ‹è¯•æœ
        </div>

        <div class="grid-container" id="testResults">
            <!-- Test server cards will be injected here -->
        </div>
    </div>

    <!-- 6. STATUS VIEW -->
    <div id="view-status" class="view-section">
        <div class="status-display">
            <h2>å›½æœå®æ—¶æ•°æ®</h2>
            <div class="stat-row">
                <span class="stat-label">æ€»åœ¨çº¿äººæ•°</span>
                <span class="stat-val" id="statOnline">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">æ­£åœ¨æˆ˜æ–—ä¸­</span>
                <span class="stat-val" id="statBattles">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">4399 æ¸ é“</span>
                <span class="stat-val" id="stat4399">--</span>
            </div>
            <div style="margin-top: 20px; font-size: 14px; color: #888;">
                è‡ªåŠ¨åˆ·æ–°: <span id="refreshTimer" style="color: var(--primary-color)">11</span>s
            </div>
            <button class="action-btn" onclick="statusMonitor.refresh()" style="margin-top: 20px; width: auto; padding: 5px 20px;">ç«‹å³åˆ·æ–°</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="document.getElementById('settingsModal').style.display='none'">Ã—</button>
            <h3 style="margin-top:0">å…¨å±€è®¾ç½®</h3>
            <div class="input-group">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="globalChineseCheck">
                    <span class="checkbox-custom"></span> å¤–æœé“¾æ¥å¼ºåˆ¶é”å®šä¸­æ–‡
                </label>
            </div>
            <hr style="border-color: var(--glass-border); margin: 15px 0;">
            <div class="input-group">
                <label style="display:block; margin-bottom:5px;">è‡ªå®šä¹‰ç½‘å€è·³è½¬</label>
                <input type="text" id="customUrlInput" placeholder="https://example.com">
            </div>
            <button class="action-btn" onclick="app.redirectCustom()">è·³è½¬</button>
        </div>
    </div>

    <div id="mobileModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="document.getElementById('mobileModal').style.display='none'">Ã—</button>
            <h3 style="margin-top:0">é€‰æ‹©ç§»åŠ¨ç«¯å¹³å°</h3>
            <div style="display: grid; gap: 10px;">
                <a href="https://appgallery.huawei.com/app/C101972055" class="header-btn" style="justify-content:center">åä¸ºåº”ç”¨å•†åº—</a>
                <a href="https://h5coml.vivo.com.cn/h5coml/appdetail_h5/browser_v2/index.html?appId=2900145" class="header-btn" style="justify-content:center">vivo å•†åº—</a>
                <a href="https://app.mi.com/details?id=com.tankionline.mi" class="header-btn" style="justify-content:center">å°ç±³å•†åº—</a>
                <a href="https://store.oppomobile.com/" class="header-btn" style="justify-content:center">OPPO å•†åº—</a>
                <a href="https://www.honor.com/cn/tech/honor-app-market/" class="header-btn" style="justify-content:center">è£è€€åº”ç”¨å¸‚åœº</a>
                <a href="https://a.4399.cn/game-id-162288.html" class="header-btn" style="justify-content:center">4399 æ¸¸æˆç›’</a>
                <a href="https://www.ldmnq.com/app/8762/" class="header-btn" style="justify-content:center">é›·ç”µæ¨¡æ‹Ÿå™¨</a>
            </div>
        </div>
    </div>

    <script>
        // --- APP STATE MANAGEMENT ---
        const app = {
            currentView: 'home',
            
            init: () => {
                // Settings Init
                const isChinese = localStorage.getItem('chineseModeEnabled') === 'true';
                document.getElementById('globalChineseCheck').checked = isChinese;
                app.updateWaifuLink(isChinese);
                
                // Event Listeners
                document.getElementById('navBackBtn').addEventListener('click', app.handleBack);
                document.getElementById('openSettingsBtn').addEventListener('click', () => {
                    document.getElementById('settingsModal').style.display = 'flex';
                });
                
                document.getElementById('globalChineseCheck').addEventListener('change', (e) => {
                    localStorage.setItem('chineseModeEnabled', e.target.checked);
                    app.updateWaifuLink(e.target.checked);
                });

                // Test Server Options Listeners
                ['optLockLocale', 'optSkipKey', 'optChinaBuild', 'optNewWindow'].forEach(id => {
                    document.getElementById(id).addEventListener('change', testScanner.updateLinks);
                });

                // Mobile Check
                if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
                    const gl = document.getElementById('linkGuofu');
                    gl.href += (gl.href.includes('?') ? '&' : '?') + 'distribution=generic_mobile_china';
                }
            },

            navigate: (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');
                app.currentView = viewId;
                
                // Logic switches
                if (viewId === 'test') testScanner.start();
                if (viewId === 'status') statusMonitor.start();
                else statusMonitor.stop();

                // Update Header
                const titles = { 
                    'home': 'æœåŠ¡å™¨ä¸­å¿ƒ', 
                    'partners': 'è”è¿å¹³å°', 
                    'test': 'æµ‹è¯•æœåŠ¡å™¨', 
                    'status': 'å›½æœç›‘æ§',
                    'global': 'å¤–æœä¸­å¿ƒ',
                    'classic': 'ç»å…¸ç‰ˆ'
                };
                document.getElementById('pageTitle').innerText = titles[viewId] || 'Server Center';
            },

            handleBack: () => {
                if (app.currentView === 'home') {
                    window.location.href = 'index.html';
                } else {
                    app.navigate('home');
                }
            },

            updateWaifuLink: (isChinese) => {
                const link = document.getElementById('linkWaifu');
                if(!link) return;
                const url = new URL(link.href);
                if (isChinese) url.searchParams.set('locale', 'zh');
                else url.searchParams.delete('locale');
                link.href = url.toString();
            },

            redirectCustom: () => {
                let url = document.getElementById('customUrlInput').value.trim();
                if (url) {
                    if (!url.startsWith('http')) url = 'http://' + url;
                    window.location.href = url;
                }
            }
        };

        // --- TEST SERVER LOGIC ---
        const testScanner = {
            isRunning: false,
            
            start: async () => {
                const container = document.getElementById('testResults');
                container.innerHTML = ''; 
                document.getElementById('testLoader').style.display = 'flex';
                document.getElementById('testNoServers').style.display = 'none';
                document.getElementById('scanProgress').innerText = '0';
                
                const promises = [];
                let found = 0;

                const check = async (i, type) => {
                    const isDeploy = type === 'Deploy';
                    const checkUrl = isDeploy 
                        ? `https://balancer.public-deploy${i}.test-eu.tankionline.com/balancer`
                        : `https://balancer.review-${i}-public.test-ru.tankionline.com/balancer`;
                    
                    const playUrl = isDeploy
                        ? `https://public-deploy${i}.test-eu.tankionline.com/browser-public/index.html`
                        : `https://client-review-${i}-public.test-ru.tankionline.com/?config-template=https://c{server}.review-${i}-public.test-ru.tankionline.com/config.xml&resources=https://resources-review-${i}-public.test-ru.tankionline.com&balancer=https://balancer.review-${i}-public.test-ru.tankionline.com/balancer`;

                    try {
                        const res = await fetch(checkUrl, { method: 'HEAD' });
                        if (res.ok || res.status === 503) {
                            const statsRes = await fetch(checkUrl);
                            const data = await statsRes.json();
                            const online = Object.values(data.nodes).reduce((s, n) => s + n.online, 0);
                            const battles = Object.values(data.nodes).reduce((s, n) => s + n.inbattles, 0);

                            testScanner.renderCard(type + ' ' + i, playUrl, online, battles);
                            found++;
                        }
                    } catch (e) { /* ignore */ }
                    
                    const progEl = document.getElementById('scanProgress');
                    progEl.innerText = parseInt(progEl.innerText) + 1;
                };

                for (let i = 1; i <= 10; i++) {
                    promises.push(check(i, 'Deploy'));
                    promises.push(check(i, 'Review'));
                }

                await Promise.allSettled(promises);
                
                document.getElementById('testLoader').style.display = 'none';
                if (found === 0) document.getElementById('testNoServers').style.display = 'block';
                
                testScanner.updateLinks();
            },

            renderCard: (name, url, online, battles) => {
                const card = document.createElement('a');
                card.className = 'card server-item test-link';
                card.href = url;
                card.dataset.baseUrl = url;
                
                const icon = name.includes('Deploy') ? 'ğŸš€' : 'ğŸ› ï¸';
                
                card.innerHTML = `
                    <div class="card-title" style="display:flex; align-items:center; gap:10px;">
                        <span>${icon}</span> ${name}
                    </div>
                    <div class="stats-badges">
                        <span class="badge" style="color:var(--primary-color)">åœ¨çº¿: ${online}</span>
                        <span class="badge">æˆ˜æ–—: ${battles}</span>
                    </div>
                `;
                document.getElementById('testResults').appendChild(card);
            },

            updateLinks: () => {
                const links = document.querySelectorAll('.test-link');
                const lock = document.getElementById('optLockLocale').checked;
                const skip = document.getElementById('optSkipKey').checked;
                const china = document.getElementById('optChinaBuild').checked;
                const newWindow = document.getElementById('optNewWindow').checked;
                const mobile = china && /Mobi|Android/i.test(navigator.userAgent);

                links.forEach(link => {
                    const url = new URL(link.dataset.baseUrl);
                    if (skip) url.searchParams.set('skipEntranceAnyKey', 'true');
                    if (china) {
                        url.searchParams.set('isChinaBuild', 'true');
                        url.searchParams.delete('skipEntranceAnyKey');
                    }
                    if (lock) url.searchParams.set('locale', 'zh');
                    if (mobile) url.searchParams.set('distribution', 'generic_mobile_china');

                    // è®¾ç½®æ–°çª—å£æ‰“å¼€
                    if (newWindow) {
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                    } else {
                        link.target = '';
                        link.rel = '';
                    }

                    link.href = url.toString();
                });
            }
        };

        // --- STATUS MONITOR LOGIC ---
        const statusMonitor = {
            timer: null,
            interval: null,
            count: 11,

            start: () => {
                statusMonitor.refresh();
                if (statusMonitor.interval) clearInterval(statusMonitor.interval);
                
                statusMonitor.interval = setInterval(() => {
                    statusMonitor.count--;
                    document.getElementById('refreshTimer').innerText = statusMonitor.count;
                    if (statusMonitor.count <= 0) statusMonitor.refresh();
                }, 1000);
            },

            stop: () => {
                clearInterval(statusMonitor.interval);
                statusMonitor.interval = null;
            },

            refresh: () => {
                statusMonitor.count = 11;
                document.getElementById('refreshTimer').innerText = 11;
                
                fetch('https://balancer.3dtank.com/balancer')
                    .then(res => res.json())
                    .then(data => {
                        let totalInbattles = 0;
                        let totalOnline = 0;
                        let total4399 = 0;

                        Object.values(data.nodes).forEach(node => {
                            totalInbattles += node.inbattles || 0;
                            totalOnline += node.online || 0;
                            total4399 += (node.partners && node.partners.my_4399_com) ? node.partners.my_4399_com : 0;
                        });

                        document.getElementById('statOnline').innerText = totalOnline;
                        document.getElementById('statBattles').innerText = totalInbattles;
                        document.getElementById('stat4399').innerText = total4399;
                    })
                    .catch(() => {
                        document.getElementById('statOnline').innerText = "Error";
                    });
            }
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', app.init);
        
        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>