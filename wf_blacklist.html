<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黑名单编辑器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .editor-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .search-box input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .search-box button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .search-box button:first-of-type {
            background: #007bff;
            color: white;
        }
        .search-box button:last-of-type {
            background: #6c757d;
            color: white;
        }
        .action-buttons {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .action-buttons button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #addBtn {
            background: #28a745;
            color: white;
        }
        #deleteBtn {
            background: #dc3545;
            color: white;
        }
        #saveBtn {
            background: #17a2b8;
            color: white;
        }
        #statusMsg {
            margin-left: 15px;
            color: #6c757d;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f2f2f2;
            font-weight: bold;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .row-checkbox {
            cursor: pointer;
        }
        .delete-row {
            padding: 5px 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        /* 模态框样式 */
        #addModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            width: 500px;
            max-width: 90%;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal-title {
            margin: 0;
            font-size: 1.2em;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
        }
        .modal-body {
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal-footer button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal-footer button:first-child {
            background: #6c757d;
            color: white;
        }
        .modal-footer button:last-child {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <h2>黑名单编辑器</h2>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索 (id/名字/军团/指纹)">
            <button id="searchBtn">搜索</button>
            <button id="resetBtn">重置</button>
        </div>

        <div class="action-buttons">
            <button id="addBtn">添加记录</button>
            <button id="deleteBtn">删除选中</button>
            <button id="saveBtn">保存到Gitee</button>
            <span id="statusMsg"></span>
        </div>

        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>ID</th>
                    <th>名字/化名</th>
                    <th>军团</th>
                    <th>指纹数据</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="dataTable">
                <!-- 数据将通过JS动态加载 -->
            </tbody>
        </table>
    </div>

    <!-- 添加记录模态框 -->
    <div id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">添加黑名单记录</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="form-group">
                        <label>游戏账号</label>
                        <input type="text" name="id" required>
                    </div>
                    <div class="form-group">
                        <label>名字/化名</label>
                        <input type="text" name="name">
                    </div>
                    <div class="form-group">
                        <label>军团</label>
                        <input type="text" name="corp">
                    </div>
                    <div class="form-group">
                        <label>指纹数据</label>
                        <input type="text" name="fingerprint">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="cancelAdd">取消</button>
                <button id="confirmAdd">确认添加</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 确保Bootstrap加载完成
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap未正确加载，请检查网络连接');
            document.getElementById('statusMsg').textContent = '系统依赖加载失败，请刷新页面';
        }
        
        // 全局变量
        let blacklistData = [];
        const giteeToken = localStorage.giteeToken;
        const giteeRepo = 'Kosto179/kosto';
        const jsonPath = 'json/1.json';
        
        // DOM元素
        const dataTable = document.getElementById('dataTable');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resetBtn = document.getElementById('resetBtn');
        const addBtn = document.getElementById('addBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const saveBtn = document.getElementById('saveBtn');
        const selectAll = document.getElementById('selectAll');
        const statusMsg = document.getElementById('statusMsg');
        let addModal = null;
        
        // 延迟初始化Bootstrap组件
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof bootstrap !== 'undefined') {
                addModal = new bootstrap.Modal('#addModal');
            }
            loadData();
            setupEventListeners();
        });
        const confirmAdd = document.getElementById('confirmAdd');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
        });

        // 加载数据
        async function loadData() {
            try {
                statusMsg.textContent = '正在加载数据...';
                const response = await axios.get(
                    `https://gitee.com/api/v5/repos/${giteeRepo}/contents/${jsonPath}`,
                    { headers: { 'Authorization': `token ${giteeToken}` } }
                );
                
                const content = atob(response.data.content);
                blacklistData = JSON.parse(content);
                renderTable(blacklistData);
                statusMsg.textContent = '数据加载成功';
            } catch (error) {
                console.error('加载数据失败:', error);
                statusMsg.textContent = '数据加载失败，请检查控制台';
            }
        }

        // 渲染表格
        function renderTable(data) {
            dataTable.innerHTML = '';
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" data-index="${index}"></td>
                    <td>${item.id || ''}</td>
                    <td>${item.name || ''}</td>
                    <td>${item.corp || ''}</td>
                    <td>${item.fingerprint || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-row" data-index="${index}">删除</button>
                    </td>
                `;
                dataTable.appendChild(row);
            });
        }

        // 设置事件监听
        function setupEventListeners() {
            // 搜索功能
            searchBtn.addEventListener('click', () => {
                const searchTerm = searchInput.value.toLowerCase();
                if (!searchTerm) return;
                
                const filtered = blacklistData.filter(item => 
                    (item.id && item.id.toLowerCase().includes(searchTerm)) ||
                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                    (item.corp && item.corp.toLowerCase().includes(searchTerm)) ||
                    (item.fingerprint && item.fingerprint.toLowerCase().includes(searchTerm))
                );
                renderTable(filtered);
            });

            // 重置搜索
            resetBtn.addEventListener('click', () => {
                searchInput.value = '';
                renderTable(blacklistData);
            });

            // 全选/取消全选
            selectAll.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.row-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });

            // 添加记录
            addBtn.addEventListener('click', () => {
                document.getElementById('addForm').reset();
                addModal.show();
            });

            // 确认添加
            confirmAdd.addEventListener('click', () => {
                const form = document.getElementById('addForm');
                if (!form.checkValidity()) return;
                
                const newRecord = {
                    id: form.elements.id.value,
                    name: form.elements.name.value,
                    corp: form.elements.corp.value,
                    fingerprint: form.elements.fingerprint.value
                };
                
                blacklistData.push(newRecord);
                renderTable(blacklistData);
                addModal.hide();
                statusMsg.textContent = '记录已添加 (未保存)';
            });

            // 删除选中
            deleteBtn.addEventListener('click', () => {
                const checkboxes = document.querySelectorAll('.row-checkbox:checked');
                const indexes = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
                
                // 从大到小排序，避免删除时索引变化
                indexes.sort((a, b) => b - a).forEach(i => {
                    blacklistData.splice(i, 1);
                });
                
                renderTable(blacklistData);
                selectAll.checked = false;
                statusMsg.textContent = `已删除 ${indexes.length} 条记录 (未保存)`;
            });

            // 表格行内删除按钮
            dataTable.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-row')) {
                    const index = parseInt(e.target.dataset.index);
                    blacklistData.splice(index, 1);
                    renderTable(blacklistData);
                    statusMsg.textContent = '记录已删除 (未保存)';
                }
            });

            // 保存到Gitee
            saveBtn.addEventListener('click', async () => {
                try {
                    statusMsg.textContent = '正在保存...';
                    
                    // 获取文件SHA用于更新
                    const getResponse = await axios.get(
                        `https://gitee.com/api/v5/repos/${giteeRepo}/contents/${jsonPath}`,
                        { headers: { 'Authorization': `token ${giteeToken}` } }
                    );
                    
                    const sha = getResponse.data.sha;
                    const content = JSON.stringify(blacklistData, null, 2);
                    const encodedContent = btoa(unescape(encodeURIComponent(content)));
                    
                    const updateResponse = await axios.put(
                        `https://gitee.com/api/v5/repos/${giteeRepo}/contents/${jsonPath}`,
                        {
                            message: '更新黑名单数据',
                            content: encodedContent,
                            sha: sha
                        },
                        { headers: { 'Authorization': `token ${giteeToken}` } }
                    );
                    
                    statusMsg.textContent = '保存成功';
                } catch (error) {
                    console.error('保存失败:', error);
                    statusMsg.textContent = '保存失败，请检查控制台';
                }
            });
        }
    </script>
</body>
</html>