

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kosto管理系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css?v=1.0" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js?v=1.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 移动端适配 */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 0 10px;
            }
            
            .nav-tabs .nav-link {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 14px;
            }
            
            .form-control {
                font-size: 14px;
                padding: 6px 10px;
            }
            
            .table {
                font-size: 12px;
            }
            
            .notification-container {
                right: 10px;
                max-width: 300px;
            }
            
            .modal-dialog {
                margin: 10px;
            }
            
            .search-results-container {
                max-height: 300px;
            }
        }

        /* 通知弹窗样式 */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
            font-family: Arial, sans-serif;
        }
        
        .notification {
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: white;
            display: flex;
            align-items: flex-start;
            animation: slideIn 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .notification.success {
            background-color: #4CAF50;
        }
        
        .notification.error {
            background-color: #f44336;
        }
        
        .notification.warning {
            background-color: #ff9800;
        }
        
        .notification.info {
            background-color: #2196F3;
        }
        
        .notification-icon {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .notification-content {
            flex-grow: 1;
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .notification-message {
            white-space: pre-line;
        }
        
        .notification-close {
            cursor: pointer;
            margin-left: 10px;
            font-size: 18px;
            opacity: 0.7;
        }
        
        .notification-close:hover {
            opacity: 1;
        }
        
        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.7);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 24px;
            font-weight: 600;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 16px;
            color: var(--secondary-color);
            text-align: center;
        }

        .content-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        .list-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 120px;
        }

        .list-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 120px;
            align-items: center;
        }

        .list-item:hover {
            background-color: #f8f9fa;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .block-btn {
            background-color: var(--danger-color);
            color: white;
        }

        .block-btn:hover {
            background-color: #c82333;
        }

        .open-link-btn {
            background-color: #28a745 !important;
            margin-left: 8px;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 4px;
        }

        .open-link-btn:hover {
            background-color: #218838 !important;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .refresh-btn {
            background-color: var(--success-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .refresh-btn:hover {
            background-color: #218838;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online {
            background-color: var(--success-color);
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            color: var(--secondary-color);
            font-size: 14px;
        }

        /* 日志开关浮窗样式 */
        .log-switch-container {
            position: fixed;
            top: 50%;
            right: -120px; /* 只隐藏主体部分，露出一小部分作为提示 */
            transform: translateY(-50%);
            z-index: 1000;
            background-color: white;
            border-radius: 10px 0 0 10px; /* 只在左侧显示圆角 */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 15px;
            min-width: 130px;
            text-align: center;
            transition: right 0.3s ease-out; /* 添加过渡动画 */
        }
        
        /* 鼠标悬停时显示 */
        .log-switch-container:hover {
            right: 0; /* 鼠标悬停时移到可见区域 */
        }
        
        /* 增加一个提示条，让用户知道这里有开关 */
        .log-switch-hint {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 60px;
            background-color: var(--primary-color);
            border-radius: 5px 0 0 5px;
            cursor: pointer;
        }

        .log-switch-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 14px;
        }

        .log-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .log-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .log-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .log-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .log-slider {
            background-color: var(--success-color);
        }

        input:checked + .log-slider:before {
            transform: translateX(30px);
        }

        .log-status {
            margin-top: 8px;
            font-size: 12px;
            font-weight: bold;
        }

        .log-status.on {
            color: var(--success-color);
        }

        .log-status.off {
            color: var(--danger-color);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .title {
                font-size: 20px;
            }

            .stats-container {
                flex-direction: column;
                gap: 15px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 28px;
            }

            .hidden-sm {
                display: none;
            }

            .nav-tabs {
                flex-wrap: wrap;
                gap: 5px;
                margin-bottom: 15px;
            }

            .nav-tabs button {
                padding: 8px 12px;
                font-size: 14px;
                flex: 1;
                min-width: 120px;
            }

            .card-header {
                padding: 12px 15px;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .card-body {
                padding: 15px;
            }

            .list-header {
                padding: 12px 15px;
                grid-template-columns: 1fr 1fr 80px;
                font-size: 14px;
            }

            .list-item {
                padding: 12px 15px;
                grid-template-columns: 1fr 1fr 80px;
                font-size: 14px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }

            .action-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .table-responsive {
                font-size: 14px;
            }

            th, td {
                padding: 8px 10px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 14px;
            }

            .btn-lg {
                padding: 10px 16px;
                font-size: 16px;
            }

            .d-flex.gap-3 {
                flex-direction: column;
                gap: 10px !important;
            }

            .input-group {
                width: 100% !important;
            }

            .refresh-btn {
                width: 100%;
                margin-top: 10px;
            }

            /* 最新有效用户区域优化 */
            #latestValidUser {
                font-size: 16px !important;
            }

            #latestUserFingerprint {
                font-size: 11px !important;
                line-height: 1.3;
            }

            /* 模态框优化 */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }

            .modal-body {
                padding: 15px;
            }

            .form-control {
                font-size: 16px; /* 防止iOS缩放 */
            }
        }

        @media (max-width: 480px) {
            .title {
                font-size: 18px;
            }

            .nav-tabs button {
                min-width: 100px;
                padding: 6px 8px;
                font-size: 12px;
            }

            .stat-value {
                font-size: 24px;
            }

            .list-header,
            .list-item {
                grid-template-columns: 1fr 60px;
                font-size: 13px;
            }

            .list-header div:nth-child(2),
            .list-item div:nth-child(2) {
                display: none;
            }

            .action-btn {
                font-size: 11px;
                padding: 4px 8px;
            }

            th, td {
                padding: 6px 8px;
                font-size: 13px;
            }

            .btn {
                font-size: 13px;
            }
        }

        /* 导航样式 */
        .nav-tabs {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tabs li {
            margin-bottom: -1px;
        }

        .nav-tabs button {
            padding: 10px 20px;
            text-decoration: none;
            color: var(--secondary-color);
            background: none;
            border: 1px solid transparent;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tabs button.active {
            color: var(--primary-color);
            border-color: var(--border-color) var(--border-color) white;
            background-color: white;
            font-weight: 500;
        }

        .nav-tabs button:hover {
            color: var(--primary-color);
            border-color: var(--border-color);
        }

        /* 表格样式 */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* 移动端触摸优化 */
        .action-btn, .btn {
            min-height: 44px; /* iOS推荐的最小触摸目标 */
            touch-action: manipulation; /* 防止双击缩放 */
        }

        /* 表格滚动优化 */
        .table-responsive {
            -webkit-overflow-scrolling: touch;
        }

        /* 防止文本选择影响触摸 */
        .nav-tabs button, .action-btn {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

    </style>
</head>
<body>
    <!-- 通知弹窗容器 -->
    <div class="notification-container" id="notification-container"></div>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="title">Kosto管理系统</div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <div class="input-group" style="width: 250px; min-width: 200px;">
                        <input type="password" id="giteeToken" class="form-control" placeholder="GitHub Token">
                        <button class="btn btn-secondary" type="button" id="saveTokenBtn">保存</button>
                    </div>
                    <button id="refreshBtn" class="refresh-btn">刷新数据</button>
                </div>
            </div>
        </header>

        <!-- 权限提示 -->
        <div id="permissionError" class="content-card" style="display: none;">
            <div class="card-body">
                <h2 style="color: var(--danger-color);">权限不足</h2>
                <p>您的GitHub Token没有编辑1.json的权限，请输入有效的Token。</p>
            </div>
        </div>

        <!-- 导航标签 -->
        <ul class="nav-tabs">
            <li role="presentation">
                <button class="active" id="online-tab" data-tab="online" type="button">
                    <i class="fas fa-users"></i> 在线管理
                </button>
            </li>
            <li role="presentation">
                <button id="tanknames-tab" data-tab="tanknames" type="button">
                    <i class="fas fa-id-card"></i> 白名单用户ID
                </button>
            </li>
            <li role="presentation">
                <button id="groups-tab" data-tab="groups" type="button">
                    <i class="fas fa-users"></i> 白名单军团
                </button>
            </li>
            <li role="presentation">
                <button id="ours-tab" data-tab="ours" type="button">
                    <i class="fas fa-crown"></i> 开发者ID
                </button>
            </li>
            <li role="presentation">
                <button id="ss-tab" data-tab="ss" type="button">
                    <i class="fas fa-bomb"></i> 自爆程序标志
                </button>
            </li>
            <li role="presentation">
                <button id="cookie1-tab" data-tab="cookie1" type="button">
                    <i class="fas fa-key"></i> 身份验证Cookie
                </button>
            </li>
            <li role="presentation">
                <button id="users-tab" data-tab="users" type="button">
                    <i class="fas fa-user"></i> 用户指纹数据
                </button>
            </li>
            <li role="presentation">
                <button id="blacklist-tab" data-tab="blacklist" type="button">
                    <i class="fas fa-ban"></i> 黑名单用户
                </button>
            </li>
            <li role="presentation">
                <button id="github-tab" data-tab="github" type="button">
                    <i class="fab fa-github"></i> 字典管理
                </button>
            </li>
        </ul>

        <!-- 在线管理内容 -->
        <div id="online-content" class="tab-content active">
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">当前在线人数</div>
                    <div id="currentOnline" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">今日总人数</div>
                    <div id="todayTotal" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">最新有效用户</div>
                    <div id="latestValidUser" class="stat-value" style="font-size: 18px; line-height: 1.2;">
                        <div id="latestUserName" style="color: var(--primary-color); word-break: break-all;">-</div>
                        <div id="latestUserFingerprint" style="font-size: 12px; color: var(--secondary-color); margin-top: 5px; white-space: pre-line; word-break: break-all;">-</div>
                    </div>
                </div>
                <div class="stat-card" id="progress-container" style="display: none;">
                    <div class="stat-label">数据加载进度</div>
                    <div class="progress-bar-container" style="width: 100%; height: 10px; background-color: #e0e0e0; border-radius: 5px; overflow: hidden; margin-top: 5px;">
                        <div id="progress-bar" style="width: 0%; height: 100%; background-color: var(--primary-color); transition: width 0.3s;"></div>
                    </div>
                    <div id="progress-text" style="font-size: 12px; text-align: center; margin-top: 5px;">准备加载数据...</div>
                </div>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <div>在线用户列表</div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-outline-primary" onclick="toggleSearchView(event)">
                            <i class="fas fa-search"></i> 搜索账号
                        </button>
                    </div>
                </div>
                
                <!-- 搜索区域 -->
                <div id="searchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color);">
                    <div class="input-group mb-3">
                        <input type="text" id="searchInput" class="form-control" placeholder="输入ID或用户名搜索..." onkeypress="if(event.key==='Enter') performSearch()">
                        <button class="btn btn-primary" type="button" onclick="performSearch()">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                    <div id="searchResults"></div>
                </div>
                
                <div id="onlineList">
                    <div class="list-header">
                        <div>用户名</div>
                        <div>ID</div>
                        <div class="hidden-sm">脚本名称</div>
                        <div class="hidden-sm">当前阶段</div>
                        <div class="hidden-sm">最后活动</div>
                        <div class="hidden-sm">在线时长</div>
                        <div>操作</div>
                    </div>
                    <div id="userList"></div>
                </div>
            </div>

            <div class="footer">
                <p>数据来源: <a href="https://gitee.com/Kosto179/kosto-battle-clicker-new/blob/master/log.json" target="_blank">https://gitee.com/Kosto179/kosto-battle-clicker-new/blob/master/log.json</a></p>
                <p>上次更新时间: <span id="lastUpdateTime">未更新</span></p>
            </div>
        </div>

        <!-- 白名单管理内容 -->
        <div id="tanknames-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>白名单用户ID</div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-outline-primary" onclick="toggleTableSearch('tanknames')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="toggleBatchManagement('tanknames')">
                            <i class="fas fa-tasks"></i> 批量管理
                        </button>
                        <button type="button" class="btn btn-primary" id="addTanknameBtn">
                            <i class="fas fa-plus"></i> 添加ID
                        </button>
                    </div>
                </div>
                
                <!-- 批量管理区域 -->
                <div id="tanknamesBatchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color); background-color: #f8f9fa;">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="tanknamesSelectAll" onchange="toggleSelectAll('tanknames', this.checked)">
                                <label class="form-check-label" for="tanknamesSelectAll">全选</label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelectedTanknames()">
                                <i class="fas fa-trash"></i> 删除选中
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="toggleBatchManagement('tanknames')">
                                <i class="fas fa-times"></i> 取消
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 批量管理区域 -->
                <div id="usersBatchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color); background-color: #f8f9fa;">
                    <div class="row align-items-center mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="usersSelectAll" onchange="toggleSelectAll('users', this.checked)">
                                <label class="form-check-label" for="usersSelectAll">全选</label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-success btn-sm me-2" onclick="batchAddUsers()">
                                <i class="fas fa-plus"></i> 批量添加
                            </button>
                            <button type="button" class="btn btn-danger btn-sm me-2" onclick="deleteSelectedUsers()">
                                <i class="fas fa-trash"></i> 删除选中
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="toggleBatchManagement('users')">
                                <i class="fas fa-times"></i> 取消
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <textarea id="batchUsersInput" class="form-control" rows="4" placeholder="请输入用户数据，每行一个用户，格式：用户ID,用户名&#10;例如：&#10;fingerprint123,用户A&#10;fingerprint456,用户B"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- 搜索区域 -->
                <div id="tanknamesSearchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color);">
                    <div class="input-group mb-3">
                        <input type="text" id="tanknamesSearchInput" class="form-control" placeholder="输入用户ID搜索..." onkeypress="if(event.key==='Enter') performTableSearch('tanknames')">
                        <button class="btn btn-primary" type="button" onclick="performTableSearch('tanknames')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>选择</th>
                                    <th>用户ID</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="tanknamesTableBody">
                                <!-- 白名单用户ID数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="groups-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>白名单军团</div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-outline-primary" onclick="toggleTableSearch('groups')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="toggleBatchManagement('groups')">
                            <i class="fas fa-tasks"></i> 批量管理
                        </button>
                        <button type="button" class="btn btn-primary" id="addGroupBtn">
                            <i class="fas fa-plus"></i> 添加军团
                        </button>
                    </div>
                </div>
                
                <!-- 批量管理区域 -->
                <div id="groupsBatchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color); background-color: #f8f9fa;">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="groupsSelectAll" onchange="toggleSelectAll('groups', this.checked)">
                                <label class="form-check-label" for="groupsSelectAll">全选</label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelectedGroups()">
                                <i class="fas fa-trash"></i> 删除选中
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="toggleBatchManagement('groups')">
                                <i class="fas fa-times"></i> 取消
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 批量管理区域 -->
                <div id="usersBatchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color); background-color: #f8f9fa;">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="usersSelectAll" onchange="toggleSelectAll('users', this.checked)">
                                <label class="form-check-label" for="usersSelectAll">全选</label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelectedUsers()">
                                <i class="fas fa-trash"></i> 删除选中
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="toggleBatchManagement('users')">
                                <i class="fas fa-times"></i> 取消
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 搜索区域 -->
                <div id="groupsSearchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color);">
                    <div class="input-group mb-3">
                        <input type="text" id="groupsSearchInput" class="form-control" placeholder="输入军团名称搜索..." onkeypress="if(event.key==='Enter') performTableSearch('groups')">
                        <button class="btn btn-primary" type="button" onclick="performTableSearch('groups')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>选择</th>
                                    <th>军团名称</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="groupsTableBody">
                                <!-- 组数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="ours-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>开发者ID</div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-outline-primary" onclick="toggleTableSearch('ours')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="toggleBatchManagement('ours')">
                            <i class="fas fa-tasks"></i> 批量管理
                        </button>
                        <button type="button" class="btn btn-primary" id="addOurBtn">
                            <i class="fas fa-plus"></i> 添加开发者
                        </button>
                    </div>
                </div>
                
                <!-- 批量管理区域 -->
                <div id="oursBatchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color); background-color: #f8f9fa;">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="oursSelectAll" onchange="toggleSelectAll('ours', this.checked)">
                                <label class="form-check-label" for="oursSelectAll">全选</label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelectedOurs()">
                                <i class="fas fa-trash"></i> 删除选中
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="toggleBatchManagement('ours')">
                                <i class="fas fa-times"></i> 取消
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 搜索区域 -->
                <div id="oursSearchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color);">
                    <div class="input-group mb-3">
                        <input type="text" id="oursSearchInput" class="form-control" placeholder="输入开发者ID搜索..." onkeypress="if(event.key==='Enter') performTableSearch('ours')">
                        <button class="btn btn-primary" type="button" onclick="performTableSearch('ours')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>选择</th>
                                <th>开发者ID</th>
                                <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="oursTableBody">
                                <!-- 数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="ss-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>自爆程序标志</div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-outline-primary" onclick="toggleTableSearch('ss')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <button type="button" class="btn btn-primary" id="addSsBtn">
                            <i class="fas fa-plus"></i> 添加标志
                        </button>
                    </div>
                </div>
                
                <!-- 搜索区域 -->
                <div id="ssSearchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color);">
                    <div class="input-group mb-3">
                        <input type="text" id="ssSearchInput" class="form-control" placeholder="输入标志值搜索..." onkeypress="if(event.key==='Enter') performTableSearch('ss')">
                        <button class="btn btn-primary" type="button" onclick="performTableSearch('ss')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>标志值</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="ssTableBody">
                                <!-- 数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="cookie1-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>身份验证Cookie</div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-outline-primary" onclick="toggleTableSearch('cookie1')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <button type="button" class="btn btn-primary" id="addCookie1Btn">
                            <i class="fas fa-plus"></i> 添加Cookie
                        </button>
                    </div>
                </div>
                
                <!-- 搜索区域 -->
                <div id="cookie1SearchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color);">
                    <div class="input-group mb-3">
                        <input type="text" id="cookie1SearchInput" class="form-control" placeholder="输入Cookie值搜索..." onkeypress="if(event.key==='Enter') performTableSearch('cookie1')">
                        <button class="btn btn-primary" type="button" onclick="performTableSearch('cookie1')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Cookie值</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="cookie1TableBody">
                                <!-- 数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="users-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>用户特定数据</div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-outline-primary" onclick="toggleTableSearch('users')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="toggleBatchManagement('users')">
                            <i class="fas fa-tasks"></i> 批量管理
                        </button>
                        <button type="button" class="btn btn-primary" id="addUserBtn">
                            <i class="fas fa-plus"></i> 添加用户
                        </button>
                    </div>
                </div>
                
                <!-- 搜索区域 -->
                <div id="usersSearchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color);">
                    <div class="input-group mb-3">
                        <input type="text" id="usersSearchInput" class="form-control" placeholder="输入用户ID或名称搜索..." onkeypress="if(event.key==='Enter') performTableSearch('users')">
                        <button class="btn btn-primary" type="button" onclick="performTableSearch('users')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="usersHeaderSelectAll" onchange="toggleSelectAll('users', this.checked)" style="display: none;"></th>
                                <th>ID</th>
                                <th>名称</th>
                                <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- 用户数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 黑名单管理内容 -->
        <div id="blacklist-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>黑名单用户</div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-outline-primary" onclick="toggleTableSearch('blacklist')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="toggleBatchManagement('blacklist')">
                            <i class="fas fa-tasks"></i> 批量管理
                        </button>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBlacklistModal">
                            <i class="fas fa-plus"></i> 添加黑名单用户
                        </button>
                    </div>
                </div>
                
                <!-- 批量管理区域 -->
                <div id="blacklistBatchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color); background-color: #f8f9fa;">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="blacklistSelectAll" onchange="toggleSelectAll('blacklist', this.checked)">
                                <label class="form-check-label" for="blacklistSelectAll">全选</label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelectedBlacklist()">
                                <i class="fas fa-trash"></i> 删除选中
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="toggleBatchManagement('blacklist')">
                                <i class="fas fa-times"></i> 取消
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 搜索区域 -->
                <div id="blacklistSearchArea" style="display: none; padding: 15px; border-bottom: 1px solid var(--border-color);">
                    <div class="input-group mb-3">
                        <input type="text" id="blacklistSearchInput" class="form-control" placeholder="输入用户ID、名称或军团搜索..." onkeypress="if(event.key==='Enter') performTableSearch('blacklist')">
                        <button class="btn btn-primary" type="button" onclick="performTableSearch('blacklist')">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="blacklistHeaderSelectAll" onchange="toggleSelectAll('blacklist', this.checked)" style="display: none;"></th>
                                <th>用户ID</th>
                                <th>用户名称</th>
                                <th>用户军团</th>
                                <th>用户指纹</th>
                                <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="blacklistTableBody">
                <!-- 黑名单数据将通过JS动态加载 -->
                <tr id="default-blacklist-user">
                    <td>BLOCKED_USER_123</td>
                    <td>已拉黑用户</td>
                    <td>[黑名单军团]</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-blacklist" data-index="default">编辑</button>
                        <button class="btn btn-sm btn-danger delete-blacklist" data-index="default">删除</button>
                    </td>
                </tr>
            </tbody>
        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- GitHub文件编辑内容 -->
        <div id="github-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>字典编辑</div>
                </div>
                <div class="card-body" style="padding: 0; height: 480px;">
                    <iframe id="external-frame" 
                            style="width: 100%; height: 100%; border: none;"
                            sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                            src="https://kosto179cn.github.io/Dictionaryeditor.html"
                            allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js?v=1.0"></script>
    <script src="游戏链接验证器.js"></script>
    <script>
        // 通知弹窗系统
        const notificationSystem = {
            container: null,
            
            // 初始化通知系统
            init: function() {
                this.container = document.getElementById('notification-container');
                if (!this.container) {
                    this.container = document.createElement('div');
                    this.container.id = 'notification-container';
                    this.container.className = 'notification-container';
                    document.body.appendChild(this.container);
                }
            },
            
            // 创建通知
            create: function(options) {
                // 确保容器已初始化
                if (!this.container) this.init();
                
                const defaults = {
                    type: 'info',  // success, error, warning, info
                    title: '',
                    message: '',
                    duration: 5000, // 毫秒，0表示不自动关闭
                    closable: true
                };
                
                const settings = { ...defaults, ...options };
                
                // 创建通知元素
                const notification = document.createElement('div');
                notification.className = `notification ${settings.type}`;
                
                // 添加图标
                const iconElement = document.createElement('div');
                iconElement.className = 'notification-icon';
                
                switch (settings.type) {
                    case 'success':
                        iconElement.innerHTML = '✓';
                        break;
                    case 'error':
                        iconElement.innerHTML = '✗';
                        break;
                    case 'warning':
                        iconElement.innerHTML = '⚠';
                        break;
                    case 'info':
                    default:
                        iconElement.innerHTML = 'ℹ';
                        break;
                }
                
                notification.appendChild(iconElement);
                
                // 添加内容
                const contentElement = document.createElement('div');
                contentElement.className = 'notification-content';
                
                if (settings.title) {
                    const titleElement = document.createElement('div');
                    titleElement.className = 'notification-title';
                    titleElement.textContent = settings.title;
                    contentElement.appendChild(titleElement);
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = 'notification-message';
                messageElement.textContent = settings.message;
                contentElement.appendChild(messageElement);
                
                notification.appendChild(contentElement);
                
                // 添加关闭按钮
                if (settings.closable) {
                    const closeElement = document.createElement('div');
                    closeElement.className = 'notification-close';
                    closeElement.innerHTML = '×';
                    closeElement.addEventListener('click', () => this.close(notification));
                    notification.appendChild(closeElement);
                }
                
                // 添加进度条（如果设置了自动关闭）
                if (settings.duration > 0) {
                    const progressElement = document.createElement('div');
                    progressElement.className = 'notification-progress';
                    progressElement.style.width = '100%';
                    notification.appendChild(progressElement);
                    
                    // 动画进度条
                    progressElement.style.transition = `width ${settings.duration}ms linear`;
                    setTimeout(() => {
                        progressElement.style.width = '0%';
                    }, 10);
                    
                    // 设置自动关闭
                    setTimeout(() => {
                        this.close(notification);
                    }, settings.duration);
                }
                
                // 添加到容器
                this.container.appendChild(notification);
                
                return notification;
            },
            
            // 关闭通知
            close: function(notification) {
                notification.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            },
            
            // 快捷方法
            success: function(message, title = '成功', duration = 3000) {
                return this.create({
                    type: 'success',
                    title: title,
                    message: message,
                    duration: duration
                });
            },
            
            error: function(message, title = '错误', duration = 5000) {
                // 检查是否是特定的"请先设置Gitee Token"错误消息
                if (message === '请先设置Gitee Token才能获取在线人数') {
                    // 使用sessionStorage记录是否已经显示过（每次会话只显示一次）
                    const tokenErrorShown = sessionStorage.getItem('giteeTokenErrorShown');
                    if (tokenErrorShown === 'true') {
                        return null; // 本次会话已经显示过，不再显示
                    }
                    // 标记为本次会话已显示
                    sessionStorage.setItem('giteeTokenErrorShown', 'true');
                }
                
                return this.create({
                    type: 'error',
                    title: title,
                    message: message,
                    duration: duration
                });
            },
            
            warning: function(message, title = '警告', duration = 4000) {
                return this.create({
                    type: 'warning',
                    title: title,
                    message: message,
                    duration: duration
                });
            },
            
            info: function(message, title = '信息', duration = 3000) {
                return this.create({
                    type: 'info',
                    title: title,
                    message: message,
                    duration: duration
                });
            }
        };
        
        // 初始化通知系统
        document.addEventListener('DOMContentLoaded', () => {
            notificationSystem.init();
        });
        
        // 替换原生alert函数
        const originalAlert = window.alert;
        window.alert = function(message) {
            notificationSystem.info(message);
            // 如果需要保留原始alert行为，可以取消下面的注释
            // originalAlert(message);
        };
        // API配置 - 更新为GitHub链接
        const API_CONFIG = {
            whitelist: 'https://gitee.com/api/v5/repos/Kosto179/kosto/contents/json/1.json',
            updateLog: 'https://gitee.com/api/v5/repos/Kosto179/kosto-battle-clicker-new/contents/log.json'
        };

        // 配置
        const CONFIG = {
            LOG_URL: API_CONFIG.updateLog,
            WHITELIST_URL: API_CONFIG.whitelist,
            ONLINE_THRESHOLD_MINUTES: 2.5, // 2分半内有活动视为在线
            REFRESH_INTERVAL_MS: 10000, // 自动刷新间隔(毫秒) - 改为10秒
        };

        // 存储白名单数据
        let whitelistData = [];
        const TANKNAMES_INDEX = 0; // 白名单用户ID在JSON中的索引
        const GROUPS_INDEX = 1;   // 组数据在JSON中的索引
        const OURS_INDEX = 2;     // 开发者ID在JSON中的索引
        const SS_INDEX = 3;       // 自爆程序标志在JSON中的索引
        const COOKIE1_INDEX = 4;  // 身份验证Cookie在JSON中的索引
        const USERS_INDEX = 5;    // 用户数据在JSON中的索引
        const BLACKLIST_INDEX = 6; // 黑名单数据在JSON中的索引
        const LOG_SWITCH_INDEX = 7; // 日志开关在JSON中的索引

        // DOM元素
        const tanknamesTableBody = document.getElementById('tanknamesTableBody');
        const groupsTableBody = document.getElementById('groupsTableBody');
        const oursTableBody = document.getElementById('oursTableBody');
        const ssTableBody = document.getElementById('ssTableBody');
        const cookie1TableBody = document.getElementById('cookie1TableBody');
        const usersTableBody = document.getElementById('usersTableBody');
        const blacklistTableBody = document.getElementById('blacklistTableBody');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const permissionError = document.getElementById('permissionError');

        // 存储拉黑名单(基于指纹)
        let blockedFingerprints = new Set();

        // 导航标签切换
        document.querySelectorAll('.nav-tabs button').forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有活动状态
                document.querySelectorAll('.nav-tabs button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });

                // 设置当前活动状态
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-content`).style.display = 'block';
                
                // 处理标签页切换的特殊逻辑
                handleTabSwitch(tabId);
            });
        });

        // 标签页切换时的特殊处理
        function handleTabSwitch(tabId) {
            if (tabId === 'validation') {
                // 切换到验证日志标签时，刷新日志显示
                setTimeout(() => {
                    if (window.gameLinkValidator) {
                        renderValidationLogs();
                    }
                }, 100);
            } else if (tabId === 'test') {
                // 切换到测试标签时，显示提示信息
                setTimeout(() => {
                    showValidationMessage('测试功能已加载，您可以运行各种验证测试', 'success');
                }, 100);
            }
        }

        // 获取数据的通用函数
        async function fetchData(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    // 检查是否是Gitee API URL，如果是则添加access_token
                    let finalUrl = url;
                    if (url.includes('gitee.com/api/v5/repos')) {
                        const token = loadToken();
                        if (!token) {
                            notificationSystem.error('请先设置Gitee Token才能获取在线人数', '未设置Token');
                            return false;
                        }
                        if (token) {
                            finalUrl = url.includes('?') ? `${url}&access_token=${token}` : `${url}?access_token=${token}`;
                        }
                    }
                    
                    const response = await fetch(finalUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                        cache: 'no-cache'
                    });
                    
                    if (!response.ok) {
                        if (response.status === 403) {
                            throw new Error('API频率限制已超出，请等待一段时间后再试');
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // 如果是 Gitee API 响应，需要解码 base64 内容
                    // 检查是否是 allorigins 代理格式
                    if (data.content) {
                        // Gitee API返回base64编码的内容，需要解码
                        // 正确处理UTF-8编码，防止中文乱码
                        const base64Content = data.content.replace(/\s/g, ''); // 移除空白字符
                        const binaryString = atob(base64Content);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        const decoder = new TextDecoder('utf-8');
                        const decodedContent = decoder.decode(bytes);
                        return JSON.parse(decodedContent);
                    }
                    
                    // 如果是直接的 JSON 数据
                    return data;
            } catch (error) {
                
                console.error('Gitee API错误:', error);
                notificationSystem.error(`Gitee操作失败: ${error.message}\\n\\n请检查：\\n1. Token是否有效\\n2. Token是否有repo权限\\n3. 仓库名称是否正确`, '错误');
                return false;
            }
            }
        }

        // 从本地存储加载拉黑名单
        function loadBlockedUsers() {
            const saved = localStorage.getItem('blockedFingerprints');
            if (saved) {
                blockedFingerprints = new Set(JSON.parse(saved));
            }
        }

        // 保存拉黑名单到本地存储
        function saveBlockedUsers() {
            localStorage.setItem('blockedFingerprints', JSON.stringify([...blockedFingerprints]));
        }

        // 拉黑用户
        async function blockUser(fingerprint, username) {
            if (confirm(`确定要拉黑用户 ${username} 吗？`)) {
                try {
                    // 添加到本地拉黑集合
                    blockedFingerprints.add(fingerprint);
                    saveBlockedUsers();
                    
                    // 获取用户详细信息
                    const userDetail = window.userDetails && window.userDetails[fingerprint];
                    
                    // 确保黑名单数组存在
                    if (!whitelistData[BLACKLIST_INDEX]) {
                        whitelistData[BLACKLIST_INDEX] = [];
                    }
                    
                    // 检查是否已存在于黑名单中（更宽松的匹配）
                    const exists = whitelistData[BLACKLIST_INDEX].some(blackUser => 
                        blackUser.id === (userDetail?.getid || fingerprint) || 
                        blackUser.id === fingerprint ||
                        blackUser.fingerprint === fingerprint ||
                        (blackUser.name && userDetail?.username && blackUser.name === userDetail.username)
                    );
                    
                    if (!exists) {
                        // 添加到黑名单数组
                        const blacklistEntry = {
                            id: userDetail?.getid || fingerprint,
                            name: username === '未知用户' ? (userDetail?.username || 'unknown') : username,
                            corp: '',
                            fingerprint: fingerprint,
                            blockedAt: new Date().toISOString()
                        };
                        
                        whitelistData[BLACKLIST_INDEX].push(blacklistEntry);
                        
                        // 立即保存到服务器
                        const jsonContent = JSON.stringify(whitelistData, null, 2);
                        const success = await updateGitHubFile(jsonContent);
                        
                        if (success) {
                            notificationSystem.success(`用户 ${username} 已成功拉黑并上传到服务器！`, '操作成功');
                            // 刷新黑名单表格显示
                            renderBlacklistTable();
                        } else {
                            notificationSystem.warning(`用户 ${username} 已本地拉黑，但上传到服务器失败，请稍后手动保存。`, '部分成功');
                        }
                    } else {
                        notificationSystem.info(`用户 ${username} 已在黑名单中！`, '提示信息');
                    }
                    
                    // 刷新在线数据显示
                    fetchOnlineData();
                } catch (error) {
                    console.error('拉黑用户失败:', error);
                    notificationSystem.error(`拉黑用户失败: ${error.message}`, '操作失败');
                }
            }
        }

        // 格式化时间
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 计算在线时长(分钟)
        function calculateOnlineTime(onlineTimeSeconds) {
            return Math.round(onlineTimeSeconds / 60);
        }

        // 高亮搜索关键词
        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm || !text) return text;
            
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<strong class="text-warning">$1</strong>');
        }

        // 精确计算时间差 - 年、月、日、时、分、秒
        function getPreciseTimeDifference(timestamp) {
            const now = new Date();
            const recordTime = new Date(timestamp);
            const diffMs = now - recordTime;
            
            if (diffMs < 0) return '未来时间';
            if (diffMs < 1000) return '刚刚';
            
            // 计算各个时间单位
            const seconds = Math.floor(diffMs / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const months = Math.floor(days / 30);
            const years = Math.floor(months / 12);
            
            // 计算剩余时间
            const remainingMonths = months % 12;
            const remainingDays = days % 30;
            const remainingHours = hours % 24;
            const remainingMinutes = minutes % 60;
            const remainingSeconds = seconds % 60;
            
            // 构建精确时间字符串
            const parts = [];
            
            if (years > 0) parts.push(`${years}年`);
            if (remainingMonths > 0) parts.push(`${remainingMonths}个月`);
            if (remainingDays > 0) parts.push(`${remainingDays}天`);
            if (remainingHours > 0) parts.push(`${remainingHours}小时`);
            if (remainingMinutes > 0) parts.push(`${remainingMinutes}分钟`);
            if (remainingSeconds > 0 && parts.length < 3) parts.push(`${remainingSeconds}秒`);
            
            return parts.length > 0 ? parts.join('') + '前' : '刚刚';
        }

        // 处理数据
        function processData(data) {
            if (!data || !Array.isArray(data)) {
                console.error('数据格式无效');
                return { currentOnlineUsers: [], todayTotalUsers: 0, latestValidUser: null, blockedUsers: [] };
            }

            const now = new Date();
            const offlineThresholdAgo = new Date(now.getTime() - CONFIG.ONLINE_THRESHOLD_MINUTES * 60000);
            const todayStart = new Date(now);
            todayStart.setHours(0, 0, 0, 0);

            // 筛选今日数据 - 兼容新旧数据格式
            const todayData = data.filter(item => {
                const timestamp = item.time || item.timestamp;
                return timestamp && new Date(timestamp) >= todayStart;
            });
            
            // 设置为全局变量供搜索功能使用
            window.todayData = todayData;
            window.allData = data; // 存储所有数据供搜索使用

            // 获取今日所有唯一用户(基于fingerprint)
            const todayUsers = new Set(todayData.map(item => item.fingerprint || item.username));
            
            // 统计每个用户登录的不同ID数量
            const userIdStats = new Map();
            todayData.forEach(item => {
                const fingerprint = item.fingerprint || item.username;
                const userId = item.getid || item.details?.getid || '未知ID';
                
                if (!userIdStats.has(fingerprint)) {
                    userIdStats.set(fingerprint, {
                        fingerprint: fingerprint,
                        userIds: new Set(),
                        usernames: new Set(),
                        latestData: item
                    });
                }
                
                userIdStats.get(fingerprint).userIds.add(userId);
                userIdStats.get(fingerprint).usernames.add(item.username || '未知用户');
                // 保持最新的数据
                if (new Date(item.timestamp) > new Date(userIdStats.get(fingerprint).latestData.timestamp)) {
                    userIdStats.get(fingerprint).latestData = item;
                }
            });

            // 筛选在线用户（5分钟内有活动）
            const onlineUsers = data.filter(item => {
                const timestamp = item.time || item.timestamp;
                const entryTime = new Date(timestamp);
                const fingerprint = item.fingerprint || item.username;
                return entryTime >= offlineThresholdAgo && !blockedFingerprints.has(fingerprint);
            });

            // 筛选被拉黑的在线用户
            const blockedUsers = data.filter(item => {
                const timestamp = item.time || item.timestamp;
                const entryTime = new Date(timestamp);
                const fingerprint = item.fingerprint || item.username;
                return entryTime >= offlineThresholdAgo && blockedFingerprints.has(fingerprint);
            });

            // 按fingerprint分组并获取每个用户的最后活动记录
            const userGroups = new Map();
            onlineUsers.forEach(item => {
                const fingerprint = item.fingerprint || item.username;
                if (!userGroups.has(fingerprint) || new Date(item.timestamp) > new Date(userGroups.get(fingerprint).timestamp)) {
                    userGroups.set(fingerprint, item);
                }
            });

            // 将userIdStats设为全局变量，供多ID统计使用
            window.userIdStats = userIdStats;

            // 转换为数组并排序(按最后活动时间降序)
            const currentOnlineUsers = Array.from(userGroups.values()).sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            
            // 处理被拉黑的用户
            const blockedUserGroups = new Map();
            blockedUsers.forEach(item => {
                const fingerprint = item.fingerprint || item.username;
                if (!blockedUserGroups.has(fingerprint) || new Date(item.timestamp) > new Date(blockedUserGroups.get(fingerprint).timestamp)) {
                    blockedUserGroups.set(fingerprint, item);
                }
            });
            
            // 转换为数组并排序
            const blockedOnlineUsers = Array.from(blockedUserGroups.values()).sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            // 查找最新的有效用户（getid不等于unknown，不考虑是否在线）
            let latestValidUser = null;
            const validUsers = data.filter(user => 
                user.getid && user.getid.toLowerCase() !== 'unknown'
            );
            
            if (validUsers.length > 0) {
                // 按时间排序，取最新的
                latestValidUser = validUsers.sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                )[0];
            }

            return {
                currentOnlineUsers,
                todayTotalUsers: todayUsers.size,
                latestValidUser,
                blockedOnlineUsers
            };
        }

        // 渲染用户列表
        function renderUserList(users, blockedUsers = []) {
            const userListElement = document.getElementById('userList');
            userListElement.innerHTML = '';

            // 添加在线用户
            if (users.length === 0 && blockedUsers.length === 0) {
                userListElement.innerHTML = '<div class="list-item"><div colspan="5">当前没有在线用户</div></div>';
                return;
            }

            // 检查日志开关状态
            const logSwitchEnabled = whitelistData[LOG_SWITCH_INDEX] && whitelistData[LOG_SWITCH_INDEX][0] === "OK";

            // 添加在线用户标题
            if (users.length > 0) {
                const onlineHeader = document.createElement('div');
                onlineHeader.className = 'list-item';
                onlineHeader.style.backgroundColor = '#e9ecef';
                onlineHeader.style.fontWeight = 'bold';
                onlineHeader.innerHTML = '<div colspan="5">在线用户</div>';
                userListElement.appendChild(onlineHeader);
                
                users.forEach((user, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';

                    const timestamp = user.time || user.timestamp;
                    const lastActiveTime = formatTime(timestamp);
                    const onlineTime = calculateOnlineTime(user.details?.onlineTime || 0);

                    const fingerprint = user.fingerprint || user.username;
                    
                    // 根据指纹从白名单数据里获取对应的用户名
                    let displayUsername = user.username || '未知用户';
                    if (whitelistData[USERS_INDEX]) {
                        const matchedUser = whitelistData[USERS_INDEX].find(whiteUser => 
                            whiteUser.id === fingerprint
                        );
                        if (matchedUser && matchedUser.name) {
                            displayUsername = matchedUser.name;
                        }
                    }
                    
                    // 处理用户名显示问题
                    if (displayUsername.toLowerCase() === 'unknown' || displayUsername === '未知用户') {
                        displayUsername = user.fingerprint || '未知用户';
                    }
                    const userId = fingerprint;
                    
                    // 存储用户数据到全局对象
                    window.userDetails = window.userDetails || {};
                    window.userDetails[userId] = user;
                    
                    // 检查是否包含可打开的链接
                    const hasOpenableLink = checkForOpenableLink(user.details);
                    const openButtonHtml = hasOpenableLink ? 
                        `<button class="action-btn open-link-btn" onclick="openUserLink('${userId}')">打开</button>` : '';
                    
                    const scriptName = user.scriptName || '未知脚本';
                    const phase = user.phase || '未知阶段';
                    const onlineDuration = user.onlineDurationText || (calculateOnlineTime(user.details?.onlineTime || 0) + '分钟');
                    
                    // 根据日志开关状态决定显示内容
                    if (logSwitchEnabled) {
                        // 日志开关开启时 - 显示完整信息
                        listItem.innerHTML = `
                            <div><span class="status-indicator status-online"></span>${displayUsername} <span class="badge bg-primary ms-2">索引: ${index + 1}</span></div>
                            <div>${user.getid || '未知'}</div>
                            <div class="hidden-sm">${scriptName}</div>
                            <div class="hidden-sm">${phase}</div>
                            <div class="hidden-sm">${lastActiveTime}</div>
                            <div class="hidden-sm">${onlineDuration}</div>
                            <div class="user-actions">
                                <button class="action-btn btn-info" onclick="showUserDetails('${userId}')">详情</button>
                                <button class="action-btn block-btn" onclick="blockUser('${fingerprint}', '${displayUsername}')">拉黑</button>
                                ${openButtonHtml}
                            </div>
                        `;
                    } else {
                        // 日志开关关闭时 - 隐藏在线状态和在线时长
                        listItem.innerHTML = `
                            <div>${displayUsername} <span class="badge bg-primary ms-2">索引: ${index + 1}</span></div>
                            <div>${user.getid || '未知'}</div>
                            <div class="hidden-sm">${scriptName}</div>
                            <div class="hidden-sm">${phase}</div>
                            <div class="hidden-sm">${lastActiveTime}</div>
                            <div></div>
                            <div class="user-actions">
                                <button class="action-btn btn-info" onclick="showUserDetails('${userId}')">详情</button>
                                <button class="action-btn block-btn" onclick="blockUser('${fingerprint}', '${displayUsername}')">拉黑</button>
                                ${openButtonHtml}
                            </div>
                        `;
                    }
                    userListElement.appendChild(listItem);
                });
            }
            
            // 添加已拉黑用户
            if (blockedUsers.length > 0) {
                const blockedHeader = document.createElement('div');
                blockedHeader.className = 'list-item';
                blockedHeader.style.backgroundColor = '#f8d7da';
                blockedHeader.style.fontWeight = 'bold';
                blockedHeader.innerHTML = '<div colspan="5">已拉黑用户</div>';
                userListElement.appendChild(blockedHeader);
                
                blockedUsers.forEach(user => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    listItem.style.backgroundColor = '#fff3f5';

                    const lastActiveTime = formatTime(user.timestamp);
                    const onlineTime = calculateOnlineTime(user.details?.onlineTime || 0);

                    // 处理用户名显示问题
                    const fingerprint = user.fingerprint || user.username;
                    
                    // 根据指纹从白名单数据里获取对应的用户名
                    let displayUsername = user.username || '未知用户';
                    if (whitelistData && whitelistData[USERS_INDEX]) {
                        const matchedUser = whitelistData[USERS_INDEX].find(whiteUser => 
                            whiteUser.id === fingerprint
                        );
                        if (matchedUser && matchedUser.name) {
                            displayUsername = matchedUser.name;
                        }
                    }
                    
                    // 处理用户名显示问题
                    if (displayUsername.toLowerCase() === 'unknown' || displayUsername === '未知用户') {
                        displayUsername = user.fingerprint || '未知用户';
                    }
                    const userId = fingerprint;
                    
                    // 存储用户数据到全局对象
                    window.userDetails = window.userDetails || {};
                    window.userDetails[userId] = user;
                    
                    const scriptName = user.scriptName || '未知脚本';
                    const phase = user.phase || '未知阶段';
                    const onlineDuration = user.onlineDurationText || (calculateOnlineTime(user.details?.onlineTime || 0) + '分钟');
                    
                    // 根据日志开关状态决定显示内容
                    if (logSwitchEnabled) {
                        // 日志开关开启时 - 显示完整信息
                        listItem.innerHTML = `
                            <div><span class="status-indicator" style="background-color: #dc3545;"></span>${displayUsername} <span class="badge bg-danger">已拉黑</span> <span class="badge bg-secondary ms-1">索引: ${index + 1}</span></div>
                            <div>${user.getid || '未知'}</div>
                            <div class="hidden-sm">${scriptName}</div>
                            <div class="hidden-sm">${phase}</div>
                            <div class="hidden-sm">${lastActiveTime}</div>
                            <div class="hidden-sm">${onlineDuration}</div>
                            <div class="user-actions">
                                <button class="action-btn btn-info" onclick="showUserDetails('${userId}')">详情</button>
                                <button class="action-btn btn-success" onclick="unblockUser('${fingerprint}', '${displayUsername}')">解除拉黑</button>
                            </div>
                        `;
                    } else {
                        // 日志开关关闭时 - 隐藏在线状态和在线时长
                        listItem.innerHTML = `
                            <div>${displayUsername} <span class="badge bg-danger">已拉黑</span> <span class="badge bg-secondary ms-1">索引: ${index + 1}</span></div>
                            <div>${user.getid || '未知'}</div>
                            <div class="hidden-sm">${scriptName}</div>
                            <div class="hidden-sm">${phase}</div>
                            <div class="hidden-sm">${lastActiveTime}</div>
                            <div></div>
                            <div class="user-actions">
                                <button class="action-btn btn-info" onclick="showUserDetails('${userId}')">详情</button>
                                <button class="action-btn btn-success" onclick="unblockUser('${fingerprint}', '${displayUsername}')">解除拉黑</button>
                            </div>
                        `;
                    }
                    userListElement.appendChild(listItem);
                });
            }
        }

        // 更新统计信息
        function updateStats(currentOnline, todayTotal, latestValidUser) {
            const currentOnlineEl = document.getElementById('currentOnline');
            const todayTotalEl = document.getElementById('todayTotal');
            const lastUpdateTimeEl = document.getElementById('lastUpdateTime');
            
            if (currentOnlineEl) currentOnlineEl.textContent = currentOnline;
            if (todayTotalEl) todayTotalEl.textContent = todayTotal;
            if (lastUpdateTimeEl) lastUpdateTimeEl.textContent = new Date().toLocaleString('zh-CN');
            
            // 更新最新有效用户信息
            const latestUserNameElement = document.getElementById('latestUserName');
            const latestUserFingerprintElement = document.getElementById('latestUserFingerprint');
            
            if (latestValidUser) {
                let displayUsername = latestValidUser.username;
                // 如果用户名为unknown或未知用户，则显示指纹
                if (displayUsername && (displayUsername.toLowerCase() === 'unknown' || displayUsername === '未知用户')) {
                    displayUsername = latestValidUser.fingerprint || '未知用户';
                }
                
                if (latestUserNameElement) {
                    latestUserNameElement.textContent = `${displayUsername} (${latestValidUser.getid})`;
                }
                
                // 构建指纹显示文本，包含最后活动时间
                let fingerprintText = `指纹: ${latestValidUser.fingerprint || '无'}`;
                const latestTimestamp = latestValidUser.time || latestValidUser.timestamp;
                fingerprintText += `\n最后活动: ${formatTime(latestTimestamp)}`;
                
                // 与用户指纹数据进行比对
                if (latestValidUser.fingerprint && whitelistData[USERS_INDEX]) {
                    const matchedUser = whitelistData[USERS_INDEX].find(user => 
                        user.id === latestValidUser.fingerprint
                    );
                    
                    if (matchedUser) {
                        fingerprintText += `\n用户名称："${matchedUser.name}"`;
                    }
                }
                
                if (latestUserFingerprintElement) {
                    latestUserFingerprintElement.textContent = fingerprintText;
                }
            } else {
                if (latestUserNameElement) {
                    latestUserNameElement.textContent = '暂无';
                }
                if (latestUserFingerprintElement) {
                    latestUserFingerprintElement.textContent = '指纹: -';
                }
            }
        }

        // 获取在线数据
        function ensureTodaySection() {
            const onlineContent = document.getElementById('online-content');
            if (!onlineContent) return null;
            let section = document.getElementById('todayUsersSection');
            if (!section) {
                section = document.createElement('div');
                section.id = 'todayUsersSection';
                section.className = 'card';
                section.innerHTML = `
                    <div class="card-header">
                        <div>今日在线名单（含已离线）</div>
                        <div class="header-actions">
                            <small id="todayUsersCount" style="color:#6c757d"></small>
                        </div>
                    </div>
                    <div class="list-header hidden-sm">
                        <div>用户名</div>
                        <div>指纹/getid</div>
                        <div class="hidden-sm">最后活动</div>
                        <div class="hidden-sm">状态</div>
                        <div>操作</div>
                    </div>
                    <div id="todayUserList" class="list-container"></div>
                `;
                onlineContent.appendChild(section);
            }
            return section;
        }

        function computeTodayAllUsers(data) {
            try {
                const now = new Date();
                const todayStart = new Date(now);
                todayStart.setHours(0, 0, 0, 0);
                const todayData = (data || []).filter(item => {
                    const t = item.time || item.timestamp;
                    return t && new Date(t) >= todayStart;
                });
                
                // 按用户分组并按时间排序
                const userGroups = new Map();
                todayData.forEach(item => {
                    const fingerprint = item.fingerprint || item.username;
                    if (!fingerprint) return;
                    
                    if (!userGroups.has(fingerprint)) {
                        userGroups.set(fingerprint, []);
                    }
                    userGroups.get(fingerprint).push(item);
                });
                
                const result = [];
                userGroups.forEach((items, fingerprint) => {
                    // 按时间排序
                    items.sort((a, b) => new Date(a.time || a.timestamp) - new Date(b.time || b.timestamp));
                    
                    let totalOnlineMs = 0;
                    let sessionCount = 0;
                    let lastOnlineMs = 0;
                    
                    // 根据指纹查找在线时长在00:00:00-00:00:10范围内的记录数量作为登录次数
                    const shortSessionRecords = items.filter(item => {
                        let currentOnlineMs = 0;
                        if (item.details && typeof item.details.onlineTime === 'number') {
                            currentOnlineMs = item.details.onlineTime * 1000;
                        } else if (item.onlineDurationMs && typeof item.onlineDurationMs === 'number') {
                            currentOnlineMs = item.onlineDurationMs;
                        } else if (item.onlineDurationText) {
                            // 解析 HH:MM:SS 格式
                            const match = item.onlineDurationText.match(/(\d+):(\d+):(\d+)/);
                            if (match) {
                                const hours = parseInt(match[1], 10);
                                const minutes = parseInt(match[2], 10);
                                const seconds = parseInt(match[3], 10);
                                currentOnlineMs = (hours * 3600 + minutes * 60 + seconds) * 1000;
                            }
                        }
                        // 检查在线时长是否在0-10秒范围内
                        return currentOnlineMs >= 0 && currentOnlineMs <= 10000;
                    });
                    
                    // 设置登录次数为短会话记录的数量
                    sessionCount = shortSessionRecords.length;
                    
                    // 如果没有短会话记录但有其他记录，至少算一次登录
                    if (sessionCount === 0 && items.length > 0) {
                        sessionCount = 1;
                    }
                    
                    // 计算总在线时长
                    items.forEach((item, index) => {
                        // 获取当前记录的在线时长（毫秒）
                        let currentOnlineMs = 0;
                        if (item.details && typeof item.details.onlineTime === 'number') {
                            currentOnlineMs = item.details.onlineTime * 1000;
                        } else if (item.onlineDurationMs && typeof item.onlineDurationMs === 'number') {
                            currentOnlineMs = item.onlineDurationMs;
                        } else if (item.onlineDurationText) {
                            // 解析 HH:MM:SS 格式
                            const match = item.onlineDurationText.match(/(\d+):(\d+):(\d+)/);
                            if (match) {
                                const hours = parseInt(match[1], 10);
                                const minutes = parseInt(match[2], 10);
                                const seconds = parseInt(match[3], 10);
                                currentOnlineMs = (hours * 3600 + minutes * 60 + seconds) * 1000;
                            }
                        }
                        
                        totalOnlineMs += currentOnlineMs;
                    });
                    
                    // 使用最新的记录信息
                    const latestItem = items[items.length - 1];
                    result.push({
                        fingerprint,
                        username: latestItem.username || fingerprint,
                        getid: latestItem.getid,
                        timestamp: latestItem.time || latestItem.timestamp,
                        details: latestItem.details || {},
                        onlineDurationText: formatDuration(totalOnlineMs),
                        totalOnlineMs: totalOnlineMs,
                        phase: latestItem.phase,
                        sessionCount: sessionCount
                    });
                });
                
                return result.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } catch (e) {
                console.error('computeTodayAllUsers error', e);
                return [];
            }
        }

        // 格式化时长为 HH:MM:SS 格式
        function formatDuration(ms) {
            if (!ms || ms < 0) return '00:00:00';
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function renderTodayUserList(users) {
            ensureTodaySection();
            const listEl = document.getElementById('todayUserList');
            const countEl = document.getElementById('todayUsersCount');
            if (!listEl) return;
            listEl.innerHTML = '';
            if (countEl) countEl.textContent = `今日出现人数：${users?.length || 0}`;
            if (!users || users.length === 0) {
                listEl.innerHTML = '<div class="list-item"><div colspan="5">今日暂无用户记录</div></div>';
                return;
            }
            
            // 检查日志开关状态
            const logSwitchEnabled = whitelistData[LOG_SWITCH_INDEX] && whitelistData[LOG_SWITCH_INDEX][0] === "OK";
            
            const now = Date.now();
            users.forEach((user, index) => {
                const fingerprint = user.fingerprint || user.username;
                
                // 根据指纹从白名单数据里获取对应的用户名
                let displayUsername = user.username || '未知用户';
                if (whitelistData[USERS_INDEX]) {
                    const matchedUser = whitelistData[USERS_INDEX].find(whiteUser => 
                        whiteUser.id === fingerprint
                    );
                    if (matchedUser && matchedUser.name) {
                        displayUsername = matchedUser.name;
                    }
                }
                
                // 如果用户名为unknown或未知用户，则显示指纹
                if (displayUsername.toLowerCase() === 'unknown' || displayUsername === '未知用户') {
                    displayUsername = user.fingerprint || '未知用户';
                }
                
                const lastActiveTime = typeof formatTime === 'function' ? formatTime(user.timestamp) : (new Date(user.timestamp)).toLocaleString('zh-CN');
                const isOnline = new Date(user.timestamp) >= new Date(now - (CONFIG?.ONLINE_THRESHOLD_MINUTES || 1.5) * 60000);
                const statusHtml = isOnline ? '<span class="status-indicator status-online"></span>在线' : '<span class="status-indicator status-offline"></span>离线';
                const onlineDuration = user.onlineDurationText || (typeof calculateOnlineTime === 'function' ? (calculateOnlineTime(user.details?.onlineTime || 0) + '分钟') : '-');
                const sessionInfo = user.sessionCount > 1 ? ` (${user.sessionCount}次登录)` : '';
                const item = document.createElement('div');
                item.className = 'list-item';
                const userId = (user.fingerprint || user.username || 'unknown') + '_' + (user.getid || 'id');
                window.userDetails = window.userDetails || {};
                window.userDetails[userId] = user;
                
                // 根据日志开关状态决定显示内容
                if (logSwitchEnabled) {
                    // 日志开关开启时 - 显示完整信息
                    item.innerHTML = `
                        <div>${displayUsername}</div>
                        <div>${user.getid || '未知'}</div>
                        <div class="hidden-sm">${lastActiveTime}</div>
                        <div class="hidden-sm">${statusHtml}</div>
                        <div class="user-actions">
                            <button class="action-btn btn-info" onclick="showUserDetails('${userId}')">详情</button>
                            <small style="margin-left:8px;color:#6c757d">${onlineDuration}${sessionInfo}</small>
                        </div>
                    `;
                } else {
                    // 日志开关关闭时 - 显示登录次数而非在线状态
                    // 获取登录次数（根据指纹查找00:00:00-00:00:10的记录数量）
                    const loginCount = user.sessionCount || 0;
                    item.innerHTML = `
                        <div>${displayUsername}</div>
                        <div>${user.getid || '未知'}</div>
                        <div class="hidden-sm">${lastActiveTime}</div>
                        <div class="hidden-sm"><span class="badge bg-secondary">登录 ${loginCount} 次</span></div>
                        <div class="user-actions">
                            <button class="action-btn btn-info" onclick="showUserDetails('${userId}')">详情</button>
                        </div>
                    `;
                }
                
                listEl.appendChild(item);
            });
        }

async function fetchOnlineData() {
            try {
                // 显示进度条
                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                
                progressContainer.style.display = 'block';
                progressBar.style.width = '10%';
                progressText.textContent = '正在获取数据...';
                
                // 获取数据
                const logData = await fetchData(API_CONFIG.updateLog);
                progressBar.style.width = '30%';
                progressText.textContent = '数据获取成功，正在处理...';
                
                // 处理数据
                const { currentOnlineUsers, todayTotalUsers, latestValidUser, blockedOnlineUsers } = processData(logData);
                progressBar.style.width = '50%';
                progressText.textContent = '数据处理完成，正在渲染用户列表...';
                
                // 渲染用户列表
                renderUserList(currentOnlineUsers, blockedOnlineUsers);
                progressBar.style.width = '70%';
                progressText.textContent = '用户列表渲染完成，正在计算今日数据...';
                
                // 计算今日数据
                const todayAllUsers = computeTodayAllUsers(logData);
                progressBar.style.width = '85%';
                progressText.textContent = '今日数据计算完成，正在渲染...';
                
                // 渲染今日用户列表
                renderTodayUserList(todayAllUsers);
                progressBar.style.width = '95%';
                progressText.textContent = '今日用户列表渲染完成，正在更新统计信息...';
                
                // 更新统计信息
                updateStats(currentOnlineUsers.length, todayTotalUsers, latestValidUser);
                
                // 完成加载
                progressBar.style.width = '100%';
                progressText.textContent = '数据加载完成';
                console.log('在线数据获取成功');
                
                // 3秒后隐藏进度条
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 3000);
            } catch (error) {
                // 出错时隐藏进度条
                document.getElementById('progress-container').style.display = 'none';
                console.error('获取在线数据失败:', error);
                notificationSystem.error(`获取在线数据失败: ${error.message}`, '数据获取错误');
            }
        }

        // 渲染白名单用户ID表格
        function renderTanknamesTable() {
            const tanknames = whitelistData[TANKNAMES_INDEX] || [];
            tanknamesTableBody.innerHTML = '';
            const showCheckboxes = isBatchManagementEnabled('tanknames');

            tanknames.forEach((id, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="form-check" style="${showCheckboxes ? '' : 'display: none;'}">
                            <input type="checkbox" class="form-check-input" data-index="${index}" onchange="updateSelectAllState('tanknames')">
                        </div>
                    </td>
                    <td><span class="badge bg-secondary me-2">${index + 1}</span>${id}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editItemWithAutoSave(${TANKNAMES_INDEX}, ${index}, prompt('请输入新的白名单用户ID:', currentValue), renderTanknamesTable)">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItemWithAutoSave(${TANKNAMES_INDEX}, ${index}, renderTanknamesTable)">删除</button>
                        <button class="btn btn-sm btn-warning" onclick="blacklistItem(${TANKNAMES_INDEX}, ${index}, 'id')">拉黑</button>
                    </td>
                `;
                tanknamesTableBody.appendChild(row);
            });

            // 添加事件监听器
            document.querySelectorAll('.edit-tankname').forEach(button => {
                button.addEventListener('click', (e) => editItem(TANKNAMES_INDEX, parseInt(e.target.dataset.index), '编辑白名单用户ID'));
            });
            document.querySelectorAll('.delete-tankname').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(TANKNAMES_INDEX, parseInt(e.target.dataset.index), renderTanknamesTable));
            });
            document.querySelectorAll('.blacklist-tankname').forEach(button => {
                button.addEventListener('click', (e) => blacklistItem(TANKNAMES_INDEX, parseInt(e.target.dataset.index), 'id'));
            });
        }

        // 渲染白名单军团表格
        function renderGroupsTable() {
            const groups = whitelistData[GROUPS_INDEX] || [];
            groupsTableBody.innerHTML = '';
            const showCheckboxes = isBatchManagementEnabled('groups');

            groups.forEach((group, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="form-check" style="${showCheckboxes ? '' : 'display: none;'}">
                            <input type="checkbox" class="form-check-input" data-index="${index}" onchange="updateSelectAllState('groups')">
                        </div>
                    </td>
                    <td><span class="badge bg-secondary me-2">${index + 1}</span>${group}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editItem(${GROUPS_INDEX}, ${index}, 'Groups')">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem(${GROUPS_INDEX}, ${index}, renderGroupsTable)">删除</button>
                        <button class="btn btn-sm btn-warning" onclick="blacklistItem(${GROUPS_INDEX}, ${index}, 'corp')">拉黑</button>
                    </td>
                `;
                groupsTableBody.appendChild(row);
            });

            // 添加事件监听器
            document.querySelectorAll('.edit-group').forEach(button => {
                button.addEventListener('click', (e) => editItem(GROUPS_INDEX, parseInt(e.target.dataset.index), '编辑白名单军团'));
            });
            document.querySelectorAll('.delete-group').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(GROUPS_INDEX, parseInt(e.target.dataset.index), renderGroupsTable));
            });
            document.querySelectorAll('.blacklist-group').forEach(button => {
                button.addEventListener('click', (e) => blacklistItem(GROUPS_INDEX, parseInt(e.target.dataset.index), 'corp'));
            });
        }

        // 渲染开发者ID表格
        function renderOursTable() {
            const ours = whitelistData[OURS_INDEX] || [];
            oursTableBody.innerHTML = '';
            const showCheckboxes = isBatchManagementEnabled('ours');

            ours.forEach((id, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="form-check" style="${showCheckboxes ? '' : 'display: none;'}">
                            <input type="checkbox" class="form-check-input" data-index="${index}" onchange="updateSelectAllState('ours')">
                        </div>
                    </td>
                    <td><span class="badge bg-secondary me-2">${index + 1}</span>${id}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-our" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-our" data-index="${index}">删除</button>
                    </td>
                `;
                oursTableBody.appendChild(row);
            });

            // 添加事件监听器
            document.querySelectorAll('.edit-our').forEach(button => {
                button.addEventListener('click', (e) => editItem(OURS_INDEX, parseInt(e.target.dataset.index), '编辑开发者ID'));
            });
            document.querySelectorAll('.delete-our').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(OURS_INDEX, parseInt(e.target.dataset.index), renderOursTable));
            });
        }

        // 渲染自爆程序标志表格
        function renderSsTable() {
            const ss = whitelistData[SS_INDEX] || [];
            ssTableBody.innerHTML = '';
            const showCheckboxes = isBatchManagementEnabled('ss');

            ss.forEach((value, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="form-check" style="${showCheckboxes ? '' : 'display: none;'}">
                            <input type="checkbox" class="form-check-input" data-index="${index}" onchange="updateSelectAllState('ss')">
                        </div>
                    </td>
                    <td><span class="badge bg-secondary me-2">${index + 1}</span>${value}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-ss" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-ss" data-index="${index}">删除</button>
                    </td>
                `;
                ssTableBody.appendChild(row);
            });

            // 添加事件监听器
            document.querySelectorAll('.edit-ss').forEach(button => {
                button.addEventListener('click', (e) => editItem(SS_INDEX, parseInt(e.target.dataset.index), '编辑自爆程序标志'));
            });
            document.querySelectorAll('.delete-ss').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(SS_INDEX, parseInt(e.target.dataset.index), renderSsTable));
            });
        }

        // 渲染身份验证Cookie表格
        function renderCookie1Table() {
            const cookie1 = whitelistData[COOKIE1_INDEX] || [];
            cookie1TableBody.innerHTML = '';
            const showCheckboxes = isBatchManagementEnabled('cookie1');

            cookie1.forEach((value, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="form-check" style="${showCheckboxes ? '' : 'display: none;'}">
                            <input type="checkbox" class="form-check-input" data-index="${index}" onchange="updateSelectAllState('cookie1')">
                        </div>
                    </td>
                    <td><span class="badge bg-secondary me-2">${index + 1}</span>${value}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-cookie1" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-cookie1" data-index="${index}">删除</button>
                    </td>
                `;
                cookie1TableBody.appendChild(row);
            });

            // 添加事件监听器
            document.querySelectorAll('.edit-cookie1').forEach(button => {
                button.addEventListener('click', (e) => editItem(COOKIE1_INDEX, parseInt(e.target.dataset.index), '编辑身份验证Cookie'));
            });
            document.querySelectorAll('.delete-cookie1').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(COOKIE1_INDEX, parseInt(e.target.dataset.index), renderCookie1Table));
            });
        }

        // 渲染用户指纹数据表格

        // 渲染黑名单表格
        function renderBlacklistTable() {
            const blacklist = whitelistData[BLACKLIST_INDEX] || [];
            blacklistTableBody.innerHTML = '';
            const showCheckboxes = isBatchManagementEnabled('blacklist');
            
            // 添加默认的已拉黑用户示例
            const defaultRow = document.createElement('tr');
            defaultRow.id = 'default-blacklist-user';
            defaultRow.innerHTML = `
                <td>
                    <div class="form-check" style="${showCheckboxes ? '' : 'display: none;'}">
                        <input type="checkbox" class="form-check-input" data-index="default" onchange="updateSelectAllState('blacklist')">
                    </div>
                </td>
                <td>BLOCKED_USER_123</td>
                <td>已拉黑用户</td>
                <td>[黑名单军团]</td>
                <td>无指纹数据</td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-primary edit-blacklist" data-index="default">编辑</button>
                    <button class="btn btn-sm btn-danger delete-blacklist" data-index="default">删除</button>
                </td>
            `;
            blacklistTableBody.appendChild(defaultRow);
            
            // 如果有黑名单数据，隐藏默认示例
            if (blacklist.length > 0) {
                defaultRow.style.display = 'none';
            }

            blacklist.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="form-check" style="${showCheckboxes ? '' : 'display: none;'}">
                            <input type="checkbox" class="form-check-input" data-index="${index}" onchange="updateSelectAllState('blacklist')">
                        </div>
                    </td>
                    <td>${user.id || ''}</td>
                    <td>${user.name || ''}</td>
                    <td>${user.corp || ''}</td>
                    <td>${user.fingerprint || '无'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-blacklist" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-blacklist" data-index="${index}">删除</button>
                    </td>
                `;
                blacklistTableBody.appendChild(row);
            });

            // 使用事件委托来处理动态生成的按钮
            // 事件监听器已经在页面初始化时绑定到表格容器
        }

        // 处理添加黑名单用户
        function handleAddBlacklist() {
            const userId = document.getElementById('blacklistUserId').value.trim();
            const userName = document.getElementById('blacklistUserName').value.trim();
            const userCorp = document.getElementById('blacklistUserCorp').value.trim();
            const userFingerprint = document.getElementById('blacklistUserFingerprint').value.trim();

            // 验证至少填写一项内容
            if (!userId && !userName && !userCorp && !userFingerprint) {
                notificationSystem.warning('请至少填写一项内容（用户ID、用户名、军团或指纹）', '警告');
                return;
            }

            if (!whitelistData[BLACKLIST_INDEX]) {
                whitelistData[BLACKLIST_INDEX] = [];
            }
            addItemWithAutoSave(BLACKLIST_INDEX, {
                'id': userId,
                'name': userName,
                'corp': userCorp,
                'fingerprint': userFingerprint
            }, renderBlacklistTable);

            // 关闭模态框并重置表单
            const modalElement = document.getElementById('addBlacklistModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                modal.hide();
                
                // 手动清理残留的背景层（如果Bootstrap没有自动清理）
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 300);
            }
            document.getElementById('blacklistUserId').value = '';
            document.getElementById('blacklistUserName').value = '';
            document.getElementById('blacklistUserCorp').value = '';
            document.getElementById('blacklistUserFingerprint').value = '';
        }

        // 处理编辑黑名单用户
        function handleEditBlacklist(event) {
            const index = parseInt(event.target.dataset.index);
            const blacklist = whitelistData[BLACKLIST_INDEX] || [];
            const user = blacklist[index];

            document.getElementById('editBlacklistUserId').value = user.id || '';
            document.getElementById('editBlacklistUserName').value = user.name || '';
            document.getElementById('editBlacklistUserCorp').value = user.corp || '';
            document.getElementById('editBlacklistUserFingerprint').value = user.fingerprint || '';
            document.getElementById('editBlacklistIndex').value = index;
            const modal = new bootstrap.Modal(document.getElementById('editBlacklistModal'));
            modal.show();
        }

        // 确认编辑黑名单用户
        function handleConfirmEditBlacklist() {
            const index = parseInt(document.getElementById('editBlacklistIndex').value);
            const newUserId = document.getElementById('editBlacklistUserId').value.trim();
            const newUserName = document.getElementById('editBlacklistUserName').value.trim();
            const newUserCorp = document.getElementById('editBlacklistUserCorp').value.trim();
            const newUserFingerprint = document.getElementById('editBlacklistUserFingerprint').value.trim();
            if (!newUserId || !newUserName) return;

            editItemWithAutoSave(BLACKLIST_INDEX, index, {
                'id': newUserId,
                'name': newUserName,
                'corp': newUserCorp,
                'fingerprint': newUserFingerprint
            }, renderBlacklistTable);

            // 关闭模态框
            const modalElement = document.getElementById('editBlacklistModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                modal.hide();
                
                // 手动清理残留的背景层（如果Bootstrap没有自动清理）
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 300);
            }
        }

        // 处理删除黑名单用户
        function handleDeleteBlacklist(event) {
            const index = parseInt(event.target.dataset.index);
            if (confirm('确定要删除这个黑名单用户吗？')) {
                deleteItemWithAutoSave(BLACKLIST_INDEX, index, renderBlacklistTable);
            }
        }

        // 通用编辑函数（用于简单字符串值）- 使用模态框
        function editItem(arrayIndex, itemIndex, title) {
            const currentValue = whitelistData[arrayIndex][itemIndex];
            
            // 如果是用户数据（对象格式），使用专门的用户编辑模态框
            if (arrayIndex === USERS_INDEX && typeof currentValue === 'object') {
                editUserItem(itemIndex);
                return;
            }
            
            // 设置模态框内容
            const editItemModalLabelEl = document.getElementById('editItemModalLabel');
            const editItemLabelEl = document.getElementById('editItemLabel');
            
            if (editItemModalLabelEl) editItemModalLabelEl.textContent = title;
            if (editItemLabelEl) editItemLabelEl.textContent = title.replace('编辑', '');
            
            // 如果是军团数据，在编辑框中显示不带方括号的名称
            let displayValue = currentValue;
            if (arrayIndex === GROUPS_INDEX && currentValue.startsWith('[') && currentValue.endsWith(']')) {
                displayValue = currentValue.slice(1, -1); // 移除首尾的方括号
            }
            
            document.getElementById('editItemValue').value = displayValue;
            document.getElementById('editItemIndex').value = itemIndex;
            document.getElementById('editItemArrayIndex').value = arrayIndex;
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('editItemModal'));
            modal.show();
        }

        // 通用删除函数
        function deleteItem(arrayIndex, itemIndex, renderFunction) {
            if (confirm('确定要删除这个项目吗？')) {
                deleteItemWithAutoSave(arrayIndex, itemIndex, renderFunction);
            }
        }

        // 编辑用户数据（特殊处理，因为是对象）- 使用模态框
        function editUserItem(index) {
            const user = whitelistData[USERS_INDEX][index];
            
            // 设置模态框内容
            document.getElementById('editUserId').value = user.id || '';
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserIndex').value = index;
            
            // 设置模态框标题
            const editUserModalLabelEl = document.getElementById('editUserModalLabel');
            if (editUserModalLabelEl) {
                editUserModalLabelEl.textContent = '编辑白名单用户ID';
            }
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        // 确认编辑通用项目
        function handleConfirmEditItem() {
            const newValue = document.getElementById('editItemValue').value.trim();
            const itemIndex = parseInt(document.getElementById('editItemIndex').value);
            const arrayIndex = parseInt(document.getElementById('editItemArrayIndex').value);
            
            if (!newValue) return;
            
            editItemWithAutoSave(arrayIndex, itemIndex, newValue, renderAllTables);
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editItemModal'));
            modal.hide();
        }

        // 确认编辑用户数据
        function handleConfirmEditUser() {
            const newId = document.getElementById('editUserId').value.trim();
            const newName = document.getElementById('editUserName').value.trim();
            const index = parseInt(document.getElementById('editUserIndex').value);
            
            if (!newId || !newName) return;
            
            editItemWithAutoSave(USERS_INDEX, index, {
                id: newId,
                name: newName
            }, renderUsersTable);
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
        }

        // 显示添加项目模态框
        function showAddItemModal(arrayIndex, title, label, renderFunction) {
            const addItemModalLabelEl = document.getElementById('addItemModalLabel');
            const addItemLabelEl = document.getElementById('addItemLabel');
            
            if (addItemModalLabelEl) addItemModalLabelEl.textContent = title;
            if (addItemLabelEl) addItemLabelEl.textContent = label;
            document.getElementById('addItemValue').value = '';
            document.getElementById('addItemArrayIndex').value = arrayIndex;
            
            // 存储渲染函数供后续使用
            window.currentRenderFunction = renderFunction;
            
            const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
            modal.show();
        }

        // 显示添加用户模态框
        function showAddUserModal() {
            document.getElementById('addUserName').value = '';
            document.getElementById('addUserFingerprint').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();
            
            // 重新绑定确认按钮事件（确保模态框显示后事件绑定有效）
            const confirmAddUserBtn = document.getElementById('confirmAddUser');
            if (confirmAddUserBtn) {
                // 先移除可能存在的旧事件监听器
                confirmAddUserBtn.replaceWith(confirmAddUserBtn.cloneNode(true));
                // 重新获取按钮并绑定事件
                const newConfirmBtn = document.getElementById('confirmAddUser');
                newConfirmBtn.addEventListener('click', handleConfirmAddUser);
            }
        }

        // 确认添加通用项目
        function handleConfirmAddItem() {
            const value = document.getElementById('addItemValue').value.trim();
            const arrayIndex = parseInt(document.getElementById('addItemArrayIndex').value);
            
            if (!value) return;
            
            if (!whitelistData[arrayIndex]) whitelistData[arrayIndex] = [];
            
            // 如果是军团数据（GROUPS_INDEX = 1），自动添加方括号
            let finalValue = value;
            if (arrayIndex === GROUPS_INDEX) {
                // 检查是否已经有方括号，如果没有则添加
                if (!value.startsWith('[') || !value.endsWith(']')) {
                    finalValue = `[${value}]`;
                }
            }
            
            // 使用自动保存添加项目
            addItemWithAutoSave(arrayIndex, finalValue, window.currentRenderFunction);
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
            modal.hide();
        }

        // 确认添加用户数据
        function handleConfirmAddUser() {
            const name = document.getElementById('addUserName').value.trim();
            const fingerprint = document.getElementById('addUserFingerprint').value.trim();
            
            if (!name || !fingerprint) return;
            
            if (!whitelistData[USERS_INDEX]) whitelistData[USERS_INDEX] = [];
            addItemWithAutoSave(USERS_INDEX, {
                id: fingerprint,
                name: name
            }, renderUsersTable);
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            if (modal) {
                modal.hide();
                // 确保模态框完全关闭，移除背景阴影
                const modalBackdrop = document.querySelector('.modal-backdrop');
                if (modalBackdrop) {
                    modalBackdrop.remove();
                }
                // 移除modal-open类，恢复页面滚动
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }
            
            // 重置表单
            document.getElementById('addUserName').value = '';
            document.getElementById('addUserFingerprint').value = '';
        }

        // 拉黑通用项目函数
        async function blacklistItem(arrayIndex, itemIndex, type) {
            const item = whitelistData[arrayIndex][itemIndex];
            let displayValue = item;
            let blacklistData = {};
            
            if (type === 'id') {
                // 白名单用户ID -> 黑名单：只填用户ID，其他留空
                displayValue = item;
                blacklistData = { 
                    id: item, 
                    name: '', 
                    corp: '',
                    blockedAt: new Date().toISOString()
                };
            } else if (type === 'corp') {
                // 白名单军团 -> 黑名单：只填用户军团，其他留空
                displayValue = item;
                blacklistData = { 
                    id: '', 
                    name: '', 
                    corp: item,
                    blockedAt: new Date().toISOString()
                };
            }
            
            if (confirm(`确定要将 "${displayValue}" 加入黑名单吗？`)) {
                try {
                    // 确保黑名单数组存在
                    if (!whitelistData[BLACKLIST_INDEX]) {
                        whitelistData[BLACKLIST_INDEX] = [];
                    }
                    
                    // 检查是否已存在（根据类型检查不同字段）
                    let exists = false;
                    if (type === 'id') {
                        exists = whitelistData[BLACKLIST_INDEX].some(blackUser => blackUser.id === item);
                    } else if (type === 'corp') {
                        exists = whitelistData[BLACKLIST_INDEX].some(blackUser => blackUser.corp === item);
                    }
                    
                    if (!exists) {
                        // 添加到黑名单
                        whitelistData[BLACKLIST_INDEX].push(blacklistData);
                        
                        // 从原数组中删除
                        whitelistData[arrayIndex].splice(itemIndex, 1);
                        
                        // 立即保存到服务器
                        const jsonContent = JSON.stringify(whitelistData, null, 2);
                        const success = await updateGitHubFile(jsonContent);
                        
                        if (success) {
                            notificationSystem.success(`"${displayValue}" 已成功加入黑名单并上传到服务器！`, '成功');
                        } else {
                            notificationSystem.warning(`"${displayValue}" 已加入黑名单，但上传到服务器失败，请稍后手动保存。`, '警告');
                        }
                        
                        // 重新渲染相关表格
                        renderAllTables();
                    } else {
                        notificationSystem.info(`"${displayValue}" 已存在于黑名单中！`, '提示');
                    }
                } catch (error) {
                    console.error('拉黑操作失败:', error);
                    notificationSystem.error(`拉黑操作失败: ${error.message}`, '错误');
                }
            }
        }

        // 拉黑用户指纹数据函数
        async function blacklistUserItem(itemIndex) {
            const user = whitelistData[USERS_INDEX][itemIndex];
            const displayValue = `${user.name} (${user.id})`;
            
            if (confirm(`确定要将用户 "${displayValue}" 加入黑名单吗？`)) {
                try {
                    // 确保黑名单数组存在
                    if (!whitelistData[BLACKLIST_INDEX]) {
                        whitelistData[BLACKLIST_INDEX] = [];
                    }
                    
                    // 检查是否已存在
                    const exists = whitelistData[BLACKLIST_INDEX].some(blackUser => 
                        blackUser.id === user.id && blackUser.name === user.name
                    );
                    
                    if (!exists) {
                        // 用户指纹数据 -> 黑名单：填入用户ID和用户名称，军团留空
                        whitelistData[BLACKLIST_INDEX].push({
                            id: user.id,
                            name: user.name,
                            corp: '',
                            fingerprint: user.id,
                            blockedAt: new Date().toISOString()
                        });
                        
                        // 从用户指纹数据中删除
                        whitelistData[USERS_INDEX].splice(itemIndex, 1);
                        
                        // 立即保存到服务器
                        const jsonContent = JSON.stringify(whitelistData, null, 2);
                        const success = await updateGitHubFile(jsonContent);
                        
                        if (success) {
                            notificationSystem.success(`用户 "${displayValue}" 已成功加入黑名单并上传到服务器！`, '成功');
                        } else {
                            notificationSystem.warning(`用户 "${displayValue}" 已加入黑名单，但上传到服务器失败，请稍后手动保存。`, '警告');
                        }
                        
                        // 重新渲染相关表格
                        renderAllTables();
                    } else {
                        notificationSystem.info(`用户 "${displayValue}" 已存在于黑名单中！`, '提示');
                    }
                } catch (error) {
                    console.error('拉黑用户失败:', error);
                    notificationSystem.error(`拉黑用户失败: ${error.message}`, '错误');
                }
            }
        }

        // 添加项目的通用函数 - 已废弃，使用模态框替代
        function addSimpleItem(arrayIndex, renderFunction, title) {
            // 这个函数已被 showAddItemModal 替代
            showAddItemModal(arrayIndex, `添加${title}`, title, renderFunction);
        }

        // 添加用户数据
        function addUserItem() {
            const name = document.getElementById('addUserName').value.trim();
            const fingerprint = document.getElementById('addUserFingerprint').value.trim();
            
            if (!name) return;
            
            addItemWithAutoSave(USERS_INDEX, {
                'name': name,
                'fingerprint': fingerprint
            }, renderUsersTable);
        }

        // 保存Token到本地存储
        function saveToken() {
            const token = document.getElementById('giteeToken').value.trim();
            if (token) {
                localStorage.setItem('giteeToken', token);
                notificationSystem.success('Token保存成功！', '成功');
                // 重新加载数据
                loadWhitelistData();
                fetchOnlineData();
            } else {
                notificationSystem.warning('请输入有效的Token', '警告');
            }
        }

        // 从本地存储加载Token
        function loadToken() {
            const savedToken = localStorage.getItem('giteeToken');
            if (savedToken) {
                document.getElementById('giteeToken').value = savedToken;
                return savedToken;
            }
            return null;
        }

        // 从GitHub加载白名单数据
        async function loadWhitelistData() {
            const token = loadToken();
            if (!token) {
                console.log('未找到保存的Token，跳过白名单数据加载');
                return;
            }

            try {
                // 使用Gitee API获取文件内容
                const response = await fetch(`https://gitee.com/api/v5/repos/Kosto179/kosto/contents/json/1.json?access_token=${token}`, {
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Kosto-Manager'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        notificationSystem.warning('Token无效或已过期，请重新输入', '认证失败');
                        localStorage.removeItem('giteeToken');
                        document.getElementById('giteeToken').value = '';
                        return;
                    }
                    if (response.status === 403) {
                        notificationSystem.error('API频率限制已超出，请等待一段时间后再试', '频率限制');
                        return;
                    }
                    if (response.status === 404) {
                        // 文件不存在，初始化空数据
                        console.log('文件不存在，初始化空数据');
                        whitelistData = [[], [], [], [], [], [], []]; // 7个空数组
                        renderAllTables();
                        notificationSystem.info('文件不存在，已初始化空数据。请添加数据后保存。', '初始化数据');
                        return;
                    }
                    const errorText = await response.text();
                    throw new Error(`GitHub API请求失败: ${response.status} - ${errorText}`);
                }

                const fileData = await response.json();
                // 正确解码base64内容，处理中文字符
                const base64Content = fileData.content.replace(/\s/g, ''); // 移除空白字符
                const binaryString = atob(base64Content);
                
                // 将二进制字符串转换为Uint8Array
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // 使用TextDecoder正确解码UTF-8
                const decoder = new TextDecoder('utf-8');
                const decodedContent = decoder.decode(bytes);
                whitelistData = JSON.parse(decodedContent);
                
                // 初始化空数组（如果某些索引不存在）
                if (!whitelistData[TANKNAMES_INDEX]) whitelistData[TANKNAMES_INDEX] = [];
                if (!whitelistData[GROUPS_INDEX]) whitelistData[GROUPS_INDEX] = [];
                if (!whitelistData[OURS_INDEX]) whitelistData[OURS_INDEX] = [];
                if (!whitelistData[SS_INDEX]) whitelistData[SS_INDEX] = [];
                if (!whitelistData[COOKIE1_INDEX]) whitelistData[COOKIE1_INDEX] = [];
                if (!whitelistData[USERS_INDEX]) whitelistData[USERS_INDEX] = [];
                if (!whitelistData[BLACKLIST_INDEX]) whitelistData[BLACKLIST_INDEX] = [];
                if (!whitelistData[LOG_SWITCH_INDEX]) whitelistData[LOG_SWITCH_INDEX] = ["OK"]; // 默认开启日志
                
                // 初始化日志开关状态
                initializeLogSwitch();
                
                renderAllTables();
                
                console.log('白名单数据加载成功');
                permissionError.style.display = 'none';
            } catch (error) {
                console.error('加载白名单数据失败:', error);
                permissionError.style.display = 'block';
                notificationSystem.error(`加载白名单数据失败: ${error.message}\n\n请检查：\n1. 仓库是否存在: Kosto179cn/Kosto179cn.github.io\n2. Token是否有repo权限\n3. 文件路径是否正确: 1.json`, '白名单加载错误', 8000);
            }
        }

        // 渲染所有表格的辅助函数
        function renderAllTables() {
            renderTanknamesTable();
            renderGroupsTable();
            renderOursTable();
            renderSsTable();
            renderCookie1Table();
            renderUsersTable();
            renderBlacklistTable();
        }

        // 初始化
        function init() {
            loadBlockedUsers();
            loadToken(); // 加载保存的Token
            fetchOnlineData();
            loadWhitelistData();

            // 设置自动刷新
            setInterval(fetchOnlineData, CONFIG.REFRESH_INTERVAL_MS);
            
        }

        // 页面加载完成后初始化
        window.onload = init;

        // 检查用户详情中是否包含可打开的链接
        function checkForOpenableLink(details) {
            if (!details || typeof details !== 'object') return false;
            
            // 使用游戏链接验证器进行检查
            if (window.gameLinkValidator) {
                return window.gameLinkValidator.checkForValidGameLink(details);
            }
            
            // 备用检查逻辑（如果验证器未加载）
            if (details.url && typeof details.url === 'string' && 
                details.referrer && typeof details.referrer === 'string') {
                return details.url.includes('3dtank.com') && 
                       details.url.includes('token=') && 
                       details.referrer === 'https://game.4399iw2.com/';
            }
            
            return false;
        }

        // 打开用户链接（带验证）
        function openUserLink(userId) {
            const user = window.userDetails[userId];
            if (!user || !user.details || !user.details.url) {
                notificationSystem.error('用户链接数据不存在', '错误');
                return;
            }

            // 直接打开链接，不再进行验证
            window.open(user.details.url, '_blank');
        }


        // 暴露全局函数
        // 显示用户详情
        function showUserDetails(userId) {
            const user = window.userDetails[userId];
            if (!user) {
                notificationSystem.error('用户详情不存在', '错误');
                return;
            }

            // 处理用户名显示
            const userFingerprint = user.fingerprint || user.username;
            
            // 根据指纹从白名单数据里获取对应的用户名
            let displayUsername = user.username || '未知用户';
            if (whitelistData && whitelistData[USERS_INDEX]) {
                const matchedUser = whitelistData[USERS_INDEX].find(whiteUser => 
                    whiteUser.id === userFingerprint
                );
                if (matchedUser && matchedUser.name) {
                    displayUsername = matchedUser.name;
                }
            }
            
            // 处理用户名显示问题
            if (displayUsername && (displayUsername.toLowerCase() === 'unknown' || displayUsername === '未知用户')) {
                displayUsername = user.fingerprint || '未知用户';
            }

            // 获取该用户指纹对应的所有ID信息
            const fingerprint = user.fingerprint || user.username;
            let multiIdInfo = '';
            if (window.userIdStats && window.userIdStats.has(fingerprint)) {
                const userStats = window.userIdStats.get(fingerprint);
                const allIds = Array.from(userStats.usernames);
                if (allIds.length > 1) {
                    multiIdInfo = `
                        <div class="alert alert-warning mt-2">
                            <strong><i class="fas fa-exclamation-triangle"></i> 多ID检测</strong><br>
                            该用户今日登录了 <strong>${allIds.length}</strong> 个不同ID：<br>
                            <span class="badge bg-secondary me-1">${allIds.join('</span> <span class="badge bg-secondary me-1">')}</span>
                        </div>
                    `;
                }
            }

            // 填充模态框数据
            const detailUsernameEl = document.getElementById('detailUsername');
            const detailUserIdEl = document.getElementById('detailUserId');
            const detailFingerprintEl = document.getElementById('detailFingerprint');
            const detailScriptNameEl = document.getElementById('detailScriptName');
            const detailPhaseEl = document.getElementById('detailPhase');
            const detailLastActiveEl = document.getElementById('detailLastActive');
            const detailOnlineTimeEl = document.getElementById('detailOnlineTime');
            const detailStatusEl = document.getElementById('detailStatus');
            const detailRawDataEl = document.getElementById('detailRawData');
            
            if (detailUsernameEl) detailUsernameEl.textContent = displayUsername;
            if (detailUserIdEl) detailUserIdEl.textContent = user.getid || '未知';
            if (detailFingerprintEl) detailFingerprintEl.textContent = user.fingerprint || '无';
            if (detailScriptNameEl) detailScriptNameEl.textContent = user.scriptName || '未知脚本';
            if (detailPhaseEl) detailPhaseEl.textContent = user.phase || '未知阶段';
            
            const userTimestamp = user.time || user.timestamp;
            if (detailLastActiveEl) detailLastActiveEl.textContent = formatTime(userTimestamp);
            
            const onlineDuration = user.onlineDurationText || (calculateOnlineTime(user.details?.onlineTime || 0) + '分钟');
            if (detailOnlineTimeEl) detailOnlineTimeEl.textContent = onlineDuration;
            const isOnline = new Date(userTimestamp) >= new Date(Date.now() - (CONFIG?.ONLINE_THRESHOLD_MINUTES || 1.5) * 60000);
            if (detailStatusEl) {
                detailStatusEl.innerHTML = isOnline
                    ? '<span class="status-indicator status-online"></span>在线'
                    : '<span class="status-indicator status-offline"></span>离线';
            }

            // 显示原始数据
            if (detailRawDataEl) detailRawDataEl.textContent = JSON.stringify(user, null, 2);

            // 设置拉黑按钮事件
            const blockBtn = document.getElementById('blockFromDetails');
            blockBtn.onclick = function() {
                const fingerprint = user.fingerprint || user.username;
                blockUser(fingerprint, displayUsername);
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
                modal.hide();
            };

            // 显示模态框
            // 添加多ID信息显示
            const currentUserFingerprint = user.fingerprint || user.username;
            const modalBody = document.querySelector('#userDetailsModal .modal-body');
            
            // 移除之前的多ID提示
            const existingAlert = modalBody.querySelector('.multi-id-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // 检查是否有多ID登录
            if (window.userIdStats && window.userIdStats.has(userFingerprint)) {
                const userStats = window.userIdStats.get(userFingerprint);
                const allUserIds = Array.from(userStats.userIds);
                const allUsernames = Array.from(userStats.usernames);
                
                if (allUserIds.length > 1) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning multi-id-alert mt-3';
                    alertDiv.innerHTML = `
                        <h6><i class="fas fa-exclamation-triangle"></i> 多ID检测</h6>
                        <p class="mb-2">该用户今日登录了 <strong>${allUserIds.length}</strong> 个不同ID：</p>
                        <div class="d-flex flex-wrap gap-1 mb-2">
                            ${allUserIds.map(id => `<span class="badge bg-secondary">${id}</span>`).join('')}
                        </div>
                        <small class="text-muted">对应用户名: ${allUsernames.join(', ')}</small>
                    `;
                    modalBody.appendChild(alertDiv);
                }
            }

            const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
            modal.show();
        }

        // 切换多ID统计显示
        function toggleMultiIdView(event) {
            const multiIdStats = document.getElementById('multiIdStats');
            const onlineList = document.getElementById('onlineList');
            const button = event ? event.target.closest('button') : document.querySelector('button[onclick="toggleMultiIdView()"]');
            
            if (multiIdStats && onlineList && button) {
                if (multiIdStats.style.display === 'none' || multiIdStats.style.display === '') {
                    multiIdStats.style.display = 'block';
                    onlineList.style.display = 'none';
                    button.innerHTML = '<i class="fas fa-list"></i> 普通列表';
                    renderMultiIdStats();
                } else {
                    multiIdStats.style.display = 'none';
                    onlineList.style.display = 'block';
                    button.innerHTML = '<i class="fas fa-users"></i> 多ID统计';
                }
            }
        }

        // 渲染多ID统计
        function renderMultiIdStats() {
            const multiIdList = document.getElementById('multiIdList');
            if (!window.userIdStats) return;
            
            // 筛选出登录了多个ID的用户
            const multiIdUsers = Array.from(window.userIdStats.values())
                .filter(user => user.usernames.size > 1)
                .sort((a, b) => b.usernames.size - a.usernames.size);
            
            if (multiIdUsers.length === 0) {
                multiIdList.innerHTML = '<div class="text-center text-muted py-3">暂无用户登录多个ID</div>';
                return;
            }
            
            multiIdList.innerHTML = '';
            
            multiIdUsers.forEach(user => {
                const usernameList = Array.from(user.usernames).join(', ');
                const lastActiveTime = typeof formatTime === 'function' ? 
                    formatTime(user.latestData.timestamp) : 
                    (new Date(user.latestData.timestamp)).toLocaleString('zh-CN');
                
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">
                            <strong>用户指纹:</strong> ${user.fingerprint}
                            <span class="badge bg-warning ms-2">${user.userIds.size}个ID</span>
                        </div>
                        <div class="user-details">
                            <small><strong>登录的ID:</strong> ${userIdList}</small><br>
                            <small><strong>用户名:</strong> ${usernameList}</small><br>
                            <small><strong>最后活跃:</strong> ${lastActiveTime}</small>
                        </div>
                    </div>
                `;
                multiIdList.appendChild(item);
            });
        }

        // 切换搜索视图
        function toggleSearchView(event) {
            const searchArea = document.getElementById('searchArea');
            const onlineList = document.getElementById('onlineList');
            const button = event ? event.target.closest('button') : document.querySelector('button[onclick="toggleSearchView()"]');
            
            if (searchArea && onlineList && button) {
                if (searchArea.style.display === 'none' || searchArea.style.display === '') {
                    searchArea.style.display = 'block';
                    onlineList.style.display = 'none';
                    button.innerHTML = '<i class="fas fa-list"></i> 返回列表';
                    document.getElementById('searchInput').focus();
                } else {
                    searchArea.style.display = 'none';
                    onlineList.style.display = 'block';
                    button.innerHTML = '<i class="fas fa-search"></i> 搜索账号';
                }
            }
        }

        // 执行搜索
        function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (!searchTerm) {
                searchResults.innerHTML = '<div class="text-center text-muted py-3">请输入要搜索的ID、用户名或指纹</div>';
                return;
            }
            
            if (!window.allData || window.allData.length === 0) {
                searchResults.innerHTML = '<div class="text-center text-muted py-3">暂无数据可搜索</div>';
                return;
            }
            
            // 搜索匹配的记录 - 使用所有数据
            const matchedRecords = window.allData.filter(item => {
                const userId = (item.getid || item.details?.getid || '').toString().toLowerCase();
                const username = (item.username || '').toLowerCase();
                const fingerprint = (item.fingerprint || '').toLowerCase();
                return userId.includes(searchTerm) || username.includes(searchTerm) || fingerprint.includes(searchTerm);
            });
            
            if (matchedRecords.length === 0) {
                searchResults.innerHTML = '<div class="text-center text-muted py-3">未找到匹配的记录</div>';
                return;
            }
            
            // 按时间排序，最新的在前
            matchedRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // 去重处理：只保留每个用户ID的最新记录
            const uniqueRecordsMap = new Map();
            matchedRecords.forEach(record => {
                const userId = (record.getid || record.details?.getid || '').toString();
                
                // 确保时间戳字段有效
                const currentTimestamp = record.timestamp || record.time;
                const existingRecord = uniqueRecordsMap.get(userId);
                
                if (!existingRecord) {
                    uniqueRecordsMap.set(userId, record);
                } else {
                    // 比较时间戳，保留最新的记录
                    const existingTimestamp = existingRecord.timestamp || existingRecord.time;
                    const currentTime = currentTimestamp ? new Date(currentTimestamp).getTime() : 0;
                    const existingTime = existingTimestamp ? new Date(existingTimestamp).getTime() : 0;
                    
                    if (currentTime > existingTime) {
                        uniqueRecordsMap.set(userId, record);
                    }
                }
            });
            
            const uniqueRecords = Array.from(uniqueRecordsMap.values());
            
            // 显示搜索结果
            searchResults.innerHTML = '';
            
            // 添加搜索结果标题
            const resultHeader = document.createElement('div');
            resultHeader.className = 'alert alert-info mb-3';
            resultHeader.innerHTML = `<i class="fas fa-info-circle"></i> 找到 <strong>${matchedRecords.length}</strong> 条记录，去重后 <strong>${uniqueRecords.length}</strong> 条唯一记录`;
            searchResults.appendChild(resultHeader);
            
            // 使用去重后的记录
            const displayRecords = uniqueRecords;
            
            displayRecords.forEach((item, index) => {
                const userId = item.getid || item.details?.getid || '未知ID';
                
                // 智能计算在线时长
                let onlineTime = '未知';
                if (item.details?.onlineTime) {
                    onlineTime = item.details.onlineTime + ' 分钟';
                } else if (item.timestamp) {
                    // 使用精确时间计算
                    onlineTime = getPreciseTimeDifference(item.timestamp);
                } else if (item.time) {
                    // 使用精确时间计算
                    onlineTime = getPreciseTimeDifference(item.time);
                }
                
                const resultItem = document.createElement('div');
                resultItem.className = 'list-item';
                resultItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">
                            <strong>游戏ID:</strong> ${userId}
                            ${index === 0 ? '<span class="badge bg-success ms-2">最新记录</span>' : ''}
                        </div>
                        <div class="user-details">
                            <small><strong>上次上线:</strong> ${onlineTime}</small>
                        </div>
                        <div class="action-buttons mt-2">
                            <button class="btn btn-sm btn-outline-primary view-details-btn" 
                                    data-record='${JSON.stringify(item).replace(/'/g, "'")}'>
                                <i class="fas fa-eye"></i> 查看详情
                            </button>
                        </div>
                    </div>
                `;
                searchResults.appendChild(resultItem);
                
                // 添加详情按钮点击事件
                const viewBtn = resultItem.querySelector('.view-details-btn');
                viewBtn.addEventListener('click', function() {
                    const recordData = JSON.parse(this.getAttribute('data-record'));
                    showRecordDetails(recordData);
                });
            });
        }

        // 显示记录详情
        function showRecordDetails(record) {
            const detailsHtml = `
                <div class="record-details">
                    <h4 class="mb-3"><i class="fas fa-info-circle"></i> 记录详情</h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <strong>游戏ID:</strong> ${record.getid || record.details?.getid || '未知'}
                        </div>
                        <div class="detail-item">
                            <strong>用户名:</strong> ${record.username || '未知'}
                        </div>
                        <div class="detail-item">
                            <strong>指纹:</strong> ${record.fingerprint || '未知'}
                        </div>
                        <div class="detail-item">
                            <strong>时间戳:</strong> ${record.timestamp ? formatTime(record.timestamp) : '未知'}
                        </div>
                        ${record.details ? `
                        <div class="detail-item">
                            <strong>在线时长:</strong> ${record.details.onlineTime || '未知'} 分钟
                        </div>
                        <div class="detail-item">
                            <strong>IP地址:</strong> ${record.details.ip || '未知'}
                        </div>
                        <div class="detail-item">
                            <strong>用户代理:</strong> ${record.details.userAgent || '未知'}
                        </div>
                        ` : ''}
                        ${record.time ? `
                        <div class="detail-item">
                            <strong>记录时间:</strong> ${formatTime(record.time)}
                        </div>
                        ` : ''}
                    </div>
                    <div class="mt-3">
                        <strong>完整数据:</strong>
                        <pre class="bg-light p-2 mt-2 rounded" style="max-height: 200px; overflow: auto;">
${JSON.stringify(record, null, 2)}
                        </pre>
                    </div>
                </div>
            `;
            
            showCustomConfirm(detailsHtml, '记录详情', {
                confirmText: '关闭',
                showCancel: false,
                onConfirm: function() {}
            });
        }

        // 简化搜索功能
        function showSearchDialog() {
            const searchTerm = prompt('请输入要搜索的ID或用户名:');
            if (!searchTerm || !searchTerm.trim()) return;
            
            if (!window.todayData || window.todayData.length === 0) {
                notificationSystem.info('暂无数据可搜索', '提示');
                return;
            }
            
            const term = searchTerm.trim().toLowerCase();
                const matchedRecords = window.todayData.filter(item => {
                const userId = (item.getid || item.details?.getid || '').toString().toLowerCase();
                const username = (item.username || '').toLowerCase();
                const fingerprint = (item.fingerprint || '').toLowerCase();
                return userId.includes(term) || username.includes(term) || fingerprint.includes(term);
            });
            
            if (matchedRecords.length === 0) {
                notificationSystem.info('未找到匹配的记录', '提示');
                return;
            }
            
            // 按时间排序，最新的在前
            matchedRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let resultText = `找到 ${matchedRecords.length} 条匹配记录:\n\n`;
            matchedRecords.forEach((item, index) => {
                const userId = item.getid || item.details?.getid || '未知ID';
                const username = item.username || '未知用户';
                const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString('zh-CN') : '未知时间';
                const onlineTime = item.details?.onlineTime ? (item.details.onlineTime + ' 分钟') : '未知';
                
                resultText += `${index + 1}. ID: ${highlightSearchTerm(userId, term)}\n`;
                resultText += `   用户名: ${highlightSearchTerm(username, term)}\n`;
                resultText += `   时间: ${timestamp}\n`;
                resultText += `   在线时长: ${onlineTime}\n`;
                if (index === 0) resultText += `   [最新记录]\n`;
                resultText += '\n';
            });
            
            // 调用新的页面显示函数
            showSearchResults(`搜索结果: "${searchTerm}"`, matchedRecords, searchTerm);
        }

        // 在页面显示搜索结果并整合数据
        function showSearchResults(title, records, searchTerm = '') {
            // 数据整合分析
            const analysis = analyzeSearchData(records);
            
            // 创建或更新搜索结果容器
            let searchContainer = document.getElementById('searchResultsContainer');
            if (!searchContainer) {
                searchContainer = document.createElement('div');
                searchContainer.id = 'searchResultsContainer';
                searchContainer.className = 'mt-4';
                
                // 插入到今日在线名单后面
                const todaySection = document.querySelector('.container .row .col-md-6:first-child');
                if (todaySection) {
                    todaySection.appendChild(searchContainer);
                }
            }

            let html = `
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-search"></i> ${title}
                        </h5>
                        <button class="btn btn-sm btn-outline-light" onclick="closeSearchResults()">
                            <i class="fas fa-times"></i> 关闭
                        </button>
                    </div>
                    <div class="card-body">
            `;

            if (analysis.length === 0) {
                html += '<div class="text-center text-muted py-3">暂无匹配结果</div>';
            } else {
                analysis.forEach((item, index) => {
                    const usernameList = item.usernames.length > 0 ? item.usernames.join(', ') : '未知用户';
                    
                    html += `
                        <div class="border rounded p-3 mb-3 ${index === 0 ? 'border-success bg-light' : ''}">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-id-card"></i> ID: <strong>${highlightSearchTerm(item.id, searchTerm)}</strong>
                                        ${index === 0 ? '<span class="badge badge-success ml-2">最活跃</span>' : ''}
                                    </h6>
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <p class="mb-1"><i class="fas fa-user text-info"></i> <strong>使用者:</strong> ${highlightSearchTerm(usernameList, searchTerm)}</p>
                                            <p class="mb-1"><i class="fas fa-clock text-success"></i> <strong>总在线:</strong> <span class="text-success font-weight-bold">${item.totalDuration}</span></p>
                                        </div>
                                        <div class="col-sm-6">
                                            <p class="mb-1"><i class="fas fa-sign-in-alt text-warning"></i> <strong>登录次数:</strong> ${item.recordCount} 次</p>
                                            <p class="mb-1"><i class="fas fa-calendar text-secondary"></i> <strong>最后活动:</strong> ${item.lastTime ? item.lastTime.toLocaleString() : '未知'}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-right">
                                    <button class="btn btn-sm btn-outline-info mb-2" onclick="toggleDetailRecords(${index})">
                                        <i class="fas fa-list"></i> 详细记录
                                    </button>
                                </div>
                            </div>
                            <div id="detailRecords_${index}" class="mt-3" style="display: none;">
                                <h6 class="text-secondary"><i class="fas fa-history"></i> 详细登录记录:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="thead-light">
                                            <tr>
                                                <th><i class="fas fa-clock"></i> 时间</th>
                                                <th><i class="fas fa-user"></i> 用户名</th>
                                                <th><i class="fas fa-hourglass-half"></i> 时长</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;
                    
                    item.records.forEach(record => {
                        const time = record.time || record.details?.time || '未知';
                        const username = record.username || record.details?.username || '未知';
                        const duration = record.duration || record.details?.duration || '未知';
                        
                        html += `
                            <tr>
                                <td>${time}</td>
                                <td><span class="badge badge-secondary">${highlightSearchTerm(username, searchTerm)}</span></td>
                                <td><span class="text-success">${duration}</span></td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            html += `
                    </div>
                </div>
            `;

            searchContainer.innerHTML = html;
            
            // 滚动到搜索结果
            searchContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // 数据分析函数
        function analyzeSearchData(records) {
            // 按ID分组
            const groupedByID = {};
            records.forEach(item => {
                const userId = item.getid || item.details?.getid || '未知';
                if (!groupedByID[userId]) {
                    groupedByID[userId] = [];
                }
                groupedByID[userId].push(item);
            });

            const analysis = [];
            
            Object.keys(groupedByID).forEach(userId => {
                const userRecords = groupedByID[userId];
                
                // 计算总在线时长
                let totalMinutes = 0;
                const usernames = new Set();
                let lastTime = null;
                
                userRecords.forEach(record => {
                    // 提取时长（分钟）
                    const duration = record.duration || record.details?.duration || '0分钟';
                    const minutes = parseInt(duration.match(/(\d+)分钟/)?.[1] || '0');
                    totalMinutes += minutes;
                    
                    // 收集用户名
                    const username = record.username || record.details?.username;
                    if (username && username !== '未知') {
                        usernames.add(username);
                    }
                    
                    // 记录最后时间
                    const time = new Date(record.time || record.details?.time);
                    if (!lastTime || time > lastTime) lastTime = time;
                });

                // 格式化总时长
                const hours = Math.floor(totalMinutes / 60);
                const mins = totalMinutes % 60;
                const totalDuration = hours > 0 ? `${hours}小时${mins}分钟` : `${mins}分钟`;

                analysis.push({
                    id: userId,
                    usernames: Array.from(usernames),
                    totalDuration: totalDuration,
                    totalMinutes: totalMinutes,
                    recordCount: userRecords.length,
                    lastTime: lastTime,
                    records: userRecords.sort((a, b) => new Date(b.time || b.details?.time || 0) - new Date(a.time || a.details?.time || 0))
                });
            });

            // 按总时长排序
            return analysis.sort((a, b) => b.totalMinutes - a.totalMinutes);
        }

        // 切换详细记录显示
        function toggleDetailRecords(index) {
            const detailDiv = document.getElementById(`detailRecords_${index}`);
            if (detailDiv.style.display === 'none') {
                detailDiv.style.display = 'block';
            } else {
                detailDiv.style.display = 'none';
            }
        }

        // 关闭搜索结果
        function closeSearchResults() {
            const searchContainer = document.getElementById('searchResultsContainer');
            if (searchContainer) {
                searchContainer.remove();
            }
        }

        // 解除拉黑用户
        async function unblockUser(fingerprint, username) {
            if (confirm(`确定要解除拉黑用户 ${username} 吗？`)) {
                try {
                    // 从本地拉黑集合中移除
                    blockedFingerprints.delete(fingerprint);
                    saveBlockedUsers();
                    
                    // 从黑名单数组中移除（更宽松的匹配）
                    if (whitelistData[BLACKLIST_INDEX]) {
                        const originalLength = whitelistData[BLACKLIST_INDEX].length;
                        whitelistData[BLACKLIST_INDEX] = whitelistData[BLACKLIST_INDEX].filter(blackUser => 
                            blackUser.fingerprint !== fingerprint && 
                            blackUser.id !== fingerprint &&
                            blackUser.id !== (userDetail?.getid || '') &&
                            !(blackUser.name === username) &&
                            !(blackUser.name && userDetail?.username && blackUser.name === userDetail.username)
                        );
                        
                        // 检查是否真的从黑名单中移除了用户
                        const removedFromBlacklist = whitelistData[BLACKLIST_INDEX].length < originalLength;
                        
                        if (removedFromBlacklist) {
                            // 立即保存到服务器
                            const jsonContent = JSON.stringify(whitelistData, null, 2);
                            const success = await updateGitHubFile(jsonContent);
                            
                            if (success) {
                                notificationSystem.success(`用户 ${username} 已解除拉黑并同步到服务器！`, '成功');
                                // 刷新黑名单表格显示
                                renderBlacklistTable();
                            } else {
                                notificationSystem.warning(`用户 ${username} 已本地解除拉黑，但同步到服务器失败，请稍后手动保存。`, '警告');
                            }
                        } else {
                            notificationSystem.success(`用户 ${username} 已从本地拉黑列表中移除！`, '成功');
                        }
                    }
                    
                    // 刷新在线数据显示
                    fetchOnlineData();
                } catch (error) {
                    console.error('解除拉黑失败:', error);
                    notificationSystem.error(`解除拉黑失败: ${error.message}`, '错误');
                }
            }
        }
        


        // 暴露全局函数
        window.blockUser = blockUser;
        window.unblockUser = unblockUser;
        window.showUserDetails = showUserDetails;

        // 更新GitHub文件
        async function updateGitHubFile(content) {
            const token = loadToken();
            if (!token) {
                notificationSystem.warning('请先保存GitHub Token', '警告');
                return false;
            }

            try {
                // 首先获取文件信息（包含SHA）- 修正仓库名称
                const fileResponse = await fetch(`https://gitee.com/api/v5/repos/Kosto179/kosto/contents/json/1.json?access_token=${token}`, {
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Kosto-Manager'
                    }
                });

                if (!fileResponse.ok) {
                    if (fileResponse.status === 404) {
                        // 文件不存在，创建新文件
                        console.log('文件不存在，创建新文件');
                        const encoder = new TextEncoder();
                        const utf8Bytes = encoder.encode(content);
                        const base64Content = btoa(String.fromCharCode(...utf8Bytes));

                        const createResponse = await fetch(`https://gitee.com/api/v5/repos/Kosto179/kosto/contents/json/1.json?access_token=${token}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'User-Agent': 'Kosto-Manager'
                            },
                            body: JSON.stringify({
                                message: 'Create whitelist file via manager',
                                content: base64Content
                            })
                        });

                        if (!createResponse.ok) {
                            if (createResponse.status === 403) {
                                throw new Error('API频率限制已超出，请等待一段时间后再试');
                            }
                            const errorText = await createResponse.text();
                            throw new Error(`创建文件失败: ${createResponse.status} - ${errorText}`);
                        }
                        return true;
                    } else {
                        const errorText = await fileResponse.text();
                        throw new Error(`获取文件信息失败: ${fileResponse.status} - ${errorText}`);
                    }
                }

                const fileInfo = await fileResponse.json();
                
                // 正确编码UTF-8内容为base64
                const encoder = new TextEncoder();
                const utf8Bytes = encoder.encode(content);
                const base64Content = btoa(String.fromCharCode(...utf8Bytes));

                // 更新文件
                const updateResponse = await fetch(`https://gitee.com/api/v5/repos/Kosto179/kosto/contents/json/1.json?access_token=${token}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'User-Agent': 'Kosto-Manager'
                    },
                    body: JSON.stringify({
                        message: 'Update whitelist via manager',
                        content: base64Content,
                        sha: fileInfo.sha
                    })
                });

                if (!updateResponse.ok) {
                    if (updateResponse.status === 403) {
                        throw new Error('API频率限制已超出，请等待一段时间后再试');
                    }
                    const errorText = await updateResponse.text();
                    throw new Error(`更新文件失败: ${updateResponse.status} - ${errorText}`);
                }
                
                return true;
            } catch (error) {
                console.error('GitHub API错误:', error);
                notificationSystem.error(`GitHub操作失败: ${error.message}\n\n请检查：\n1. Token是否有效\n2. Token是否有repo权限\n3. 仓库名称是否正确`, '错误');
                return false;
            }
        }

        // 保存更改到GitHub
        async function saveChanges() {
            try {
                const jsonContent = JSON.stringify(whitelistData, null, 2);
                const success = await updateGitHubFile(jsonContent);
                if (success) {
                    notificationSystem.success('保存到Gitee成功！', '保存成功');
                }
            } catch (error) {
                notificationSystem.error('保存失败: ' + error.message, '保存错误');
            }
        }

        // 初始化日志开关
        function initializeLogSwitch() {
            const logSwitch = document.getElementById('logSwitch');
            const logStatus = document.getElementById('logStatus');
            
            if (whitelistData[LOG_SWITCH_INDEX] && whitelistData[LOG_SWITCH_INDEX][0] === "OK") {
                logSwitch.checked = true;
                logStatus.textContent = "开启";
                logStatus.className = "log-status on";
            } else {
                logSwitch.checked = false;
                logStatus.textContent = "关闭";
                logStatus.className = "log-status off";
            }
            
            // 添加开关事件监听
            logSwitch.addEventListener('change', function() {
                updateLogSwitch(this.checked);
            });
        }

        // 更新日志开关状态
        async function updateLogSwitch(isEnabled) {
            const logStatus = document.getElementById('logStatus');
            
            if (isEnabled) {
                whitelistData[LOG_SWITCH_INDEX] = ["OK"];
                logStatus.textContent = "开启";
                logStatus.className = "log-status on";
                notificationSystem.success("日志功能已开启", "开关状态");
            } else {
                whitelistData[LOG_SWITCH_INDEX] = ["NO"];
                logStatus.textContent = "关闭";
                logStatus.className = "log-status off";
                notificationSystem.warning("日志功能已关闭", "开关状态");
            }
            
            // 立即同步到服务器
            try {
                const jsonContent = JSON.stringify(whitelistData, null, 2);
                const success = await updateGitHubFile(jsonContent);
                if (success) {
                    notificationSystem.success('日志开关状态已同步到服务器', '同步成功');
                }
            } catch (error) {
                notificationSystem.error('同步失败: ' + error.message, '同步错误');
            }
        }

        // 添加事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // Token保存按钮事件监听
            const saveTokenBtn = document.getElementById('saveTokenBtn');
            if (saveTokenBtn) {
                saveTokenBtn.addEventListener('click', saveToken);
            }

            // 保存更改按钮事件监听
            const saveChangesBtn = document.getElementById('saveChangesBtn');
            if (saveChangesBtn) {
                saveChangesBtn.addEventListener('click', saveChanges);
            }

            // 打开源文件按钮事件监听
            const openSourceBtn = document.getElementById('openSourceBtn');
            if (openSourceBtn) {
                openSourceBtn.addEventListener('click', function() {
                    // 检测当前活动的标签页
                    const activeTab = document.querySelector('.nav-tabs button.active');
                    let sourceUrl;
                    
                    if (activeTab && activeTab.getAttribute('data-tab') === 'online') {
                        // 如果在"在线管理"标签，打开log.json的raw链接
                        sourceUrl = 'https://gitee.com/Kosto179/kosto-battle-clicker-new/raw/master/log.json';
                    } else {
                        // 其他标签打开1.json的raw链接
                        sourceUrl = 'https://gitee.com/Kosto179/kosto/raw/master/json/1.json';
                    }
                    
                    window.open(sourceUrl, '_blank');
                });
            }

            // 黑名单相关事件监听
            const confirmAddBlacklistBtn = document.getElementById('confirmAddBlacklist');
            if (confirmAddBlacklistBtn) {
                confirmAddBlacklistBtn.addEventListener('click', handleAddBlacklist);
            }

            const confirmEditBlacklistBtn = document.getElementById('confirmEditBlacklist');
            if (confirmEditBlacklistBtn) {
                confirmEditBlacklistBtn.addEventListener('click', handleConfirmEditBlacklist);
            }

            // 通用编辑确认按钮事件监听
            const confirmEditItemBtn = document.getElementById('confirmEditItem');
            if (confirmEditItemBtn) {
                confirmEditItemBtn.addEventListener('click', handleConfirmEditItem);
            }

            // 用户数据编辑确认按钮事件监听
            const confirmEditUserBtn = document.getElementById('confirmEditUser');
            if (confirmEditUserBtn) {
                confirmEditUserBtn.addEventListener('click', handleConfirmEditUser);
            }

            // 通用添加确认按钮事件监听
            const confirmAddItemBtn = document.getElementById('confirmAddItem');
            if (confirmAddItemBtn) {
                confirmAddItemBtn.addEventListener('click', handleConfirmAddItem);
            }

            // 用户数据添加确认按钮事件监听
            const confirmAddUserBtn = document.getElementById('confirmAddUser');
            if (confirmAddUserBtn) {
                confirmAddUserBtn.addEventListener('click', handleConfirmAddUser);
            }

            // 黑名单表格事件委托（处理动态生成的编辑和删除按钮）
            const blacklistTableBody = document.getElementById('blacklistTableBody');
            if (blacklistTableBody) {
                blacklistTableBody.addEventListener('click', function(event) {
                    const target = event.target;
                    
                    // 处理编辑按钮点击
                    if (target.classList.contains('edit-blacklist')) {
                        handleEditBlacklist(event);
                    }
                    
                    // 处理删除按钮点击
                    if (target.classList.contains('delete-blacklist')) {
                        handleDeleteBlacklist(event);
                    }
                });
            }

            // 刷新按钮事件监听
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    fetchOnlineData();
                    loadWhitelistData();
                });
            }


            // 使用延迟绑定确保DOM元素存在
            setTimeout(function() {
                // 添加按钮事件监听器 - 使用模态框
                const addTanknameBtn = document.getElementById('addTanknameBtn');
                if (addTanknameBtn) {
                    addTanknameBtn.addEventListener('click', function() {
                        showAddItemModal(TANKNAMES_INDEX, '添加白名单用户ID', '白名单用户ID', renderTanknamesTable);
                    });
                }
                
                const addGroupBtn = document.getElementById('addGroupBtn');
                if (addGroupBtn) {
                    addGroupBtn.addEventListener('click', function() {
                        showAddItemModal(GROUPS_INDEX, '添加白名单军团', '白名单军团', renderGroupsTable);
                    });
                }
                
                const addOurBtn = document.getElementById('addOurBtn');
                if (addOurBtn) {
                    addOurBtn.addEventListener('click', function() {
                        showAddItemModal(OURS_INDEX, '添加开发者ID', '开发者ID', renderOursTable);
                    });
                }
                
                const addSsBtn = document.getElementById('addSsBtn');
                if (addSsBtn) {
                    addSsBtn.addEventListener('click', function() {
                        showAddItemModal(SS_INDEX, '添加自爆程序标志', '自爆程序标志', renderSsTable);
                    });
                }
                
                const addCookie1Btn = document.getElementById('addCookie1Btn');
                if (addCookie1Btn) {
                    addCookie1Btn.addEventListener('click', function() {
                        showAddItemModal(COOKIE1_INDEX, '添加身份验证Cookie', '身份验证Cookie', renderCookie1Table);
                    });
                }
                
            }, 100); // 延迟100ms确保DOM完全加载
        });
    </script>

    <!-- 添加黑名单用户模态框 -->
    <div class="modal fade" id="addBlacklistModal" tabindex="-1" aria-labelledby="addBlacklistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBlacklistModalLabel">添加黑名单用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="blacklistUserId" class="form-label">用户ID</label>
                        <input type="text" class="form-control" id="blacklistUserId" required>
                    </div>
                    <div class="form-group">
                        <label for="blacklistUserName" class="form-label">用户名称</label>
                        <input type="text" class="form-control" id="blacklistUserName" required>
                    </div>
                    <div class="form-group">
                        <label for="blacklistUserCorp" class="form-label">用户军团</label>
                        <input type="text" class="form-control" id="blacklistUserCorp">
                    </div>
                    <div class="form-group">
                        <label for="blacklistUserFingerprint" class="form-label">用户指纹</label>
                        <input type="text" class="form-control" id="blacklistUserFingerprint">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmAddBlacklist">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用添加项目模态框 -->
    <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addItemModalLabel">添加项目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="addItemValue" class="form-label" id="addItemLabel">值</label>
                        <input type="text" class="form-control" id="addItemValue" required>
                        <input type="hidden" id="addItemArrayIndex">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmAddItem">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加用户数据模态框 -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">添加用户数据</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="addUserName" class="form-label">用户名称</label>
                        <input type="text" class="form-control" id="addUserName" required>
                    </div>
                    <div class="form-group">
                        <label for="addUserFingerprint" class="form-label">用户指纹</label>
                        <input type="text" class="form-control" id="addUserFingerprint">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmAddUser">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑黑名单用户模态框 -->
    <div class="modal fade" id="editBlacklistModal" tabindex="-1" aria-labelledby="editBlacklistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBlacklistModalLabel">编辑黑名单用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editBlacklistUserId" class="form-label">用户ID</label>
                        <input type="text" class="form-control" id="editBlacklistUserId">
                    </div>
                    <div class="form-group">
                        <label for="editBlacklistUserName" class="form-label">用户名称</label>
                        <input type="text" class="form-control" id="editBlacklistUserName">
                    </div>
                    <div class="form-group">
                        <label for="editBlacklistUserCorp" class="form-label">用户军团</label>
                        <input type="text" class="form-control" id="editBlacklistUserCorp">
                    </div>
                    <div class="form-group">
                        <label for="editBlacklistUserFingerprint" class="form-label">用户指纹</label>
                        <input type="text" class="form-control" id="editBlacklistUserFingerprint">
                    </div>
                    <input type="hidden" id="editBlacklistIndex">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmEditBlacklist">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用编辑模态框 -->
    <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editItemModalLabel">编辑项目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editItemValue" class="form-label" id="editItemLabel">值</label>
                        <input type="text" class="form-control" id="editItemValue" required>
                        <input type="hidden" id="editItemIndex">
                        <input type="hidden" id="editItemArrayIndex">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmEditItem">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑用户数据模态框 -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">编辑用户数据</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editUserId" class="form-label">用户ID</label>
                        <input type="text" class="form-control" id="editUserId" required>
                    </div>
                    <div class="form-group">
                        <label for="editUserName" class="form-label">用户名称</label>
                        <input type="text" class="form-control" id="editUserName" required>
                        <input type="hidden" id="editUserIndex">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmEditUser">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户详情模态框 -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userDetailsModalLabel">用户详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label"><strong>用户名:</strong></label>
                                <p id="detailUsername" class="form-control-plaintext">-</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><strong>用户ID:</strong></label>
                                <p id="detailUserId" class="form-control-plaintext">-</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><strong>用户指纹:</strong></label>
                                <p id="detailFingerprint" class="form-control-plaintext" style="word-break: break-all;">-</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label"><strong>最后活动时间:</strong></label>
                                <p id="detailLastActive" class="form-control-plaintext">-</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><strong>在线时长:</strong></label>
                                <p id="detailOnlineTime" class="form-control-plaintext">-</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><strong>状态:</strong></label>
                                <p id="detailStatus" class="form-control-plaintext">
                                    <span class="status-indicator status-online"></span>在线
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3" id="detailsSection" style="display: none;">
                        <div class="col-12">
                            <h6><strong>详细信息:</strong></h6>
                            <div class="bg-light p-3 rounded">
                                <pre id="detailRawData" style="margin: 0; white-space: pre-wrap; word-break: break-all; font-size: 12px;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-danger" id="blockFromDetails">拉黑用户</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 日志开关浮窗 -->
    <div class="log-switch-container" id="logSwitchContainer">
        <div class="log-switch-hint"></div><!-- 提示条，让用户知道这里有开关 -->
        <div class="log-switch-title">日志开关</div>
        <label class="log-switch">
            <input type="checkbox" id="logSwitch">
            <span class="log-slider"></span>
        </label>
        <div class="log-status" id="logStatus">关闭</div>
    </div>

    <script>
        // 表格搜索功能
        function toggleTableSearch(tableType) {
            const searchArea = document.getElementById(`${tableType}SearchArea`);
            const searchInput = document.getElementById(`${tableType}SearchInput`);
            
            if (searchArea.style.display === 'none' || searchArea.style.display === '') {
                searchArea.style.display = 'block';
                searchInput.focus();
            } else {
                searchArea.style.display = 'none';
                searchInput.value = '';
                // 重置表格显示
                resetTableSearch(tableType);
            }
        }

        function performTableSearch(tableType) {
            const searchTerm = document.getElementById(`${tableType}SearchInput`).value.trim().toLowerCase();
            const tableBody = document.getElementById(`${tableType}TableBody`);
            
            if (!searchTerm) {
                resetTableSearch(tableType);
                return;
            }
            
            const rows = tableBody.querySelectorAll('tr');
            let hasMatches = false;
            
            rows.forEach(row => {
                // 跳过表头和其他非数据行
                if (row.classList.contains('table-header') || row.id === 'default-blacklist-user') {
                    return;
                }
                
                const cells = row.querySelectorAll('td');
                let rowMatches = false;
                
                cells.forEach(cell => {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        rowMatches = true;
                    }
                });
                
                if (rowMatches) {
                    row.style.display = '';
                    hasMatches = true;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // 如果没有匹配项，显示提示
            if (!hasMatches) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.innerHTML = `<td colspan="10" class="text-center text-muted py-3">未找到匹配的记录</td>`;
                tableBody.appendChild(noResultsRow);
            }
        }

        function resetTableSearch(tableType) {
            const tableBody = document.getElementById(`${tableType}TableBody`);
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                row.style.display = '';
            });
            
            // 移除可能存在的无结果提示
            const noResults = tableBody.querySelector('td[colspan="10"]');
            if (noResults) {
                noResults.parentElement.remove();
            }
        }

        // 检查批量管理是否开启
        function isBatchManagementEnabled(tableType) {
            const batchArea = document.getElementById(`${tableType}BatchArea`);
            return batchArea && batchArea.style.display === 'block';
        }

        // 批量管理功能
        function toggleBatchManagement(tableType) {
            const batchArea = document.getElementById(`${tableType}BatchArea`);
            const selectAllCheckbox = document.getElementById(`${tableType}SelectAll`);
            const headerSelectAll = document.getElementById(`${tableType}HeaderSelectAll`);
            
            if (batchArea.style.display === 'none' || batchArea.style.display === '') {
                batchArea.style.display = 'block';
                // 显示表头全选复选框
                if (headerSelectAll) {
                    headerSelectAll.style.display = 'inline-block';
                }
                // 初始化选择状态
                selectAllCheckbox.checked = false;
                updateSelectAllState(tableType);
                // 重新渲染表格以显示复选框
                renderAllTables();
            } else {
                batchArea.style.display = 'none';
                // 隐藏表头全选复选框
                if (headerSelectAll) {
                    headerSelectAll.style.display = 'none';
                }
                // 取消所有选择
                const checkboxes = document.querySelectorAll(`#${tableType}TableBody input[type="checkbox"]`);
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                // 重新渲染表格以隐藏复选框
                renderAllTables();
            }
        }

        function toggleSelectAll(tableType, isChecked) {
            const checkboxes = document.querySelectorAll(`#${tableType}TableBody input[type="checkbox"]`);
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        }

        function updateSelectAllState(tableType) {
            const selectAllCheckbox = document.getElementById(`${tableType}SelectAll`);
            const checkboxes = document.querySelectorAll(`#${tableType}TableBody input[type="checkbox"]`);
            const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(checkbox => checkbox.checked);
            const someChecked = checkboxes.length > 0 && Array.from(checkboxes).some(checkbox => checkbox.checked);
            
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }

        async function deleteSelectedUsers() {
            const checkboxes = document.querySelectorAll('#usersTableBody input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                notificationSystem.warning('请先选择要删除的用户', '警告');
                return;
            }

            if (confirm(`确定要删除选中的 ${checkboxes.length} 个用户吗？`)) {
                const indices = [];
                checkboxes.forEach(checkbox => {
                    const index = checkbox.getAttribute('data-index');
                    if (index) indices.push(parseInt(index));
                });

                // 从白名单数据中删除选中的用户（倒序删除避免索引问题）
                indices.sort((a, b) => b - a).forEach(index => {
                    if (whitelistData[USERS_INDEX] && whitelistData[USERS_INDEX][index]) {
                        whitelistData[USERS_INDEX].splice(index, 1);
                    }
                });

                // 重新渲染表格
                renderUsersTable();
                notificationSystem.success(`成功删除 ${indices.length} 个用户`, '删除成功');
                
                // 自动保存到服务器
                try {
                    const jsonContent = JSON.stringify(whitelistData, null, 2);
                    const success = await updateGitHubFile(jsonContent);
                    if (success) {
                        notificationSystem.success('自动保存成功', '成功');
                        console.log('批量删除自动保存成功');
                    }
                } catch (error) {
                    console.error('批量删除自动保存失败:', error);
                    notificationSystem.error('批量删除自动保存失败: ' + error.message, '保存错误');
                }
                
                // 关闭批量管理模式
                toggleBatchManagement('users');
            }
        }

        async function deleteSelectedTanknames() {
            const checkboxes = document.querySelectorAll('#tanknamesTableBody input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                notificationSystem.warning('请先选择要删除的用户ID', '警告');
                return;
            }

            if (confirm(`确定要删除选中的 ${checkboxes.length} 个用户ID吗？`)) {
                const indices = [];
                checkboxes.forEach(checkbox => {
                    const index = checkbox.getAttribute('data-index');
                    if (index) indices.push(parseInt(index));
                });

                // 从白名单数据中删除选中的用户ID
                indices.sort((a, b) => b - a).forEach(index => {
                    if (whitelistData[TANKNAMES_INDEX] && whitelistData[TANKNAMES_INDEX][index]) {
                        whitelistData[TANKNAMES_INDEX].splice(index, 1);
                    }
                });

                // 重新渲染表格
                renderTanknamesTable();
                notificationSystem.success(`成功删除 ${indices.length} 个用户ID`, '删除成功');
                
                // 自动保存到服务器
                try {
                    const jsonContent = JSON.stringify(whitelistData, null, 2);
                    const success = await updateGitHubFile(jsonContent);
                    if (success) {
                        notificationSystem.success('自动保存成功', '成功');
                        console.log('批量删除自动保存成功');
                    }
                } catch (error) {
                    console.error('批量删除自动保存失败:', error);
                    notificationSystem.error('批量删除自动保存失败: ' + error.message, '保存错误');
                }
                
                // 关闭批量管理模式
                toggleBatchManagement('tanknames');
            }
        }

        async function deleteSelectedGroups() {
            const checkboxes = document.querySelectorAll('#groupsTableBody input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                notificationSystem.warning('请先选择要删除的军团', '警告');
                return;
            }

            if (confirm(`确定要删除选中的 ${checkboxes.length} 个军团吗？`)) {
                const indices = [];
                checkboxes.forEach(checkbox => {
                    const index = checkbox.getAttribute('data-index');
                    if (index) indices.push(parseInt(index));
                });

                // 从白名单数据中删除选中的军团
                indices.sort((a, b) => b - a).forEach(index => {
                    if (whitelistData[GROUPS_INDEX] && whitelistData[GROUPS_INDEX][index]) {
                        whitelistData[GROUPS_INDEX].splice(index, 1);
                    }
                });

                // 重新渲染表格
                renderGroupsTable();
                notificationSystem.success(`成功删除 ${indices.length} 个军团`, '删除成功');
                
                // 自动保存到服务器
                try {
                    const jsonContent = JSON.stringify(whitelistData, null, 2);
                    const success = await updateGitHubFile(jsonContent);
                    if (success) {
                        notificationSystem.success('自动保存成功', '成功');
                        console.log('批量删除自动保存成功');
                    }
                } catch (error) {
                    console.error('批量删除自动保存失败:', error);
                    notificationSystem.error('批量删除自动保存失败: ' + error.message, '保存错误');
                }
                
                // 关闭批量管理模式
                toggleBatchManagement('groups');
            }
        }

        async function deleteSelectedOurs() {
            const checkboxes = document.querySelectorAll('#oursTableBody input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                notificationSystem.warning('请先选择要删除的开发者ID', '警告');
                return;
            }

            if (confirm(`确定要删除选中的 ${checkboxes.length} 个开发者ID吗？`)) {
                const indices = [];
                checkboxes.forEach(checkbox => {
                    const index = checkbox.getAttribute('data-index');
                    if (index) indices.push(parseInt(index));
                });

                // 从白名单数据中删除选中的开发者ID
                indices.sort((a, b) => b - a).forEach(index => {
                    if (whitelistData[OURS_INDEX] && whitelistData[OURS_INDEX][index]) {
                        whitelistData[OURS_INDEX].splice(index, 1);
                    }
                });

                // 重新渲染表格
                renderOursTable();
                notificationSystem.success(`成功删除 ${indices.length} 个开发者ID`, '删除成功');
                
                // 自动保存到服务器
                try {
                    const jsonContent = JSON.stringify(whitelistData, null, 2);
                    const success = await updateGitHub极File(jsonContent);
                    if (success) {
                        notificationSystem.success('自动保存成功', '成功');
                        console.log('批量删除自动保存成功');
                    }
                } catch (error) {
                    console.error('批量删除自动保存失败:', error);
                    notificationSystem.error('批量删除自动保存失败: ' + error.message, '保存错误');
                }
                
                // 关闭批量管理模式
                toggleBatchManagement('ours');
            }
        }

        async function deleteSelectedBlacklist() {
            const checkboxes = document.querySelectorAll('#blacklistTableBody input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                notificationSystem.warning('请先选择要删除的黑名单用户', '警告');
                return;
            }

            if (confirm(`确定要删除选中的 ${checkboxes.length} 个黑名单用户吗？`)) {
                const indices = [];
                checkboxes.forEach(checkbox => {
                    // 跳过默认的黑名单示例
                    if (checkbox.getAttribute('data-index') === 'default') return;
                    const index = checkbox.getAttribute('data-index');
                    if (index) indices.push(parseInt(index));
                });

                // 从白名单数据中删除选中的黑名单用户
                indices.sort((a, b) => b - a).forEach(index => {
                    if (whitelistData[BLACKLIST_INDEX] && whitelistData[BLACKLIST_INDEX][index]) {
                        whitelistData[BLACKLIST_INDEX].splice(index, 1);
                    }
                });

                // 重新渲染表格
                renderBlacklistTable();
                notificationSystem.success(`成功删除 ${indices.length} 个黑名单用户`, '删除成功');
                
                // 自动保存到服务器
                try {
                    const jsonContent = JSON.stringify(whitelistData, null, 2);
                    const success = await updateGitHubFile(jsonContent);
                    if (success) {
                        notificationSystem.success('自动保存成功', '成功');
                        console.log('批量删除自动保存成功');
                    }
                } catch (error) {
                    console.error('批量删除自动保存失败:', error);
                    notificationSystem.error('批量删除自动保存失败: ' + error.message, '保存错误');
                }
                
                // 关闭批量管理模式
                toggleBatchManagement('blacklist');
            }
        }

        // 修改渲染用户表格函数，添加复选框
        function renderUsersTable() {
            const tableBody = document.getElementById('usersTableBody');
            if (!tableBody || !whitelistData[USERS_INDEX]) return;

            tableBody.innerHTML = '';
            
            whitelistData[USERS_INDEX].forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-index="${index}" onchange="updateSelectAllState('users')">
                        </div>
                    </td>
                    <td>${user.id || '无ID'}</td>
                    <td>${user.name || '无名用户'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-user" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-user" data-index="${index}">删除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // 添加事件监听
            addUserTableEventListeners();
        }

        // 用户表格事件监听器
        function addUserTableEventListeners() {
            // 编辑按钮事件
            document.querySelectorAll('.edit-user').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    editUser(index);
                });
            });

            // 删除按钮事件
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    deleteUser(index);
                });
            });

            // 复选框选择事件
            document.querySelectorAll('#usersTableBody input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSelectAllState('users');
                });
            });
        }

        // 编辑用户
        function editUser(index) {
            if (whitelistData[USERS_INDEX] && whitelistData[USERS_INDEX][index]) {
                const user = whitelistData[USERS_INDEX][index];
                document.getElementById('editUserId').value = user.id || '';
                document.getElementById('editUserName').value = user.name || '';
                document.getElementById('editUserIndex').value = index;
                
                // 显示编辑模态框
                const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                editModal.show();
            }
        }

        // 删除用户
        function deleteUser(index) {
            if (whitelistData[USERS_INDEX] && whitelistData[USERS_INDEX][index]) {
                if (confirm('确定要删除这个用户吗？')) {
                    whitelistData[USERS_INDEX].splice(index, 1);
                    renderUsersTable();
                    notificationSystem.success('用户删除成功', '删除成功');
                    // 自动保存到服务器
                    deleteItemWithAutoSave(USERS_INDEX, index, renderUsersTable);
                }
            }
        }

        // 为所有搜索输入框添加回车键支持
        document.addEventListener('DOMContentLoaded', function() {
            const searchInputs = [
                'tanknamesSearchInput', 'groupsSearchInput', 'oursSearchInput',
                'ssSearchInput', 'cookie1SearchInput', 'usersSearchInput',
                'blacklistSearchInput'
            ];
            
            searchInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            const tableType = inputId.replace('SearchInput', '');
                            performTableSearch(tableType);
                        }
                    });
                }
            });

            // 添加用户按钮事件监听器
            const addUserBtn = document.getElementById('addUserBtn');
            if (addUserBtn) {
                addUserBtn.addEventListener('click', function() {
                    showAddUserModal();
                });
            }

            // 添加用户指纹数据按钮事件监听器
            const addFingerprintUserBtn = document.getElementById('addFingerprintUserBtn');
            if (addFingerprintUserBtn) {
                addFingerprintUserBtn.addEventListener('click', function() {
                    showAddUserModal();
                });
            }

            // 确保页面始终可滚动 - 修复黑名单添加后无法下滑的问题
            function ensurePageScrollable() {
                document.body.style.overflow = 'auto';
                document.body.style.overflowX = 'hidden';
                document.body.classList.remove('modal-open');
                document.body.style.paddingRight = '';
            }

            // 立即执行一次确保可滚动
            ensurePageScrollable();

            // 每隔一段时间检查并修复滚动状态
            setInterval(ensurePageScrollable, 1000);
        });

        // 自定义弹窗函数
        function showCustomPrompt(message, defaultValue, callback) {
            const modal = document.createElement('div');
            modal.style = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
                align-items: center; z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; width: 300px;">
                    <div style="margin-bottom: 10px;">${message}</div>
                    <input type="text" id="promptInput" value="${defaultValue || ''}" 
                           style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;">
                    <div style="display: flex; gap: 10极速赛车开奖结果查询; justify-content: flex-end;">
                        <button id="promptCancelBtn" class="btn btn-secondary">取消</button>
                        <button id="promptConfirmBtn" class="btn btn-primary">确定</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('promptInput').focus();
            
            // 添加事件监听器
            document.getElementById('promptCancelBtn').onclick = function() {
                modal.remove();
            };
            
            document.getElementById('promptConfirmBtn').onclick = function() {
                const value = document.getElementById('promptInput').value;
                modal.remove();
                callback(value);
            };
        }

        function showCustomConfirm(message, title = '确认', options = {}) {
            const modal = document.createElement('div');
            modal.style = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
                align-items: center; z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90vw;">
                    <h5 style="margin-bottom: 15px;">${title}</h5>
                    <div style="margin-bottom: 20px; max-height: 300px; overflow: auto;">${message}</div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        ${options.showCancel !== false ? `
                        <button id="cancelBtn" class="btn btn-secondary">${options.cancelText || '取消'}</button>
                        ` : ''}
                        <button id="confirmBtn" class="btn btn-primary">${options.confirmText || '确定'}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 添加事件监听器
            if (options.showCancel !== false) {
                document.getElementById('cancelBtn').onclick = function() {
                    modal.remove();
                    if (options.onCancel) options.onCancel();
                };
            }
            
            document.getElementById('confirmBtn').onclick = function() {
                modal.remove();
                if (options.onConfirm) options.onConfirm();
            };
        }

        // 自动保存函数 - 编辑项目
        async function editItemWithAutoSave(arrayIndex, itemIndex, newValue, renderFunction) {
            if (!whitelistData[arrayIndex]) {
                console.error('数组索引不存在:', arrayIndex);
                return;
            }
            
            // 更新数据
            whitelistData[arrayIndex][itemIndex] = newValue;
            
            // 重新渲染表格
            if (renderFunction && typeof renderFunction === 'function') {
                renderFunction();
            }
            
            // 自动保存到服务器
            try {
                const jsonContent = JSON.stringify(whitelistData, null, 2);
                const success = await updateGitHubFile(jsonContent);
                if (success) {
                    notificationSystem.success('自动保存成功', '成功');
                    console.log('自动保存成功');
                }
            } catch (error) {
                console.error('自动保存失败:', error);
                notificationSystem.error('自动保存失败: ' + error.message, '保存错误');
            }
        }

        // 自动保存函数 - 添加项目
        async function addItemWithAutoSave(arrayIndex, newItem, renderFunction) {
            if (!whitelistData[arrayIndex]) {
                whitelistData[arrayIndex] = [];
            }
            
            // 添加新项目
            whitelistData[arrayIndex].push(newItem);
            
            // 重新渲染表格
            if (renderFunction && typeof renderFunction === 'function') {
                renderFunction();
            }
            
            // 自动保存到服务器
            try {
                const jsonContent = JSON.stringify(whitelistData, null, 2);
                const success = await updateGitHubFile(jsonContent);
                if (success) {
                    notificationSystem.success('自动保存成功', '成功');
                    console.log('自动保存成功');
                }
            } catch (error) {
                console.error('自动保存失败:', error);
                notificationSystem.error('自动保存失败: ' + error.message, '保存错误');
            }
        }

        // 自动保存函数 - 删除项目
        async function deleteItemWithAutoSave(arrayIndex, itemIndex, renderFunction) {
            if (!whitelistData[arrayIndex]) {
                console.error('数组索引不存在:', arrayIndex);
                return;
            }
            
            // 删除项目
            whitelistData[arrayIndex].splice(itemIndex, 1);
            
            // 重新渲染表格
            if (renderFunction && typeof renderFunction === 'function') {
                renderFunction();
            }
            
            // 自动保存到服务器
            try {
                const jsonContent = JSON.stringify(whitelistData, null, 2);
                const success = await updateGitHubFile(jsonContent);
                if (success) {
                    notificationSystem.success('自动保存成功', '成功');
                    console.log('自动保存成功');
                }
            } catch (error) {
                console.error('自动保存失败:', error);
                notificationSystem.error('自动保存失败: ' + error.message, '保存错误');
            }
        }
 </script>

</body>
</html>

 </script>

</body>
</html>
