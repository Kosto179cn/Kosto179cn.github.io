
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kosto管理系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css?v=1.0" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js?v=1.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 24px;
            font-weight: 600;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 16px;
            color: var(--secondary-color);
            text-align: center;
        }

        .content-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        .list-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 120px;
        }

        .list-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 120px;
            align-items: center;
        }

        .list-item:hover {
            background-color: #f8f9fa;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .block-btn {
            background-color: var(--danger-color);
            color: white;
        }

        .block-btn:hover {
            background-color: #c82333;
        }

        .open-link-btn {
            background-color: #28a745 !important;
            margin-left: 8px;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 4px;
        }

        .open-link-btn:hover {
            background-color: #218838 !important;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .refresh-btn {
            background-color: var(--success-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .refresh-btn:hover {
            background-color: #218838;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online {
            background-color: var(--success-color);
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            color: var(--secondary-color);
            font-size: 14px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .title {
                font-size: 20px;
            }

            .stats-container {
                flex-direction: column;
                gap: 15px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 28px;
            }

            .hidden-sm {
                display: none;
            }

            .nav-tabs {
                flex-wrap: wrap;
                gap: 5px;
                margin-bottom: 15px;
            }

            .nav-tabs button {
                padding: 8px 12px;
                font-size: 14px;
                flex: 1;
                min-width: 120px;
            }

            .card-header {
                padding: 12px 15px;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .card-body {
                padding: 15px;
            }

            .list-header {
                padding: 12px 15px;
                grid-template-columns: 1fr 1fr 80px;
                font-size: 14px;
            }

            .list-item {
                padding: 12px 15px;
                grid-template-columns: 1fr 1fr 80px;
                font-size: 14px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }

            .action-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .table-responsive {
                font-size: 14px;
            }

            th, td {
                padding: 8px 10px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 14px;
            }

            .btn-lg {
                padding: 10px 16px;
                font-size: 16px;
            }

            .d-flex.gap-3 {
                flex-direction: column;
                gap: 10px !important;
            }

            .input-group {
                width: 100% !important;
            }

            .refresh-btn {
                width: 100%;
                margin-top: 10px;
            }

            /* 最新有效用户区域优化 */
            #latestValidUser {
                font-size: 16px !important;
            }

            #latestUserFingerprint {
                font-size: 11px !important;
                line-height: 1.3;
            }

            /* 模态框优化 */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }

            .modal-body {
                padding: 15px;
            }

            .form-control {
                font-size: 16px; /* 防止iOS缩放 */
            }
        }

        @media (max-width: 480px) {
            .title {
                font-size: 18px;
            }

            .nav-tabs button {
                min-width: 100px;
                padding: 6px 8px;
                font-size: 12px;
            }

            .stat-value {
                font-size: 24px;
            }

            .list-header,
            .list-item {
                grid-template-columns: 1fr 60px;
                font-size: 13px;
            }

            .list-header div:nth-child(2),
            .list-item div:nth-child(2) {
                display: none;
            }

            .action-btn {
                font-size: 11px;
                padding: 4px 8px;
            }

            th, td {
                padding: 6px 8px;
                font-size: 13px;
            }

            .btn {
                font-size: 13px;
            }
        }

        /* 导航样式 */
        .nav-tabs {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tabs li {
            margin-bottom: -1px;
        }

        .nav-tabs button {
            padding: 10px 20px;
            text-decoration: none;
            color: var(--secondary-color);
            background: none;
            border: 1px solid transparent;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tabs button.active {
            color: var(--primary-color);
            border-color: var(--border-color) var(--border-color) white;
            background-color: white;
            font-weight: 500;
        }

        .nav-tabs button:hover {
            color: var(--primary-color);
            border-color: var(--border-color);
        }

        /* 表格样式 */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* 移动端触摸优化 */
        .action-btn, .btn {
            min-height: 44px; /* iOS推荐的最小触摸目标 */
            touch-action: manipulation; /* 防止双击缩放 */
        }

        /* 表格滚动优化 */
        .table-responsive {
            -webkit-overflow-scrolling: touch;
        }

        /* 防止文本选择影响触摸 */
        .nav-tabs button, .action-btn {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* 游戏链接验证消息样式 */
        .validation-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 400px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            line-height: 1.4;
            animation: slideInRight 0.3s ease-out;
        }

        .validation-message.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .validation-message.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .validation-message.warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .validation-message i {
            margin-right: 8px;
            font-size: 16px;
        }

        .validation-message .close-btn {
            position: absolute;
            top: 8px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .validation-message .close-btn:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* 验证日志查看器样式 */
        .validation-logs {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-entry.success {
            background-color: #d4edda;
            border-left: 3px solid #28a745;
        }

        .log-entry.error {
            background-color: #f8d7da;
            border-left: 3px solid #dc3545;
        }

        .log-timestamp {
            color: #6c757d;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="title">Kosto管理系统</div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <div class="input-group" style="width: 250px; min-width: 200px;">
                        <input type="password" id="giteeToken" class="form-control" placeholder="GitHub Token">
                        <button class="btn btn-secondary" type="button" id="saveTokenBtn">保存</button>
                    </div>
                    <button id="refreshBtn" class="refresh-btn">刷新数据</button>
                </div>
            </div>
        </header>

        <!-- 权限提示 -->
        <div id="permissionError" class="content-card" style="display: none;">
            <div class="card-body">
                <h2 style="color: var(--danger-color);">权限不足</h2>
                <p>您的GitHub Token没有编辑1.json的权限，请输入有效的Token。</p>
            </div>
        </div>

        <!-- 导航标签 -->
        <ul class="nav-tabs">
            <li role="presentation">
                <button class="active" id="online-tab" data-tab="online" type="button">
                    <i class="fas fa-users"></i> 在线管理
                </button>
            </li>
            <li role="presentation">
                <button id="tanknames-tab" data-tab="tanknames" type="button">
                    <i class="fas fa-id-card"></i> 白名单用户ID
                </button>
            </li>
            <li role="presentation">
                <button id="groups-tab" data-tab="groups" type="button">
                    <i class="fas fa-users"></i> 白名单军团
                </button>
            </li>
            <li role="presentation">
                <button id="ours-tab" data-tab="ours" type="button">
                    <i class="fas fa-crown"></i> 开发者ID
                </button>
            </li>
            <li role="presentation">
                <button id="ss-tab" data-tab="ss" type="button">
                    <i class="fas fa-bomb"></i> 自爆程序标志
                </button>
            </li>
            <li role="presentation">
                <button id="cookie1-tab" data-tab="cookie1" type="button">
                    <i class="fas fa-key"></i> 身份验证Cookie
                </button>
            </li>
            <li role="presentation">
                <button id="users-tab" data-tab="users" type="button">
                    <i class="fas fa-user"></i> 用户指纹数据
                </button>
            </li>
            <li role="presentation">
                <button id="blacklist-tab" data-tab="blacklist" type="button">
                    <i class="fas fa-ban"></i> 黑名单用户
                </button>
            </li>
            <li role="presentation">
                <button id="validation-tab" data-tab="validation" type="button">
                    <i class="fas fa-shield-alt"></i> 链接验证日志
                </button>
            </li>
            <li role="presentation">
                <button id="test-tab" data-tab="test" type="button">
                    <i class="fas fa-vial"></i> 验证测试
                </button>
            </li>
        </ul>

        <!-- 在线管理内容 -->
        <div id="online-content" class="tab-content active">
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">当前在线人数</div>
                    <div id="currentOnline" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">今日总人数</div>
                    <div id="todayTotal" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">最新有效用户</div>
                    <div id="latestValidUser" class="stat-value" style="font-size: 18px; line-height: 1.2;">
                        <div id="latestUserName" style="color: var(--primary-color); word-break: break-all;">-</div>
                        <div id="latestUserFingerprint" style="font-size: 12px; color: var(--secondary-color); margin-top: 5px; white-space: pre-line; word-break: break-all;">-</div>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <div>在线用户列表</div>
                </div>
                <div class="list-header">
                    <div>用户名</div>
                    <div>ID</div>
                    <div class="hidden-sm">脚本名称</div>
                    <div class="hidden-sm">当前阶段</div>
                    <div class="hidden-sm">最后活动</div>
                    <div class="hidden-sm">在线时长</div>
                    <div>操作</div>
                </div>
                <div id="userList"></div>
            </div>

            <div class="footer">
                <p>数据来源: <a href="https://gitee.com/Kosto179/kosto-battle-clicker-new/blob/master/log.json" target="_blank">https://gitee.com/Kosto179/kosto-battle-clicker-new/blob/master/log.json</a></p>
                <p>上次更新时间: <span id="lastUpdateTime">未更新</span></p>
            </div>
        </div>

        <!-- 白名单管理内容 -->
        <div id="tanknames-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>白名单用户ID</div>
                    <button type="button" class="btn btn-primary" id="addTanknameBtn">
                        <i class="fas fa-plus"></i> 添加ID
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>用户ID</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="tanknamesTableBody">
                                <!-- 白名单用户ID数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="groups-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>白名单军团</div>
                    <button type="button" class="btn btn-primary" id="addGroupBtn">
                        <i class="fas fa-plus"></i> 添加军团
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>军团名称</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="groupsTableBody">
                                <!-- 组数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="ours-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>开发者ID</div>
                    <button type="button" class="btn btn-primary" id="addOurBtn">
                        <i class="fas fa-plus"></i> 添加开发者
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>开发者ID</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="oursTableBody">
                                <!-- 数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="ss-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>自爆程序标志</div>
                    <button type="button" class="btn btn-primary" id="addSsBtn">
                        <i class="fas fa-plus"></i> 添加标志
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>标志值</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="ssTableBody">
                                <!-- 数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="cookie1-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>身份验证Cookie</div>
                    <button type="button" class="btn btn-primary" id="addCookie1Btn">
                        <i class="fas fa-plus"></i> 添加Cookie
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Cookie值</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="cookie1TableBody">
                                <!-- 数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="users-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>用户特定数据</div>
                    <button type="button" class="btn btn-primary" id="addUserBtn">
                        <i class="fas fa-plus"></i> 添加用户
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>名称</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- 用户数据将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 黑名单管理内容 -->
        <div id="blacklist-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>黑名单用户</div>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBlacklistModal">
                        <i class="fas fa-plus"></i> 添加黑名单用户
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>用户ID</th>
                                    <th>用户名称</th>
                                    <th>用户军团</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="blacklistTableBody">
                <!-- 黑名单数据将通过JS动态加载 -->
                <tr id="default-blacklist-user">
                    <td>BLOCKED_USER_123</td>
                    <td>已拉黑用户</td>
                    <td>[黑名单军团]</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-blacklist" data-index="default">编辑</button>
                        <button class="btn btn-sm btn-danger delete-blacklist" data-index="default">删除</button>
                    </td>
                </tr>
            </tbody>
        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 链接验证日志内容 -->
        <div id="validation-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div>游戏链接验证日志</div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" id="refreshValidationLogs">
                            <i class="fas fa-sync-alt"></i> 刷新日志
                        </button>
                        <button type="button" class="btn btn-warning" id="clearValidationLogs">
                            <i class="fas fa-trash"></i> 清空日志
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 验证统计信息 -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">总验证次数</div>
                                <div id="totalValidations" class="stat-value" style="font-size: 24px;">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">验证通过</div>
                                <div id="validValidations" class="stat-value" style="font-size: 24px; color: #28a745;">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">验证失败</div>
                                <div id="invalidValidations" class="stat-value" style="font-size: 24px; color: #dc3545;">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">成功率</div>
                                <div id="successRate" class="stat-value" style="font-size: 24px; color: #17a2b8;">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 验证日志列表 -->
                    <div class="validation-logs" id="validationLogsList">
                        <div class="text-center text-muted">暂无验证日志</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 验证测试内容 -->
        <div id="test-content" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <div><i class="fas fa-vial"></i> 游戏链接验证系统测试</div>
                    <div class="text-muted small">测试验证功能是否正常工作</div>
                </div>
                <div class="card-body">
                    <!-- 测试用例区域 -->
                    <div class="row">
                        <!-- 测试用例1: 正确的链接 -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <i class="fas fa-check-circle"></i> 测试用例1: 正确的游戏链接
                                </div>
                                <div class="card-body">
                                    <p class="card-text">测试包含正确referrer的游戏链接验证</p>
                                    <button class="btn btn-success" onclick="testValidLink()">
                                        <i class="fas fa-play"></i> 测试正确链接
                                    </button>
                                    <div id="test1-result" class="mt-3"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 测试用例2: 错误的referrer -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-danger text-white">
                                    <i class="fas fa-times-circle"></i> 测试用例2: 错误的referrer
                                </div>
                                <div class="card-body">
                                    <p class="card-text">测试包含错误referrer的链接验证</p>
                                    <button class="btn btn-danger" onclick="testInvalidReferrer()">
                                        <i class="fas fa-play"></i> 测试错误referrer
                                    </button>
                                    <div id="test2-result" class="mt-3"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 测试用例3: 缺少referrer -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-white">
                                    <i class="fas fa-exclamation-triangle"></i> 测试用例3: 缺少referrer
                                </div>
                                <div class="card-body">
                                    <p class="card-text">测试缺少referrer字段的链接验证</p>
                                    <button class="btn btn-warning" onclick="testMissingReferrer()">
                                        <i class="fas fa-play"></i> 测试缺少referrer
                                    </button>
                                    <div id="test3-result" class="mt-3"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 测试用例4: URL参数验证 -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-info text-white">
                                    <i class="fas fa-link"></i> 测试用例4: URL参数验证
                                </div>
                                <div class="card-body">
                                    <p class="card-text">测试URL参数中的referrer验证</p>
                                    <button class="btn btn-info" onclick="testUrlParameter()">
                                        <i class="fas fa-play"></i> 测试URL参数
                                    </button>
                                    <div id="test4-result" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 批量测试按钮 -->
                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg" onclick="runAllTests()">
                            <i class="fas fa-play-circle"></i> 运行所有测试
                        </button>
                        <button class="btn btn-secondary btn-lg ms-2" onclick="clearAllTestResults()">
                            <i class="fas fa-eraser"></i> 清空测试结果
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 保存按钮 -->
        <div class="d-flex justify-content-center mt-4 gap-3">
            <button id="saveChangesBtn" class="btn btn-success btn-lg">保存更改</button>
            <button id="openSourceBtn" class="btn btn-info btn-lg">
                <i class="fas fa-external-link-alt"></i> 打开源文件
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js?v=1.0"></script>
    <script src="游戏链接验证器.js"></script>
    <script>
        // API配置 - 更新为GitHub链接
        const API_CONFIG = {
            whitelist: 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://gitee.com/Kosto179/kosto-battle-clicker-new/raw/master/1.json'),
            updateLog: 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://gitee.com/Kosto179/kosto-battle-clicker-new/raw/master/log.json')
        };

        // 配置
        const CONFIG = {
            LOG_URL: API_CONFIG.updateLog,
            WHITELIST_URL: API_CONFIG.whitelist,
            ONLINE_THRESHOLD_MINUTES: 1.5, // 90秒内有活动视为在线
            REFRESH_INTERVAL_MS: 60000, // 自动刷新间隔(毫秒) - 改为60秒
        };

        // 存储白名单数据
        let whitelistData = [];
        const TANKNAMES_INDEX = 0; // 白名单用户ID在JSON中的索引
        const GROUPS_INDEX = 1;   // 组数据在JSON中的索引
        const OURS_INDEX = 2;     // 开发者ID在JSON中的索引
        const SS_INDEX = 3;       // 自爆程序标志在JSON中的索引
        const COOKIE1_INDEX = 4;  // 身份验证Cookie在JSON中的索引
        const USERS_INDEX = 5;    // 用户数据在JSON中的索引
        const BLACKLIST_INDEX = 6; // 黑名单数据在JSON中的索引

        // DOM元素
        const tanknamesTableBody = document.getElementById('tanknamesTableBody');
        const groupsTableBody = document.getElementById('groupsTableBody');
        const oursTableBody = document.getElementById('oursTableBody');
        const ssTableBody = document.getElementById('ssTableBody');
        const cookie1TableBody = document.getElementById('cookie1TableBody');
        const usersTableBody = document.getElementById('usersTableBody');
        const blacklistTableBody = document.getElementById('blacklistTableBody');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const permissionError = document.getElementById('permissionError');

        // 存储拉黑名单(基于指纹)
        let blockedFingerprints = new Set();

        // 导航标签切换
        document.querySelectorAll('.nav-tabs button').forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有活动状态
                document.querySelectorAll('.nav-tabs button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });

                // 设置当前活动状态
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-content`).style.display = 'block';
                
                // 处理标签页切换的特殊逻辑
                handleTabSwitch(tabId);
            });
        });

        // 获取数据的通用函数
        async function fetchData(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                        cache: 'no-cache'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // 如果是 Gitee API 响应，需要解码 base64 内容
                    // 检查是否是 allorigins 代理格式
                    if (data.contents) {
                        return JSON.parse(data.contents);
                    }
                    
                    // 如果是直接的 JSON 数据
                    return data;
                } catch (error) {
                    console.warn(`尝试 ${i + 1}/${retries} 失败:`, error.message);
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }

        // 从本地存储加载拉黑名单
        function loadBlockedUsers() {
            const saved = localStorage.getItem('blockedFingerprints');
            if (saved) {
                blockedFingerprints = new Set(JSON.parse(saved));
            }
        }

        // 保存拉黑名单到本地存储
        function saveBlockedUsers() {
            localStorage.setItem('blockedFingerprints', JSON.stringify([...blockedFingerprints]));
        }

        // 拉黑用户
        async function blockUser(fingerprint, username) {
            if (confirm(`确定要拉黑用户 ${username} 吗？`)) {
                try {
                    // 添加到本地拉黑集合
                    blockedFingerprints.add(fingerprint);
                    saveBlockedUsers();
                    
                    // 获取用户详细信息
                    const userDetail = window.userDetails && window.userDetails[fingerprint];
                    
                    // 确保黑名单数组存在
                    if (!whitelistData[BLACKLIST_INDEX]) {
                        whitelistData[BLACKLIST_INDEX] = [];
                    }
                    
                    // 检查是否已存在于黑名单中
                    const exists = whitelistData[BLACKLIST_INDEX].some(blackUser => 
                        blackUser.id === (userDetail?.getid || fingerprint) || 
                        blackUser.fingerprint === fingerprint
                    );
                    
                    if (!exists) {
                        // 添加到黑名单数组
                        const blacklistEntry = {
                            id: userDetail?.getid || fingerprint,
                            name: username === '未知用户' ? (userDetail?.username || 'unknown') : username,
                            corp: '',
                            fingerprint: fingerprint,
                            blockedAt: new Date().toISOString()
                        };
                        
                        whitelistData[BLACKLIST_INDEX].push(blacklistEntry);
                        
                        // 立即保存到服务器
                        const jsonContent = JSON.stringify(whitelistData, null, 2);
                        const success = await updateGitHubFile(jsonContent);
                        
                        if (success) {
                            alert(`用户 ${username} 已成功拉黑并上传到服务器！`);
                            // 刷新黑名单表格显示
                            renderBlacklistTable();
                        } else {
                            alert(`用户 ${username} 已本地拉黑，但上传到服务器失败，请稍后手动保存。`);
                        }
                    } else {
                        alert(`用户 ${username} 已在黑名单中！`);
                    }
                    
                    // 刷新在线数据显示
                    fetchOnlineData();
                } catch (error) {
                    console.error('拉黑用户失败:', error);
                    alert(`拉黑用户失败: ${error.message}`);
                }
            }
        }

        // 格式化时间
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 计算在线时长(分钟)
        function calculateOnlineTime(onlineTimeSeconds) {
            return Math.round(onlineTimeSeconds / 60);
        }

        // 处理数据
        function processData(data) {
            if (!data || !Array.isArray(data)) {
                console.error('数据格式无效');
                return { currentOnlineUsers: [], todayTotalUsers: 0, latestValidUser: null, blockedUsers: [] };
            }

            const now = new Date();
            const offlineThresholdAgo = new Date(now.getTime() - CONFIG.ONLINE_THRESHOLD_MINUTES * 60000);
            const todayStart = new Date(now);
            todayStart.setHours(0, 0, 0, 0);

            // 筛选今日数据 - 兼容新旧数据格式
            const todayData = data.filter(item => {
                const timestamp = item.time || item.timestamp;
                return new Date(timestamp) >= todayStart;
            });

            // 获取今日所有唯一用户(基于fingerprint)
            const todayUsers = new Set(todayData.map(item => item.fingerprint || item.username));

            // 筛选在线用户（5分钟内有活动）
            const onlineUsers = data.filter(item => {
                const timestamp = item.time || item.timestamp;
                const entryTime = new Date(timestamp);
                const fingerprint = item.fingerprint || item.username;
                return entryTime >= offlineThresholdAgo && !blockedFingerprints.has(fingerprint);
            });

            // 筛选被拉黑的在线用户
            const blockedUsers = data.filter(item => {
                const timestamp = item.time || item.timestamp;
                const entryTime = new Date(timestamp);
                const fingerprint = item.fingerprint || item.username;
                return entryTime >= offlineThresholdAgo && blockedFingerprints.has(fingerprint);
            });

            // 按fingerprint分组并获取每个用户的最后活动记录
            const userGroups = new Map();
            onlineUsers.forEach(item => {
                const fingerprint = item.fingerprint || item.username;
                if (!userGroups.has(fingerprint) || new Date(item.timestamp) > new Date(userGroups.get(fingerprint).timestamp)) {
                    userGroups.set(fingerprint, item);
                }
            });

            // 转换为数组并排序(按最后活动时间降序)
            const currentOnlineUsers = Array.from(userGroups.values()).sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            
            // 处理被拉黑的用户
            const blockedUserGroups = new Map();
            blockedUsers.forEach(item => {
                const fingerprint = item.fingerprint || item.username;
                if (!blockedUserGroups.has(fingerprint) || new Date(item.timestamp) > new Date(blockedUserGroups.get(fingerprint).timestamp)) {
                    blockedUserGroups.set(fingerprint, item);
                }
            });
            
            // 转换为数组并排序
            const blockedOnlineUsers = Array.from(blockedUserGroups.values()).sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            // 查找最新的有效用户（getid不等于unknown，不考虑是否在线）
            let latestValidUser = null;
            const validUsers = data.filter(user => 
                user.getid && user.getid.toLowerCase() !== 'unknown'
            );
            
            if (validUsers.length > 0) {
                // 按时间排序，取最新的
                latestValidUser = validUsers.sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                )[0];
            }

            return {
                currentOnlineUsers,
                todayTotalUsers: todayUsers.size,
                latestValidUser,
                blockedOnlineUsers
            };
        }

        // 渲染用户列表
        function renderUserList(users, blockedUsers = []) {
            const userListElement = document.getElementById('userList');
            userListElement.innerHTML = '';

            // 添加在线用户
            if (users.length === 0 && blockedUsers.length === 0) {
                userListElement.innerHTML = '<div class="list-item"><div colspan="5">当前没有在线用户</div></div>';
                return;
            }

            // 添加在线用户标题
            if (users.length > 0) {
                const onlineHeader = document.createElement('div');
                onlineHeader.className = 'list-item';
                onlineHeader.style.backgroundColor = '#e9ecef';
                onlineHeader.style.fontWeight = 'bold';
                onlineHeader.innerHTML = '<div colspan="5">在线用户</div>';
                userListElement.appendChild(onlineHeader);
                
                users.forEach(user => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';

                    const timestamp = user.time || user.timestamp;
                    const lastActiveTime = formatTime(timestamp);
                    const onlineTime = calculateOnlineTime(user.details?.onlineTime || 0);

                    // 处理用户名显示问题
                    let displayUsername = user.username;
                    if (displayUsername.toLowerCase() === 'unknown') {
                        displayUsername = '未知用户';
                    }

                    const fingerprint = user.fingerprint || user.username;
                    const userId = fingerprint;
                    
                    // 存储用户数据到全局对象
                    window.userDetails = window.userDetails || {};
                    window.userDetails[userId] = user;
                    
                    // 检查是否包含可打开的链接
                    const hasOpenableLink = checkForOpenableLink(user.details);
                    const openButtonHtml = hasOpenableLink ? 
                        `<button class="action-btn open-link-btn" onclick="openUserLink('${userId}')">打开</button>` : '';
                    
                    const scriptName = user.scriptName || '未知脚本';
                    const phase = user.phase || '未知阶段';
                    const onlineDuration = user.onlineDurationText || (calculateOnlineTime(user.details?.onlineTime || 0) + '分钟');
                    
                    listItem.innerHTML = `
                        <div><span class="status-indicator status-online"></span>${displayUsername}</div>
                        <div>${user.getid || '未知'}</div>
                        <div class="hidden-sm">${scriptName}</div>
                        <div class="hidden-sm">${phase}</div>
                        <div class="hidden-sm">${lastActiveTime}</div>
                        <div class="hidden-sm">${onlineDuration}</div>
                        <div class="user-actions">
                            <button class="action-btn btn-info" onclick="showUserDetails('${userId}')">详情</button>
                            <button class="action-btn block-btn" onclick="blockUser('${fingerprint}', '${displayUsername}')">拉黑</button>
                            ${openButtonHtml}
                        </div>
                    `;
                    userListElement.appendChild(listItem);
                });
            }
            
            // 添加已拉黑用户
            if (blockedUsers.length > 0) {
                const blockedHeader = document.createElement('div');
                blockedHeader.className = 'list-item';
                blockedHeader.style.backgroundColor = '#f8d7da';
                blockedHeader.style.fontWeight = 'bold';
                blockedHeader.innerHTML = '<div colspan="5">已拉黑用户</div>';
                userListElement.appendChild(blockedHeader);
                
                blockedUsers.forEach(user => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    listItem.style.backgroundColor = '#fff3f5';

                    const lastActiveTime = formatTime(user.timestamp);
                    const onlineTime = calculateOnlineTime(user.details?.onlineTime || 0);

                    // 处理用户名显示问题
                    let displayUsername = user.username;
                    if (displayUsername.toLowerCase() === 'unknown') {
                        displayUsername = '未知用户';
                    }

                    const fingerprint = user.fingerprint || user.username;
                    const userId = fingerprint;
                    
                    // 存储用户数据到全局对象
                    window.userDetails = window.userDetails || {};
                    window.userDetails[userId] = user;
                    
                    const scriptName = user.scriptName || '未知脚本';
                    const phase = user.phase || '未知阶段';
                    const onlineDuration = user.onlineDurationText || (calculateOnlineTime(user.details?.onlineTime || 0) + '分钟');
                    
                    listItem.innerHTML = `
                        <div><span class="status-indicator" style="background-color: #dc3545;"></span>${displayUsername} <span class="badge bg-danger">已拉黑</span></div>
                        <div>${user.getid || '未知'}</div>
                        <div class="hidden-sm">${scriptName}</div>
                        <div class="hidden-sm">${phase}</div>
                        <div class="hidden-sm">${lastActiveTime}</div>
                        <div class="hidden-sm">${onlineDuration}</div>
                        <div class="user-actions">
                            <button class="action-btn btn-info" onclick="showUserDetails('${userId}')">详情</button>
                            <button class="action-btn btn-success" onclick="unblockUser('${fingerprint}', '${displayUsername}')">解除拉黑</button>
                        </div>
                    `;
                    userListElement.appendChild(listItem);
                });
            }
        }

        // 更新统计信息
        function updateStats(currentOnline, todayTotal, latestValidUser) {
            const currentOnlineEl = document.getElementById('currentOnline');
            const todayTotalEl = document.getElementById('todayTotal');
            const lastUpdateTimeEl = document.getElementById('lastUpdateTime');
            
            if (currentOnlineEl) currentOnlineEl.textContent = currentOnline;
            if (todayTotalEl) todayTotalEl.textContent = todayTotal;
            if (lastUpdateTimeEl) lastUpdateTimeEl.textContent = new Date().toLocaleString('zh-CN');
            
            // 更新最新有效用户信息
            const latestUserNameElement = document.getElementById('latestUserName');
            const latestUserFingerprintElement = document.getElementById('latestUserFingerprint');
            
            if (latestValidUser) {
                let displayUsername = latestValidUser.username;
                if (displayUsername && displayUsername.toLowerCase() === 'unknown') {
                    displayUsername = '未知用户';
                }
                
                if (latestUserNameElement) {
                    latestUserNameElement.textContent = `${displayUsername} (${latestValidUser.getid})`;
                }
                
                // 构建指纹显示文本，包含最后活动时间
                let fingerprintText = `指纹: ${latestValidUser.fingerprint || '无'}`;
                const latestTimestamp = latestValidUser.time || latestValidUser.timestamp;
                fingerprintText += `\n最后活动: ${formatTime(latestTimestamp)}`;
                
                // 与用户指纹数据进行比对
                if (latestValidUser.fingerprint && whitelistData[USERS_INDEX]) {
                    const matchedUser = whitelistData[USERS_INDEX].find(user => 
                        user.id === latestValidUser.fingerprint
                    );
                    
                    if (matchedUser) {
                        fingerprintText += `\n用户名称："${matchedUser.name}"`;
                    }
                }
                
                if (latestUserFingerprintElement) {
                    latestUserFingerprintElement.textContent = fingerprintText;
                }
            } else {
                if (latestUserNameElement) {
                    latestUserNameElement.textContent = '暂无';
                }
                if (latestUserFingerprintElement) {
                    latestUserFingerprintElement.textContent = '指纹: -';
                }
            }
        }

        // 获取在线数据
        function ensureTodaySection() {
            const onlineContent = document.getElementById('online-content');
            if (!onlineContent) return null;
            let section = document.getElementById('todayUsersSection');
            if (!section) {
                section = document.createElement('div');
                section.id = 'todayUsersSection';
                section.className = 'card';
                section.innerHTML = `
                    <div class="card-header">
                        <div>今日在线名单（含已离线）</div>
                        <div class="header-actions">
                            <small id="todayUsersCount" style="color:#6c757d"></small>
                        </div>
                    </div>
                    <div class="list-header hidden-sm">
                        <div>用户名</div>
                        <div>指纹/getid</div>
                        <div class="hidden-sm">最后活动</div>
                        <div class="hidden-sm">状态</div>
                        <div>操作</div>
                    </div>
                    <div id="todayUserList" class="list-container"></div>
                `;
                onlineContent.appendChild(section);
            }
            return section;
        }

        function computeTodayAllUsers(data) {
            try {
                const now = new Date();
                const todayStart = new Date(now);
                todayStart.setHours(0, 0, 0, 0);
                const todayData = (data || []).filter(item => {
                    const t = item.time || item.timestamp;
                    return t && new Date(t) >= todayStart;
                });
                const map = new Map();
                todayData.forEach(item => {
                    const fingerprint = item.fingerprint || item.username;
                    if (!fingerprint) return;
                    const ts = new Date(item.time || item.timestamp);
                    const prev = map.get(fingerprint);
                    if (!prev || ts > new Date(prev.timestamp)) {
                        map.set(fingerprint, {
                            fingerprint,
                            username: item.username || fingerprint,
                            getid: item.getid,
                            timestamp: item.time || item.timestamp,
                            details: item.details || {},
                            onlineDurationText: item.onlineDurationText,
                            phase: item.phase
                        });
                    }
                });
                return Array.from(map.values()).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } catch (e) {
                console.error('computeTodayAllUsers error', e);
                return [];
            }
        }

        function renderTodayUserList(users) {
            ensureTodaySection();
            const listEl = document.getElementById('todayUserList');
            const countEl = document.getElementById('todayUsersCount');
            if (!listEl) return;
            listEl.innerHTML = '';
            if (countEl) countEl.textContent = `今日出现人数：${users?.length || 0}`;
            if (!users || users.length === 0) {
                listEl.innerHTML = '<div class="list-item"><div colspan="5">今日暂无用户记录</div></div>';
                return;
            }
            const now = Date.now();
            users.forEach(user => {
                const displayUsername = user.username || user.fingerprint || '未知用户';
                const lastActiveTime = typeof formatTime === 'function' ? formatTime(user.timestamp) : (new Date(user.timestamp)).toLocaleString('zh-CN');
                const isOnline = new Date(user.timestamp) >= new Date(now - (CONFIG?.ONLINE_THRESHOLD_MINUTES || 1.5) * 60000);
                const statusHtml = isOnline ? '<span class="status-indicator status-online"></span>在线' : '<span class="status-indicator status-offline"></span>离线';
                const onlineDuration = user.onlineDurationText || (typeof calculateOnlineTime === 'function' ? (calculateOnlineTime(user.details?.onlineTime || 0) + '分钟') : '-');
                const item = document.createElement('div');
                item.className = 'list-item';
                const userId = (user.fingerprint || user.username || 'unknown') + '_' + (user.getid || 'id');
                window.userDetails = window.userDetails || {};
                window.userDetails[userId] = user;
                item.innerHTML = `
                    <div>${displayUsername}</div>
                    <div>${user.getid || '未知'}</div>
                    <div class="hidden-sm">${lastActiveTime}</div>
                    <div class="hidden-sm">${statusHtml}</div>
                    <div class="user-actions">
                        <button class="action-btn btn-info" onclick="showUserDetails('${userId}')">详情</button>
                        <small style="margin-left:8px;color:#6c757d">${onlineDuration}</small>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        async function fetchOnlineData() {
            try {
                const logData = await fetchData(API_CONFIG.updateLog);
                const { currentOnlineUsers, todayTotalUsers, latestValidUser, blockedOnlineUsers } = processData(logData);
                renderUserList(currentOnlineUsers, blockedOnlineUsers);
                const todayAllUsers = computeTodayAllUsers(logData);
                renderTodayUserList(todayAllUsers);
                updateStats(currentOnlineUsers.length, todayTotalUsers, latestValidUser);
                console.log('在线数据获取成功');
            } catch (error) {
                console.error('获取在线数据失败:', error);
                alert(`获取在线数据失败: ${error.message}`);
            }
        }

        // 渲染白名单用户ID表格
        function renderTanknamesTable() {
            const tanknames = whitelistData[TANKNAMES_INDEX] || [];
            tanknamesTableBody.innerHTML = '';

            tanknames.forEach((id, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${id}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-tankname" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-tankname" data-index="${index}">删除</button>
                        <button class="btn btn-sm btn-dark blacklist-tankname" data-index="${index}">拉黑</button>
                    </td>
                `;
                tanknamesTableBody.appendChild(row);
            });

            // 添加事件监听器
            document.querySelectorAll('.edit-tankname').forEach(button => {
                button.addEventListener('click', (e) => editItem(TANKNAMES_INDEX, parseInt(e.target.dataset.index), '编辑白名单用户ID'));
            });
            document.querySelectorAll('.delete-tankname').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(TANKNAMES_INDEX, parseInt(e.target.dataset.index), renderTanknamesTable));
            });
            document.querySelectorAll('.blacklist-tankname').forEach(button => {
                button.addEventListener('click', (e) => blacklistItem(TANKNAMES_INDEX, parseInt(e.target.dataset.index), 'id'));
            });
        }

        // 渲染白名单军团表格
        function renderGroupsTable() {
            const groups = whitelistData[GROUPS_INDEX] || [];
            groupsTableBody.innerHTML = '';

            groups.forEach((group, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${group}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-group" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-group" data-index="${index}">删除</button>
                        <button class="btn btn-sm btn-dark blacklist-group" data-index="${index}">拉黑</button>
                    </td>
                `;
                groupsTableBody.appendChild(row);
            });

            // 添加事件监听器
            document.querySelectorAll('.edit-group').forEach(button => {
                button.addEventListener('click', (e) => editItem(GROUPS_INDEX, parseInt(e.target.dataset.index), '编辑白名单军团'));
            });
            document.querySelectorAll('.delete-group').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(GROUPS_INDEX, parseInt(e.target.dataset.index), renderGroupsTable));
            });
            document.querySelectorAll('.blacklist-group').forEach(button => {
                button.addEventListener('click', (e) => blacklistItem(GROUPS_INDEX, parseInt(e.target.dataset.index), 'corp'));
            });
        }

        // 渲染开发者ID表格
        function renderOursTable() {
            const ours = whitelistData[OURS_INDEX] || [];
            oursTableBody.innerHTML = '';

            ours.forEach((id, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${id}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-our" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-our" data-index="${index}">删除</button>
                    </td>
                `;
                oursTableBody.appendChild(row);
            });

            // 添加事件监听器
            document.querySelectorAll('.edit-our').forEach(button => {
                button.addEventListener('click', (e) => editItem(OURS_INDEX, parseInt(e.target.dataset.index), '编辑开发者ID'));
            });
            document.querySelectorAll('.delete-our').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(OURS_INDEX, parseInt(e.target.dataset.index), renderOursTable));
            });
        }

        // 渲染自爆程序标志表格
        function renderSsTable() {
            const ss = whitelistData[SS_INDEX] || [];
            ssTableBody.innerHTML = '';

            ss.forEach((value, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${value}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-ss" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-ss" data-index="${index}">删除</button>
                    </td>
                `;
                ssTableBody.appendChild(row);
            });

            // 添加事件监听器
            document.querySelectorAll('.edit-ss').forEach(button => {
                button.addEventListener('click', (e) => editItem(SS_INDEX, parseInt(e.target.dataset.index), '编辑自爆程序标志'));
            });
            document.querySelectorAll('.delete-ss').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(SS_INDEX, parseInt(e.target.dataset.index), renderSsTable));
            });
        }

        // 渲染身份验证Cookie表格
        function renderCookie1Table() {
            const cookie1 = whitelistData[COOKIE1_INDEX] || [];
            cookie1TableBody.innerHTML = '';

            cookie1.forEach((value, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${value}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-cookie1" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-cookie1" data-index="${index}">删除</button>
                    </td>
                `;
                cookie1TableBody.appendChild(row);
            });

            // 添加事件监听器
            document.querySelectorAll('.edit-cookie1').forEach(button => {
                button.addEventListener('click', (e) => editItem(COOKIE1_INDEX, parseInt(e.target.dataset.index), '编辑身份验证Cookie'));
            });
            document.querySelectorAll('.delete-cookie1').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(COOKIE1_INDEX, parseInt(e.target.dataset.index), renderCookie1Table));
            });
        }

        // 渲染用户指纹数据表格
        function renderUsersTable() {
            const users = whitelistData[USERS_INDEX] || [];
            usersTableBody.innerHTML = '';

            users.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id || ''}</td>
                    <td>${user.name || ''}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-user" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-user" data-index="${index}">删除</button>
                        <button class="btn btn-sm btn-dark blacklist-user" data-index="${index}">拉黑</button>
                    </td>
                `;
                usersTableBody.appendChild(row);
            });

            // 添加事件监听器
            document.querySelectorAll('.edit-user').forEach(button => {
                button.addEventListener('click', (e) => editUserItem(parseInt(e.target.dataset.index)));
            });
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', (e) => deleteItem(USERS_INDEX, parseInt(e.target.dataset.index), renderUsersTable));
            });
            document.querySelectorAll('.blacklist-user').forEach(button => {
                button.addEventListener('click', (e) => blacklistUserItem(parseInt(e.target.dataset.index)));
            });
        }

        // 渲染黑名单表格
        function renderBlacklistTable() {
            const blacklist = whitelistData[BLACKLIST_INDEX] || [];
            blacklistTableBody.innerHTML = '';
            
            // 添加默认的已拉黑用户示例
            const defaultRow = document.createElement('tr');
            defaultRow.id = 'default-blacklist-user';
            defaultRow.innerHTML = `
                <td>BLOCKED_USER_123</td>
                <td>已拉黑用户</td>
                <td>[黑名单军团]</td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-primary edit-blacklist" data-index="default">编辑</button>
                    <button class="btn btn-sm btn-danger delete-blacklist" data-index="default">删除</button>
                </td>
            `;
            blacklistTableBody.appendChild(defaultRow);
            
            // 如果有黑名单数据，隐藏默认示例
            if (blacklist.length > 0) {
                defaultRow.style.display = 'none';
            }

            blacklist.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id || ''}</td>
                    <td>${user.name || ''}</td>
                    <td>${user.corp || ''}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-blacklist" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-danger delete-blacklist" data-index="${index}">删除</button>
                    </td>
                `;
                blacklistTableBody.appendChild(row);
            });

            // 添加编辑和删除事件监听
            document.querySelectorAll('.edit-blacklist').forEach(button => {
                button.addEventListener('click', handleEditBlacklist);
            });
            document.querySelectorAll('.delete-blacklist').forEach(button => {
                button.addEventListener('click', handleDeleteBlacklist);
            });
        }

        // 处理添加黑名单用户
        function handleAddBlacklist() {
            const userId = document.getElementById('blacklistUserId').value.trim();
            const userName = document.getElementById('blacklistUserName').value.trim();
            const userCorp = document.getElementById('blacklistUserCorp').value.trim();

            if (!whitelistData[BLACKLIST_INDEX]) {
                whitelistData[BLACKLIST_INDEX] = [];
            }
            whitelistData[BLACKLIST_INDEX].push({
                'id': userId,
                'name': userName,
                'corp': userCorp
            });
            renderBlacklistTable();

            // 关闭模态框并重置表单
            const modal = bootstrap.Modal.getInstance(document.getElementById('addBlacklistModal'));
            modal.hide();
            document.getElementById('blacklistUserId').value = '';
            document.getElementById('blacklistUserName').value = '';
            document.getElementById('blacklistUserCorp').value = '';
        }

        // 处理编辑黑名单用户
        function handleEditBlacklist(event) {
            const index = parseInt(event.target.dataset.index);
            const blacklist = whitelistData[BLACKLIST_INDEX] || [];
            const user = blacklist[index];

            document.getElementById('editBlacklistUserId').value = user.id || '';
            document.getElementById('editBlacklistUserName').value = user.name || '';
            document.getElementById('editBlacklistUserCorp').value = user.corp || '';
            document.getElementById('editBlacklistIndex').value = index;
            const modal = new bootstrap.Modal(document.getElementById('editBlacklistModal'));
            modal.show();
        }

        // 确认编辑黑名单用户
        function handleConfirmEditBlacklist() {
            const index = parseInt(document.getElementById('editBlacklistIndex').value);
            const newUserId = document.getElementById('editBlacklistUserId').value.trim();
            const newUserName = document.getElementById('editBlacklistUserName').value.trim();
            if (!newUserId || !newUserName) return;

            whitelistData[BLACKLIST_INDEX][index] = {
                'id': newUserId,
                'name': newUserName
            };
            renderBlacklistTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editBlacklistModal'));
            modal.hide();
        }

        // 处理删除黑名单用户
        function handleDeleteBlacklist(event) {
            const index = parseInt(event.target.dataset.index);
            if (confirm('确定要删除这个黑名单用户吗？')) {
                whitelistData[BLACKLIST_INDEX].splice(index, 1);
                renderBlacklistTable();
            }
        }

        // 通用编辑函数（用于简单字符串值）- 使用模态框
        function editItem(arrayIndex, itemIndex, title) {
            const currentValue = whitelistData[arrayIndex][itemIndex];
            
            // 设置模态框内容
            const editItemModalLabelEl = document.getElementById('editItemModalLabel');
            const editItemLabelEl = document.getElementById('editItemLabel');
            
            if (editItemModalLabelEl) editItemModalLabelEl.textContent = title;
            if (editItemLabelEl) editItemLabelEl.textContent = title.replace('编辑', '');
            
            // 如果是军团数据，在编辑框中显示不带方括号的名称
            let displayValue = currentValue;
            if (arrayIndex === GROUPS_INDEX && currentValue.startsWith('[') && currentValue.endsWith(']')) {
                displayValue = currentValue.slice(1, -1); // 移除首尾的方括号
            }
            
            document.getElementById('editItemValue').value = displayValue;
            document.getElementById('editItemIndex').value = itemIndex;
            document.getElementById('editItemArrayIndex').value = arrayIndex;
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('editItemModal'));
            modal.show();
        }

        // 通用删除函数
        function deleteItem(arrayIndex, itemIndex, renderFunction) {
            if (confirm('确定要删除这个项目吗？')) {
                whitelistData[arrayIndex].splice(itemIndex, 1);
                renderFunction();
            }
        }

        // 编辑用户数据（特殊处理，因为是对象）- 使用模态框
        function editUserItem(index) {
            const user = whitelistData[USERS_INDEX][index];
            
            // 设置模态框内容
            document.getElementById('editUserId').value = user.id || '';
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserIndex').value = index;
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        // 确认编辑通用项目
        function handleConfirmEditItem() {
            const newValue = document.getElementById('editItemValue').value.trim();
            const itemIndex = parseInt(document.getElementById('editItemIndex').value);
            const arrayIndex = parseInt(document.getElementById('editItemArrayIndex').value);
            
            if (!newValue) return;
            
            whitelistData[arrayIndex][itemIndex] = newValue;
            renderAllTables();
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editItemModal'));
            modal.hide();
        }

        // 确认编辑用户数据
        function handleConfirmEditUser() {
            const newId = document.getElementById('editUserId').value.trim();
            const newName = document.getElementById('editUserName').value.trim();
            const index = parseInt(document.getElementById('editUserIndex').value);
            
            if (!newId || !newName) return;
            
            whitelistData[USERS_INDEX][index] = {
                id: newId,
                name: newName
            };
            renderUsersTable();
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
        }

        // 显示添加项目模态框
        function showAddItemModal(arrayIndex, title, label, renderFunction) {
            const addItemModalLabelEl = document.getElementById('addItemModalLabel');
            const addItemLabelEl = document.getElementById('addItemLabel');
            
            if (addItemModalLabelEl) addItemModalLabelEl.textContent = title;
            if (addItemLabelEl) addItemLabelEl.textContent = label;
            document.getElementById('addItemValue').value = '';
            document.getElementById('addItemArrayIndex').value = arrayIndex;
            
            // 存储渲染函数供后续使用
            window.currentRenderFunction = renderFunction;
            
            const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
            modal.show();
        }

        // 显示添加用户模态框
        function showAddUserModal() {
            document.getElementById('addUserId').value = '';
            document.getElementById('addUserName').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();
        }

        // 确认添加通用项目
        function handleConfirmAddItem() {
            const value = document.getElementById('addItemValue').value.trim();
            const arrayIndex = parseInt(document.getElementById('addItemArrayIndex').value);
            
            if (!value) return;
            
            if (!whitelistData[arrayIndex]) whitelistData[arrayIndex] = [];
            
            // 如果是军团数据（GROUPS_INDEX = 1），自动添加方括号
            let finalValue = value;
            if (arrayIndex === GROUPS_INDEX) {
                // 检查是否已经有方括号，如果没有则添加
                if (!value.startsWith('[') || !value.endsWith(']')) {
                    finalValue = `[${value}]`;
                }
            }
            
            whitelistData[arrayIndex].push(finalValue);
            
            // 调用对应的渲染函数
            if (window.currentRenderFunction) {
                window.currentRenderFunction();
            }
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
            modal.hide();
        }

        // 确认添加用户数据
        function handleConfirmAddUser() {
            const id = document.getElementById('addUserId').value.trim();
            const name = document.getElementById('addUserName').value.trim();
            
            if (!id || !name) return;
            
            if (!whitelistData[USERS_INDEX]) whitelistData[USERS_INDEX] = [];
            whitelistData[USERS_INDEX].push({
                id: id,
                name: name
            });
            renderUsersTable();
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            modal.hide();
        }

        // 拉黑通用项目函数
        async function blacklistItem(arrayIndex, itemIndex, type) {
            const item = whitelistData[arrayIndex][itemIndex];
            let displayValue = item;
            let blacklistData = {};
            
            if (type === 'id') {
                // 白名单用户ID -> 黑名单：只填用户ID，其他留空
                displayValue = item;
                blacklistData = { 
                    id: item, 
                    name: '', 
                    corp: '',
                    blockedAt: new Date().toISOString()
                };
            } else if (type === 'corp') {
                // 白名单军团 -> 黑名单：只填用户军团，其他留空
                displayValue = item;
                blacklistData = { 
                    id: '', 
                    name: '', 
                    corp: item,
                    blockedAt: new Date().toISOString()
                };
            }
            
            if (confirm(`确定要将 "${displayValue}" 加入黑名单吗？`)) {
                try {
                    // 确保黑名单数组存在
                    if (!whitelistData[BLACKLIST_INDEX]) {
                        whitelistData[BLACKLIST_INDEX] = [];
                    }
                    
                    // 检查是否已存在（根据类型检查不同字段）
                    let exists = false;
                    if (type === 'id') {
                        exists = whitelistData[BLACKLIST_INDEX].some(blackUser => blackUser.id === item);
                    } else if (type === 'corp') {
                        exists = whitelistData[BLACKLIST_INDEX].some(blackUser => blackUser.corp === item);
                    }
                    
                    if (!exists) {
                        // 添加到黑名单
                        whitelistData[BLACKLIST_INDEX].push(blacklistData);
                        
                        // 从原数组中删除
                        whitelistData[arrayIndex].splice(itemIndex, 1);
                        
                        // 立即保存到服务器
                        const jsonContent = JSON.stringify(whitelistData, null, 2);
                        const success = await updateGitHubFile(jsonContent);
                        
                        if (success) {
                            alert(`"${displayValue}" 已成功加入黑名单并上传到服务器！`);
                        } else {
                            alert(`"${displayValue}" 已加入黑名单，但上传到服务器失败，请稍后手动保存。`);
                        }
                        
                        // 重新渲染相关表格
                        renderAllTables();
                    } else {
                        alert(`"${displayValue}" 已存在于黑名单中！`);
                    }
                } catch (error) {
                    console.error('拉黑操作失败:', error);
                    alert(`拉黑操作失败: ${error.message}`);
                }
            }
        }

        // 拉黑用户指纹数据函数
        async function blacklistUserItem(itemIndex) {
            const user = whitelistData[USERS_INDEX][itemIndex];
            const displayValue = `${user.name} (${user.id})`;
            
            if (confirm(`确定要将用户 "${displayValue}" 加入黑名单吗？`)) {
                try {
                    // 确保黑名单数组存在
                    if (!whitelistData[BLACKLIST_INDEX]) {
                        whitelistData[BLACKLIST_INDEX] = [];
                    }
                    
                    // 检查是否已存在
                    const exists = whitelistData[BLACKLIST_INDEX].some(blackUser => 
                        blackUser.id === user.id && blackUser.name === user.name
                    );
                    
                    if (!exists) {
                        // 用户指纹数据 -> 黑名单：填入用户ID和用户名称，军团留空
                        whitelistData[BLACKLIST_INDEX].push({
                            id: user.id,
                            name: user.name,
                            corp: '',
                            fingerprint: user.id,
                            blockedAt: new Date().toISOString()
                        });
                        
                        // 从用户指纹数据中删除
                        whitelistData[USERS_INDEX].splice(itemIndex, 1);
                        
                        // 立即保存到服务器
                        const jsonContent = JSON.stringify(whitelistData, null, 2);
                        const success = await updateGitHubFile(jsonContent);
                        
                        if (success) {
                            alert(`用户 "${displayValue}" 已成功加入黑名单并上传到服务器！`);
                        } else {
                            alert(`用户 "${displayValue}" 已加入黑名单，但上传到服务器失败，请稍后手动保存。`);
                        }
                        
                        // 重新渲染相关表格
                        renderAllTables();
                    } else {
                        alert(`用户 "${displayValue}" 已存在于黑名单中！`);
                    }
                } catch (error) {
                    console.error('拉黑用户失败:', error);
                    alert(`拉黑用户失败: ${error.message}`);
                }
            }
        }

        // 添加项目的通用函数 - 已废弃，使用模态框替代
        function addSimpleItem(arrayIndex, renderFunction, title) {
            // 这个函数已被 showAddItemModal 替代
            showAddItemModal(arrayIndex, `添加${title}`, title, renderFunction);
        }

        // 添加用户数据
        function addUserItem() {
            const id = prompt('输入用户ID:');
            if (!id || !id.trim()) return;
            
            const name = prompt('输入用户名称:');
            if (!name || !name.trim()) return;
            
            if (!whitelistData[USERS_INDEX]) {
                whitelistData[USERS_INDEX] = [];
            }
            whitelistData[USERS_INDEX].push({
                id: id.trim(),
                name: name.trim()
            });
            renderUsersTable();
        }

        // 保存Token到本地存储
        function saveToken() {
            const token = document.getElementById('giteeToken').value.trim();
            if (token) {
                localStorage.setItem('githubToken', token);
                alert('Token保存成功！');
                // 重新加载数据
                loadWhitelistData();
                fetchOnlineData();
            } else {
                alert('请输入有效的Token');
            }
        }

        // 从本地存储加载Token
        function loadToken() {
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                document.getElementById('giteeToken').value = savedToken;
                return savedToken;
            }
            return null;
        }

        // 从GitHub加载白名单数据
        async function loadWhitelistData() {
            const token = loadToken();
            if (!token) {
                console.log('未找到保存的Token，跳过白名单数据加载');
                return;
            }

            try {
                // 使用GitHub API获取文件内容 - 修正仓库名称
                const response = await fetch('https://gitee.com/api/v5/repos/Kosto179/kosto-battle-clicker-new/contents/1.json', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'Kosto-Manager'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Token无效或已过期，请重新输入');
                        localStorage.removeItem('githubToken');
                        document.getElementById('giteeToken').value = '';
                        return;
                    }
                    if (response.status === 404) {
                        // 文件不存在，初始化空数据
                        console.log('文件不存在，初始化空数据');
                        whitelistData = [[], [], [], [], [], [], []]; // 7个空数组
                        renderAllTables();
                        alert('文件不存在，已初始化空数据。请添加数据后保存。');
                        return;
                    }
                    const errorText = await response.text();
                    throw new Error(`GitHub API请求失败: ${response.status} - ${errorText}`);
                }

                const fileData = await response.json();
                // 正确解码base64内容，处理中文字符
                const base64Content = fileData.content.replace(/\s/g, ''); // 移除空白字符
                const binaryString = atob(base64Content);
                
                // 将二进制字符串转换为Uint8Array
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // 使用TextDecoder正确解码UTF-8
                const decoder = new TextDecoder('utf-8');
                const decodedContent = decoder.decode(bytes);
                whitelistData = JSON.parse(decodedContent);
                
                // 初始化空数组（如果某些索引不存在）
                if (!whitelistData[TANKNAMES_INDEX]) whitelistData[TANKNAMES_INDEX] = [];
                if (!whitelistData[GROUPS_INDEX]) whitelistData[GROUPS_INDEX] = [];
                if (!whitelistData[OURS_INDEX]) whitelistData[OURS_INDEX] = [];
                if (!whitelistData[SS_INDEX]) whitelistData[SS_INDEX] = [];
                if (!whitelistData[COOKIE1_INDEX]) whitelistData[COOKIE1_INDEX] = [];
                if (!whitelistData[USERS_INDEX]) whitelistData[USERS_INDEX] = [];
                if (!whitelistData[BLACKLIST_INDEX]) whitelistData[BLACKLIST_INDEX] = [];
                
                renderAllTables();
                
                console.log('白名单数据加载成功');
                permissionError.style.display = 'none';
            } catch (error) {
                console.error('加载白名单数据失败:', error);
                permissionError.style.display = 'block';
                alert(`加载白名单数据失败: ${error.message}\n\n请检查：\n1. 仓库是否存在: Kosto179cn/Kosto179cn.github.io\n2. Token是否有repo权限\n3. 文件路径是否正确: 1.json`);
            }
        }

        // 渲染所有表格的辅助函数
        function renderAllTables() {
            renderTanknamesTable();
            renderGroupsTable();
            renderOursTable();
            renderSsTable();
            renderCookie1Table();
            renderUsersTable();
            renderBlacklistTable();
        }

        // 初始化
        function init() {
            loadBlockedUsers();
            loadToken(); // 加载保存的Token
            fetchOnlineData();
            loadWhitelistData();

            // 设置自动刷新
            setInterval(fetchOnlineData, CONFIG.REFRESH_INTERVAL_MS);
            
            // 初始化验证日志显示
            setTimeout(() => {
                if (window.gameLinkValidator) {
                    renderValidationLogs();
                }
            }, 1000);
        }

        // 标签页切换时的特殊处理
        function handleTabSwitch(tabId) {
            if (tabId === 'validation') {
                // 切换到验证日志标签时，刷新日志显示
                setTimeout(() => {
                    renderValidationLogs();
                }, 100);
            } else if (tabId === 'test') {
                // 切换到测试标签时，显示提示信息
                setTimeout(() => {
                    showValidationMessage('测试功能已加载，您可以运行各种验证测试', 'success');
                }, 100);
            }
        }

        // 页面加载完成后初始化
        window.onload = init;

        // 检查用户详情中是否包含可打开的链接
        function checkForOpenableLink(details) {
            if (!details || typeof details !== 'object') return false;
            
            // 使用游戏链接验证器进行检查
            if (window.gameLinkValidator) {
                return window.gameLinkValidator.checkForValidGameLink(details);
            }
            
            // 备用检查逻辑（如果验证器未加载）
            if (details.url && typeof details.url === 'string' && 
                details.referrer && typeof details.referrer === 'string') {
                return details.url.includes('3dtank.com') && 
                       details.url.includes('token=') && 
                       details.referrer === 'https://game.4399iw2.com/';
            }
            
            return false;
        }

        // 打开用户链接（带验证）
        function openUserLink(userId) {
            const user = window.userDetails[userId];
            if (!user || !user.details || !user.details.url) {
                alert('用户链接数据不存在');
                return;
            }

            // 使用验证器验证链接
            if (window.gameLinkValidator) {
                const validationResult = window.gameLinkValidator.validateGameLink(user.details.url, user);
                
                if (validationResult.isValid) {
                    // 验证通过，打开链接
                    console.log('链接验证通过，正在打开游戏链接...');
                    window.open(user.details.url, '_blank');
                    
                    // 显示成功提示
                    showValidationMessage('链接验证通过，游戏正在启动...', 'success');
                } else {
                    // 验证失败，显示错误信息
                    console.error('链接验证失败:', validationResult.reason);
                    showValidationMessage(`链接验证失败: ${validationResult.reason}`, 'error');
                }
            } else {
                // 验证器未加载，使用备用逻辑
                console.warn('验证器未加载，使用备用验证逻辑');
                if (checkForOpenableLink(user.details)) {
                    window.open(user.details.url, '_blank');
                } else {
                    alert('链接验证失败，请确保链接来自正确渠道');
                }
            }
        }

        // 显示验证消息
        function showValidationMessage(message, type) {
            // 移除现有的验证消息
            const existingMessage = document.querySelector('.validation-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // 创建消息元素
            const messageDiv = document.createElement('div');
            messageDiv.className = `validation-message ${type}`;
            
            const iconMap = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-triangle',
                'warning': 'fa-exclamation-circle'
            };
            
            messageDiv.innerHTML = `
                <i class="fas ${iconMap[type] || 'fa-info-circle'}"></i>
                ${message}
                <button type="button" class="close-btn" onclick="this.parentElement.remove()">×</button>
            `;
            
            // 添加到页面
            document.body.appendChild(messageDiv);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }

        // 暴露全局函数
        // 显示用户详情
        function showUserDetails(userId) {
            const user = window.userDetails[userId];
            if (!user) {
                alert('用户数据不存在');
                return;
            }

            // 处理用户名显示
            let displayUsername = user.username;
            if (displayUsername && displayUsername.toLowerCase() === 'unknown') {
                displayUsername = '未知用户';
            }

            // 填充模态框数据
            const detailUsernameEl = document.getElementById('detailUsername');
            const detailUserIdEl = document.getElementById('detailUserId');
            const detailFingerprintEl = document.getElementById('detailFingerprint');
            const detailScriptNameEl = document.getElementById('detailScriptName');
            const detailPhaseEl = document.getElementById('detailPhase');
            const detailLastActiveEl = document.getElementById('detailLastActive');
            const detailOnlineTimeEl = document.getElementById('detailOnlineTime');
            const detailStatusEl = document.getElementById('detailStatus');
            const detailRawDataEl = document.getElementById('detailRawData');
            
            if (detailUsernameEl) detailUsernameEl.textContent = displayUsername;
            if (detailUserIdEl) detailUserIdEl.textContent = user.getid || '未知';
            if (detailFingerprintEl) detailFingerprintEl.textContent = user.fingerprint || '无';
            if (detailScriptNameEl) detailScriptNameEl.textContent = user.scriptName || '未知脚本';
            if (detailPhaseEl) detailPhaseEl.textContent = user.phase || '未知阶段';
            
            const userTimestamp = user.time || user.timestamp;
            if (detailLastActiveEl) detailLastActiveEl.textContent = formatTime(userTimestamp);
            
            const onlineDuration = user.onlineDurationText || (calculateOnlineTime(user.details?.onlineTime || 0) + '分钟');
            if (detailOnlineTimeEl) detailOnlineTimeEl.textContent = onlineDuration;
            const isOnline = new Date(userTimestamp) >= new Date(Date.now() - (CONFIG?.ONLINE_THRESHOLD_MINUTES || 1.5) * 60000);
            if (detailStatusEl) {
                detailStatusEl.innerHTML = isOnline
                    ? '<span class="status-indicator status-online"></span>在线'
                    : '<span class="status-indicator status-offline"></span>离线';
            }

            // 显示原始数据
            if (detailRawDataEl) detailRawDataEl.textContent = JSON.stringify(user, null, 2);

            // 设置拉黑按钮事件
            const blockBtn = document.getElementById('blockFromDetails');
            blockBtn.onclick = function() {
                const fingerprint = user.fingerprint || user.username;
                blockUser(fingerprint, displayUsername);
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
                modal.hide();
            };

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
            modal.show();
        }

        // 解除拉黑用户
        async function unblockUser(fingerprint, username) {
            if (confirm(`确定要解除拉黑用户 ${username} 吗？`)) {
                try {
                    // 从本地拉黑集合中移除
                    blockedFingerprints.delete(fingerprint);
                    saveBlockedUsers();
                    
                    // 从黑名单数组中移除（根据指纹或ID匹配）
                    if (whitelistData[BLACKLIST_INDEX]) {
                        const originalLength = whitelistData[BLACKLIST_INDEX].length;
                        whitelistData[BLACKLIST_INDEX] = whitelistData[BLACKLIST_INDEX].filter(blackUser => 
                            blackUser.fingerprint !== fingerprint && 
                            blackUser.id !== fingerprint &&
                            !(blackUser.name === username && blackUser.fingerprint === fingerprint)
                        );
                        
                        // 检查是否真的从黑名单中移除了用户
                        const removedFromBlacklist = whitelistData[BLACKLIST_INDEX].length < originalLength;
                        
                        if (removedFromBlacklist) {
                            // 立即保存到服务器
                            const jsonContent = JSON.stringify(whitelistData, null, 2);
                            const success = await updateGitHubFile(jsonContent);
                            
                            if (success) {
                                alert(`用户 ${username} 已解除拉黑并同步到服务器！`);
                                // 刷新黑名单表格显示
                                renderBlacklistTable();
                            } else {
                                alert(`用户 ${username} 已本地解除拉黑，但同步到服务器失败，请稍后手动保存。`);
                            }
                        } else {
                            alert(`用户 ${username} 已从本地拉黑列表中移除！`);
                        }
                    }
                    
                    // 刷新在线数据显示
                    fetchOnlineData();
                } catch (error) {
                    console.error('解除拉黑失败:', error);
                    alert(`解除拉黑失败: ${error.message}`);
                }
            }
        }
        
        // 渲染验证日志
        function renderValidationLogs() {
            if (!window.gameLinkValidator) {
                document.getElementById('validationLogsList').innerHTML = '<div class="text-center text-muted">验证器未加载</div>';
                return;
            }

            const logs = window.gameLinkValidator.getValidationLogs(50);
            const stats = window.gameLinkValidator.getValidationStats();
            
            // 更新统计信息
            const totalValidationsEl = document.getElementById('totalValidations');
            const validValidationsEl = document.getElementById('validValidations');
            const invalidValidationsEl = document.getElementById('invalidValidations');
            const successRateEl = document.getElementById('successRate');
            
            if (totalValidationsEl) totalValidationsEl.textContent = stats.total;
            if (validValidationsEl) validValidationsEl.textContent = stats.valid;
            if (invalidValidationsEl) invalidValidationsEl.textContent = stats.invalid;
            if (successRateEl) successRateEl.textContent = stats.successRate;
            
            // 渲染日志列表
            const logsList = document.getElementById('validationLogsList');
            
            if (logs.length === 0) {
                logsList.innerHTML = '<div class="text-center text-muted">暂无验证日志</div>';
                return;
            }
            
            const logsHtml = logs.reverse().map(log => {
                const statusClass = log.isValid ? 'success' : 'error';
                const statusIcon = log.isValid ? 'fa-check-circle' : 'fa-times-circle';
                const statusText = log.isValid ? '通过' : '失败';
                
                return `
                    <div class="log-entry ${statusClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas ${statusIcon} me-2"></i>
                                    <strong>验证${statusText}</strong>
                                    <span class="log-timestamp ms-2">${new Date(log.timestamp).toLocaleString('zh-CN')}</span>
                                </div>
                                <div class="mb-1">
                                    <small><strong>原因:</strong> ${log.reason}</small>
                                </div>
                                ${log.referrer ? `<div class="mb-1"><small><strong>Referrer:</strong> ${log.referrer}</small></div>` : ''}
                                ${log.url ? `<div><small><strong>URL:</strong> <span style="word-break: break-all;">${log.url.substring(0, 100)}${log.url.length > 100 ? '...' : ''}</span></small></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            logsList.innerHTML = logsHtml;
        }

        // 刷新验证日志
        function refreshValidationLogs() {
            renderValidationLogs();
            showValidationMessage('验证日志已刷新', 'success');
        }

        // 清空验证日志
        function clearValidationLogs() {
            if (confirm('确定要清空所有验证日志吗？此操作不可恢复。')) {
                if (window.gameLinkValidator) {
                    window.gameLinkValidator.clearLogs();
                    renderValidationLogs();
                    showValidationMessage('验证日志已清空', 'warning');
                }
            }
        }

        // 测试功能函数
        // 测试正确的游戏链接
        function testValidLink() {
            const testUrl = 'https://3dtank.com/game?token=abc123&server=1';
            const testUserData = {
                username: 'testUser',
                details: {
                    url: testUrl,
                    referrer: 'https://game.4399iw2.com/'
                }
            };

            const result = window.gameLinkValidator.validateGameLink(testUrl, testUserData);
            displayTestResult('test1-result', result, testUserData);
        }

        // 测试错误的referrer
        function testInvalidReferrer() {
            const testUrl = 'https://3dtank.com/game?token=abc123&server=1';
            const testUserData = {
                username: 'testUser',
                details: {
                    url: testUrl,
                    referrer: 'https://malicious-site.com/'
                }
            };

            const result = window.gameLinkValidator.validateGameLink(testUrl, testUserData);
            displayTestResult('test2-result', result, testUserData);
        }

        // 测试缺少referrer
        function testMissingReferrer() {
            const testUrl = 'https://3dtank.com/game?token=abc123&server=1';
            const testUserData = {
                username: 'testUser',
                details: {
                    url: testUrl
                    // 故意不包含referrer字段
                }
            };

            const result = window.gameLinkValidator.validateGameLink(testUrl, testUserData);
            displayTestResult('test3-result', result, testUserData);
        }

        // 测试URL参数验证
        function testUrlParameter() {
            const testUrl = 'https://3dtank.com/game?token=abc123&server=1&referrer=https://game.4399iw2.com/';
            
            const result = window.gameLinkValidator.validateGameLink(testUrl);
            displayTestResult('test4-result', result, { url: testUrl });
        }

        // 显示测试结果
        function displayTestResult(elementId, result, testData) {
            const element = document.getElementById(elementId);
            const statusClass = result.isValid ? 'alert-success' : 'alert-danger';
            const statusIcon = result.isValid ? 'fa-check-circle' : 'fa-times-circle';
            
            element.innerHTML = `
                <div class="alert ${statusClass}">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas ${statusIcon} me-2"></i>
                        <strong>验证结果: ${result.isValid ? '通过' : '失败'}</strong>
                    </div>
                    <div><strong>原因:</strong> ${result.reason}</div>
                    <div><strong>时间:</strong> ${new Date(result.timestamp).toLocaleString('zh-CN')}</div>
                    ${result.referrer ? `<div><strong>Referrer:</strong> ${result.referrer}</div>` : ''}
                    
                    <details class="mt-2">
                        <summary class="btn btn-sm btn-outline-secondary">查看详细信息</summary>
                        <div class="mt-2">
                            <div><strong>测试数据:</strong></div>
                            <pre class="bg-light p-2 rounded small">${JSON.stringify(testData, null, 2)}</pre>
                            <div><strong>验证结果:</strong></div>
                            <pre class="bg-light p-2 rounded small">${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    </details>
                </div>
            `;
        }

        // 运行所有测试
        function runAllTests() {
            showValidationMessage('正在运行所有测试...', 'warning');
            
            setTimeout(() => {
                testValidLink();
            }, 100);
            
            setTimeout(() => {
                testInvalidReferrer();
            }, 200);
            
            setTimeout(() => {
                testMissingReferrer();
            }, 300);
            
            setTimeout(() => {
                testUrlParameter();
                showValidationMessage('所有测试已完成！', 'success');
                // 自动刷新验证日志
                setTimeout(() => {
                    renderValidationLogs();
                }, 500);
            }, 400);
        }

        // 清空所有测试结果
        function clearAllTestResults() {
            ['test1-result', 'test2-result', 'test3-result', 'test4-result'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '';
                }
            });
            showValidationMessage('测试结果已清空', 'warning');
        }

        // 暴露全局函数
        window.blockUser = blockUser;
        window.unblockUser = unblockUser;
        window.showUserDetails = showUserDetails;
        window.renderValidationLogs = renderValidationLogs;
        window.refreshValidationLogs = refreshValidationLogs;
        window.clearValidationLogs = clearValidationLogs;
        window.testValidLink = testValidLink;
        window.testInvalidReferrer = testInvalidReferrer;
        window.testMissingReferrer = testMissingReferrer;
        window.testUrlParameter = testUrlParameter;
        window.runAllTests = runAllTests;
        window.clearAllTestResults = clearAllTestResults;

        // 更新GitHub文件
        async function updateGitHubFile(content) {
            const token = loadToken();
            if (!token) {
                alert('请先保存GitHub Token');
                return false;
            }

            try {
                // 首先获取文件信息（包含SHA）- 修正仓库名称
                const fileResponse = await fetch('https://gitee.com/api/v5/repos/Kosto179/kosto-battle-clicker-new/contents/1.json', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'Kosto-Manager'
                    }
                });

                if (!fileResponse.ok) {
                    if (fileResponse.status === 404) {
                        // 文件不存在，创建新文件
                        console.log('文件不存在，创建新文件');
                        const encoder = new TextEncoder();
                        const utf8Bytes = encoder.encode(content);
                        const base64Content = btoa(String.fromCharCode(...utf8Bytes));

                        const createResponse = await fetch('https://gitee.com/api/v5/repos/Kosto179/kosto-battle-clicker-new/contents/1.json', {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/vnd.github.v3+json',
                                'User-Agent': 'Kosto-Manager'
                            },
                            body: JSON.stringify({
                                message: 'Create whitelist file via manager',
                                content: base64Content
                            })
                        });

                        if (!createResponse.ok) {
                            const errorText = await createResponse.text();
                            throw new Error(`创建文件失败: ${createResponse.status} - ${errorText}`);
                        }
                        return true;
                    } else {
                        const errorText = await fileResponse.text();
                        throw new Error(`获取文件信息失败: ${fileResponse.status} - ${errorText}`);
                    }
                }

                const fileInfo = await fileResponse.json();
                
                // 正确编码UTF-8内容为base64
                const encoder = new TextEncoder();
                const utf8Bytes = encoder.encode(content);
                const base64Content = btoa(String.fromCharCode(...utf8Bytes));

                // 更新文件
                const updateResponse = await fetch('https://gitee.com/api/v5/repos/Kosto179/kosto-battle-clicker-new/contents/1.json', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'Kosto-Manager'
                    },
                    body: JSON.stringify({
                        message: 'Update whitelist via manager',
                        content: base64Content,
                        sha: fileInfo.sha
                    })
                });

                if (!updateResponse.ok) {
                    const errorText = await updateResponse.text();
                    throw new Error(`更新文件失败: ${updateResponse.status} - ${errorText}`);
                }
                
                return true;
            } catch (error) {
                console.error('GitHub API错误:', error);
                alert(`GitHub操作失败: ${error.message}\n\n请检查：\n1. Token是否有效\n2. Token是否有repo权限\n3. 仓库名称是否正确`);
                return false;
            }
        }

        // 保存更改到GitHub
        async function saveChanges() {
            try {
                const jsonContent = JSON.stringify(whitelistData, null, 2);
                const success = await updateGitHubFile(jsonContent);
                if (success) {
                    alert('保存到GitHub成功！');
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }

        // 添加事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // Token保存按钮事件监听
            const saveTokenBtn = document.getElementById('saveTokenBtn');
            if (saveTokenBtn) {
                saveTokenBtn.addEventListener('click', saveToken);
            }

            // 保存更改按钮事件监听
            const saveChangesBtn = document.getElementById('saveChangesBtn');
            if (saveChangesBtn) {
                saveChangesBtn.addEventListener('click', saveChanges);
            }

            // 打开源文件按钮事件监听
            const openSourceBtn = document.getElementById('openSourceBtn');
            if (openSourceBtn) {
                openSourceBtn.addEventListener('click', function() {
                    // 检测当前活动的标签页
                    const activeTab = document.querySelector('.nav-tabs button.active');
                    let sourceUrl;
                    
                    if (activeTab && activeTab.getAttribute('data-tab') === 'online') {
                        // 如果在"在线管理"标签，打开log.json
                        sourceUrl = 'https://gitee.com/Kosto179/kosto-battle-clicker-new/raw/master/log.json';
                    } else {
                        // 其他标签打开1.json
                        sourceUrl = 'https://gitee.com/Kosto179/kosto-battle-clicker-new/raw/master/1.json';
                    }
                    
                    window.open(sourceUrl, '_blank');
                });
            }

            // 黑名单相关事件监听
            const confirmAddBlacklistBtn = document.getElementById('confirmAddBlacklist');
            if (confirmAddBlacklistBtn) {
                confirmAddBlacklistBtn.addEventListener('click', handleAddBlacklist);
            }

            const confirmEditBlacklistBtn = document.getElementById('confirmEditBlacklist');
            if (confirmEditBlacklistBtn) {
                confirmEditBlacklistBtn.addEventListener('click', handleConfirmEditBlacklist);
            }

            // 通用编辑确认按钮事件监听
            const confirmEditItemBtn = document.getElementById('confirmEditItem');
            if (confirmEditItemBtn) {
                confirmEditItemBtn.addEventListener('click', handleConfirmEditItem);
            }

            // 用户数据编辑确认按钮事件监听
            const confirmEditUserBtn = document.getElementById('confirmEditUser');
            if (confirmEditUserBtn) {
                confirmEditUserBtn.addEventListener('click', handleConfirmEditUser);
            }

            // 通用添加确认按钮事件监听
            const confirmAddItemBtn = document.getElementById('confirmAddItem');
            if (confirmAddItemBtn) {
                confirmAddItemBtn.addEventListener('click', handleConfirmAddItem);
            }

            // 用户数据添加确认按钮事件监听
            const confirmAddUserBtn = document.getElementById('confirmAddUser');
            if (confirmAddUserBtn) {
                confirmAddUserBtn.addEventListener('click', handleConfirmAddUser);
            }

            // 刷新按钮事件监听
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    fetchOnlineData();
                    loadWhitelistData();
                });
            }

            // 验证日志相关按钮事件监听
            const refreshValidationLogsBtn = document.getElementById('refreshValidationLogs');
            if (refreshValidationLogsBtn) {
                refreshValidationLogsBtn.addEventListener('click', refreshValidationLogs);
            }

            const clearValidationLogsBtn = document.getElementById('clearValidationLogs');
            if (clearValidationLogsBtn) {
                clearValidationLogsBtn.addEventListener('click', clearValidationLogs);
            }

            // 使用延迟绑定确保DOM元素存在
            setTimeout(function() {
                // 添加按钮事件监听器 - 使用模态框
                const addTanknameBtn = document.getElementById('addTanknameBtn');
                if (addTanknameBtn) {
                    addTanknameBtn.addEventListener('click', function() {
                        showAddItemModal(TANKNAMES_INDEX, '添加白名单用户ID', '白名单用户ID', renderTanknamesTable);
                    });
                }
                
                const addGroupBtn = document.getElementById('addGroupBtn');
                if (addGroupBtn) {
                    addGroupBtn.addEventListener('click', function() {
                        showAddItemModal(GROUPS_INDEX, '添加白名单军团', '白名单军团', renderGroupsTable);
                    });
                }
                
                const addOurBtn = document.getElementById('addOurBtn');
                if (addOurBtn) {
                    addOurBtn.addEventListener('click', function() {
                        showAddItemModal(OURS_INDEX, '添加开发者ID', '开发者ID', renderOursTable);
                    });
                }
                
                const addSsBtn = document.getElementById('addSsBtn');
                if (addSsBtn) {
                    addSsBtn.addEventListener('click', function() {
                        showAddItemModal(SS_INDEX, '添加自爆程序标志', '自爆程序标志', renderSsTable);
                    });
                }
                
                const addCookie1Btn = document.getElementById('addCookie1Btn');
                if (addCookie1Btn) {
                    addCookie1Btn.addEventListener('click', function() {
                        showAddItemModal(COOKIE1_INDEX, '添加身份验证Cookie', '身份验证Cookie', renderCookie1Table);
                    });
                }
                
                const addUserBtn = document.getElementById('addUserBtn');
                if (addUserBtn) {
                    addUserBtn.addEventListener('click', function() {
                        showAddUserModal();
                    });
                }
            }, 100); // 延迟100ms确保DOM完全加载
        });
    </script>

    <!-- 添加黑名单用户模态框 -->
    <div class="modal fade" id="addBlacklistModal" tabindex="-1" aria-labelledby="addBlacklistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBlacklistModalLabel">添加黑名单用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="blacklistUserId" class="form-label">用户ID</label>
                        <input type="text" class="form-control" id="blacklistUserId" required>
                    </div>
                    <div class="form-group">
                        <label for="blacklistUserName" class="form-label">用户名称</label>
                        <input type="text" class="form-control" id="blacklistUserName" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmAddBlacklist">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用添加项目模态框 -->
    <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addItemModalLabel">添加项目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="addItemValue" class="form-label" id="addItemLabel">值</label>
                        <input type="text" class="form-control" id="addItemValue" required>
                        <input type="hidden" id="addItemArrayIndex">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmAddItem">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加用户数据模态框 -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">添加用户数据</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="addUserId" class="form-label">用户ID</label>
                        <input type="text" class="form-control" id="addUserId" required>
                    </div>
                    <div class="form-group">
                        <label for="addUserName" class="form-label">用户名称</label>
                        <input type="text" class="form-control" id="addUserName" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmAddUser">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑黑名单用户模态框 -->
    <div class="modal fade" id="editBlacklistModal" tabindex="-1" aria-labelledby="editBlacklistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBlacklistModalLabel">编辑黑名单用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editBlacklistUserId" class="form-label">用户ID</label>
                        <input type="text" class="form-control" id="editBlacklistUserId">
                    </div>
                    <div class="form-group">
                        <label for="editBlacklistUserName" class="form-label">用户名称</label>
                        <input type="text" class="form-control" id="editBlacklistUserName">
                    </div>
                    <div class="form-group">
                        <label for="editBlacklistUserCorp" class="form-label">用户军团</label>
                        <input type="text" class="form-control" id="editBlacklistUserCorp">
                        <input type="hidden" id="editBlacklistIndex">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmEditBlacklist">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用编辑模态框 -->
    <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editItemModalLabel">编辑项目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editItemValue" class="form-label" id="editItemLabel">值</label>
                        <input type="text" class="form-control" id="editItemValue" required>
                        <input type="hidden" id="editItemIndex">
                        <input type="hidden" id="editItemArrayIndex">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmEditItem">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑用户数据模态框 -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">编辑用户数据</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editUserId" class="form-label">用户ID</label>
                        <input type="text" class="form-control" id="editUserId" required>
                    </div>
                    <div class="form-group">
                        <label for="editUserName" class="form-label">用户名称</label>
                        <input type="text" class="form-control" id="editUserName" required>
                        <input type="hidden" id="editUserIndex">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmEditUser">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户详情模态框 -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userDetailsModalLabel">用户详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label"><strong>用户名:</strong></label>
                                <p id="detailUsername" class="form-control-plaintext">-</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><strong>用户ID:</strong></label>
                                <p id="detailUserId" class="form-control-plaintext">-</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><strong>用户指纹:</strong></label>
                                <p id="detailFingerprint" class="form-control-plaintext" style="word-break: break-all;">-</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label"><strong>最后活动时间:</strong></label>
                                <p id="detailLastActive" class="form-control-plaintext">-</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><strong>在线时长:</strong></label>
                                <p id="detailOnlineTime" class="form-control-plaintext">-</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><strong>状态:</strong></label>
                                <p id="detailStatus" class="form-control-plaintext">
                                    <span class="status-indicator status-online"></span>在线
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3" id="detailsSection" style="display: none;">
                        <div class="col-12">
                            <h6><strong>详细信息:</strong></h6>
                            <div class="bg-light p-3 rounded">
                                <pre id="detailRawData" style="margin: 0; white-space: pre-wrap; word-break: break-all; font-size: 12px;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-danger" id="blockFromDetails">拉黑用户</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
