(function() {
    'use strict';

    // --- START: Version Check ---
    const currentVersion = "2.2.2"; // 您的当前版本号
    const currentVersionCode = 999; // 版本代码增加
    const versionUrl = 'https://testanki1.github.io/models/version.json';

    let iconsInjected = false;

    function injectMaterialIcons() {
        if (iconsInjected || document.querySelector('link[href*="Material+Symbols+Outlined"]')) {
            return;
        }
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0';
        document.head.appendChild(link);
        iconsInjected = true;
    }

    function showToast(message) {
        const existingToast = document.querySelector('.replacer-toast');
        if (existingToast) {
            existingToast.remove();
        }

        const toast = document.createElement('div');
        toast.className = 'replacer-toast';
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }

    function showUpdateDialog(message, downloadUrl) {
        if (document.getElementById('update-dialog-overlay')) return;

        const dialogHtml = `
            <div class="update-dialog-overlay" id="update-dialog-overlay">
                <div class="update-dialog-panel">
                    <div class="update-dialog-header">脚本更新可用</div>
                    <div class="update-dialog-body">${message}</div>
                    <div class="update-dialog-actions">
                        <button id="update-dialog-close" class="replacer-btn close-btn"><span class="material-symbols-outlined">close</span>稍后提醒</button>
                        <button id="update-dialog-confirm" class="replacer-btn save-reload-btn"><span class="material-symbols-outlined">download</span>前往下载</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', dialogHtml);

        const overlay = document.getElementById('update-dialog-overlay');
        const confirmBtn = document.getElementById('update-dialog-confirm');
        const closeBtn = document.getElementById('update-dialog-close');

        const closeDialog = () => {
            if (overlay) overlay.remove();
        };

        confirmBtn.onclick = () => {
            window.open(downloadUrl, '_blank');
            closeDialog();
        };

        closeBtn.onclick = closeDialog;
        overlay.onclick = (e) => {
            if (e.target === overlay) closeDialog();
        };
    }

    fetch(versionUrl, { cache: 'reload' })
        .then(response => {
        if (!response.ok) throw new Error('网络错误');
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
            return response.json();
        }
        throw new Error('收到的不是JSON格式的响应');
    })
        .then(data => {
        const latestVersion = data.version;
        const latestVersionCode = data.version_code;
        const updateInfo = data.update_info;
        const downloadUrl = data.download_url;

        if (latestVersionCode > currentVersionCode) {
            const message = `
                    <p>资源替换脚本有新版本可用！</p>
                    <p><b>当前版本：</b>${currentVersion}</p>
                    <p><b>最新版本：</b>${latestVersion}</p>
                    <p><b>更新内容：</b></p>
                    <div class="update-info-box">${updateInfo.replace(/\n/g, '<br>')}</div>
                `;
            const interval = setInterval(() => {
                if (document.body) {
                    clearInterval(interval);
                    injectMaterialIcons();
                    injectPanelCSS();
                    showUpdateDialog(message, downloadUrl);
                }
            }, 200);
        }
    })
        .catch(error => {
        console.error('更新检查失败:', error);
    });
    // --- END: Version Check ---


    const nameMapping = {
        'firebird': '火焰炮', 'freeze': '冰风暴', 'isida': '磁力炮', 'tesla': '特斯拉', 'hammer': '滑膛炮',
        'twins': '离子炮', 'ricochet': '火龙珠', 'smoky': '轰天炮', 'striker': '火箭炮', 'vulcan': '极速炮',
        'thunder': '雷暴炮', 'scorpion': '蝎子', 'railgun': '激光炮', 'magnum': '马格南', 'gauss': '电磁炮', 'shaft': '镭射炮',
        'wasp': '黄蜂轻甲', 'hornet': '蜂王', 'hopper': '霍珀', 'paladin': '圣骑士', 'hunter': '猎人中甲',
        'crusader': '十字军', 'viking': '维京', 'dictator': '独裁者', 'ares': '阿瑞斯', 'titan': '泰坦', 'mammoth': '猛犸象',
        'brutus': '布鲁特斯', 'mechanic': '机械师', 'trickster': '魔术师', 'saboteur': '破坏者', 'booster': '助推器',
        'defender': '守卫者', 'hyperion': '亥伯龙神', 'crisis': '危机', 'supply': '道具', 'ut': '超高', 'pr': '青春',
        'lc': '遗产', 'xt': 'XT', 'dc': '恶魔', 'gt': 'GT（跑车）', 'hd': 'HD（高清）', 'rf': 'RF（复古未来）', 'se': 'SE（秘密）',
        'dk': 'DK（黑暗）', 'sp': 'SP（蒸汽朋克）', 'ic': 'IC（冰）', 'old': '旧', '爆破手': '爆破手（仅音效）',
        '魔法': '魔法（仅音效）', '新年 重制': '新年 重制（演练场 重制 夏天 ——> 新年 重制）', '雪人': '雪人（进入游戏后再装备马格南）', '番茄炮': '番茄炮（进入游戏后再装备马格南）', '蜘蛛': '蜘蛛（资源域名改为 testanki1.github.io，移动设备不可用）'
    };

    function capitalize(s) {
        if (typeof s !== 'string') return '';
        return s.toUpperCase();
    }

    function getDisplayName(key) {
        if (!key) return '';
        if (key === 'default') return '默认';
        const processedKey = String(key).replace(/_/g, ' ').trim();
        const lowerCaseKey = processedKey.toLowerCase();
        if (nameMapping[lowerCaseKey]) return nameMapping[lowerCaseKey];
        const parts = processedKey.split(' ');
        const translatedParts = parts.map(part => nameMapping[part.toLowerCase()] || capitalize(part));
        return translatedParts.join(' ');
    }

    const pinyinSorter = (a, b) => getDisplayName(a).localeCompare(getDisplayName(b), 'zh-Hans-CN');

    // --- START: Raw Data (Omitted for brevity) ---
    const turretsRedirectMap = {
        "firebird": {
            "default": "573/113511/153/137/31167700271626",
            "XT": "0/16722/167/100/31033604530020",
            "LC": "606/154706/226/46/31033604523453",
            "DC": "574/111547/344/362/31033604472221",
            "DC_OLD": "546/140033/371/67/31033604465511",
            "GT": "620/113215/220/43/31033604507506"
        },
        "freeze": {
            "default": "575/153310/123/250/31167700273561",
            "XT": "545/126533/221/204/31033604562720",
            "XT_HD": "607/133452/43/130/31033604565055",
            "LC": "605/14613/143/127/31033604552551",
            "IC": "605/135171/211/104/31033604546324",
            "GT": "613/146472/243/156/31033604531607",
            "SE": "575/141301/263/323/31033604560325",
            "DK": "626/144115/113/320/31342003517262"
        },
        "isida": {
            "default": "605/12650/334/263/31167700276234",
            "XT": "547/121262/134/345/31033604677132",
            "LC": "606/155040/263/253/31033604672363",
            "GT": "605/12655/270/246/31033604660301"
        },
        "tesla": {
            "default": "567/20040/100/57/31254554136103",
            "XT_HD": "567/20040/100/30/31033605140327",
            "LC": "604/60235/244/25/31033605125726",
            "RF": "616/167677/151/223/31033605130425",
            "GT": "625/62766/332/145/31254576341037",
            "DK": "626/144203/350/14/31331656716045"
        },
        "hammer": {
            "default": "611/147301/37/333/31353636335156",
            "XT": "550/160307/363/221/31033604643362",
            "LC": "601/166273/204/221/31033604634650",
            "DC": "604/4215/36/135/31033605266363",
            "IC": "623/41371/53/15/31150312633557",
            "GT": "623/151743/74/104/31173555130540",
            "SP": "627/57157/76/75/31353640113770"
        },
        "twins": {
            "default": "575/4122/336/247/31167700272424",
            "XT": "547/35525/56/66/31033605232035",
            "LC": "577/157371/340/255/31033605210405",
            "SP": "573/113554/112/100/31033605224225",
            "RF": "607/24114/77/214/31033605215045",
            "GT": "617/163502/325/41/31033605175257"
        },
        "ricochet": {
            "default": "603/121326/210/264/31167700267554",
            "XT": "546/5477/152/352/31033605004772",
            "LC": "556/131232/204/234/31033604772501",
            "RF": "577/176465/41/10/31033605000151",
            "GT": "623/44272/271/157/31167700273640"
        },
        "vulcan": {
            "default": "622/107753/242/303/31167700276134",
            "XT": "0/16722/260/334/31033604733427",
            "PR": "556/15741/256/125/31033605241104",
            "UT": "560/31363/210/347/31033604717360",
            "DC": "613/2044/314/224/31033604703141",
            "LC": "624/106537/253/161/31222141724202"
        },
        "smoky": {
            "default": "566/114246/64/4/31167700272332",
            "XT": "0/114/153/53/31033605053755",
            "LC": "577/171773/42/54/31033605047550",
            "GT": "607/133661/133/27/31033605036471"
        },
        "striker": {
            "default": "626/176167/41/146/31345773511404",
            "XT": "551/70756/233/273/31033605117137",
            "UT": "627/101364/237/0/31360275274536",
            "XT_HD": "626/144201/263/252/31342006372645"
        },
        "thunder": {
            "default": "601/105644/16/124/31167700273301",
            "XT": "0/16722/167/101/31033605170145",
            "PR": "557/14251/175/251/31033605155427",
            "UT": "551/122165/142/136/31033605157155",
            "LC": "545/14356/174/306/31033605151121",
            "GT": "603/104171/41/115/31033605030161",
            "XT_HD": "617/134472/113/60/31033605164111",
            "DK": "623/154657/361/155/31247405107022"
        },
        "scorpion": {
            "default": "600/40107/4/364/31172771520222",
            "XT_HD": "602/132677/206/41/31033605253521",
            "DK": "626/144156/163/60/31342006663170",
            "RF": "627/130231/355/322/31366140324255"
        },
        "magnum": {
            "default": "0/16723/57/323/31167700274631",
            "XT": "550/75104/53/350/31033604732253",
            "SP": "612/42416/374/133/31033604725533",
            "雪人": "575/77444/65/233/31167700273100",
            "番茄炮": "602/100453/315/334/31167700274347"
        },
        "railgun": {
            "default": "567/105205/202/122/31167700270037",
            "XT": "0/16722/6/301/31033604764033",
            "LC": "550/121443/145/146/31033604745456",
            "PR": "553/116715/27/132/31033604752652",
            "UT": "556/177362/212/346/31033604754562",
            "GT": "606/155010/245/142/31033604735353"
        },
        "gauss": {
            "default": "611/61722/256/76/31167700275006",
            "XT": "560/124462/246/14/31033604617041",
            "PR": "554/41313/45/141/31033604572567",
            "UT": "563/51105/72/133/31033605272237",
            "GT": "613/146442/233/316/31033604574743",
            "IC": "614/75662/326/41/31033604602505"
        },
        "shaft": {
            "default": "622/21305/321/374/31167700272525",
            "XT": "546/73531/62/216/31033605014624",
            "LC": "600/170471/174/26/31033605260624",
            "DC": "622/107573/220/101/31123207764670",
            "GT": "623/152225/145/72/31172445577356"
        },
        "B0-NK": {
            "default": "572/36217/77/243/31167700275012",
            "僵尸": "574/72603/5/45/31033604462404"
        }
    };

    const hullsRedirectMap = {
        "wasp": {
            "default": "574/111243/33/322/31167700276263",
            "XT": "0/16722/167/77/31033610130736",
            "DC": "574/113351/211/154/31033610052500",
            "LC": "577/171773/42/62/31033610115062",
            "GT": "620/112773/325/5/31033610100325",
            "蜘蛛": "spider"
        },
        "hopper": {
            "default": "564/5207/367/304/31244271140755",
            "XT_HD": "564/41402/173/47/31033610315703",
            "RF": "616/167677/151/211/31033607331063"
        },
        "hornet": {
            "default": "566/70102/323/346/31167700274103",
            "XT": "0/16722/6/305/31033607424605",
            "LC": "551/32007/310/225/31033607400400",
            "PR": "553/1466/317/276/31033607413764",
            "UT": "562/165115/303/236/31033610210055",
            "GT": "605/27506/77/216/31033607347661",
            "XT_HD": "623/127512/235/65/31166467457145",
            "DK": "626/144132/270/25/31342007351021"
        },
        "viking": {
            "default": "571/121215/5/23/31167700276142",
            "XT": "0/16722/167/76/31033610034165",
            "LC": "545/14403/373/22/31033607776373",
            "PR": "557/14273/215/344/31033610007323",
            "UT": "552/54655/57/366/31033610356100",
            "GT": "603/64520/263/244/31033607745375",
            "XT_HD": "606/155145/337/205/31033610020277",
            "DC": "604/7224/253/317/31033610256112",
            "DK": "623/154646/120/352/31244201526461"
        },
        "crusader": {
            "default": "566/4547/232/306/31330452744134",
            "XT_HD": "566/40410/335/237/31033610341433",
            "RF": "607/24114/77/31/31033607224317"
        },
        "hunter": {
            "default": "567/166366/55/140/31167700272025",
            "XT": "547/121236/44/244/31033607523721",
            "LC": "577/157453/256/241/31033607506717",
            "PR": "554/155720/136/73/31033607521775",
            "UT": "561/113562/137/140/31033610302174",
            "GT": "607/133630/253/171/31033607471473",
            "DC": "613/14407/324/50/31033607446007"
        },
        "paladin": {
            "default": "573/47363/125/65/31222261301215",
            "XT_HD": "573/47363/125/60/31033610367705",
            "RF": "577/176465/41/12/31033607640405"
        },
        "dictator": {
            "default": "602/61700/245/106/31167700275611",
            "XT": "546/125503/267/14/31033607303502",
            "LC": "600/170471/174/17/31033610146055",
            "GT": "606/154745/265/375/31033607235725",
            "SP": "621/133615/104/57/31066757323353"
        },
        "titan": {
            "default": "606/22645/10/357/31167700270522",
            "XT": "545/41207/304/132/31033607734572",
            "LC": "601/166273/204/222/31033607677022",
            "PR": "555/103037/265/247/31033607711541",
            "SP": "612/40333/350/361/31033607720032",
            "GT": "623/44515/116/176/31167700267466"
        },
        "ares": {
            "default": "560/117661/334/334/31330453426702",
            "XT_HD": "626/144373/14/54/31331666154335",
            "RF": "626/36647/152/360/31310325573105",
            "DK": "626/144014/137/35/31342007273462"
        },
        "mammoth": {
            "default": "600/67314/131/54/31167700271637",
            "XT": "0/16722/260/335/31033607615546",
            "LC": "557/31354/323/254/31033607553520",
            "UT": "571/76747/372/131/31033610235472",
            "SP": "573/113554/112/106/31033607575155",
            "GT": "617/163502/325/33/31033607536216"
        }
    };

    const dronesRedirectMap = {
        "hyperion": {
            "default": "556/107004/326/35/31167700276045",
            "XT": "603/140170/104/322/30545000710642"
        },
        "crisis": {
            "default": "562/45273/110/127/31167700270140",
            "XT": "602/142250/300/167/30545000710756"
        }
    };
    const festivalsRedirectMap = {
        "oracle": {
            "default": "544/13635/354/10/31167700271770",
            "UFO 日": "544/55023/262/71/31167700273755"
        },
        "brutus": {
            "default": "553/1401/341/344/31167700270530",
            "UFO 日": "544/55023/262/71/31167700273755"
        },
        "machanic": {
            "default": "542/171271/105/172/31167700275672",
            "UFO 日": "544/55023/262/71/31167700273755"
        },
        "defender": {
            "default": "546/35001/351/175/31167700271513",
            "UFO 日": "544/55023/262/71/31167700273755"
        },
        "booster": {
            "default": "546/35000/233/120/31167700271064",
            "UFO 日": "544/55023/262/71/31167700273755"
        },
        "trickster": {
            "default": "546/63720/303/121/31167700272572",
            "UFO 日": "544/55023/262/71/31167700273755"
        },
        "saboteur": {
            "default": "546/63720/11/312/31167700273521",
            "UFO 日": "544/55023/262/71/31167700273755"
        },
        "hyperion": {
            "default": "556/107004/326/35/31167700276045",
            "UFO 日": "544/55023/262/71/31167700273755"
        },
        "crisis": {
            "default": "562/45273/110/127/31167700270140",
            "UFO 日": "544/55023/262/71/31167700273755"
        },
        "hyperion_xt": {
            "default": "603/140170/104/322/30545000710642",
            "UFO 日": "544/55023/262/71/31167700273755"
        },
        "crisis_xt": {
            "default": "602/142250/300/167/30545000710756",
            "UFO 日": "544/55023/262/71/31167700273755"
        },
        "garage": {
            "default": "601/166176/165/206/31167700267244",
            "万圣节": "613/2501/252/46/30545000710615",
            "生日_15": "601/166176/165/206/31167700267244",
            "新年_2025": "623/152656/155/20/31173045365546",
            "生日_16": "627/10511/266/210/31343251212333"
        },
        "goldbox": {
            "default": "577/106265/316/62/31167700270621",
            "五月假期_2025": "626/66541/105/246/31317431144762",
            "夏季节日": "621/52423/231/162/31167700274305"
        },
        "goldbox_drop_zone": {
            "夏季节日": "621/46012/23/64/31051402416107"
        },
        "sandbox_winter": {
            "default": "570/174542/371/61/30544540056777",
            "节日季节 主题": "570/174542/371/62/30544541264567"
        },
        "forest_winter": {
            "default": "0/16723/204/143/30545207067664",
            "节日季节 主题": "0/16723/204/144/30545210267003"
        },
        "new_year_library": {
            "default": "553/105167/27/302/30546776460526",
            "新年 重制": "570/174542/371/71/31167243462337"
        },
        "new_year_map": {
            "default": "544/77313/263/311/30545211407625",
            "新年 重制": "570/174542/371/72/31167257256577"
        },
        "new_year_music_map": {
            "default": "602/103320/104/163/31345722114137/sound.mp3",
            "节日季节 主题": "575/163160/137/356/30653770533354/sound.mp3",
            "新年 重制": "575/163160/137/356/30653770533354/sound.mp3"
        },
        "new_year_music_lobby": {
            "default": "624/47563/51/36/31346024736404/sound.mp3",
            "新年_2025": "575/163160/137/356/30653770533354/sound.mp3"
        },
        "new_year_music_garage": {
            "default": "624/47563/351/11/31346024735775/sound.mp3",
            "新年_2025": "575/163160/137/356/30653770533354/sound.mp3"
        }
    };
    const shotEffectsRedirectMap = {
        "firebird_1": {
            "default": "546/145213/173/213/30545000703101",
            "幻影黑": "546/145213/172/34/30545000702774",
            "岩浆": "546/145213/173/346/30545000702745",
            "粉红色": "546/145213/173/61/30545000702662",
            "深红色": "546/145213/174/101/30545000703037"
        },
        "firebird_2": {
            "default": "546/145213/174/235/30545000702754",
            "幻影黑": "546/145213/172/326/30545000703020",
            "岩浆": "546/145213/172/171/30545000703031",
            "粉红色": "546/145213/171/277/30545000703113",
            "深红色": "546/145213/171/142/30545000702773"
        },
        "freeze_1": {
            "default": "546/145213/144/251/30545000702776",
            "寒冷": "546/145213/143/357/30545000703103",
            "毒": "546/145213/142/53/30545000702770",
            "暗月": "546/145213/143/223/30545000703120",
            "雪": "546/145213/142/340/30545000703124"
        },
        "freeze_2": {
            "default": "546/145213/142/206/30545000703057",
            "寒冷": "546/145213/144/114/30545000703120",
            "毒": "546/145213/141/312/30545000702717",
            "暗月": "546/145213/143/72/30545000703045",
            "雪": "546/145213/141/157/30545000702630"
        },
        "isida_1": {
            "default": "546/147613/376/315/30545000606067",
            "火": "546/147614/265/140/30545000606433",
            "太阳": "546/147614/315/217/30545000607355",

        },
        "isida_2": {
            "default": "546/145213/157/16/30545000703112",
            "火": "546/145213/160/314/30545000702744",
            "太阳": "546/145213/157/147/30545000703060"
        },
        "tesla_1": {
            "default": "562/24337/265/306/30545000607156"
        },
        "tesla_2": {
            "default": "562/24337/265/320/30545000606123"
        },
        "tesla_3": {
            "default": "545/117451/153/325/30545000607527"
        },
        "hammer_1": {
            "default": "0/16721/360/363/30545000605632",
            "水": "552/51671/2/323/30545000605746",
            "岩浆": "552/53566/151/315/30545000606146",
            "虚空": "552/53601/214/6/30545000607100",
            "毒": "552/53572/352/35/30545000606234",
            "日食": "552/52027/331/152/30545000606672",
            "天空蓝": "552/52016/127/345/30545000607136",
            "血液": "552/52003/10/225/30545000606004"
        },
        "hammer_2": {
            "default": "0/16721/360/354/30545000702655",
            "水": "552/51665/316/67/30545000703052",
            "岩浆": "552/52036/52/14/30545000703064",
            "虚空": "552/53576/213/137/30545000703100",
            "毒": "552/53567/222/305/30545000702727",
            "日食": "552/52025/323/24/30545000702651",
            "天空蓝": "552/52013/202/106/30545000703040",
            "血液": "552/52001/105/321/30545000703016"
        },
        "hammer_3": {
            "default": "0/16721/360/353/30545000702716",
            "水": "552/51633/372/42/30545000703044",
            "岩浆": "552/51660/351/135/30545000702664",
            "虚空": "552/51663/251/302/30545000703110",
            "毒": "552/51662/112/72/30545000702771",
            "日食": "552/51651/115/372/30545000702724",
            "天空蓝": "552/51641/324/356/30545000702734",
            "血液": "552/51636/14/205/30545000702615"
        },
        "hammer_4": {
            "default": "0/16721/360/362/30545000607320",
            "水": "552/51670/1/143/30545000606152",
            "岩浆": "552/53565/327/202/30545000605737",
            "虚空": "552/53600/174/213/30545000606610",
            "毒": "552/53572/120/76/30545000607202",
            "日食": "552/52027/112/70/30545000605577",
            "天空蓝": "552/52015/322/160/30545000606065",
            "血液": "552/52002/222/200/30545000605627"
        },
        "twins_1": {
            "default": "546/145213/165/145/30545000702663",
            "珊瑚礁": "546/145213/165/10/30545000702632",
            "暗月": "546/145213/164/122/30545000703054",
            "天空": "546/145213/167/352/30545000703121",
            "金": "546/145213/163/371/30545000703070",
            "紫罗兰色": "546/145213/170/106/30545000702645",
            "电": "546/145213/161/336/30545000703015"
        },
        "twins_2": {
            "default": "546/147411/176/204/30545000607302",
            "珊瑚礁": "546/147443/56/222/30545000607142",
            "暗月": "546/147443/205/75/30545000606311",
            "天空": "546/147444/204/315/30545000607034",
            "金": "546/147444/25/271/30545000606000",
            "紫罗兰色": "546/147444/336/41/30545000606005",
            "电": "546/147443/331/145/30545000606131"
        },
        "twins_3": {
            "default": "546/145213/166/330/30545000702745",
            "珊瑚礁": "546/145213/166/37/30545000703044",
            "暗月": "546/145213/165/302/30545000703114",
            "天空": "546/145213/163/240/30545000702777",
            "金": "546/145213/167/215/30545000702475",
            "紫罗兰色": "546/145213/162/355/30545000703011",
            "电": "546/145213/171/0/30545000702716"
        },
        "twins_sound_1": {
            "default": "0/114/113/232/31345722126256/sound.mp3",
            "爆破手": "600/155645/173/315/30653771331454/sound.mp3"
        },
        "twins_sound_2": {
            "爆破手": "600/155645/173/305/30653771331271"
        },
        "ricochet_1": {
            "default": "546/147741/131/160/30545000606467",
            "电": "546/147741/302/146/30545000607410",
            "金": "546/147743/0/265/30545000607037",
            "深红色": "546/147741/236/332/30545000607462",
            "烟雾": "546/147743/74/211/30545000606654",
            "岩浆": "546/147743/37/47/30545000605725",
            "紫罗兰色": "546/147744/61/264/30545000607335",
            "毒": "546/147743/143/272/30545000607221",
            "水": "546/147741/204/277/30545000605736"
        },
        "ricochet_2": {
            "default": "546/145213/211/227/30545000703056",
            "电": "546/145213/210/204/30545000702650",
            "金": "546/145213/201/277/30545000703045",
            "深红色": "546/145213/203/206/30545000702623",
            "烟雾": "546/145213/211/362/30545000702723",
            "岩浆": "546/145213/212/250/30545000702757",
            "紫罗兰色": "546/145213/203/340/30545000702614",
            "毒": "546/145213/210/50/30545000702604",
            "水": "546/145213/206/271/30545000702771"
        },
        "ricochet_3": {
            "default": "546/145213/207/24/30545000703106",
            "电": "546/145213/206/136/30545000703055",
            "金": "546/145213/214/32/30545000703012",
            "深红色": "546/145213/205/250/30545000703067",
            "烟雾": "546/145213/213/275/30545000703105",
            "岩浆": "546/145213/205/115/30545000703036",
            "紫罗兰色": "546/145213/202/165/30545000702775",
            "毒": "546/145213/207/160/30545000702565",
            "水": "546/145213/211/73/30545000703041"
        },
        "ricochet_4": {
            "default": "546/147746/300/166/30545000605533",
            "电": "546/147747/362/5/30545000607041",
            "金": "546/147750/20/205/30545000605607",
            "深红色": "546/147746/376/1/30545000606504",
            "烟雾": "546/147760/47/244/30545000605531",
            "岩浆": "546/147750/54/23/30545000606260",
            "紫罗兰色": "546/147760/144/56/30545000606624",
            "毒": "546/147760/77/170/30545000605361",
            "水": "546/147746/341/23/30545000607474"
        },
        "ricochet_sound_1": {
            "default": "0/114/141/75/30653771331544/sound.mp3",
            "爆破手": "600/155645/173/316/30653771331536/sound.mp3"
        },
        "ricochet_sound_2": {
            "default": "0/114/141/74/30653771331450/sound.mp3",
            "爆破手": "600/155645/173/315/30653771331454/sound.mp3"
        },
        "ricochet_sound_3": {
            "default": "0/114/141/110/30653771331253/sound.mp3",
            "爆破手": "600/155645/173/305/30653771331271/sound.mp3"
        },
        "vulcan_1": {
            "default": "546/145213/124/120/30545000703060",
            "神秘的红色": "560/33733/324/111/30545000702647"
        },
        "vulcan_2": {
            "default": "546/145213/117/343/30545000702623",
            "神秘的红色": "560/33733/324/104/30545000702743"
        },
        "smoky_1": {
            "default": "546/145213/140/271/30545000702755"
        },
        "smoky_2": {
            "default": "0/1374/264/44/30545000607440"
        },
        "smoky_3": {
            "default": "566/124613/346/51/30545000606147"
        },
        "smoky_4": {
            "default": "566/124613/346/64/30545000607002"
        },
        "smoky_5": {
            "default": "566/124613/346/70/30545000606325"
        },
        "smoky_6": {
            "default": "566/124613/346/65/30545000702606"
        },
        "smoky_7": {
            "default": "566/124716/12/375/30545000607150"
        },
        "smoky_8": {
            "default": "555/127561/370/247/30545000605433"
        },
        "striker_1": {
            "default": "546/145213/114/104/30545000703026",
            "紫罗兰色": "546/145213/115/262/30545000702665",
            "毒": "546/145213/116/316/30545000702574",
            "深红色": "546/145213/116/23/30545000702746",
            "天空蓝": "546/145213/113/212/30545000702642"
        },
        "striker_2": {
            "default": "546/150052/46/102/30545000605332",
            "紫罗兰色": "546/150053/175/72/30545000607442",
            "毒": "546/150053/43/77/30545000607372",
            "深红色": "546/150052/352/51/30545000606042",
            "天空蓝": "546/150052/222/172/30545000607270"
        },
        "thunder_1": {
            "default": "546/145213/174/374/30545000703122"
        },
        "thunder_2": {
            "default": "555/127645/160/2/30545000605641"
        },
        "thunder_3": {
            "default": "555/127647/64/315/30545000607202"
        },
        "thunder_4": {
            "default": "555/127647/233/165/30545000606002"
        },
        "thunder_5": {
            "default": "555/127650/133/357/30545000605351"
        },
        "scorpion_1": {
            "default": "546/145213/177/370/30545000702654"
        },
        "scorpion_2": {
            "default": "0/16723/73/211/30545000606641"
        },
        "scorpion_3": {
            "default": "0/16723/73/210/30545000607024"
        },
        "magnum_1": {
            "default": "546/145213/177/44/30545000702741",
            "天空蓝": "554/153573/307/234/30545000703017",
            "深红色": "554/153573/310/141/30545000702743",
            "毒": "554/153573/311/60/30545000702612",
            "紫罗兰色": "554/153573/311/171/30545000703070",
            "日食": "554/153573/310/340/30545000702671",
            "番茄炮": "602/105615/143/174/30545000703044"
        },
        "magnum_2": {
            "default": "546/145213/177/370/30545000702654",
            "天空蓝": "554/153573/311/277/30545000702760",
            "深红色": "554/153573/312/2/30545000702566",
            "毒": "554/153573/312/212/30545000702764",
            "紫罗兰色": "554/153573/312/317/30545000703014",
            "日食": "554/153573/312/106/30545000702730",
            "番茄炮": "554/153573/312/2/30545000702566"
        },
        "magnum_sound": {
            "default": "0/16723/73/221/31345722115044",
            "番茄炮": "572/75525/322/163/31345722125627"
        },
        "railgun_1": {
            "default": "546/150126/51/246/30545000607361",
            "血液": "546/150135/217/70/30545000607516",
            "橄榄绿": "546/150137/76/311/30545000607006",
            "雪": "546/150137/212/373/30545000607076",
            "天空蓝": "546/150136/157/164/30545000605652",
            "金": "546/150136/371/37/30545000605757",
            "紫罗兰色": "546/150137/313/47/30545000607434",
            "黑暗": "546/150136/262/137/30545000607033"
        },
        "railgun_2": {
            "default": "546/150126/253/153/30545000607325",
            "血液": "546/150140/120/227/30545000605435",
            "橄榄绿": "546/150141/317/134/30545000607352",
            "雪": "546/150142/34/243/30545000606654",
            "天空蓝": "546/150140/221/33/30545000607077",
            "金": "546/150141/177/276/30545000606471",
            "紫罗兰色": "546/150142/141/114/30545000605736",
            "黑暗": "546/150140/335/362/30545000605561"
        },
        "railgun_3": {
            "default": "546/150125/227/36/30545000606325",
            "血液": "546/150132/137/312/30545000606477",
            "橄榄绿": "546/150133/361/63/30545000607371",
            "雪": "546/150134/61/330/30545000607361",
            "天空蓝": "546/150132/273/312/30545000607533",
            "金": "546/150133/175/343/30545000607547",
            "紫罗兰色": "546/150134/177/241/30545000605424",
            "黑暗": "546/150133/65/175/30545000607422"
        },
        "railgun_4": {
            "default": "614/167157/112/162/30635634260772",
            "魔法": "615/171467/335/170/30706105525223"
        },
        "railgun_sound": {
            "default": "0/114/113/314/31345722126571/sound.mp3",
            "魔法": "617/51351/145/71/30752715761312/sound.swf"
        },
        "gauss_1": {
            "default": "552/132670/36/315/30545000606571",
            "暴力": "560/161445/44/340/30545000607420"
        },
        "gauss_2": {
            "default": "552/132670/163/5/30545000607131",
            "暴力": "560/161445/44/342/30545000607416"
        },
        "gauss_3": {
            "default": "552/132672/57/244/30545000606601",
            "暴力": "560/161445/44/341/30545000606255"
        },
        "gauss_4": {
            "default": "552/132667/104/225/30545000702742",
            "暴力": "560/161445/44/337/30545000702761"
        },
        "gauss_5": {
            "default": "552/132667/257/15/30545000703127",
            "暴力": "560/161445/44/324/30545000703027"
        },
        "gauss_6": {
            "default": "552/132672/221/154/30545000607025",
            "暴力": "560/161445/44/336/30545000606725"
        },
        "gauss_7": {
            "default": "552/132666/160/177/30545000606500",
            "暴力": "560/161445/44/343/30545000606270"
        },
        "gauss_8": {
            "default": "552/132671/132/330/30545000607211",
            "暴力": "560/161445/44/334/30545000606221"
        },
        "shaft_1": {
            "default": "546/145213/127/45/30545000703054",
            "天空蓝": "546/145213/135/15/30545000703075",
            "日食": "546/145213/130/216/30545000703046",
            "正午": "546/145213/134/5/30545000703107",
            "橄榄绿": "546/145213/127/333/30545000703031",
            "水": "546/145213/130/346/30545000702761",
            "虚空": "546/145213/131/77/30545000703035",
            "血液": "546/145213/133/124/30545000703047",
            "紫罗兰色": "546/145213/126/45/30545000703100",
            "岩浆": "546/145213/134/135/30545000703123"
        },
        "shaft_2": {
            "default": "546/145213/132/373/30545000703117",
            "天空蓝": "546/145213/130/65/30545000703014",
            "日食": "546/145213/127/200/30545000702732",
            "正午": "546/145213/137/251/30545000702663",
            "橄榄绿": "546/145213/133/254/30545000702624",
            "水": "546/145213/136/101/30545000703113",
            "虚空": "546/145213/131/230/30545000703066",
            "血液": "546/145213/135/147/30545000702626",
            "紫罗兰色": "546/145213/126/314/30545000703004",
            "岩浆": "546/145213/136/364/30545000703060"
        },
        "shaft_3": {
            "default": "546/150162/53/137/30545000605710",
            "天空蓝": "546/150162/346/234/30545000607140",
            "日食": "546/150163/364/61/30545000606306",
            "正午": "546/150165/141/234/30545000606565",
            "橄榄绿": "546/150164/102/322/30545000607471",
            "水": "546/150162/233/365/30545000606632",
            "虚空": "546/150165/346/273/30545000606650",
            "血液": "546/150163/72/47/30545000606655",
            "紫罗兰色": "546/150165/250/233/30545000605723",
            "岩浆": "546/150164/204/117/30545000607517"
        },
        "supply_boost_armor_sound": {
            "default": "0/16723/157/341/31345722114575",
            "危机": "562/50436/64/45/31345722122070"
        },
        "supply_boost_damage_sound": {
            "default": "0/16723/157/343/31345722114677",
            "危机": "562/50436/64/57/31345722114600"
        },
        "supply_boost_speed_sound": {
            "default": "0/16723/157/346/31345722120537",
            "危机": "562/50436/64/61/31345722123737"
        }
    };
    const paintsRedirectMap = {
        "paints": {
            "橄榄绿": "0/0/332/376/30545000607534",
            "中国红": "0/0/345/314/30545000606635",
            "光谱": "537/157270/46/364/30545000703055",
            "坦克币坦克": "556/15724/147/2/30545000702723",
            "天空蓝": "610/51505/40/77/30545000606404",
            "幻影黑": "0/0/332/373/30545000606672",
            "海蓝色": "610/51503/310/365/30545000606240",
            "芥末": "615/77267/341/375/30660323773566",
            "雪山飞狐": "0/0/345/317/30545000607502",
            "黄马甲": "610/51507/145/136/30545000607100",
            "珊瑚色": "610/51505/270/232/30545000607452",
            "苹果色": "610/51502/260/102/30545000607557",
            "合金装备": "0/0/345/311/30545000605127",
            "平静": "615/77267/166/44/30660323745713",
            "紫红色": "610/51506/123/64/30545000607075",
            "褐红色": "0/0/345/314/30545000606635",
            "黄色": "610/51510/310/171/30545000607204",
            "偏蓝色": "610/51504/137/145/30545000606503",
            "紫罗兰色": "610/51510/145/53/30545000607357",
            "金色": "610/51507/23/220/30545000606776",
            "乌拉圭": "0/16721/126/71/30545000606647",
            "喀麦隆": "0/16721/125/215/30545000607105",
            "巴拿马": "544/1033/64/360/30545000606721",
            "希腊": "0/16721/125/201/30545000606136",
            "废墟": "0/114/122/55/30545000606036",
            "森林": "0/0/333/1/30545000605414",
            "法国": "0/16721/125/171/30545000606654",
            "流沙": "0/114/144/26/30545000607301",
            "游击队": "0/16722/56/166/30545000607467",
            "热带": "0/114/114/101/30545000605636",
            "磐石": "0/114/144/27/30545000606312",
            "红色城市": "0/16723/6/14/30545000606071",
            "翡翠": "0/114/164/111/30545000606253",
            "锈斑": "0/114/143/110/30545000606651",
            "阿根廷": "0/16721/125/153/30545000606432",
            "丛林杀手": "0/114/144/24/30545000606313",
            "五彩纸屑": "0/16722/363/252/30545000606637",
            "俄罗斯": "0/16721/126/65/30545000607105",
            "克罗地亚": "0/16721/125/203/30545000607535",
            "冰岛": "0/16722/350/355/30545000606721",
            "哥伦比亚": "0/16721/125/217/30545000607417",
            "埃及": "544/1033/63/340/30545000606027",
            "塞内加尔": "544/1033/65/311/30545000607171",
            "威尔士": "0/16722/350/357/30545000607000",
            "岩浆": "0/16722/35/4/30545000607012",
            "意大利": "0/16721/125/211/30545000607513",
            "摩洛哥": "544/1033/64/160/30545000606441",
            "漩涡": "0/16722/56/175/30545000606567",
            "智利": "0/16721/125/166/30545000607360",
            "松针": "0/114/164/76/30545000605431",
            "比利时": "0/16721/125/157/30545000607333",
            "沙漠": "0/114/114/77/30545000607076",
            "沼泽": "0/114/122/52/30545000606151",
            "波斯尼亚和黑塞哥维那": "0/16721/125/161/30545000606335",
            "澳大利亚": "0/16721/125/155/30545000605701",
            "瑞典": "544/1033/66/241/30545000607345",
            "突尼斯": "544/1033/75/236/30545000607202",
            "草原": "0/16723/6/15/30545000606777",
            "葡萄牙": "0/16721/126/63/30545000606254",
            "象牙海岸": "0/16721/125/225/30545000606564",
            "雪松": "0/114/144/25/30545000607412",
            "风语者": "0/114/143/106/30545000606431",
            "加纳": "0/16721/125/173/30545000605713",
            "墨西哥": "0/16721/125/227/30545000607442",
            "巴西": "0/16721/125/163/30545000606642",
            "幻影骑士": "0/114/122/101/30545000606211",
            "极地隐身": "0/114/144/43/30545000606434",
            "樱桃": "0/16722/56/163/30545000607321",
            "洪都拉斯": "0/16721/125/177/30545000607207",
            "海军": "0/114/114/100/30545000606524",
            "激浪": "0/114/143/51/30545000607211",
            "瑞士": "0/16721/126/67/30545000606313",
            "秘鲁": "544/1050/246/162/30545000605552",
            "美国": "0/16721/126/73/30545000606511",
            "苔藓": "0/16722/363/257/30545000606463",
            "阿尔及利亚": "0/16721/125/147/30545000606774",
            "丛林": "0/0/332/370/30545000607415",
            "丹麦": "544/1032/215/315/30545000606131",
            "伊朗伊斯兰共和国": "0/16721/125/205/30545000607132",
            "像素": "0/16722/35/7/30545000607016",
            "冬天": "0/114/122/102/30545000607276",
            "厄瓜多尔": "0/16721/125/167/30545000606656",
            "哥斯达黎加": "0/16721/125/223/30545000607440",
            "城市": "0/114/114/102/30545000606613",
            "塞尔维亚": "544/1033/66/66/30545000605756",
            "尼日利亚": "0/16721/126/61/30545000606503",
            "德国": "0/16721/125/175/30545000606327",
            "日本": "0/16721/125/213/30545000606641",
            "暴风雪": "0/114/143/112/30545000606104",
            "极地沼泽": "0/114/144/42/30545000607532",
            "毕加索": "0/114/164/75/30545000606717",
            "沙特阿拉伯": "544/1033/65/137/30545000607222",
            "波兰": "0/16722/350/356/30545000605703",
            "泥浆": "0/114/143/107/30545000607441",
            "火星": "0/16722/35/5/30545000607042",
            "破绽": "0/16722/56/164/30545000607017",
            "英格兰": "0/16721/125/151/30545000607121",
            "荷兰": "0/16721/126/57/30545000607311",
            "西班牙": "0/16721/125/207/30545000605530",
            "隐身衣": "0/114/122/36/30545000607206",
            "韩国": "0/16721/125/221/30545000607375",
            "万花筒": "0/16722/363/255/30545000606454",
            "古典": "0/114/143/111/30545000605745",
            "斑纹": "0/114/121/372/30545000607316",
            "原子": "0/16722/35/2/30545000606151",
            "外星伪装": "0/114/122/56/30545000607130",
            "宙斯": "0/114/156/134/30545000606631",
            "樱花": "0/16722/56/174/30545000607447",
            "死亡骑士": "0/114/122/11/30545000605726",
            "涂鸦": "0/16722/56/165/30545000606005",
            "火山": "0/0/345/303/30545000607074",
            "爱你一万年": "0/16722/62/45/30545000606502",
            "牛仔裤": "0/16722/363/254/30545000607354",
            "番茄玛丽": "0/114/143/152/30545000607222",
            "绿宝石": "0/114/156/135/30545000607452",
            "蜂巢": "0/16722/56/167/30545000606230",
            "迪斯科": "0/16722/363/253/30545000605530",
            "铁匠": "0/16722/56/162/30545000607212",
            "龙鳞骑士": "0/114/121/371/30545000607115",
            "上帝之眼": "0/114/122/7/30545000607561",
            "伐木工": "0/16722/56/171/30545000605744",
            "侵略者": "0/16722/56/170/30545000607075",
            "像素心": "0/16722/356/153/30545000606732",
            "初恋": "0/16722/356/155/30545000606424",
            "地狱火": "0/114/156/150/30545000606262",
            "夜晚": "0/16722/356/152/30545000605511",
            "宇宙空间": "0/16722/356/157/30545000607135",
            "撒哈拉沙漠": "0/16722/363/260/30545000607351",
            "毛线衣": "0/16722/356/156/30545000605507",
            "浣熊": "0/16722/56/172/30545000607117",
            "滑稽演员": "0/16722/363/251/30545000607373",
            "犀牛": "0/16722/56/173/30545000606546",
            "猛虎": "0/16722/35/10/30545000606657",
            "碳纤": "0/114/122/34/30545000606660",
            "纳米": "0/16722/35/6/30545000605574",
            "花火": "0/114/143/50/30545000607560",
            "蟒蛇": "0/114/143/153/30545000605516",
            "软花": "0/16722/356/154/30545000607034",
            "金钱豹": "0/114/121/370/30545000605222",
            "链甲": "0/16722/35/3/30545000607471",
            "镀铅": "0/114/164/365/30545000607406",
            "雪豹": "0/114/165/3/30545000606043",
            "非洲": "0/16722/56/161/30545000606024",
            "52 区": "572/34560/262/327/30545000606672",
            "E236": "543/66557/172/122/30545000605676",
            "丁香花瓣": "0/16723/72/5/30545000607210",
            "佩斯利冰": "541/26511/305/152/30545000605740",
            "前卫派": "566/65737/330/277/30545000607015",
            "包装长筒袜": "557/33761/314/300/30545000606017",
            "声纳": "564/23012/127/250/30545000606217",
            "游戏手柄": "566/115237/243/141/30545000607411",
            "大都市": "543/66573/106/36/30545000607531",
            "奇怪的鱼": "553/3667/10/45/30545000607020",
            "帽子": "552/51352/300/305/30545000606046",
            "恒星和火焰": "560/100572/177/225/30545000606727",
            "抽象线条": "543/66556/373/12/30545000606472",
            "撕碎": "561/25253/244/143/30545000607515",
            "斯堪的那维亚": "0/16723/135/52/30545000606266",
            "新年礼物": "540/66626/127/277/30545000606522",
            "时尚坦克手": "561/142545/333/13/30545000607464",
            "星光大道": "571/14366/260/207/30545000606051",
            "春季花束": "567/130011/272/263/30545000607320",
            "永恒": "0/16722/232/3/30545000606507",
            "流行艺术": "541/26511/305/120/30545000605730",
            "海滩": "572/34561/144/112/30545000607507",
            "淘金者": "562/170135/40/121/30545000605246",
            "烧焦": "553/114343/321/275/30545000606063",
            "牛排": "0/16723/135/61/30545000605403",
            "琥珀": "0/16723/6/11/30545000607421",
            "生锈": "0/16723/135/54/30545000605631",
            "病毒": "561/61551/166/321/30545000606701",
            "睡衣": "0/16723/135/60/30545000607345",
            "石灰爆裂": "0/16723/72/3/30545000605227",
            "硅酸盐": "541/26511/305/132/30545000607365",
            "祖母的沙发": "561/25253/244/153/30545000607543",
            "神经元": "0/16722/356/165/30545000607011",
            "神经网络": "566/65742/34/143/30545000606502",
            "绿洲": "571/125007/232/46/30545000607554",
            "落叶": "574/31046/60/77/30545000605327",
            "蓝色几何": "561/25253/244/146/30545000607514",
            "蓝色星球": "554/41202/220/275/30545000605743",
            "薄荷": "0/16723/6/12/30545000606300",
            "西瓜": "553/114353/265/331/30545000607504",
            "超立方体": "541/26511/305/122/30545000607554",
            "逆波": "572/166517/257/277/30545000607137",
            "金星": "0/16722/356/161/30545000606723",
            "钢微纤维": "0/16723/66/102/30545000607351",
            "青柠": "0/16722/356/164/30545000605366",
            "飞驰之星": "561/142545/333/20/30545000607511",
            "450 纳米": "561/25253/244/150/30545000605763",
            "UFO": "570/61721/132/221/30545000607374",
            "VIP 迷彩": "0/16722/221/71/30545000606135",
            "丑角": "570/61722/261/211/30545000606611",
            "丰富的装饰品": "557/33762/110/27/30545000607131",
            "亚当和夏娃": "556/16004/11/231/30545000606470",
            "佩斯利火焰": "541/26511/305/154/30545000607500",
            "俄罗斯方块": "564/155045/353/71/30545000607501",
            "僵尸": "0/16723/5/160/30545000606574",
            "冰霜": "0/16722/6/317/30545000605535",
            "冷静兄弟！": "0/16723/227/134/30545000607553",
            "创意工程师": "561/142545/333/22/30545000607344",
            "化装舞会": "573/100606/272/364/30545000606601",
            "压碎机": "552/51356/65/243/30545000607450",
            "古奇旗子": "541/26511/305/114/30545000607350",
            "可怕的事情": "555/102572/301/267/30545000607222",
            "和平，工作，五月！": "571/14353/303/123/30545000606501",
            "培乐多": "541/26511/305/142/30545000605600",
            "塔兰图拉": "552/51367/16/51/30545000607007",
            "复活节": "567/130016/222/202/30545000607551",
            "外星人的秘密": "0/16723/247/227/30545000607532",
            "外星人链甲": "560/100572/177/233/30545000605732",
            "多米诺骨牌": "0/16722/374/162/30545000607555",
            "大洋洲": "557/163165/361/246/30545000607077",
            "天蓝": "541/26511/305/160/30545000606602",
            "小木屋": "574/31047/146/174/30545000606567",
            "山峰": "541/26511/305/116/30545000606070",
            "巴布什卡的被子": "560/100572/177/217/30545000605764",
            "干旱": "0/16723/6/13/30545000607223",
            "平安夜": "575/112017/111/35/30545000607441",
            "幻影": "541/26511/305/150/30545000606466",
            "幻觉": "541/26511/305/124/30545000606471",
            "彩色玻璃": "543/66577/152/215/30545000607531",
            "微型砖石": "556/16006/24/21/30545000606026",
            "微风": "543/176106/125/337/30545000607363",
            "您所需要的是…": "0/16723/61/230/30545000607427",
            "战舰": "562/45076/20/331/30545000607557",
            "所有的好东西": "557/33761/2/27/30545000607220",
            "故障": "0/16723/135/51/30545000606155",
            "救生员": "554/155643/245/4/30545000607321",
            "数独": "541/26511/305/130/30545000607346",
            "新加坡": "550/121245/75/173/30545000605634",
            "日落伪装": "0/16723/66/104/30545000607347",
            "昆古尔冰洞": "541/26511/305/136/30545000607120",
            "曲折": "541/26511/305/134/30545000605663",
            "月球土壤": "0/16723/135/57/30545000606663",
            "月球漫步者": "0/16717/262/246/30545000607112",
            "木头迷彩": "550/121245/254/152/30545000606333",
            "核能太阳": "562/45076/20/334/30545000605211",
            "棒棒糖": "541/26511/305/144/30545000606655",
            "橙色海胆": "557/163173/240/65/30545000606670",
            "毯子": "575/112017/255/212/30545000605745",
            "水彩画": "0/16722/374/163/30545000606327",
            "波纹": "541/26511/305/146/30545000606241",
            "流行它": "571/125005/351/210/30545000606642",
            "液态金属": "0/16722/363/256/30545000607545",
            "深蓝色像素": "557/163174/306/55/30545000605601",
            "游戏玩家": "563/112373/41/234/30545000605241",
            "火山喷发": "566/115234/353/363/30545000607275",
            "火龙": "543/66562/107/70/30545000605554",
            "炼乳": "543/66576/13/145/30545000606216",
            "烤炉": "556/16004/335/357/30545000606227",
            "烧烤": "562/104265/346/222/30545000607204",
            "热带地区": "565/67400/142/143/30545000606627",
            "狂野风格": "572/166524/245/14/30545000607477",
            "玉鳞": "553/114352/236/113/30545000606663",
            "环保型": "563/112371/330/230/30545000607514",
            "珍贵的耳钉": "560/100572/177/223/30545000607474",
            "理发店": "0/16723/135/56/30545000607441",
            "白色星球": "554/41254/55/327/30545000606610",
            "瞄准镜": "575/46555/261/256/30545000607503",
            "矢量": "567/37631/253/315/30545000606144",
            "礼物包装": "553/3666/304/323/30545000607422",
            "神鸟": "554/155644/166/30/30545000606634",
            "粉红色大象": "555/102575/40/125/30545000607003",
            "红色星球": "554/41253/265/272/30545000605541",
            "红色果酱": "550/121243/76/171/30545000605712",
            "红色标记": "573/100613/311/12/30545000607551",
            "红色西装": "0/16722/316/153/30545000606266",
            "羽毛": "543/66561/30/32/30545000607420",
            "翻滚": "554/155641/323/221/30545000606174",
            "脉冲星": "541/26511/305/126/30545000606145",
            "苏打水": "562/104265/346/212/30545000606041",
            "草莓": "0/16723/135/55/30545000607450",
            "芥麦": "561/61476/276/101/30545000607453",
            "莫奈": "541/26511/305/162/30545000606060",
            "莲花": "541/26511/305/156/30545000606570",
            "蓝方块": "543/66560/61/12/30545000606725",
            "蓝色果酱": "550/121244/103/312/30545000606232",
            "薄荷糖": "575/46552/314/267/30545000607413",
            "蛋糕": "562/104265/346/220/30545000606644",
            "蜘蛛": "0/16722/363/250/30545000606215",
            "观鸟者": "0/16723/150/166/30545000606125",
            "视网膜": "0/16723/150/164/30545000607111",
            "设计师氛围": "561/142545/333/16/30545000606417",
            "越野车": "562/170140/75/64/30545000607136",
            "路障胶带": "565/67401/231/336/30545000606715",
            "进攻": "562/44013/24/265/30545000607373",
            "远古巨龙": "551/134532/12/261/30545000605705",
            "金光闪烁": "0/16723/23/221/30545000607211",
            "钒": "0/16723/135/53/30545000607302",
            "问题": "567/37634/331/270/30545000606143",
            "陶艺家": "541/26511/305/140/30545000606324",
            "雪花": "0/16723/44/257/30545000607323",
            "雷暴球": "543/66562/241/30/30545000607415",
            "靶子": "564/155027/33/210/30545000607531",
            "飞镖": "562/44013/24/272/30545000607014",
            "鱿鱼的手指": "555/102576/60/53/30545000607264",
            "鹰眼": "564/23020/11/175/30545000606651",
            "黑曜石": "552/51360/121/217/30545000606404",
            "X 黑色": "553/1433/50/273/30545000703117",
            "几何形状的霓虹灯": "555/102567/46/351/30545000703107",
            "化学反应": "561/25253/244/136/30545000702666",
            "困在内部": "556/130764/204/367/30545000703020",
            "春天": "551/24636/42/72/30545000702736",
            "正方体迷彩": "547/116152/46/270/30545000702670",
            "片假名": "565/67302/70/327/30545000702652",
            "篝火": "564/23137/27/324/30545000703000",
            "网络手里剑": "561/25253/244/141/30545000703077",
            "藤本植物": "551/27326/356/365/30545000702651",
            "银砖": "547/116412/306/51/30545000702600",
            "阴极射线管": "573/10240/176/221/30545000702774",
            "雷达": "554/67737/67/265/30545000702631",
            "LOL": "551/134147/265/133/30545000702562",
            "七十年代的乐趣": "555/102570/232/331/30545000702756",
            "不是一个灯笼": "554/156330/206/340/30545000702673",
            "井字棋": "546/73372/207/102/30545000703037",
            "像素等离子": "561/142545/333/1/30545000702624",
            "兔子": "546/137352/112/21/30545000703034",
            "全息": "551/27324/333/273/30545000703033",
            "共生体": "546/34534/177/323/30545000703013",
            "冰乱舞": "557/33643/374/221/30545000702640",
            "冲浪": "564/23530/371/347/30545000702725",
            "初吻": "550/156240/56/163/30545000702653",
            "勇气": "543/174441/145/365/30545000703121",
            "北极光": "552/64132/112/241/30545000702661",
            "华丽的鳄鱼": "555/102562/350/355/30545000702767",
            "南瓜浆果": "555/175742/220/260/30545000703126",
            "卡普利亚特": "555/102555/140/111/30545000702643",
            "印刷电路板": "564/23104/74/23/30545000702775",
            "发光二极管": "545/11623/72/202/30545000702563",
            "发光器": "562/167535/270/242/30545000702576",
            "合金": "565/67354/370/377/30545000703126",
            "在树下": "556/131051/14/210/30545000703124",
            "地球人": "561/142545/333/11/30545000703122",
            "赛博朋克": "552/64200/140/31/30545000702617",
            "外星人再生": "553/114453/344/45/30545000702657",
            "外星人皮肤": "553/116602/324/253/30545000703007",
            "外星人绑架": "552/5334/62/6/30545000703062",
            "外星星云": "553/114524/3/200/30545000703071",
            "夜城": "554/175530/367/345/30545000702740",
            "头部开膛手": "561/142545/333/5/30545000703061",
            "宇宙爆炸": "557/163255/146/46/30545000702654",
            "富士山": "545/40717/1/211/30545000702576",
            "工艺剪刀": "565/67335/21/72/30545000702665",
            "帕斯提拉": "543/130456/16/153/30545000702706",
            "微生物学": "551/134444/100/316/30545000702740",
            "快乐的季节": "556/131023/214/327/30545000702613",
            "指北针": "557/163227/351/236/30545000703011",
            "指尖玩具": "572/14616/222/257/30545000702733",
            "搜捕": "554/41151/147/325/30545000702726",
            "放射性果冻": "545/11625/273/0/30545000702626",
            "旁观者": "544/55142/270/105/30545000702602",
            "旋转器": "545/11545/202/215/30545000702740",
            "时髦医学": "557/163340/251/240/30545000703000",
            "时髦的霓虹灯": "560/100572/177/212/30545000702630",
            "星座": "562/45076/20/322/30545000703021",
            "构造板块": "562/167566/100/25/30545000703124",
            "枫叶": "545/40715/350/114/30545000702737",
            "梦魇": "0/16723/263/330/30545000702757",
            "气候状况": "557/163307/63/346/30545000703072",
            "泡泡糖": "552/64074/371/346/30545000702772",
            "活体护甲": "556/15653/367/46/30545000702625",
            "流动": "0/16723/161/76/30545000703013",
            "流动的金属": "560/100572/177/176/30545000703102",
            "流星雨": "545/11632/355/205/30545000702623",
            "流行音乐合成器": "545/126725/52/245/30545000703102",
            "火山喷发": "543/66554/244/271/30545000703001",
            "火魔像": "551/27322/41/200/30545000703065",
            "灵魂": "556/15710/337/153/30545000702734",
            "烟幕": "555/102565/137/303/30545000702617",
            "煎蛋": "574/50102/12/72/30545000702635",
            "熔岩灯": "547/116313/64/303/30545000702773",
            "爱的迷彩": "560/100572/177/215/30545000703113",
            "獾-獾": "554/41027/222/234/30545000703057",
            "玉兰": "543/411/344/275/30545000703017",
            "电动绵羊": "554/156326/105/21/30545000703014",
            "电子人": "555/125200/352/163/30545000702602",
            "电子蜂巢": "545/126726/262/263/30545000702747",
            "眩晕": "541/30730/350/166/30545000703066",
            "矩阵": "541/26511/305/111/30545000702676",
            "破裂的光": "565/67316/327/32/30545000703053",
            "碳星": "562/44013/24/263/30545000702757",
            "神童 2.0": "541/133554/271/134/30545000703047",
            "秘制酱料": "543/66555/270/12/30545000703027",
            "符文": "546/5252/111/47/30545000703016",
            "红色烟雾": "576/110301/47/67/30545000703116",
            "纳米HUD": "561/25253/244/134/30545000702662",
            "纳米防护装甲": "554/156327/273/11/30545000702627",
            "绿色四边形": "561/25253/244/131/30545000703024",
            "绿锆石": "573/10253/222/176/30545000703030",
            "节日彩灯": "540/64314/165/347/30545000702727",
            "花火": "557/16771/76/362/30545000702646",
            "荣誉": "551/5045/321/233/30545000702742",
            "蓝色丁香": "564/23562/66/53/30545000703031",
            "西伯利亚虎": "543/66552/155/4/30545000703103",
            "视觉干扰者": "553/1373/221/42/30545000703010",
            "触手": "545/11627/266/127/30545000703110",
            "触摸寒冷": "547/146246/240/15/30545000702733",
            "跳动的心": "541/65415/164/111/30545000703067",
            "辉光": "572/77671/72/102/30545000702752",
            "迅速蔓延": "561/142545/333/7/30545000702730",
            "迪斯科 2.0": "552/64211/6/276/30545000703071",
            "逆境": "574/6253/211/221/30545000702603",
            "通感": "540/64312/120/11/30545000703104",
            "遥远的北方": "551/134444/117/265/30545000703076",
            "量子迷彩": "556/42752/316/204/30545000702731",
            "金合金": "562/167562/333/64/30545000703102",
            "金色齿轮": "552/64012/301/330/30545000702616",
            "钢铁之心": "560/100572/177/210/30545000703032",
            "钻石": "551/134444/130/205/30545000702735",
            "铁丝网": "546/137352/162/60/30545000703043",
            "银河": "541/175531/253/310/30545000703021",
            "银河星爆": "552/64134/215/32/30545000702555",
            "银河系": "542/131765/267/114/30545000703051",
            "镍": "572/100163/50/106/30545000702765",
            "防寒外套": "557/33664/165/326/30545000703115",
            "集成电路": "570/61724/131/122/30545000703104",
            "雷霆风暴": "547/116434/301/110/30545000703076",
            "风扇": "562/167467/304/374/30545000702627",
            "飞轮": "570/61727/1/317/30545000702720",
            "马赛克": "541/30732/343/205/30545000702763",
            "驾驶": "574/6304/6/145/30545000703052",
            "魔术圈": "556/15667/71/177/30545000703020",
            "鸭子": "571/77337/312/323/30545000703116",
            "黑海": "572/34572/163/302/30545000703050",
            "黑白": "554/41014/330/54/30545000702661",
            "齿轮": "545/11624/376/201/30545000702731",
            "三叶草小队": "606/142721/277/177/30545000606044",
            "休斯顿坦克": "606/52063/236/45/30545000607205",
            "佩佩加": "604/55500/15/160/30545000606136",
            "僵尸": "604/116750/271/365/30545000606143",
            "免疫": "604/116747/313/345/30545000605436",
            "冠军 1": "623/42350/264/340/31150472132672",
            "冠军 2": "623/42351/100/134/31150472240432",
            "冠军 3": "623/42351/251/127/31150472324774",
            "冠军 4": "623/42352/11/147/31150472404776",
            "冠军 5": "623/42355/17/117/31150473210051",
            "冠军 6": "623/42352/210/310/31150472576755",
            "冠军 7": "623/42355/272/323/31150473335604",
            "冠军 8": "623/42356/10/1/31150473404237",
            "勇气之火": "0/16723/130/202/30545000606147",
            "南瓜泥": "622/137024/6/24/31127605004004",
            "团队指针 1": "604/55510/203/75/30545000606070",
            "团队指针 2": "571/146111/144/37/30545000606722",
            "坦克-黑色": "606/52065/333/260/30545000607321",
            "坦克猫": "606/52065/142/77/30545000607033",
            "坦克的太阳": "606/52064/344/204/30545000607364",
            "对开发人员": "0/1374/267/140/30545000606714",
            "声望": "544/1402/203/71/30545000703123",
            "新兵": "611/524/240/123/30545000605437",
            "奇点": "577/175111/126/310/30545000605704",
            "妖精兄弟会": "606/142720/367/173/30545000607507",
            "姜饼": "605/125465/166/163/30545000606442",
            "强盗": "612/146707/57/264/30545000606716",
            "怀旧之情": "620/113263/274/327/31022654737316",
            "恐怖": "604/7264/173/133/30545000607025",
            "愁云": "613/61273/234/122/30554256716355",
            "手提袋": "565/174716/302/274/30545000607451",
            "柑橘": "604/100144/105/231/30545000606124",
            "毒": "604/55506/343/225/30545000607305",
            "治安关": "612/146706/230/231/30545000607035",
            "深红色": "604/100142/161/372/30545000607207",
            "甜蜜的礼物": "614/103702/243/276/30620760522223",
            "碎片": "612/43311/171/26/30545000606006",
            "神圣": "604/55505/224/357/30545000605576",
            "等离子体": "604/100137/327/241/30545000607043",
            "红色通缉令": "604/55507/216/315/30545000607562",
            "绿色随从": "606/142716/315/260/30545000606622",
            "美洲驼坦克": "606/52064/106/231/30545000606726",
            "银河系": "607/11377/342/30/30545000607017",
            "黑兹尔装甲工程": "606/52062/372/31/30545000607021",
            "黑色红宝石": "623/63452/73/13/31154712437072",
            "退役机器人": "604/55475/147/173/30545000606212",
            "钻石": "604/55511/71/224/30545000607411",
            "雪域惊喜": "623/157114/306/250/31173623152046",
            "青金石": "604/100143/214/52/30545000606037",
            "青铜盔甲": "573/113624/262/40/30545000702657",
            "高级监护人": "604/55511/302/312/30545000606504",
            "拼图": "626/144430/144/203/31331106073703",
            "墨盒": "630/25640/113/143/31405350075017",
            "烈火": "542/137056/361/250/30545000607033",
            "洒红节": "551/27323/272/14/30545000703040",
            //以下迷彩名称为非官方翻译
            "16 岁": "626/166330/71/330/31335466047104",
            "跑酷小子": "0/16717/162/310/30545000606035",
            "跑酷大师 2015": "0/16721/212/43/30545000606553",
            "跑酷大师 2016": "0/16723/14/104/30545000607166",
            "跑酷大师 2017": "0/16723/257/277/30545000607303",
            "跑酷大师 2019": "550/77320/242/146/30545000607116",
            "跑酷大师 2020": "560/12351/366/52/30545000607527",
            "跑酷大师 2023": "607/26446/13/143/30545000607346",
            "顶级": "541/62556/7/24/30545000606212",
            "滑翔": "0/16717/164/213/30545000607434",
            "凤凰": "0/16722/361/347/30545000607117",
            "缟玛瑙": "565/155742/353/315/30545000606410",
            "老兵": "0/16717/155/40/30545000605574",
            "冠军": "547/43332/355/140/30545000703025",
            "白银": "547/43341/230/201/30545000703065",
            "青铜": "547/43342/67/352/30545000702735",
            "星星": "0/16716/61/176/30545000607433",
            "强酸": "0/114/155/240/30545000607111",
            "幸运 7": "0/16717/164/212/30545000606576",
            "角斗士": "0/16717/155/36/30545000606503",
            "棱镜": "542/137051/152/330/30545000606116",
            "火焰": "0/1374/276/171/30545000607132",
            "火焰 2.0": "562/44013/24/255/30545000703063",
            "蓝宝石": "614/103636/351/117/30664160335503",
            "鳄鱼": "0/114/163/233/30545000607032",
            "红宝石": "0/16717/221/102/30545000606633",
            "芳纶": "0/16717/221/101/30545000607563",
            "记者": "0/114/147/57/30545000607213",
            "微芯片": "0/1374/265/227/30545000607561",
            "赫利俄斯": "0/16717/221/100/30545000606626",
            "观察者": "0/16722/171/372/30545000607413",
            "月度最佳帮手": "0/16717/307/52/30545000607212",
            "年度最佳帮手 2017": "540/157406/124/266/30545000605473",
            "年度最佳帮手 2019": "557/33534/212/63/30545000702645",
            "年度最佳帮手 2020": "567/115670/43/173/30545000606332",
            "年度最佳帮手 2021": "576/64316/31/146/30545000606630",
            "年度最佳帮手 2022": "605/12470/15/141/30545000606014",
            "年度最佳帮手 2023": "614/100675/73/76/30620157235760",
            "年度最佳帮手 2024": "623/154553/33/214/31173132625207",
            "3D坦克 YouTuber": "0/16722/334/6/30545000605500",
            "JMPR": "576/46346/347/267/30545000607533",
            "Waider": "576/46360/200/227/30545000607525",
            "JERRYYY21": "576/46353/317/267/30545000606722",
            "Taspens": "576/46347/352/225/30545000607112",
            "BigTanks": "576/46350/260/114/30545000607361",
            "Quirky": "576/46356/120/31/30545000606650",
            "死亡迷彩": "0/1/316/220/30545000607151",
            "加速燃烧": "547/164727/27/3/30545000605643",
            "涡轮增压": "553/175137/107/140/30545000702756",
            "洗手液": "561/61526/337/377/30545000606724",
            "微笑": "0/16723/100/17/30545000607073",
            "未知 1": "0/16723/234/314/30545000607322"
        }
    };
    // --- END: Raw Data (Omitted for brevity) ---


    const resourceMaps = {
        turrets: turretsRedirectMap,
        hulls: hullsRedirectMap,
        drones: dronesRedirectMap,
        festivals: festivalsRedirectMap,
        shotEffects: shotEffectsRedirectMap,
        paints: paintsRedirectMap
    };

    const CONFIG_KEY = 'tankiAdvancedReplacements_v4_per_rule_domain';

    function getDefaultResourceDomain() {
        const url = new URL(window.location.href);
        const params = url.searchParams;
        const hostname = url.hostname;

        if (params.has('resources')) {
            const resourcesParam = params.get('resources');
            // 新增：处理 ../resources 的情况
            if (resourcesParam === '../resources') {
                return `https://${hostname}/resources`;
            }
            // 保留原有逻辑
            if (resourcesParam && resourcesParam.startsWith('http')) {
                return resourcesParam.endsWith('/') ? resourcesParam.slice(0, -1) : resourcesParam;
            }
        }

        if (hostname.endsWith('3dtank.com')) {
            return 'https://res.3dtank.com';
        }
        if (hostname.startsWith('public-deploy') && hostname.endsWith('test-eu.tankionline.com')) {
            return `https://${hostname}/resources`;
        }
        if (hostname.endsWith('tankionline.com')) {
            return 'https://s.eu.tankionline.com';
        }
        return 'https://s.eu.tankionline.com';
    }


    const DEFAULT_RESOURCE_DOMAIN = getDefaultResourceDomain();
    const allPossibleDomains = [
        DEFAULT_RESOURCE_DOMAIN,
        'https://s.eu.tankionline.com',
        'https://res.3dtank.com',
        'https://testanki1.github.io',
        ...Array.from({ length: 9 }, (_, i) => `https://public-deploy${i + 1}.test-eu.tankionline.com/resources`)
    ];
    const resourceDomains = [...new Set(allPossibleDomains)];


    let currentConfig = {};
    let activeReplacements = {};
    const resourcePathCache = new Map();

    async function checkResourceExists(domain, path) {
        if (!domain || !path) return false;

        let directoryPath = path;
        const lastSlashIndex = path.lastIndexOf('/');
        // 检查路径最后一部分是否像文件名（即包含点号'.'）
        if (lastSlashIndex !== -1) {
            const lastPart = path.substring(lastSlashIndex + 1);
            if (lastPart.includes('.')) {
                // 如果是文件路径，则取其父目录
                directoryPath = path.substring(0, lastSlashIndex);
            }
        }
        // 如果不是文件路径（例如 '.../31167700271626'），则 directoryPath 保持为原始 path

        const url = `${domain}/${directoryPath}/meta.info`;
        try {
            const response = await fetch(url, { method: 'HEAD', cache: 'reload' });
            return response.ok;
        } catch (error) {
            // 网络错误或CORS策略阻止了请求，也视为资源不存在
            // console.error(`Check failed for ${url}:`, error);
            return false;
        }
    }
    function getResourcePath(category, from, to) {
        const map = resourceMaps[category];
        if (!map || !from || !to) return null;

        if (category === 'shotEffects') {
            for (const effectKey in map) {
                if (effectKey.toLowerCase().startsWith(from.toLowerCase())) {
                    const resourcePath = map[effectKey]?.[to];
                    if (resourcePath) return resourcePath;
                }
            }
        } else if (category === 'paints') {
            return map.paints?.[to];
        } else {
            return map[from]?.[to] || map[from]?.[to.toUpperCase()];
        }
        return null;
    }

    function getDomainDisplayName(domain) {
        try {
            return new URL(domain).hostname;
        } catch {
            return domain;
        }
    }

    async function validateAndHandleResource(ruleRow) {
        const toWrapper = ruleRow.querySelector('.to-select-wrapper');
        const toContainer = toWrapper.querySelector('.custom-select-container');
        if (!toContainer) return;

        const toTrigger = toContainer.querySelector('.cs-trigger');
        const domainWrapper = ruleRow.querySelector('.domain-selector-wrapper');

        // Reset previous state
        toTrigger.classList.remove('validation-error');
        toTrigger.title = '';
        domainWrapper.innerHTML = ''; // Clear old selector

        const category = ruleRow.dataset.category;
        const fromValue = ruleRow.querySelector('.from-select-wrapper .custom-select-container').dataset.value;
        const toValue = toContainer.dataset.value;

        if (!category || !fromValue || !toValue) return;

        const resourcePath = getResourcePath(category, fromValue, toValue);
        if (!resourcePath) return;

        const currentDomain = ruleRow.dataset.domain || DEFAULT_RESOURCE_DOMAIN;
        const isDefaultDomain = !ruleRow.dataset.domain;

        const existsOnCurrent = await checkResourceExists(currentDomain, resourcePath);

        if (existsOnCurrent) {
            if (!isDefaultDomain) {
                // 资源在用户选择的非默认域名上找到了 -> 这是成功状态
                toTrigger.classList.remove('validation-error');
                toTrigger.title = `已在 ${getDomainDisplayName(currentDomain)} 上找到资源。`;
                // 调用 createDomainSelector 并传递成功状态
                createDomainSelector(domainWrapper, ruleRow, false, true);
            } else {
                // 资源在默认域名上有效，不需要显示选择器
                domainWrapper.innerHTML = '';
            }
            return;
        }

        // --- 如果资源未在当前（或默认）域上找到 ---

        // 将“To”选择器标记为错误
        toTrigger.classList.add('validation-error');
        toTrigger.title = `在 ${getDomainDisplayName(currentDomain)} 上未找到资源。请从右侧选择一个可用的资源域名。`;

        // 创建并显示处于错误状态的域选择器
        createDomainSelector(domainWrapper, ruleRow, true, false);
    }


    function createDomainSelector(wrapper, ruleRow, isError, isSuccess) {
        const selectId = `domain-${Date.now()}-${Math.random()}`;
        const selectedValue = ruleRow.dataset.domain || "";
        const selectedText = selectedValue ? getDomainDisplayName(selectedValue) : '-- 请更换资源域名 --';
        const optionsHtml = resourceDomains.map(opt =>
                                                `<li class="cs-option ${selectedValue === opt ? 'selected' : ''}" data-value="${opt}">${getDomainDisplayName(opt)}</li>`
        ).join('');

        let containerClass = 'custom-select-container';
        if (isError) {
            containerClass += ' validation-error';
        } else if (isSuccess) {
            containerClass += ' validation-success';
        }


        wrapper.innerHTML = `
        <div id="${selectId}" class="${containerClass}" data-value="${selectedValue}">
            <div class="cs-trigger">${selectedText}</div>
            <div class="cs-options">
                 <input type="text" class="cs-search-input" placeholder="搜索资源域名...">
                 <ul class="cs-options-list">${optionsHtml}</ul>
            </div>
        </div>`;
    }

function getToOptionsFor(category, fromValue) {
    const map = resourceMaps[category];
    if (!map || !fromValue) {
        return [];
    }
    const options = new Set();
    if (['turrets', 'hulls', 'drones'].includes(category)) {
        const itemSkins = map[fromValue];
        if (itemSkins) {
            Object.keys(itemSkins).forEach(skin => {
                if (skin !== 'default') {
                    options.add(skin);
                }
            });
        }
    } else if (category === 'shotEffects') {
        for (const effectKey in map) {
            if (effectKey.toLowerCase().startsWith(fromValue.toLowerCase())) {
                const effectStyles = map[effectKey];
                if (effectStyles) {
                    Object.keys(effectStyles).forEach(style => {
                        if (style !== 'default') {
                            options.add(style);
                        }
                    });
                }
            }
        }
    } else if (category === 'paints') {
        if (map.paints) {
            Object.keys(map.paints).forEach(paintName => options.add(paintName));
        }
    }
    return Array.from(options).sort(pinyinSorter);
}

function createCustomSelect(id, options, selectedValue, placeholder = '-- 请选择 --', disabled = false) {
    const selectedText = selectedValue ? getDisplayName(selectedValue) : placeholder;
    const optionsHtml = options.map(opt =>
                                    `<li class="cs-option ${selectedValue === opt ? 'selected' : ''}" data-value="${opt}">${getDisplayName(opt)}</li>`
        ).join('');

    return `
        <div id="${id}" class="custom-select-container ${disabled ? 'disabled' : ''}" data-value="${selectedValue || ''}">
            <div class="cs-trigger">${selectedText}</div>
            <div class="cs-options">
                <input type="text" class="cs-search-input" placeholder="搜索...">
                <ul class="cs-options-list">${optionsHtml}</ul>
            </div>
        </div>
        `;
}

function createDynamicRuleRow(category, fromOptions, from = "", to = "", domain = "") {
    const fromId = `from-${category}-${Date.now()}-${Math.random()}`;
    const toId = `to-${category}-${Date.now()}-${Math.random()}`;
    const toOptions = from ? getToOptionsFor(category, from) : [];
    const toPlaceholder = from ? '-- 请选择目标 --' : '-- 请先选择源 --';
    const toDisabled = !from;

    return `
         <div class="replacer-rule-row" data-category="${category}" data-domain="${domain || ''}">
             <div class="from-select-wrapper">
                ${createCustomSelect(fromId, fromOptions, from, '-- 请选择源 --')}
             </div>
             <span class="arrow material-symbols-outlined">arrow_forward</span>
             <div class="to-select-wrapper">
                ${createCustomSelect(toId, toOptions, to, toPlaceholder, toDisabled)}
             </div>
             <div class="domain-selector-wrapper"></div>
             <button class="replacer-btn delete-btn" title="删除规则"><span class="material-symbols-outlined">delete</span></button>
         </div>`;
}


function createCategorySection(id, title, fromOpts, rules = []) {
    return `
         <div class="replacer-category" id="category-${id}">
             <div class="replacer-category-title">
                 <span>${title}</span>
                 <button class="replacer-btn add-btn" data-category="${id}" title="添加新规则"><span class="material-symbols-outlined">add</span></button>
             </div>
             <div class="rules-container">
                 ${(rules || []).map(rule => createDynamicRuleRow(id, fromOpts, rule.from, rule.to, rule.domain)).join('')}
             </div>
         </div>`;
}

function createFestivalSection(id, title, options, selectedValue = 'default') {
    const selectorId = 'festival-theme-selector';
    const customSelectHtml = createCustomSelect(
        selectorId,
        ['default', ...options],
        selectedValue,
        '-- 选择节日主题 --'
    );

    return `
            <div class="replacer-category" id="category-${id}" data-category="${id}">
                <div class="replacer-category-title"><span>${title}</span></div>
                <div class="replacer-rule-row single-selector-row">
                    ${customSelectHtml}
                </div>
            </div>`;
}


function injectPanelCSS() {
    if (document.getElementById('replacer-styles')) return;
    const css = `
            :root { --rp-main-color: #76FF33; --rp-bg-color: rgba(0, 25, 38, 0.95); --rp-dark-bg: #001926; --rp-text-color: #bfd5ff; --rp-error-color: #ff6666; }
            .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; display: inline-flex; vertical-align: middle; line-height: 1; }
            #replacer-edge-trigger { position: fixed; top: 50%; right: 0; transform: translateY(-50%); width: 28px; height: 100px; background-color: rgba(0, 25, 38, 0.4); border: 1px solid rgba(118, 255, 51, 0.4); border-right: none; border-radius: 10px 0 0 10px; cursor: pointer; z-index: 19999; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
            #replacer-edge-trigger:hover { background-color: rgba(0, 25, 38, 0.8); width: 35px; }
            #replacer-edge-trigger .trigger-icon { color: rgba(118, 255, 51, 0.7); font-size: 28px; transform: rotate(180deg); transition: all 0.3s ease; }
            #replacer-edge-trigger:hover .trigger-icon { color: var(--rp-main-color); transform: rotate(180deg) scale(1.1); }
            .replacer-settings-overlay, .update-dialog-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.75); display: flex; justify-content: center; align-items: center; z-index: 20000; }
            .replacer-settings-panel, .update-dialog-panel { background-color: var(--rp-bg-color); color: var(--rp-text-color); border: 1px solid var(--rp-main-color); border-radius: 12px; width: 90%; box-shadow: 0 0 30px rgba(118, 255, 51, 0.3); display: flex; flex-direction: column; max-height: 90vh; }
            .replacer-settings-panel { max-width: 950px; }
            .update-dialog-panel { max-width: 500px; }
            .replacer-header, .update-dialog-header { padding: 16px 24px; font-size: 1.75rem; color: var(--rp-main-color); border-bottom: 1px solid rgba(118, 255, 51, 0.4); text-align: center; }
            .replacer-body, .update-dialog-body { padding: 24px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--rp-main-color) var(--rp-bg-color); }
            .update-dialog-body p { margin: 0 0 12px; line-height: 1.6; }
            .update-dialog-body .update-info-box { background: rgba(0,0,0,0.2); border-left: 3px solid var(--rp-main-color); padding: 12px; margin-top: 8px; border-radius: 4px; font-size: 0.9rem; }
            .replacer-category { margin-bottom: 24px; }
            .replacer-category-title { font-size: 1.2rem; font-weight: 500; color: #fff; border-bottom: 2px solid var(--rp-main-color); padding-bottom: 8px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
            .replacer-rule-row { display: grid; grid-template-columns: 2fr auto 2fr 2fr auto; gap: 12px; align-items: center; margin-bottom: 10px; }
            .replacer-rule-row.single-selector-row { grid-template-columns: 1fr; }
            .replacer-rule-row .arrow { font-size: 1.8rem; color: var(--rp-main-color); text-align: center; }
            .replacer-btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 1rem; transition: all 0.2s ease; background-color: var(--rp-main-color); color: var(--rp-dark-bg); display: inline-flex; align-items: center; gap: 8px; }
            .replacer-btn.delete-btn { background: transparent; color: var(--rp-error-color); padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; grid-column: 5; }
            .replacer-btn.delete-btn:hover { background-color: rgba(255, 82, 82, 0.2); }
            .replacer-btn.add-btn { background: transparent; color: var(--rp-main-color); padding: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--rp-main-color); border-radius: 50%; }
            .replacer-btn.add-btn:hover { background-color: rgba(118, 255, 51, 0.2); }
            .replacer-actions, .update-dialog-actions { padding: 16px 24px; border-top: 1px solid rgba(118, 255, 51, 0.4); display: flex; justify-content: flex-end; gap: 12px; }
            .replacer-btn.close-btn { background-color: #555; color: #fff; }
            .replacer-btn.save-only-btn { background-color: #00D4FF; color: #fff; }
            .replacer-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background-color: var(--rp-bg-color); color: var(--rp-main-color); padding: 12px 24px; border-radius: 6px; border: 1px solid var(--rp-main-color); z-index: 25000; transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; opacity: 0; }
            .replacer-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
            .custom-select-container { position: relative; width: 100%; font-size: 1rem; }
            .from-select-wrapper { grid-column: 1; }
            .to-select-wrapper { grid-column: 3; }
            .domain-selector-wrapper { grid-column: 4; }
            .custom-select-container.disabled .cs-trigger { background-color: rgba(0, 0, 0, 0.1); color: #777; cursor: not-allowed; }
            .cs-trigger { width: 100%; padding: 10px; background-color: rgba(0, 0, 0, 0.3); border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; cursor: pointer; user-select: none; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: border-color 0.2s ease; }
            .custom-select-container.open .cs-trigger { border-color: var(--rp-main-color); }
            .custom-select-container.validation-error .cs-trigger, .custom-select-container.validation-error { border-color: var(--rp-error-color) !important; }
            .custom-select-container.validation-success .cs-trigger, .custom-select-container.validation-success { border-color: var(--rp-main-color) !important; }
            .cs-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: var(--rp-dark-bg); border: 1px solid var(--rp-main-color); border-radius: 4px; z-index: 20001; margin-top: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
            .custom-select-container.open .cs-options { display: block; }
            .cs-search-input { width: 100%; padding: 10px; box-sizing: border-box; background-color: rgba(0,0,0,0.5); border: none; border-bottom: 1px solid #444; color: #fff; font-size: 1rem; }
            .cs-search-input:focus { outline: none; border-bottom-color: var(--rp-main-color); }
            .cs-options-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--rp-main-color) var(--rp-dark-bg); }
            .cs-option { padding: 10px; cursor: pointer; }
            .cs-option:hover, .cs-option.selected { background-color: rgba(118, 255, 51, 0.2); }
            .cs-option.hidden { display: none; }
        `;
    document.head.insertAdjacentHTML('beforeend', `<style id="replacer-styles">${css}</style>`);
}

async function createPanel() {
    if (document.getElementById('replacer-panel-overlay')) return;
    const config = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
    const getFromOptions = (map, category) => {
        if (category === 'shotEffects') return Array.from(new Set(Object.keys(map || {}).map(key => key.split('_')[0]))).sort(pinyinSorter);
        if (category === 'paints') return Object.keys(map?.paints || {}).sort(pinyinSorter);
        return Object.keys(map || {}).sort(pinyinSorter);
    };
    const getAllFestivalThemes = (map) => {
        const themes = new Set();
        for (const item in map) {
            for (const theme in map[item]) {
                if (theme !== 'default') {
                    themes.add(theme);
                }
            }
        }
        return Array.from(themes).sort(pinyinSorter);
    };
    const categoryFromOptions = {
        turrets: getFromOptions(turretsRedirectMap, 'turrets'),
        hulls: getFromOptions(hullsRedirectMap, 'hulls'),
        paints: getFromOptions(paintsRedirectMap, 'paints'),
        shotEffects: getFromOptions(shotEffectsRedirectMap, 'shotEffects'),
        drones: getFromOptions(dronesRedirectMap, 'drones'),
    };
    const festivalThemeOpts = getAllFestivalThemes(festivalsRedirectMap);
    const panelHtml = `
            <div class="replacer-settings-overlay" id="replacer-panel-overlay" style="display:none;">
                <div class="replacer-settings-panel">
                    <div class="replacer-header">资源替换</div>
                    <div class="replacer-body" id="replacer-main-body">
                        ${createCategorySection('turrets', '炮塔', categoryFromOptions.turrets, config.turrets)}
                        ${createCategorySection('hulls', '底盘', categoryFromOptions.hulls, config.hulls)}
                        ${createCategorySection('paints', '迷彩', categoryFromOptions.paints, config.paints)}
                        ${createCategorySection('shotEffects', '射击效果', categoryFromOptions.shotEffects, config.shotEffects)}
                        ${createCategorySection('drones', '无人机', categoryFromOptions.drones, config.drones)}
                        ${createFestivalSection('festivals', '节日/地图', festivalThemeOpts, config.festivals)}
                    </div>
                    <div class="replacer-actions">
                        <button class="replacer-btn close-btn"><span class="material-symbols-outlined">close</span>关闭</button>
                        <button class="replacer-btn save-only-btn"><span class="material-symbols-outlined">save</span>仅保存</button>
                        <button class="replacer-btn save-reload-btn"><span class="material-symbols-outlined">save</span>保存并重载</button>
                    </div>
                </div>
            </div>`;
    document.body.insertAdjacentHTML('beforeend', panelHtml);

    // After panel is in the DOM, run validation on all existing rules that have a 'to' value
    document.querySelectorAll('.replacer-rule-row[data-category]').forEach(row => {
        const toValue = row.querySelector('.to-select-wrapper .custom-select-container')?.dataset.value;
        if (toValue) {
            validateAndHandleResource(row);
        }
    });

    const overlay = document.getElementById('replacer-panel-overlay');

    overlay.addEventListener('click', (e) => {
        const btn = e.target.closest('.replacer-btn');
        if (!btn && e.target === overlay) {
            overlay.style.display = 'none';
            return;
        }
        if (!btn) return;

        if (btn.classList.contains('add-btn')) {
            const category = btn.dataset.category;
            const container = btn.closest('.replacer-category').querySelector('.rules-container');
            const fromOpts = categoryFromOptions[category];
            if (fromOpts) container.insertAdjacentHTML('beforeend', createDynamicRuleRow(category, fromOpts));
        } else if (btn.classList.contains('delete-btn')) {
            btn.closest('.replacer-rule-row').remove();
        } else if (btn.classList.contains('save-reload-btn')) {
            saveConfiguration();
            showToast('配置已保存，正在重载页面...');
            setTimeout(() => window.location.reload(), 1000);
        } else if (btn.classList.contains('save-only-btn')) {
            const newConfig = saveConfiguration();
            processConfig(newConfig);
            showToast('配置已保存。部分替换可能需要重载页面才能完全生效。');
            overlay.style.display = 'none';
        } else if (btn.classList.contains('close-btn')) {
            overlay.style.display = 'none';
        }
    });
}

function saveConfiguration() {
    const newConfig = {};
    document.querySelectorAll('.replacer-rule-row[data-category]').forEach(row => {
        const category = row.dataset.category;
        if (!newConfig[category]) newConfig[category] = [];
        const from = row.querySelector('.from-select-wrapper .custom-select-container').dataset.value;
        const to = row.querySelector('.to-select-wrapper .custom-select-container').dataset.value;
        const domain = row.dataset.domain || ''; // Get domain from data attribute
        if (from && to) {
            newConfig[category].push({ from, to, domain });
        }
    });
    const festivalSelector = document.getElementById('festival-theme-selector');
    if (festivalSelector) newConfig.festivals = festivalSelector.dataset.value;

    localStorage.setItem(CONFIG_KEY, JSON.stringify(newConfig));
    console.log("配置已保存:", newConfig);
    return newConfig;
}

function initializeCustomSelectHandlers() {
    document.body.addEventListener('click', (e) => {
        const trigger = e.target.closest('.cs-trigger');

        document.querySelectorAll('.custom-select-container.open').forEach(openSelect => {
            if (!trigger || openSelect !== trigger.parentElement) {
                openSelect.classList.remove('open');
            }
        });

        if (trigger) {
            const container = trigger.closest('.custom-select-container');
            if (container && !container.classList.contains('disabled')) {
                container.classList.toggle('open');
                if (container.classList.contains('open')) {
                    const searchInput = container.querySelector('.cs-search-input');
                    if (searchInput) searchInput.focus();
                }
            }
        }
    });

    document.body.addEventListener('click', async (e) => {
        if (e.target.matches('.cs-option')) {
            const option = e.target;
            const container = option.closest('.custom-select-container');
            const trigger = container.querySelector('.cs-trigger');
            const ruleRow = container.closest('.replacer-rule-row');

            const oldValue = container.dataset.value;
            const newValue = option.dataset.value;

            container.dataset.value = newValue;
            // For domain selector, display name is different
            if (container.closest('.domain-selector-wrapper')) {
                trigger.textContent = getDomainDisplayName(newValue) || '-- 请更换资源域名 --';
            } else {
                trigger.textContent = option.textContent;
            }

            container.querySelectorAll('.cs-option.selected').forEach(sel => sel.classList.remove('selected'));
            option.classList.add('selected');
            container.classList.remove('open');

            if (oldValue !== newValue && ruleRow) {
                if (container.closest('.from-select-wrapper')) {
                    // 'From' select changed: update 'To' options
                    const category = ruleRow.dataset.category;
                    const toWrapper = ruleRow.querySelector('.to-select-wrapper');
                    const toOptions = getToOptionsFor(category, newValue);
                    const toId = `to-${category}-${Date.now()}-${Math.random()}`;
                    const newToSelectHtml = createCustomSelect(toId, toOptions, '', '-- 请选择目标 --', toOptions.length === 0);
                    toWrapper.innerHTML = newToSelectHtml;
                    ruleRow.querySelector('.domain-selector-wrapper').innerHTML = '';
                } else if (container.closest('.to-select-wrapper')) {
                    // 'To' select changed: validate
                    ruleRow.dataset.domain = ''; // Reset domain on 'To' change
                    await validateAndHandleResource(ruleRow);
                } else if (container.closest('.domain-selector-wrapper')) {
                    // Domain select changed: update stored domain and re-validate
                    ruleRow.dataset.domain = newValue;
                    await validateAndHandleResource(ruleRow);
                }
            }
        }
    });

    document.body.addEventListener('input', (e) => {
        if (e.target.matches('.cs-search-input')) {
            const input = e.target;
            const filter = input.value.toLowerCase();
            const optionsList = input.closest('.cs-options').querySelector('.cs-options-list');

            optionsList.querySelectorAll('.cs-option').forEach(option => {
                const text = option.textContent.toLowerCase();
                const value = option.dataset.value.toLowerCase();
                if (text.includes(filter) || value.includes(filter)) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        }
    });
}

function createEdgeTrigger() {
    if (document.getElementById('replacer-edge-trigger')) return;
    const trigger = document.createElement('div');
    trigger.id = 'replacer-edge-trigger';
    trigger.innerHTML = '<span class="trigger-icon material-symbols-outlined">chevron_left</span>';
    trigger.title = '打开资源替换设置';
    trigger.onclick = () => {
        const overlay = document.getElementById('replacer-panel-overlay');
        if (overlay) overlay.style.display = 'flex';
    };
    document.body.appendChild(trigger);
}

function processConfig(config) {
    const processed = {};
    if (!config) return;

    for (const category in config) {
        if (category !== 'festivals') {
            processed[category] = config[category];
        }
    }

    const selectedTheme = config.festivals;
    if (selectedTheme && selectedTheme !== 'default') {
        const festivalRules = [];
        const festivalMap = resourceMaps.festivals;
        for (const itemName in festivalMap) {
            if (festivalMap[itemName] && festivalMap[itemName][selectedTheme]) {
                festivalRules.push({
                    from: itemName,
                    to: selectedTheme,
                    domain: ''
                });
            }
        }
        processed.festivals = festivalRules;
    } else {
        processed.festivals = [];
    }

    activeReplacements = processed;
    console.log("生效中的替换规则:", activeReplacements);
}

function buildResourcePathCache() {
    resourcePathCache.clear();
    for (const category in resourceMaps) {
        const map = resourceMaps[category];
        if (category === 'paints') {
            if (map.paints) {
                for (const paintName in map.paints) {
                    resourcePathCache.set(map.paints[paintName], { category: 'paints', from: paintName });
                }
            }
        } else if (category === 'shotEffects') {
            for (const effectKey in map) {
                const from = effectKey.split('_')[0]; // e.g., 'twins' from 'twins_sound_1'
                for (const skin in map[effectKey]) {
                    const fullPath = map[effectKey][skin];
                    resourcePathCache.set(fullPath, { category: 'shotEffects', from: from, skin: skin, fullKey: effectKey });
                }
            }
        } else {
            for (const itemName in map) {
                for (const skinName in map[itemName]) {
                    resourcePathCache.set(map[itemName][skinName], { category: category, from: itemName, skin: skinName });
                }
            }
        }
    }
}

function setupInterceptors() {
    try {
        currentConfig = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
        processConfig(currentConfig);
    } catch (e) {
        console.error("解析替换配置失败:", e);
        currentConfig = {};
        activeReplacements = {};
    }

    const findReplacement = (originalUrl) => {
        let longestMatchPath = '';
        let sourceInfo = null;

        // Find the longest matching resource path from the cache
        for (const [path, info] of resourcePathCache.entries()) {
            if (originalUrl.includes(path) && path.length > longestMatchPath.length) {
                longestMatchPath = path;
                sourceInfo = info;
            }
        }

        if (!sourceInfo) return null;

        const originalFile = originalUrl.substring(originalUrl.indexOf(longestMatchPath) + longestMatchPath.length);
        const rules = activeReplacements[sourceInfo.category];

        let rule = null;
        if (sourceInfo.category === 'shotEffects') {
            // For shot effects, we need to match the 'from' part (e.g., 'twins')
            rule = rules?.find(r => r.from.toLowerCase() === sourceInfo.from.toLowerCase());
        } else {
            // For other categories, we match the full 'from' name
            rule = rules?.find(r => r.from.toLowerCase() === sourceInfo.from.toLowerCase());
        }

        if (!rule) return null;

        let targetPath;
        if (sourceInfo.category === 'shotEffects') {
            // Find the corresponding target path using the full original key
            const targetMap = resourceMaps.shotEffects[sourceInfo.fullKey];
            targetPath = targetMap ? targetMap[rule.to] : null;
        } else {
            targetPath = getResourcePath(sourceInfo.category, rule.from, rule.to);
        }

        const domain = rule.domain || DEFAULT_RESOURCE_DOMAIN;
        if (!targetPath) return null;

        return `${domain}/${targetPath}${originalFile}`;
    };


    const originalFetch = window.fetch;
    window.fetch = function(input, init) {
        let url = (input instanceof Request) ? input.url : String(input);
        const newUrl = findReplacement(url);
        if (newUrl) {
            console.log(`[Replacer] Fetch: ${url} -> ${newUrl}`);
            input = (input instanceof Request) ? new Request(newUrl, input) : newUrl;
        }
        return originalFetch.call(this, input, init);
    };

    const originalOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url, ...args) {
        const newUrl = findReplacement(String(url));
        if (newUrl) {
            console.log(`[Replacer] XHR: ${url} -> ${newUrl}`);
        }
        return originalOpen.call(this, method, newUrl || url, ...args);
    };
}

// --- 主执行逻辑 ---
buildResourcePathCache();
setupInterceptors();


const interval = setInterval(() => {
    if (document.body) {
        clearInterval(interval);
        try {
            injectMaterialIcons();
            injectPanelCSS();
            createPanel();
            initializeCustomSelectHandlers();
        } catch (e) {
            console.error("UI 初始化失败:", e);
        }
    }
}, 100);

})();
